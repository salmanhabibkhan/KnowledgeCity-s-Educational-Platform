"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmpAddOn = void 0;
const utils_1 = require("../../utils");
const adot_1 = require("../adot");
const kubectl_provider_1 = require("../helm-addon/kubectl-provider");
const aws_aps_1 = require("aws-cdk-lib/aws-aps");
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    deploymentMode: "deployment" /* DeploymentMode.DEPLOYMENT */,
    name: 'adot-collector-amp',
    namespace: 'default',
    enableAPIserverJob: false,
    memoryLimit: '2Gi',
    cpuLimit: '1'
};
/**
 * Implementation of AMP add-on for EKS Blueprints. Installs ADOT Collector.
 */
let AmpAddOn = class AmpAddOn {
    constructor(props) {
        this.ampAddOnProps = { ...defaultProps, ...props };
    }
    deploy(clusterInfo) {
        var _a;
        const cluster = clusterInfo.cluster;
        let doc;
        // Applying manifest for configuring ADOT Collector for Amp.
        if (this.ampAddOnProps.deploymentMode == "daemonset" /* DeploymentMode.DAEMONSET */) {
            doc = (0, utils_1.readYamlDocument)(__dirname + '/collector-config-amp-daemonset.ytpl');
        }
        else {
            doc = (0, utils_1.readYamlDocument)(__dirname + '/collector-config-amp.ytpl');
        }
        doc = (0, utils_1.changeTextBetweenTokens)(doc, "{{ if enableAPIserverJob }}", "{{ end }}", this.ampAddOnProps.enableAPIServerJob);
        const manifest = doc.split("---").map(e => {
            var _a;
            let object = (0, utils_1.loadYaml)(e);
            if (((_a = this.ampAddOnProps.openTelemetryCollector) === null || _a === void 0 ? void 0 : _a.manifestPath) !== undefined && object.kind === "OpenTelemetryCollector") {
                object = (0, utils_1.readYamlDocument)(this.ampAddOnProps.openTelemetryCollector.manifestPath);
                object = (0, utils_1.loadYaml)(object);
            }
            return object;
        });
        const attrPrometheusEndpoint = this.ampAddOnProps.ampPrometheusEndpoint + 'api/v1/remote_write';
        const values = {
            remoteWriteEndpoint: attrPrometheusEndpoint,
            awsRegion: cluster.stack.region,
            deploymentMode: this.ampAddOnProps.deploymentMode,
            cpuLimit: this.ampAddOnProps.cpuLimit,
            memoryLimit: this.ampAddOnProps.memoryLimit,
            namespace: this.ampAddOnProps.namespace,
            clusterName: cluster.clusterName,
            ...(_a = this.ampAddOnProps.openTelemetryCollector) === null || _a === void 0 ? void 0 : _a.manifestParameterMap
        };
        const manifestDeployment = {
            name: this.ampAddOnProps.name,
            namespace: this.ampAddOnProps.namespace,
            manifest,
            values
        };
        const kubectlProvider = new kubectl_provider_1.KubectlProvider(clusterInfo);
        const statement = kubectlProvider.addManifest(manifestDeployment);
        const ampRules = this.ampAddOnProps.ampRules;
        if (ampRules !== undefined) {
            const ruleGroupsNamespaces = this.configureRules(cluster, ampRules.ruleFilePaths, ampRules.ampWorkspaceArn);
            statement.node.addDependency(ruleGroupsNamespaces.at(-1));
        }
        return Promise.resolve(statement);
    }
    configureRules(cluster, ruleFilePaths, ampWorkspaceArn) {
        const ruleGroupsNamespaces = [];
        if (ruleFilePaths.length == 0) {
            throw new Error("No paths defined for AMP rules");
        }
        ruleFilePaths.map((ruleFilePath, index) => {
            const ruleGroupsNamespace = new aws_aps_1.CfnRuleGroupsNamespace(cluster, "AmpRulesConfigurator-" + index, {
                data: (0, utils_1.readYamlDocument)(ruleFilePath),
                name: "AmpRulesConfigurator-" + index,
                workspace: ampWorkspaceArn
            });
            if (index > 0) {
                ruleGroupsNamespace.node.addDependency(ruleGroupsNamespaces.at(-1));
            }
            ruleGroupsNamespaces.push(ruleGroupsNamespace);
        });
        return ruleGroupsNamespaces;
    }
};
exports.AmpAddOn = AmpAddOn;
__decorate([
    (0, utils_1.dependable)(adot_1.AdotCollectorAddOn.name)
], AmpAddOn.prototype, "deploy", null);
exports.AmpAddOn = AmpAddOn = __decorate([
    utils_1.supportsALL
], AmpAddOn);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2FtcC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFDQSx1Q0FBMkc7QUFDM0csa0NBQTZDO0FBRTdDLHFFQUFxRjtBQUNyRixpREFBNkQ7QUFrRzdEOztHQUVHO0FBQ0gsTUFBTSxZQUFZLEdBQUc7SUFDakIsY0FBYyw4Q0FBMkI7SUFDekMsSUFBSSxFQUFFLG9CQUFvQjtJQUMxQixTQUFTLEVBQUUsU0FBUztJQUNwQixrQkFBa0IsRUFBRSxLQUFLO0lBQ3pCLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLFFBQVEsRUFBRSxHQUFHO0NBQ2hCLENBQUM7QUFFRjs7R0FFRztBQUVJLElBQU0sUUFBUSxHQUFkLE1BQU0sUUFBUTtJQUlqQixZQUFZLEtBQW9CO1FBQzVCLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxHQUFHLFlBQVksRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDO0lBQ3ZELENBQUM7SUFHRCxNQUFNLENBQUMsV0FBd0I7O1FBQzNCLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDcEMsSUFBSSxHQUFXLENBQUM7UUFFaEIsNERBQTREO1FBQzVELElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLDhDQUE0QixFQUFFLENBQUM7WUFDaEUsR0FBRyxHQUFHLElBQUEsd0JBQWdCLEVBQUMsU0FBUyxHQUFFLHNDQUFzQyxDQUFDLENBQUM7UUFDOUUsQ0FBQzthQUNJLENBQUM7WUFDRixHQUFHLEdBQUcsSUFBQSx3QkFBZ0IsRUFBQyxTQUFTLEdBQUcsNEJBQTRCLENBQUMsQ0FBQztRQUNyRSxDQUFDO1FBRUQsR0FBRyxHQUFHLElBQUEsK0JBQXVCLEVBQ3pCLEdBQUcsRUFDSCw2QkFBNkIsRUFDN0IsV0FBVyxFQUNYLElBQUksQ0FBQyxhQUFhLENBQUMsa0JBQW1CLENBQ3JDLENBQUM7UUFFTixNQUFNLFFB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UyxFQUFFLGVBQWU7YUFDN0IsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFDLENBQUM7Z0JBQ1gsbUJBQW1CLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUUsQ0FBQyxDQUFDO1lBQ3pFLENBQUM7WUFDRCxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNuRCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sb0JBQW9CLENBQUM7SUFDaEMsQ0FBQztDQUNKLENBQUE7QUF4RlksNEJBQVE7QUFTakI7SUFEQyxJQUFBLGtCQUFVLEVBQUMseUJBQWtCLENBQUMsSUFBSSxDQUFDO3NDQXlEbkM7bUJBakVRLFFBQVE7SUFEcEIsbUJBQVc7R0FDQyxRQUFRLENBd0ZwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENsdXN0ZXJBZGRPbiwgQ2x1c3RlckluZm8sIFZhbHVlcyB9IGZyb20gXCIuLi8uLi9zcGlcIjtcbmltcG9ydCB7IGRlcGVuZGFibGUsIGxvYWRZYW1sLCByZWFkWWFtbERvY3VtZW50LCBjaGFuZ2VUZXh0QmV0d2VlblRva2Vucywgc3VwcG9ydHNBTEwgfSBmcm9tIFwiLi4vLi4vdXRpbHNcIjtcbmltcG9ydCB7IEFkb3RDb2xsZWN0b3JBZGRPbiB9IGZyb20gXCIuLi9hZG90XCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IEt1YmVjdGxQcm92aWRlciwgTWFuaWZlc3REZXBsb3ltZW50IH0gZnJvbSBcIi4uL2hlbG0tYWRkb24va3ViZWN0bC1wcm92aWRlclwiO1xuaW1wb3J0IHsgQ2ZuUnVsZUdyb3Vwc05hbWVzcGFjZSB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXBzXCI7XG5pbXBvcnQgeyBJQ2x1c3RlciB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWtzXCI7XG5cbi8qKlxuICogVGhpcyBBTVAgYWRkLW9uIGluc3RhbGxzIGFuIEFET1QgQ29sbGVjdG9yIGZvciBBbWF6b24gTWFuYWdlZCBTZXJ2aWNlIGZvciBQcm9tZXRoZXVzIFxuICogKEFNUCkgYW5kIGNyZWF0ZXMgYW4gQU1QIHdvcnBzYWNlIHRvIHJlY2VpdmUgT1RMUCBtZXRyaWNzIGZyb20gdGhlIGFwcGxpY2F0aW9uIGFuZCBcbiAqIFByb21ldGhldXMgbWV0cmljcyBzY3JhcGVkIGZyb20gcG9kcyBvbiB0aGUgY2x1c3RlciBhbmQgcmVtb3RlIHdyaXRlcyB0aGUgbWV0cmljcyBcbiAqIHRvIEFNUCByZW1vdGUgd3JpdGUgZW5kcG9pbnQgb2YgdGhlIGNyZWF0ZWQgb3IgcGFzc2VkIEFNUCB3b3Jrc3BhY2UuXG4gKi9cblxuZXhwb3J0IGludGVyZmFjZSBBbXBSdWxlcyB7XG4gICAgLyoqIFxuICAgICAqIEFNUCB3b3Jrc3BhY2UgQVJOLlxuICAgICAqL1xuICAgIGFtcFdvcmtzcGFjZUFybjogc3RyaW5nO1xuXG4gICAgLyoqIFxuICAgICAqIFBhdGhzIG9mIHRoZSBmaWxlcyBsaXN0aW5nIHRoZSBBTVAgcnVsZXMuXG4gICAgICovXG4gICAgcnVsZUZpbGVQYXRoczogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT3BlblRlbGVtZXRyeUNvbGxlY3RvciB7XG4gICAgIC8qKlxuICAgICAqIEFuIGFsdGVybmF0aXZlIE9wZW5UZWxlbWV0cnlDb2xsZWN0b3IgaWYgeW91IG5lZWQgZnVydGhlciBjdXNvbWlzYXRpb24uXG4gICAgICogSWYgbm90IHByb3ZpZGVkLCB0aGUgZGVmYXVsdCB3aWxsIGJlIHVzZWQuXG4gICAgICovXG4gICAgIG1hbmlmZXN0UGF0aDogc3RyaW5nO1xuICAgICAvKipcbiAgICAgKiBUaGlzIHBhcmFtZXRlciBpcyBvcHRpb25hbCBhbmQgaG9sZHMgYW4gb2JqZWN0IG9mIHR5cGUgVmFsdWVzLCB3aXRoIGtleXMgYW5kIHZhbHVlcy5cbiAgICAgKiBUaGUgc2FtZSBrZXkgbGl0ZXJhbHMgd2lsbCBuZWVkIHRvIGJlIHVzZWQgd2l0aGluIHRoZSBtYW5pZmVzdCBiZXR3ZWVuIGRvdWJsZSBjdXJseSBicmFjZXMge3t9fSBhbmQgdGhlIGFkZC1vbiB3aWxsIHJlcGxhY2UgdGhlbSB3aXRoIHRoZSByZWxhdGVkIHZhbHVlcy5cbiAgICAgKiBUaGUgZm9sbG93aW5nIGtleXMgYXJlIGFscmVhZHkgaW4gdXNlIGJ5IHRoZSBhZGQtb24gYW5kIHdpbGwgYmUgcmVwbGFjZWQgaW4geW91ciBtYW5pZmVzdCB3aXRoIGNvbmZpZ3VyZWQgdmFsdWVzLCBpZiB5b3Ugd2FudCB0byB1c2UgdGhlbTpcbiAgICAgKiByZW1vdGVXcml0ZUVuZHBvaW50LCBhd3NSZWdpb24sIGRlcGxveW1lbnRNb2RlLCBuYW1lc3BhY2UsIGNsdXN0ZXJOYW1lLiBUbyB1c2UgYW55IG9mIHRob3NlIHlvdSBjYW4ganVzdCBpbmNsdWRlIGUuZy4ge3tyZW1vdGVXcml0ZUVuZHBvaW50fX0gaW5zaWRlIHRoZSBtYW5pZmVzdC5cbiAgICAgKi9cbiAgICAgbWFuaWZlc3RQYXJhbWV0ZXJNYXA/OiBWYWx1ZXM7XG59XG5cbi8qKlxuICogQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciBhZGQtb24uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQW1wQWRkT25Qcm9wcyB7XG4gICAgLyoqIFxuICAgICAqIFJlbW90ZSBXcml0ZSBVUkwgb2YgdGhlIEFNUCBXb3Jrc3BhY2UgdG8gYmUgdXNlZCBmb3Igc2V0dGluZyB1cCByZW1vdGUgd3JpdGUuXG4gICAgICogIEZvcm1hdCA6IGh0dHBzOi8vYXBzLXdvcmtzcGFjZXMuPHJlZ2lvbj4uYW1hem9uYXdzLmNvbS93b3Jrc3BhY2VzLzx3cy13b3Jrc3BhY2VpZD4vXCIsXG4gICAgICovXG4gICAgYW1wUHJvbWV0aGV1c0VuZHBvaW50OiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogTW9kZXMgc3VwcG9ydGVkIDogYGRlcGxveW1lbnRgLCBgZGFlbW9uc2V0YCwgYHN0YXRlZnVsU2V0YCwgYW5kIGBzaWRlY2FyYFxuICAgICAqIEBkZWZhdWx0IGRlcGxveW1lbnRcbiAgICAgKi9cbiAgICBkZXBsb3ltZW50TW9kZT86IERlcGxveW1lbnRNb2RlO1xuICAgIC8qKlxuICAgICAqIE5hbWVzcGFjZSB0byBkZXBsb3kgdGhlIEFET1QgQ29sbGVjdG9yIGZvciBBTVAuXG4gICAgICogQGRlZmF1bHQgZGVmYXVsdFxuICAgICAqL1xuICAgIG5hbWVzcGFjZT86IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBOYW1lIGZvciBkZXBsb3ltZW50IG9mIHRoZSBBRE9UIENvbGxlY3RvciBmb3IgQU1QLlxuICAgICAqIEBkZWZhdWx0ICdhZG90LWNvbGxlY3Rvci1hbXAnXG4gICAgICovXG4gICAgbmFtZT86IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBFbmFibGUgXCJhcGlzZXJ2ZXJcIiBqb2IgaW4gdGhlIFByb21ldGhldXMgY29uZmlndXJhdGlvbiBvZiB0aGUgZGVmYXVsdCBPcGVuVGVsZW1ldHJ5Q29sbGVjdG9yLlxuICAgICAqIEBkZWZhdWx0IGZhbHNlXG4gICAgICovXG4gICAgZW5hYmxlQVBJU2VydmVySm9iPzogYm9vbGVhbjtcbiAgICAvKiogXG4gICAgICogQU1QIHJ1bGVzIHByb3ZpZGluZyBBTVAgd29ya3NwYWNlIEFSTiBhbmQgcGF0aHMgdG8gZmlsZXMgZW5jb2RpbmcgcmVjb3JkaW5nIGFuZC9vciBhbGVydGluZyBydWxlcyBmb2xsb3dpbmcgdGhlIHNhbWUgZm9ybWF0IGFzIGEgcnVsZXMgZmlsZSBpbiBzdGFuZGFsb25lIFByb21ldGhldXMuXG4gICAgICogVGhpcyBwYXJhbWV0ZXIgaXMgb3B0aW9uYWwgYW5kIGlmIG5vdCBwcm92aWRlZCwgbm8gcnVsZXMgd2lsbCBiZSBhcHBsaWVkLlxuICAgICAqL1xuICAgIGFtcFJ1bGVzPzogQW1wUnVsZXM7XG4gICAgIC8qKlxuICAgICAqIEFuIGFsdGVybmF0aXZlIE9wZW5UZWxlbWV0cnlDb2xsZWN0b3IgaWYgeW91IG5lZWQgZnVydGhlciBjdXN0b21pc2F0aW9uLlxuICAgICAqIElmIHlvdSBuZWVkIHRvIGNvbmZpZ3VyZSBydWxlcywgcGxlYXNlIGRvIG5vdCB1c2UgdGhlIHJ1bGVfZmlsZXMgZmllbGQgbGlrZSBpbiBzdGFuZGFsb25lIFByb21ldGhldXMsIGJ1dCByYXRoZXIgdXNlIHRoZSBhbXBSdWxlcyBwYXJhbWV0ZXIuXG4gICAgICogSWYgbm90IHByb3ZpZGVkLCB0aGUgZGVmYXVsdCB3aWxsIGJlIHVzZWQuXG4gICAgICovXG4gICAgb3BlblRlbGVtZXRyeUNvbGxlY3Rvcj86IE9wZW5UZWxlbWV0cnlDb2xsZWN0b3I7XG5cbiAgICAvKipcbiAgICAgKiBNZW1vcnkgbGltaXQgZm9yIHRoZSBBRE9UIENvbGxlY3RvciBmb3IgQU1QLlxuICAgICAqIEBkZWZhdWx0IDJHaVxuICAgICAqL1xuICAgIG1lbW9yeUxpbWl0PzogYW55O1xuXG4gICAgLyoqXG4gICAgICogQ1BVIGxpbWl0IGZvciB0aGUgQURPVCBDb2xsZWN0b3IgZm9yIEFNUC5cbiAgICAgKiBAZGVmYXVsdCAxXG4gICAgICovXG4gICAgY3B1TGltaXQ/OiBhbnk7XG59XG5cbmV4cG9ydCBjb25zdCBlbnVtIERlcGxveW1lbnRNb2RlIHtcbiAgICBERVBMT1lNRU5UID0gJ2RlcGxveW1lbnQnLFxuICAgIERBRU1PTlNFVCA9ICdkYWVtb25zZXQnLFxuICAgIFNUQVRFRlVMU0VUID0gJ3N0YXRlZnVsc2V0JyxcbiAgICBTSURFQ0FSID0gJ3NpZGVjYXInXG59XG5cbi8qKlxuICogRGVmYXVsdHMgb3B0aW9ucyBmb3IgdGhlIGFkZC1vblxuICovXG5jb25zdCBkZWZhdWx0UHJvcHMgPSB7XG4gICAgZGVwbG95bWVudE1vZGU6IERlcGxveW1lbnRNb2RlLkRFUExPWU1FTlQsXG4gICAgbmFtZTogJ2Fkb3QtY29sbGVjdG9yLWFtcCcsXG4gICAgbmFtZXNwYWNlOiAnZGVmYXVsdCcsXG4gICAgZW5hYmxlQVBJc2VydmVySm9iOiBmYWxzZSxcbiAgICBtZW1vcnlMaW1pdDogJzJHaScsXG4gICAgY3B1TGltaXQ6ICcxJ1xufTtcblxuLyoqXG4gKiBJbXBsZW1lbnRhdGlvbiBvZiBBTVAgYWRkLW9uIGZvciBFS1MgQmx1ZXByaW50cy4gSW5zdGFsbHMgQURPVCBDb2xsZWN0b3IuXG4gKi9cbkBzdXBwb3J0c0FMTFxuZXhwb3J0IGNsYXNzIEFtcEFkZE9uIGltcGxlbWVudHMgQ2x1c3RlckFkZE9uIHtcblxuICAgIHJlYWRvbmx5IGFtcEFkZE9uUHJvcHM6IEFtcEFkZE9uUHJvcHM7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogQW1wQWRkT25Qcm9wcykge1xuICAgICAgICB0aGlzLmFtcEFkZE9uUHJvcHMgPSB7IC4uLmRlZmF1bHRQcm9wcywgLi4ucHJvcHMgfTtcbiAgICB9XG5cbiAgICBAZGVwZW5kYWJsZShBZG90Q29sbGVjdG9yQWRkT24ubmFtZSlcbiAgICBkZXBsb3koY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHtcbiAgICAgICAgY29uc3QgY2x1c3RlciA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXI7XG4gICAgICAgIGxldCBkb2M6IHN0cmluZztcblxuICAgICAgICAvLyBBcHBseWluZyBtYW5pZmVzdCBmb3IgY29uZmlndXJpbmcgQURPVCBDb2xsZWN0b3IgZm9yIEFtcC5cbiAgICAgICAgaWYgKHRoaXMuYW1wQWRkT25Qcm9wcy5kZXBsb3ltZW50TW9kZSA9PSBEZXBsb3ltZW50TW9kZS5EQUVNT05TRVQpIHtcbiAgICAgICAgICAgIGRvYyA9IHJlYWRZYW1sRG9jdW1lbnQoX19kaXJuYW1lICsnL2NvbGxlY3Rvci1jb25maWctYW1wLWRhZW1vbnNldC55dHBsJyk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBkb2MgPSByZWFkWWFtbERvY3VtZW50KF9fZGlybmFtZSArICcvY29sbGVjdG9yLWNvbmZpZy1hbXAueXRwbCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgZG9jID0gY2hhbmdlVGV4dEJldHdlZW5Ub2tlbnMoXG4gICAgICAgICAgICBkb2MsXG4gICAgICAgICAgICBcInt7IGlmIGVuYWJsZUFQSXNlcnZlckpvYiB9fVwiLFxuICAgICAgICAgICAgXCJ7eyBlbmQgfX1cIixcbiAgICAgICAgICAgIHRoaXMuYW1wQWRkT25Qcm9wcy5lbmFibGVBUElTZXJ2ZXJKb2IhXG4gICAgICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IG1hbmlmZXN0ID0gZG9jLnNwbGl0KFwiLS0tXCIpLm1hcChlID0+IHtcbiAgICAgICAgICAgIGxldCBvYmplY3QgPSBsb2FkWWFtbChlKTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuYW1wQWRkT25Qcm9wcy5vcGVuVGVsZW1ldHJ5Q29sbGVjdG9yPy5tYW5pZmVzdFBhdGggIT09IHVuZGVmaW5lZCAmJiBvYmplY3Qua2luZCA9PT0gXCJPcGVuVGVsZW1ldHJ5Q29sbGVjdG9yXCIpe1xuICAgICAgICAgICAgICAgIG9iamVjdCA9IHJlYWRZYW1sRG9jdW1lbnQodGhpcy5hbXBBZGRPblByb3BzLm9wZW5UZWxlbWV0cnlDb2xsZWN0b3IubWFuaWZlc3RQYXRoISk7XG4gICAgICAgICAgICAgICAgb2JqZWN0ID0gbG9hZFlhbWwob2JqZWN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBvYmplY3Q7XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBhdHRyUHJvbWV0aGV1c0VuZHBvaW50ID0gdGhpcy5hbXBBZGRPblByb3BzLmFtcFByb21ldGhldXNFbmRwb2ludCArICdhcGkvdjEvcmVtb3RlX3dyaXRlJztcbiAgICAgICAgY29uc3QgdmFsdWVzOiBWYWx1ZXMgPSB7XG4gICAgICAgICAgICByZW1vdGVXcml0ZUVuZHBvaW50OiBhdHRyUHJvbWV0aGV1c0VuZHBvaW50LFxuICAgICAgICAgICAgYXdzUmVnaW9uOiBjbHVzdGVyLnN0YWNrLnJlZ2lvbixcbiAgICAgICAgICAgIGRlcGxveW1lbnRNb2RlOiB0aGlzLmFtcEFkZE9uUHJvcHMuZGVwbG95bWVudE1vZGUsXG4gICAgICAgICAgICBjcHVMaW1pdDogdGhpcy5hbXBBZGRPblByb3BzLmNwdUxpbWl0LFxuICAgICAgICAgICAgbWVtb3J5TGltaXQ6IHRoaXMuYW1wQWRkT25Qcm9wcy5tZW1vcnlMaW1pdCxcbiAgICAgICAgICAgIG5hbWVzcGFjZTogdGhpcy5hbXBBZGRPblByb3BzLm5hbWVzcGFjZSxcbiAgICAgICAgICAgIGNsdXN0ZXJOYW1lOiBjbHVzdGVyLmNsdXN0ZXJOYW1lLFxuICAgICAgICAgICAgLi4udGhpcy5hbXBBZGRPblByb3BzLm9wZW5UZWxlbWV0cnlDb2xsZWN0b3I/Lm1hbmlmZXN0UGFyYW1ldGVyTWFwXG4gICAgICAgICB9O1xuICAgICAgICAgXG4gICAgICAgICBjb25zdCBtYW5pZmVzdERlcGxveW1lbnQ6IE1hbmlmZXN0RGVwbG95bWVudCA9IHtcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuYW1wQWRkT25Qcm9wcy5uYW1lISxcbiAgICAgICAgICAgIG5hbWVzcGFjZTogdGhpcy5hbXBBZGRPblByb3BzLm5hbWVzcGFjZSEsXG4gICAgICAgICAgICBtYW5pZmVzdCxcbiAgICAgICAgICAgIHZhbHVlc1xuICAgICAgICB9O1xuICAgICAgICBjb25zdCBrdWJlY3RsUHJvdmlkZXIgPSBuZXcgS3ViZWN0bFByb3ZpZGVyKGNsdXN0ZXJJbmZvKTtcbiAgICAgICAgY29uc3Qgc3RhdGVtZW50ID0ga3ViZWN0bFByb3ZpZGVyLmFkZE1hbmlmZXN0KG1hbmlmZXN0RGVwbG95bWVudCk7XG5cbiAgICAgICAgY29uc3QgYW1wUnVsZXMgPSB0aGlzLmFtcEFkZE9uUHJvcHMuYW1wUnVsZXM7XG4gICAgICAgIGlmIChhbXBSdWxlcyAhPT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICAgIGNvbnN0IHJ1bGVHcm91cHNOYW1lc3BhY2VzID0gdGhpcy5jb25maWd1cmVSdWxlcyhjbHVzdGVyLCBhbXBSdWxlcy5ydWxlRmlsZVBhdGhzLCBhbXBSdWxlcy5hbXBXb3Jrc3BhY2VBcm4pO1xuICAgICAgICAgICAgc3RhdGVtZW50Lm5vZGUuYWRkRGVwZW5kZW5jeShydWxlR3JvdXBzTmFtZXNwYWNlcy5hdCgtMSkhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoc3RhdGVtZW50KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbmZpZ3VyZVJ1bGVzKGNsdXN0ZXI6IElDbHVzdGVyLCBydWxlRmlsZVBhdGhzOiBzdHJpbmdbXSwgYW1wV29ya3NwYWNlQXJuOiBzdHJpbmcpOiBDZm5SdWxlR3JvdXBzTmFtZXNwYWNlW10ge1xuICAgICAgICBjb25zdCBydWxlR3JvdXBzTmFtZXNwYWNlczogQ2ZuUnVsZUdyb3Vwc05hbWVzcGFjZVtdID0gW107XG5cbiAgICAgICAgaWYgKHJ1bGVGaWxlUGF0aHMubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIHBhdGhzIGRlZmluZWQgZm9yIEFNUCBydWxlc1wiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJ1bGVGaWxlUGF0aHMubWFwKChydWxlRmlsZVBhdGgsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBydWxlR3JvdXBzTmFtZXNwYWNlID0gbmV3IENmblJ1bGVHcm91cHNOYW1lc3BhY2UoY2x1c3RlciwgXCJBbXBSdWxlc0NvbmZpZ3VyYXRvci1cIiArIGluZGV4LCB7XG4gICAgICAgICAgICAgICAgZGF0YTogcmVhZFlhbWxEb2N1bWVudChydWxlRmlsZVBhdGgpLFxuICAgICAgICAgICAgICAgIG5hbWU6IFwiQW1wUnVsZXNDb25maWd1cmF0b3ItXCIgKyBpbmRleCxcbiAgICAgICAgICAgICAgICB3b3Jrc3BhY2U6IGFtcFdvcmtzcGFjZUFyblxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoaW5kZXggPiAwKXtcbiAgICAgICAgICAgICAgICBydWxlR3JvdXBzTmFtZXNwYWNlLm5vZGUuYWRkRGVwZW5kZW5jeShydWxlR3JvdXBzTmFtZXNwYWNlcy5hdCgtMSkhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJ1bGVHcm91cHNOYW1lc3BhY2VzLnB1c2gocnVsZUdyb3Vwc05hbWVzcGFjZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBydWxlR3JvdXBzTmFtZXNwYWNlcztcbiAgICB9XG59XG4iXX0=