"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApacheAirflowAddOn = void 0;
const assert = require("assert");
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const index_1 = require("../helm-addon/index");
const aws_loadbalancer_controller_1 = require("../aws-loadbalancer-controller");
const efs_csi_driver_1 = require("../efs-csi-driver");
const utils_1 = require("../../utils");
const ts_deepmerge_1 = require("ts-deepmerge");
const AIRFLOW = 'airflow';
const RELEASE = 'blueprints-addon-apache-airflow';
const AIRFLOWSC = 'apache-airflow-sc';
const AIRFLOWPVC = 'efs-apache-airflow-pvc';
/**
 * Default props to be used when creating the Helm chart
 */
const defaultProps = {
    name: AIRFLOW,
    namespace: AIRFLOW,
    chart: AIRFLOW,
    version: "1.16.0",
    release: RELEASE,
    repository: "https://airflow.apache.org",
    enableAlb: false,
    enableEfs: false,
    enableLogging: false,
    values: {}
};
/**
 * This add-on is currently not supported. It will apply the latest falco helm chart but the latest AMI does not have stock driver supported and
 * driver build in the init fails atm.
 */
let ApacheAirflowAddOn = class ApacheAirflowAddOn extends index_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a;
        const cluster = clusterInfo.cluster;
        const albAddOnCheck = clusterInfo.getScheduledAddOn(aws_loadbalancer_controller_1.AwsLoadBalancerControllerAddOn.name);
        const enableAlb = this.options.enableAlb;
        const cert = this.options.certificateResourceName;
        const loggingIsEnabled = this.options.enableLogging;
        const loggingBucketResourceName = this.options.s3Bucket;
        const efsIsEnabled = this.options.enableEfs;
        const efsResourceName = this.options.efsFileSystem;
        const namespace = this.options.namespace;
        // Create Namespace
        const ns = (0, utils_1.createNamespace)(namespace, cluster, true, true);
        // Setting basic custom values for Kubernetes
        let values = {
            config: {
                "kubernetes": {
                    "namespace": this.options.namespace
                },
                "kubernetes_executor": {
                    "namespace": this.options.namespace
                }
            },
            "securityContext": {
                "fsGroup": 66534
            },
            "executor": "KubernetesExecutor"
        };
        // If Load Balancing is enabled
        if (enableAlb) {
            values = setUpLoadBalancer(clusterInfo, values, albAddOnCheck, cert);
        }
        else {
            assert(!cert, 'Cert option is supported only if ALB is enabled.');
        }
        // If Logging with S3 is enabled
        if (loggingIsEnabled) {
            const bucket = clusterInfo.getRequiredResource(loggingBucketResourceName);
            values = setUpLogging(clusterInfo, values, ns, namespace, bucket);
        }
        // If EFS is enabled for persistent storage
        let pvcResource;
        if (efsIsEnabled) {
            [values, pvcResource] = setUpEFS(clusterInfo, values, ns, namespace, efsResourceName);
        }
        // Merge values with user-provided one
        values = (0, ts_deepmerge_1.merge)(values, (_a = this.props.values) !== null && _a !== void 0 ? _a : {});
        // Apply Helm Chart
        const chart = this.addHelmChart(clusterInfo, values, false, false);
        // Add PVC dependency to the Chart in case of EFS generating the resource
        if (efsIsEnabled) {
            chart.node.addDependency(pvcResource);
        }
        return Promise.resolve(chart);
    }
};
exports.ApacheAirflowAddOn = ApacheAirflowAddOn;
exports.ApacheAirflowAddOn = ApacheAirflowAddOn = __decorate([
    utils_1.supportsX86
], ApacheAirflowAddOn);
/**
 * Helper function to set up Load Balancer
 */
function setUpLoadBalancer(clusterInfo, values, albAddOnCheck, cert) {
    // Check to ensure AWS Load Balancer Controller AddOn is provided in the list of Addons
    assert(albAddOnCheck, `Missing a dependency: ${aws_loadbalancer_controller_1.AwsLoadBalancerControllerAddOn.name}. Please add it to your list of addons.`);
    const presetAnnotations = {
        'alb.ingress.kubernetes.io/group.name': 'airflow',
        'alb.ingress.kubernetes.io/scheme': 'internet-facing',
        'alb.ingress.kubernetes.io/target-type': 'ip',
        'alb.ingress.kubernetes.io/listen-ports': '[{"HTTP": 80}]',
        'alb.ingress.kubernetes.io/healthcheck-path': '/health',
    };
    // Set helm custom value for certificates, if provided
    if (cert) {
        presetAnnotations['alb.ingress.kubernetes.io/listen-ports'] = '[{"HTTP": 80},{"HTTPS":443}]';
        const certificate = clusterInfo.getResource(cert);
        presetAnnotations['alb.ingress.kubernetes.io/certificate-arn'] = certificate === null || certificate === void 0 ? void 0 : certificate.certificateArn;
    }
    (0, utils_1.setPath)(values, "ingress.web", {
        "enabled": "true",
        "annotations": presetAnnotations,
        "pathType": "Prefix",
        "ingressClassName": "alb",
    });
    // Configuring Ingress for Airflow Web Ui hence the service type is changed to NodePort
    (0, utils_1.setPath)(values, "webserver.service", {
        type: "NodePort",
        ports: [{
                name: "airflow-ui",
                port: "{{ .Values.ports.airflowUI }}"
            }]
    });
    return values;
}
/**
 * Helper function to set up Logging with S3 Bucket
*/
function setUpLogging(clusterInfo, values, ns, namespace, bucket) {
    // Assert check to ensure you provide an S3 Bucket
    assert(bucket, "Please provide the name of S3 bucket for Logging.");
    // IRSA Policy
    const AirflowLoggingPolicy = {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                    "s3:ListBucket"
                ],
                "Resource": [`arn:aws:s3:::${bucket.bucketName}`]
            },
            {
                "Effect": "Allow",
                "Action": [
                    "s3:GetObject",
                    "s3:PutObject"
                ],
                "Resource": [`arn:aws:s3:::${bucket.bucketName}/*`]
            }
        ]
    };
    // Set up IRSA
    const airflowLoggingPolicyDocument = aws_iam_1.PolicyDocument.fromJson(AirflowLoggingPolicy);
    const sa = (0, utils_1.createServiceAccount)(clusterInfo.cluster, 'airflow-s3-logging-sa', namespace, airflowLoggingPolicyDocument);
    sa.node.addDependency(ns);
    // Helm custom value set up for S3 logging set up
    (0, utils_1.setPath)(values, "config.core.colored_console_log", 'True');
    (0, utils_1.setPath)(values, "config.core.remote_logging", 'True');
    (0, utils_1.setPath)(values, "config.logging", {
        "remote_logging": 'True',
        "logging_level": 'INFO',
        "colored_console_log": 'True',
        "remote_base_log_folder": `s3://${bucket.bucketName}/airflow-logs`,
        // aws_s3_conn is the name of the connection that needs to be created using Airflow admin UI once the deployment is complete
        // Steps can be seen in the docs link here -> https://github.com/apache/airflow/issues/25322
        "remote_log_conn_id": 'aws_s3_conn',
        "delete_worker_pods": 'False',
        "encrypt_s3_logs": 'True'
    });
    // Set Webserver SA so that server logs can be shipped to S3
    (0, utils_1.setPath)(values, "webserver.serviceAccount", {
        create: false,
        name: `${sa.serviceAccountName}`
    });
    // Set Worker SA so that worker logs can be shipped to S3
    (0, utils_1.setPath)(values, "workers.serviceAccount", {
        create: false,
        name: `${sa.serviceAccountName}`
    });
    // Set Scheduler SA so that scheduler logs can be shipped to S3
    (0, utils_1.setPath)(values, "scheduler.serviceAccount", {
        create: false,
        name: `${sa.serviceAccountName}`
    });
    return values;
}
/**
 *
 */
function setUpEFS(clusterInfo, values, ns, namespace, efsResourceName) {
    // Check 
    const efsAddOnCheck = clusterInfo.getScheduledAddOn(efs_csi_driver_1.EfsCsiDriverAddOn.name);
    assert(efsAddOnCheck, `Missing a dependency: ${efs_csi_driver_1.EfsCsiDriverAddOn.name}. Please add it to your list of addons.`);
    const efs = clusterInfo.getRequiredResource(efsResourceName);
    assert(efs, "Please provide the name of EFS File System.");
    // Need to create a storage class and pvc for the EFS
    const scResource = new aws_eks_1.KubernetesManifest(clusterInfo.cluster, 'apache-airflow-efs-sc', {
        cluster: clusterInfo.cluster,
        manifest: [{
                apiVersion: "storage.k8s.io/v1",
                kind: "StorageClass",
                metadata: { name: AIRFLOWSC },
                provisioner: "efs.csi.aws.com",
                parameters: {
                    provisioningMode: "efs-ap",
                    fileSystemId: `${efs.fileSystemId}`,
                    directoryPerms: "700",
                    gidRangeStart: "1000",
                    gidRangeEnd: "2000",
                }
            }], overwrite: true,
    });
    const pvcResource = new aws_eks_1.KubernetesManifest(clusterInfo.cluster, 'apache-airflow-efs-pvc', {
        cluster: clusterInfo.cluster,
        manifest: [{
                apiVersion: "v1",
                kind: "PersistentVolumeClaim",
                metadata: {
                    name: AIRFLOWPVC,
                    namespace: `${namespace}`
                },
                spec: {
                    accessModes: ["ReadWriteMany"],
                    storageClassName: AIRFLOWSC,
                    resources: {
                        requests: {
                            storage: '10Gi'
                        }
                    }
                }
            }], overwrite: true,
    });
    // SC depends on the EFS addon
    if (efsAddOnCheck) {
        efsAddOnCheck.then(construct => scResource.node.addDependency(construct));
    }
    // PVC depends on SC and NS
    pvcResource.node.addDependency(scResource);
    pvcResource.node.addDependency(ns);
    // Set helm custom values for persistent storage of DAGs
    (0, utils_1.setPath)(values, "dags.persistence", {
        enabled: true,
        size: "10Gi",
        storageClassName: AIRFLOWSC,
        accessMode: "ReadWriteMany",
        existingClaim: AIRFLOWPVC
    });
    return [values, pvcResource];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2FwYWNoZS1haXJmbG93L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUNBLGlDQUFpQztBQUlqQyxpREFBeUQ7QUFDekQsaURBQXFEO0FBR3JELCtDQUFnRDtBQUNoRCxnRkFBZ0Y7QUFDaEYsc0RBQXNEO0FBSXRELHVDQUEwRjtBQUcxRiwrQ0FBcUM7QUE4Q3JDLE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQztBQUMxQixNQUFNLE9BQU8sR0FBRyxpQ0FBaUMsQ0FBQztBQUNsRCxNQUFNLFNBQVMsR0FBRyxtQkFBbUIsQ0FBQztBQUN0QyxNQUFNLFVBQVUsR0FBRyx3QkFBd0IsQ0FBQztBQUU1Qzs7R0FFRztBQUNGLE1BQU0sWUFBWSxHQUFzQjtJQUNyQyxJQUFJLEVBQUUsT0FBTztJQUNiLFNBQVMsRUFBRSxPQUFPO0lBQ2xCLEtBQUssRUFBRSxPQUFPO0lBQ2QsT0FBTyxFQUFFLFFBQVE7SUFDakIsT0FBTyxFQUFFLE9BQU87SUFDaEIsVUFBVSxFQUFHLDRCQUE0QjtJQUN6QyxTQUFTLEVBQUUsS0FBSztJQUNoQixTQUFTLEVBQUUsS0FBSztJQUNoQixhQUFhLEVBQUUsS0FBSztJQUNwQixNQUFNLEVBQUUsRUFBRTtDQUNiLENBQUM7QUFFRjs7O0dBR0c7QUFFSSxJQUFNLGtCQUFrQixHQUF4QixNQUFNLGtCQUFtQixTQUFRLGlCQUFTO0lBSTdDLFlBQVksS0FBeUI7UUFDakMsS0FBSyxDQUFDLEVBQUMsR0FBRyxZQUFvQixFQUFFLEdBQUcsS0FBSyxFQUFDLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUEwQixDQUFDO0lBQ25ELENBQUM7SUFFRCxNQUFNLENBQUMsV0FBd0I7O1FBQzNCLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDcEMsTUFBTSxhQUFhLEdB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QyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFFRCwyQkFBMkI7SUFDM0IsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDM0MsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFbkMsd0RBQXdEO0lBQ3hELElBQUEsZUFBTyxFQUFDLE1BQU0sRUFBRSxrQkFBa0IsRUFBRTtRQUNoQyxPQUFPLEVBQUUsSUFBSTtRQUNiLElBQUksRUFBRSxNQUFNO1FBQ1osZ0JBQWdCLEVBQUUsU0FBUztRQUMzQixVQUFVLEVBQUUsZUFBZTtRQUMzQixhQUFhLEVBQUUsVUFBVTtLQUM1QixDQUFDLENBQUM7SUFFSCxPQUFPLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQ2pDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgYXNzZXJ0IGZyb20gXCJhc3NlcnRcIjtcblxuaW1wb3J0IHsgSUNlcnRpZmljYXRlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWNlcnRpZmljYXRlbWFuYWdlcic7XG5pbXBvcnQgeyBJQnVja2V0IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXMzJztcbmltcG9ydCB7IEt1YmVybmV0ZXNNYW5pZmVzdCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1la3MnO1xuaW1wb3J0IHsgUG9saWN5RG9jdW1lbnQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcblxuaW1wb3J0IHsgSGVsbUFkZE9uVXNlclByb3BzIH0gZnJvbSBcIi4uL2hlbG0tYWRkb25cIjtcbmltcG9ydCB7IEhlbG1BZGRPbiB9IGZyb20gJy4uL2hlbG0tYWRkb24vaW5kZXgnO1xuaW1wb3J0IHsgQXdzTG9hZEJhbGFuY2VyQ29udHJvbGxlckFkZE9uIH0gZnJvbSBcIi4uL2F3cy1sb2FkYmFsYW5jZXItY29udHJvbGxlclwiO1xuaW1wb3J0IHsgRWZzQ3NpRHJpdmVyQWRkT24gfSBmcm9tIFwiLi4vZWZzLWNzaS1kcml2ZXJcIjtcblxuaW1wb3J0IHsgQ2x1c3RlckluZm8gfSBmcm9tICcuLi8uLi9zcGkvdHlwZXMnO1xuaW1wb3J0IHsgVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgc2V0UGF0aCwgY3JlYXRlTmFtZXNwYWNlLCBjcmVhdGVTZXJ2aWNlQWNjb3VudCwgc3VwcG9ydHNYODYgfSBmcm9tIFwiLi4vLi4vdXRpbHNcIjtcbmltcG9ydCB7IElGaWxlU3lzdGVtIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1lZnNcIjtcblxuaW1wb3J0IHsgbWVyZ2UgfSBmcm9tIFwidHMtZGVlcG1lcmdlXCI7XG5cbi8qKlxuICogVXNlciBwcm92aWRlZCBvcHRpb25zIGZvciB0aGUgSGVsbSBDaGFydFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEFpcmZsb3dBZGRPblByb3BzIGV4dGVuZHMgSGVsbUFkZE9uVXNlclByb3BzIHtcbiAgICAvKipcbiAgICAgKiBOYW1lc3BhY2VcbiAgICAgKi9cbiAgICBuYW1lc3BhY2U/OiBzdHJpbmcsXG4gICAgXG4gICAgLyoqXG4gICAgICogRW5hYmxlIExvYWQgQmFsYW5jZXIgZm9yIEluZ3Jlc3MgLSBkZWZhdWx0IGlzIGZhbHNlXG4gICAgICovXG4gICAgZW5hYmxlQWxiPzogYm9vbGVhbixcblxuICAgIC8qKlxuICAgICAqIE5hbWUgb2YgdGhlIHtAbGluayBjZXJ0aWZpY2F0ZVJlc291cmNlTmFtZX0gdG8gYmUgdXNlZCBmb3IgY2VydGlmaWNhdGUgbG9vayB1cC4gXG4gICAgICogQHNlZSB7QGxpbmsgSW1wb3J0Q2VydGlmaWNhdGVQcm92aWRlcn0gYW5kIHtAbGluayBDcmVhdGVDZXJ0aWZpY2F0ZVByb3ZpZGVyfSBmb3IgZXhhbXBsZXMgb2YgY2VydGlmaWNhdGUgcHJvdmlkZXJzLlxuICAgICAqL1xuICAgIGNlcnRpZmljYXRlUmVzb3VyY2VOYW1lPzogc3RyaW5nLFxuXG4gICAgLyoqXG4gICAgICogRW5hYmxlIExvZ2dpbmcgd2l0aCBTMyAgLSBkZWZhdWx0IGlzIGZhbHNlXG4gICAgICovXG4gICAgZW5hYmxlTG9nZ2luZz86IGJvb2xlYW4sXG5cbiAgICAvKipcbiAgICAgKiBOYW1lcyBvZiB0aGUgUzMgQnVja2V0IHByb3ZpZGVyIG5hbWVkIHJlc291cmNlcyAoQHNlZSBDcmVhdGVTM0J1Y2tldFByb3ZpZGVyLCBAc2VlIEltcG9ydFMzQnVja2V0UHJvdmlkZXIpLlxuICAgICAqIFMzIEJ1Y2tldCBwcm92aWRlciBpcyByZWdpc3RlcmVkIGFzIG5hbWVkIHJlc291cmNlIHByb3ZpZGVycyB3aXRoIHRoZSBFa3NCbHVlcHJpbnRQcm9wcy5cbiAgICAgKi9cbiAgICBzM0J1Y2tldD86IHN0cmluZyxcblxuICAgIC8qKlxuICAgICAqIEVuYWJsZSBFRlMgZm9yIHBlcnNpc3RlbnQgc3RvcmFnZSBvZiBEQUdzIC0gZGVmYXVsdCBpcyBmYWxzZVxuICAgICAqL1xuICAgIGVuYWJsZUVmcz86IGJvb2xlYW4sXG5cbiAgICAvKipcbiAgICAgKiBOYW1lcyBvZiB0aGUgRUZTIEZpbGUgU3lzdGVtIHByb3ZpZGVyIG5hbWVkIHJlc291cmNlcyAoQHNlZSBDcmVhdGVFZnNGaWxlU3lzdGVtUHJvdmlkZXIsIEBzZWUgTG9va3VwRWZzRmlsZVN5c3RlbVByb3ZpZGVyKS5cbiAgICAgKiBFRlMgRmlsZSBTeXN0ZW0gcHJvdmlkZXIgaXMgcmVnaXN0ZXJlZCBhcyBuYW1lZCByZXNvdXJjZSBwcm92aWRlcnMgd2l0aCB0aGUgRWtzQmx1ZXByaW50UHJvcHMuXG4gICAgICogVGhpcyBpcyByZXF1aXJlZCBpZiBFRlMgaXMgZW5hYmxlZFxuICAgICAqL1xuICAgIGVmc0ZpbGVTeXN0ZW0/OiBzdHJpbmcsXG59XG5cbmNvbnN0IEFJUkZMT1cgPSAnYWlyZmxvdyc7XG5jb25zdCBSRUxFQVNFID0gJ2JsdWVwcmludHMtYWRkb24tYXBhY2hlLWFpcmZsb3cnO1xuY29uc3QgQUlSRkxPV1NDID0gJ2FwYWNoZS1haXJmbG93LXNjJztcbmNvbnN0IEFJUkZMT1dQVkMgPSAnZWZzLWFwYWNoZS1haXJmbG93LXB2Yyc7XG5cbi8qKlxuICogRGVmYXVsdCBwcm9wcyB0byBiZSB1c2VkIHdoZW4gY3JlYXRpbmcgdGhlIEhlbG0gY2hhcnRcbiAqL1xuIGNvbnN0IGRlZmF1bHRQcm9wczogQWlyZmxvd0FkZE9uUHJvcHMgPSB7XG4gICAgbmFtZTogQUlSRkxPVyxcbiAgICBuYW1lc3BhY2U6IEFJUkZMT1csXG4gICAgY2hhcnQ6IEFJUkZMT1csXG4gICAgdmVyc2lvbjogXCIxLjE2LjBcIixcbiAgICByZWxlYXNlOiBSRUxFQVNFLFxuICAgIHJlcG9zaXRvcnk6ICBcImh0dHBzOi8vYWlyZmxvdy5hcGFjaGUub3JnXCIsXG4gICAgZW5hYmxlQWxiOiBmYWxzZSxcbiAgICBlbmFibGVFZnM6IGZhbHNlLFxuICAgIGVuYWJsZUxvZ2dpbmc6IGZhbHNlLFxuICAgIHZhbHVlczoge31cbn07XG5cbi8qKlxuICogVGhpcyBhZGQtb24gaXMgY3VycmVudGx5IG5vdCBzdXBwb3J0ZWQuIEl0IHdpbGwgYXBwbHkgdGhlIGxhdGVzdCBmYWxjbyBoZWxtIGNoYXJ0IGJ1dCB0aGUgbGF0ZXN0IEFNSSBkb2VzIG5vdCBoYXZlIHN0b2NrIGRyaXZlciBzdXBwb3J0ZWQgYW5kXG4gKiBkcml2ZXIgYnVpbGQgaW4gdGhlIGluaXQgZmFpbHMgYXRtLiBcbiAqL1xuQHN1cHBvcnRzWDg2XG5leHBvcnQgY2xhc3MgQXBhY2hlQWlyZmxvd0FkZE9uIGV4dGVuZHMgSGVsbUFkZE9uIHtcblxuICAgIHJlYWRvbmx5IG9wdGlvbnM6IEFpcmZsb3dBZGRPblByb3BzO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM/OiBBaXJmbG93QWRkT25Qcm9wcykge1xuICAgICAgICBzdXBlcih7Li4uZGVmYXVsdFByb3BzICBhcyBhbnksIC4uLnByb3BzfSk7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHRoaXMucHJvcHMgYXMgQWlyZmxvd0FkZE9uUHJvcHM7XG4gICAgfVxuICAgIFxuICAgIGRlcGxveShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiBQcm9taXNlPENvbnN0cnVjdD4ge1xuICAgICAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcbiAgICAgICAgY29uc3QgYWxiQWRkT25DaGVjayA9IGNsdXN0ZXJJbmZvLmdldFNjaGVkdWxlZEFkZE9uKEF3c0xvYWRCYWxhbmNlckNvbnRyb2xsZXJBZGRPbi5uYW1lKTtcbiAgICAgICAgY29uc3QgZW5hYmxlQWxiID0gdGhpcy5vcHRpb25zLmVuYWJsZUFsYjtcbiAgICAgICAgY29uc3QgY2VydCA9IHRoaXMub3B0aW9ucy5jZXJ0aWZpY2F0ZVJlc291cmNlTmFtZTtcbiAgICAgICAgY29uc3QgbG9nZ2luZ0lzRW5hYmxlZCA9IHRoaXMub3B0aW9ucy5lbmFibGVMb2dnaW5nO1xuICAgICAgICBjb25zdCBsb2dnaW5nQnVja2V0UmVzb3VyY2VOYW1lID0gdGhpcy5vcHRpb25zLnMzQnVja2V0O1xuICAgICAgICBjb25zdCBlZnNJc0VuYWJsZWQgPSB0aGlzLm9wdGlvbnMuZW5hYmxlRWZzO1xuICAgICAgICBjb25zdCBlZnNSZXNvdXJjZU5hbWUgPSB0aGlzLm9wdGlvbnMuZWZzRmlsZVN5c3RlbTtcbiAgICAgICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5vcHRpb25zLm5hbWVzcGFjZTtcblxuICAgICAgICAvLyBDcmVhdGUgTmFtZXNwYWNlXG4gICAgICAgIGNvbnN0IG5zID0gY3JlYXRlTmFtZXNwYWNlKG5hbWVzcGFjZSEsIGNsdXN0ZXIsIHRydWUsIHRydWUpO1xuXG4gICAgICAgIC8vIFNldHRpbmcgYmFzaWMgY3VzdG9tIHZhbHVlcyBmb3IgS3ViZXJuZXRlc1xuICAgICAgICBsZXQgdmFsdWVzOiBWYWx1ZXMgPSB7XG4gICAgICAgICAgICBjb25maWc6IHtcbiAgICAgICAgICAgICAgICBcImt1YmVybmV0ZXNcIjoge1xuICAgICAgICAgICAgICAgICAgICBcIm5hbWVzcGFjZVwiOiB0aGlzLm9wdGlvbnMubmFtZXNwYWNlIVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgXCJrdWJlcm5ldGVzX2V4ZWN1dG9yXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgXCJuYW1lc3BhY2VcIjogdGhpcy5vcHRpb25zLm5hbWVzcGFjZSFcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJzZWN1cml0eUNvbnRleHRcIjoge1xuICAgICAgICAgICAgICAgIFwiZnNHcm91cFwiOiA2NjUzNFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwiZXhlY3V0b3JcIjogXCJLdWJlcm5ldGVzRXhlY3V0b3JcIlxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIElmIExvYWQgQmFsYW5jaW5nIGlzIGVuYWJsZWRcbiAgICAgICAgaWYgKGVuYWJsZUFsYil7XG4gICAgICAgICAgICB2YWx1ZXMgPSBzZXRVcExvYWRCYWxhbmNlcihjbHVzdGVySW5mbywgdmFsdWVzLCBhbGJBZGRPbkNoZWNrLCBjZXJ0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFzc2VydCghY2VydCwgJ0NlcnQgb3B0aW9uIGlzIHN1cHBvcnRlZCBvbmx5IGlmIEFMQiBpcyBlbmFibGVkLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gSWYgTG9nZ2luZyB3aXRoIFMzIGlzIGVuYWJsZWRcbiAgICAgICAgaWYgKGxvZ2dpbmdJc0VuYWJsZWQpe1xuICAgICAgICAgICAgY29uc3QgYnVja2V0ID0gY2x1c3RlckluZm8uZ2V0UmVxdWlyZWRSZXNvdXJjZTxJQnVja2V0Pihsb2dnaW5nQnVja2V0UmVzb3VyY2VOYW1lISk7XG4gICAgICAgICAgICB2YWx1ZXMgPSBzZXRVcExvZ2dpbmcoY2x1c3RlckluZm8sIHZhbHVlcywgbnMsIG5hbWVzcGFjZSEsIGJ1Y2tldCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBJZiBFRlMgaXMgZW5hYmxlZCBmb3IgcGVyc2lzdGVudCBzdG9yYWdlXG4gICAgICAgIGxldCBwdmNSZXNvdXJjZTogS3ViZXJuZXRlc01hbmlmZXN0O1xuICAgICAgICBpZiAoZWZzSXNFbmFibGVkKXtcbiAgICAgICAgICAgIFt2YWx1ZXMsIHB2Y1Jlc291cmNlXSA9IHNldFVwRUZTKGNsdXN0ZXJJbmZvLCB2YWx1ZXMsIG5zLCBuYW1lc3BhY2UhLCBlZnNSZXNvdXJjZU5hbWUhKTsgICBcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE1lcmdlIHZhbHVlcyB3aXRoIHVzZXItcHJvdmlkZWQgb25lXG4gICAgICAgIHZhbHVlcyA9IG1lcmdlKHZhbHVlcywgdGhpcy5wcm9wcy52YWx1ZXMgPz8ge30pO1xuXG4gICAgICAgIC8vIEFwcGx5IEhlbG0gQ2hhcnRcbiAgICAgICAgY29uc3QgY2hhcnQgPSB0aGlzLmFkZEhlbG1DaGFydChjbHVzdGVySW5mbywgdmFsdWVzLCBmYWxzZSwgZmFsc2UpO1xuXG4gICAgICAgIC8vIEFkZCBQVkMgZGVwZW5kZW5jeSB0byB0aGUgQ2hhcnQgaW4gY2FzZSBvZiBFRlMgZ2VuZXJhdGluZyB0aGUgcmVzb3VyY2VcbiAgICAgICAgaWYgKGVmc0lzRW5hYmxlZCl7XG4gICAgICAgICAgICBjaGFydC5ub2RlLmFkZERlcGVuZGVuY3kocHZjUmVzb3VyY2UhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2hhcnQpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBIZWxwZXIgZnVuY3Rpb24gdG8gc2V0IHVwIExvYWQgQmFsYW5jZXJcbiAqL1xuZnVuY3Rpb24gc2V0VXBMb2FkQmFsYW5jZXIoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvLCB2YWx1ZXM6IFZhbHVlcywgYWxiQWRkT25DaGVjazogUHJvbWlzZTxDb25zdHJ1Y3Q+IHwgdW5kZWZpbmVkLCBjZXJ0OiBzdHJpbmcgfCB1bmRlZmluZWQgKTogVmFsdWVzIHtcbiAgICAgLy8gQ2hlY2sgdG8gZW5zdXJlIEFXUyBMb2FkIEJhbGFuY2VyIENvbnRyb2xsZXIgQWRkT24gaXMgcHJvdmlkZWQgaW4gdGhlIGxpc3Qgb2YgQWRkb25zXG4gICAgIGFzc2VydChhbGJBZGRPbkNoZWNrLCBgTWlzc2luZyBhIGRlcGVuZGVuY3k6ICR7QXdzTG9hZEJhbGFuY2VyQ29udHJvbGxlckFkZE9uLm5hbWV9LiBQbGVhc2UgYWRkIGl0IHRvIHlvdXIgbGlzdCBvZiBhZGRvbnMuYCk7IFxuICAgICBjb25zdCBwcmVzZXRBbm5vdGF0aW9uczogYW55ID0ge1xuICAgICAgICAgJ2FsYi5pbmdyZXNzLmt1YmVybmV0ZXMuaW8vZ3JvdXAubmFtZSc6ICdhaXJmbG93JyxcbiAgICAgICAgICdhbGIuaW5ncmVzcy5rdWJlcm5ldGVzLmlvL3NjaGVtZSc6ICdpbnRlcm5ldC1mYWNpbmcnLFxuICAgICAgICAgJ2FsYi5pbmdyZXNzLmt1YmVybmV0ZXMuaW8vdGFyZ2V0LXR5cGUnOiAnaXAnLFxuICAgICAgICAgJ2FsYi5pbmdyZXNzLmt1YmVybmV0ZXMuaW8vbGlzdGVuLXBvcnRzJzogJ1t7XCJIVFRQXCI6IDgwfV0nLFxuICAgICAgICAgJ2FsYi5pbmdyZXNzLmt1YmVybmV0ZXMuaW8vaGVhbHRoY2hlY2stcGF0aCc6ICcvaGVhbHRoJyxcbiAgICAgfTtcblxuICAgICAvLyBTZXQgaGVsbSBjdXN0b20gdmFsdWUgZm9yIGNlcnRpZmljYXRlcywgaWYgcHJvdmlkZWRcbiAgICAgaWYgKGNlcnQpe1xuICAgICAgICAgcHJlc2V0QW5ub3RhdGlvbnNbJ2FsYi5pbmdyZXNzLmt1YmVybmV0ZXMuaW8vbGlzdGVuLXBvcnRzJ10gPSAnW3tcIkhUVFBcIjogODB9LHtcIkhUVFBTXCI6NDQzfV0nO1xuICAgICAgICAgY29uc3QgY2VydGlmaWNhdGUgPSBjbHVzdGVySW5mby5nZXRSZXNvdXJjZTxJQ2VydGlmaWNhdGU+KGNlcnQpO1xuICAgICAgICAgcHJlc2V0QW5ub3RhdGlvbnNbJ2FsYi5pbmdyZXNzLmt1YmVybmV0ZXMuaW8vY2VydGlmaWNhdGUtYXJuJ10gPSBjZXJ0aWZpY2F0ZT8uY2VydGlmaWNhdGVBcm47XG4gICAgIH0gXG4gICAgIFxuICAgICBzZXRQYXRoKHZhbHVlcywgXCJpbmdyZXNzLndlYlwiLCB7XG4gICAgICAgICBcImVuYWJsZWRcIjogXCJ0cnVlXCIsXG4gICAgICAgICBcImFubm90YXRpb25zXCI6IHByZXNldEFubm90YXRpb25zLFxuICAgICAgICAgXCJwYXRoVHlwZVwiOiBcIlByZWZpeFwiLFxuICAgICAgICAgXCJpbmdyZXNzQ2xhc3NOYW1lXCI6IFwiYWxiXCIsXG4gICAgIH0pO1xuXG4gICAgIC8vIENvbmZpZ3VyaW5nIEluZ3Jlc3MgZm9yIEFpcmZsb3cgV2ViIFVpIGhlbmNlIHRoZSBzZXJ2aWNlIHR5cGUgaXMgY2hhbmdlZCB0byBOb2RlUG9ydFxuICAgICBzZXRQYXRoKHZhbHVlcywgXCJ3ZWJzZXJ2ZXIuc2VydmljZVwiLCB7XG4gICAgICAgICB0eXBlOiBcIk5vZGVQb3J0XCIsXG4gICAgICAgICBwb3J0czogW3tcbiAgICAgICAgICAgICBuYW1lOiBcImFpcmZsb3ctdWlcIixcbiAgICAgICAgICAgICBwb3J0OiBcInt7IC5WYWx1ZXMucG9ydHMuYWlyZmxvd1VJIH19XCJcbiAgICAgICAgIH1dXG4gICAgIH0pO1xuXG4gICAgIHJldHVybiB2YWx1ZXM7XG59XG5cbi8qKlxuICogSGVscGVyIGZ1bmN0aW9uIHRvIHNldCB1cCBMb2dnaW5nIHdpdGggUzMgQnVja2V0XG4qL1xuZnVuY3Rpb24gc2V0VXBMb2dnaW5nKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgdmFsdWVzOiBWYWx1ZXMsIG5zOiBDb25zdHJ1Y3QsIG5hbWVzcGFjZTogc3RyaW5nLCBidWNrZXQ6IElCdWNrZXQpOiBWYWx1ZXMge1xuICAgIFxuICAgIC8vIEFzc2VydCBjaGVjayB0byBlbnN1cmUgeW91IHByb3ZpZGUgYW4gUzMgQnVja2V0XG4gICAgYXNzZXJ0KGJ1Y2tldCwgXCJQbGVhc2UgcHJvdmlkZSB0aGUgbmFtZSBvZiBTMyBidWNrZXQgZm9yIExvZ2dpbmcuXCIpO1xuXG4gICAgLy8gSVJTQSBQb2xpY3lcbiAgICBjb25zdCBBaXJmbG93TG9nZ2luZ1BvbGljeSA9IHtcbiAgICAgICAgXCJWZXJzaW9uXCI6IFwiMjAxMi0xMC0xN1wiLFxuICAgICAgICBcIlN0YXRlbWVudFwiOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgXCJFZmZlY3RcIjogXCJBbGxvd1wiLFxuICAgICAgICAgICAgICAgIFwiQWN0aW9uXCI6IFtcbiAgICAgICAgICAgICAgICAgICAgXCJzMzpMaXN0QnVja2V0XCJcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIFwiUmVzb3VyY2VcIjogW2Bhcm46YXdzOnMzOjo6JHtidWNrZXQuYnVja2V0TmFtZX1gXVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBcIkVmZmVjdFwiOiBcIkFsbG93XCIsXG4gICAgICAgICAgICAgICAgXCJBY3Rpb25cIjogW1xuICAgICAgICAgICAgICAgICAgICBcInMzOkdldE9iamVjdFwiLFxuICAgICAgICAgICAgICAgICAgICBcInMzOlB1dE9iamVjdFwiXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICBcIlJlc291cmNlXCI6IFtgYXJuOmF3czpzMzo6OiR7YnVja2V0LmJ1Y2tldE5hbWV9LypgXVxuICAgICAgICAgICAgfVxuICAgICAgICBdXG4gICAgfTtcblxuICAgIC8vIFNldCB1cCBJUlNBXG4gICAgY29uc3QgYWlyZmxvd0xvZ2dpbmdQb2xpY3lEb2N1bWVudCA9IFBvbGljeURvY3VtZW50LmZyb21Kc29uKEFpcmZsb3dMb2dnaW5nUG9saWN5KTtcbiAgICBjb25zdCBzYSA9IGNyZWF0ZVNlcnZpY2VBY2NvdW50KGNsdXN0ZXJJbmZvLmNsdXN0ZXIsICdhaXJmbG93LXMzLWxvZ2dpbmctc2EnLCBuYW1lc3BhY2UsIGFpcmZsb3dMb2dnaW5nUG9saWN5RG9jdW1lbnQpO1xuICAgIHNhLm5vZGUuYWRkRGVwZW5kZW5jeShucyk7XG5cbiAgICAvLyBIZWxtIGN1c3RvbSB2YWx1ZSBzZXQgdXAgZm9yIFMzIGxvZ2dpbmcgc2V0IHVwXG4gICAgc2V0UGF0aCh2YWx1ZXMsIFwiY29uZmlnLmNvcmUuY29sb3JlZF9jb25zb2xlX2xvZ1wiLCAnVHJ1ZScpO1xuICAgIHNldFBhdGgodmFsdWVzLCBcImNvbmZpZy5jb3JlLnJlbW90ZV9sb2dnaW5nXCIsICdUcnVlJyk7XG4gICAgc2V0UGF0aCh2YWx1ZXMsIFwiY29uZmlnLmxvZ2dpbmdcIiwge1xuICAgICAgICBcInJlbW90ZV9sb2dnaW5nXCI6ICdUcnVlJyxcbiAgICAgICAgXCJsb2dnaW5nX2xldmVsXCI6ICdJTkZPJyxcbiAgICAgICAgXCJjb2xvcmVkX2NvbnNvbGVfbG9nXCI6ICdUcnVlJyxcbiAgICAgICAgXCJyZW1vdGVfYmFzZV9sb2dfZm9sZGVyXCI6IGBzMzovLyR7YnVja2V0LmJ1Y2tldE5hbWV9L2FpcmZsb3ctbG9nc2AsXG4gICAgICAgIC8vIGF3c19zM19jb25uIGlzIHRoZSBuYW1lIG9mIHRoZSBjb25uZWN0aW9uIHRoYXQgbmVlZHMgdG8gYmUgY3JlYXRlZCB1c2luZyBBaXJmbG93IGFkbWluIFVJIG9uY2UgdGhlIGRlcGxveW1lbnQgaXMgY29tcGxldGVcbiAgICAgICAgLy8gU3RlcHMgY2FuIGJlIHNlZW4gaW4gdGhlIGRvY3MgbGluayBoZXJlIC0+IGh0dHBzOi8vZ2l0aHViLmNvbS9hcGFjaGUvYWlyZmxvdy9pc3N1ZXMvMjUzMjJcbiAgICAgICAgXCJyZW1vdGVfbG9nX2Nvbm5faWRcIjogJ2F3c19zM19jb25uJyxcbiAgICAgICAgXCJkZWxldGVfd29ya2VyX3BvZHNcIjogJ0ZhbHNlJyxcbiAgICAgICAgXCJlbmNyeXB0X3MzX2xvZ3NcIjogJ1RydWUnXG4gICAgfSk7XG5cbiAgICAvLyBTZXQgV2Vic2VydmVyIFNBIHNvIHRoYXQgc2VydmVyIGxvZ3MgY2FuIGJlIHNoaXBwZWQgdG8gUzNcbiAgICBzZXRQYXRoKHZhbHVlcywgXCJ3ZWJzZXJ2ZXIuc2VydmljZUFjY291bnRcIiwge1xuICAgICAgICBjcmVhdGU6IGZhbHNlLFxuICAgICAgICBuYW1lOiBgJHtzYS5zZXJ2aWNlQWNjb3VudE5hbWV9YFxuICAgIH0pO1xuXG4gICAgLy8gU2V0IFdvcmtlciBTQSBzbyB0aGF0IHdvcmtlciBsb2dzIGNhbiBiZSBzaGlwcGVkIHRvIFMzXG4gICAgc2V0UGF0aCh2YWx1ZXMsIFwid29ya2Vycy5zZXJ2aWNlQWNjb3VudFwiLCB7XG4gICAgICAgIGNyZWF0ZTogZmFsc2UsXG4gICAgICAgIG5hbWU6IGAke3NhLnNlcnZpY2VBY2NvdW50TmFtZX1gXG4gICAgfSk7XG5cbiAgICAvLyBTZXQgU2NoZWR1bGVyIFNBIHNvIHRoYXQgc2NoZWR1bGVyIGxvZ3MgY2FuIGJlIHNoaXBwZWQgdG8gUzNcbiAgICBzZXRQYXRoKHZhbHVlcywgXCJzY2hlZHVsZXIuc2VydmljZUFjY291bnRcIiwge1xuICAgICAgICBjcmVhdGU6IGZhbHNlLFxuICAgICAgICBuYW1lOiBgJHtzYS5zZXJ2aWNlQWNjb3VudE5hbWV9YFxuICAgIH0pO1xuICAgIFxuICAgIHJldHVybiB2YWx1ZXM7XG59XG5cbi8qKlxuICogXG4gKi9cbmZ1bmN0aW9uIHNldFVwRUZTKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgdmFsdWVzOiBWYWx1ZXMsIG5zOiBDb25zdHJ1Y3QsIG5hbWVzcGFjZTogc3RyaW5nLCBlZnNSZXNvdXJjZU5hbWU6IHN0cmluZyk6IFtWYWx1ZXMsIEt1YmVybmV0ZXNNYW5pZmVzdF0ge1xuICAgIC8vIENoZWNrIFxuICAgIGNvbnN0IGVmc0FkZE9uQ2hlY2sgPSBjbHVzdGVySW5mby5nZXRTY2hlZHVsZWRBZGRPbihFZnNDc2lEcml2ZXJBZGRPbi5uYW1lKTtcbiAgICBhc3NlcnQoZWZzQWRkT25DaGVjaywgYE1pc3NpbmcgYSBkZXBlbmRlbmN5OiAke0Vmc0NzaURyaXZlckFkZE9uLm5hbWV9LiBQbGVhc2UgYWRkIGl0IHRvIHlvdXIgbGlzdCBvZiBhZGRvbnMuYCk7IFxuICAgIGNvbnN0IGVmcyA9IGNsdXN0ZXJJbmZvLmdldFJlcXVpcmVkUmVzb3VyY2U8SUZpbGVTeXN0ZW0+KGVmc1Jlc291cmNlTmFtZSk7XG4gICAgYXNzZXJ0KGVmcywgXCJQbGVhc2UgcHJvdmlkZSB0aGUgbmFtZSBvZiBFRlMgRmlsZSBTeXN0ZW0uXCIpO1xuXG4gICAgLy8gTmVlZCB0byBjcmVhdGUgYSBzdG9yYWdlIGNsYXNzIGFuZCBwdmMgZm9yIHRoZSBFRlNcbiAgICBjb25zdCBzY1Jlc291cmNlID0gbmV3IEt1YmVybmV0ZXNNYW5pZmVzdChjbHVzdGVySW5mby5jbHVzdGVyLCAnYXBhY2hlLWFpcmZsb3ctZWZzLXNjJywge1xuICAgICAgICBjbHVzdGVyOiBjbHVzdGVySW5mby5jbHVzdGVyLFxuICAgICAgICBtYW5pZmVzdDogW3tcbiAgICAgICAgICAgIGFwaVZlcnNpb246IFwic3RvcmFnZS5rOHMuaW8vdjFcIixcbiAgICAgICAgICAgIGtpbmQ6IFwiU3RvcmFnZUNsYXNzXCIsXG4gICAgICAgICAgICBtZXRhZGF0YTogeyBuYW1lOiBBSVJGTE9XU0MgfSxcbiAgICAgICAgICAgIHByb3Zpc2lvbmVyOiBcImVmcy5jc2kuYXdzLmNvbVwiLFxuICAgICAgICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICAgICAgICAgIHByb3Zpc2lvbmluZ01vZGU6IFwiZWZzLWFwXCIsXG4gICAgICAgICAgICAgICAgZmlsZVN5c3RlbUlkOiBgJHtlZnMuZmlsZVN5c3RlbUlkfWAsXG4gICAgICAgICAgICAgICAgZGlyZWN0b3J5UGVybXM6IFwiNzAwXCIsXG4gICAgICAgICAgICAgICAgZ2lkUmFuZ2VTdGFydDogXCIxMDAwXCIsXG4gICAgICAgICAgICAgICAgZ2lkUmFuZ2VFbmQ6IFwiMjAwMFwiLFxuICAgICAgICAgICAgfVxuICAgICAgICB9XSwgb3ZlcndyaXRlOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgY29uc3QgcHZjUmVzb3VyY2UgPSBuZXcgS3ViZXJuZXRlc01hbmlmZXN0KGNsdXN0ZXJJbmZvLmNsdXN0ZXIsICdhcGFjaGUtYWlyZmxvdy1lZnMtcHZjJyx7XG4gICAgICAgIGNsdXN0ZXI6IGNsdXN0ZXJJbmZvLmNsdXN0ZXIsXG4gICAgICAgIG1hbmlmZXN0OiBbe1xuICAgICAgICAgICAgYXBpVmVyc2lvbjogXCJ2MVwiLFxuICAgICAgICAgICAga2luZDogXCJQZXJzaXN0ZW50Vm9sdW1lQ2xhaW1cIixcbiAgICAgICAgICAgIG1ldGFkYXRhOiB7IFxuICAgICAgICAgICAgICAgIG5hbWU6IEFJUkZMT1dQVkMsXG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlOiBgJHtuYW1lc3BhY2V9YCBcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzcGVjOiB7XG4gICAgICAgICAgICAgICAgYWNjZXNzTW9kZXM6IFtcIlJlYWRXcml0ZU1hbnlcIl0sXG4gICAgICAgICAgICAgICAgc3RvcmFnZUNsYXNzTmFtZTogQUlSRkxPV1NDLFxuICAgICAgICAgICAgICAgIHJlc291cmNlczoge1xuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0czoge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RvcmFnZTogJzEwR2knXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1dLCBvdmVyd3JpdGU6IHRydWUsXG4gICAgfSk7XG5cbiAgICAvLyBTQyBkZXBlbmRzIG9uIHRoZSBFRlMgYWRkb25cbiAgICBpZihlZnNBZGRPbkNoZWNrKSB7XG4gICAgICAgIGVmc0FkZE9uQ2hlY2sudGhlbihjb25zdHJ1Y3QgPT4gc2NSZXNvdXJjZS5ub2RlLmFkZERlcGVuZGVuY3koY29uc3RydWN0KSk7XG4gICAgfVxuXG4gICAgLy8gUFZDIGRlcGVuZHMgb24gU0MgYW5kIE5TXG4gICAgcHZjUmVzb3VyY2Uubm9kZS5hZGREZXBlbmRlbmN5KHNjUmVzb3VyY2UpO1xuICAgIHB2Y1Jlc291cmNlLm5vZGUuYWRkRGVwZW5kZW5jeShucyk7XG5cbiAgICAvLyBTZXQgaGVsbSBjdXN0b20gdmFsdWVzIGZvciBwZXJzaXN0ZW50IHN0b3JhZ2Ugb2YgREFHc1xuICAgIHNldFBhdGgodmFsdWVzLCBcImRhZ3MucGVyc2lzdGVuY2VcIiwge1xuICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICBzaXplOiBcIjEwR2lcIixcbiAgICAgICAgc3RvcmFnZUNsYXNzTmFtZTogQUlSRkxPV1NDLFxuICAgICAgICBhY2Nlc3NNb2RlOiBcIlJlYWRXcml0ZU1hbnlcIixcbiAgICAgICAgZXhpc3RpbmdDbGFpbTogQUlSRkxPV1BWQ1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIFt2YWx1ZXMsIHB2Y1Jlc291cmNlXTtcbn0iXX0=