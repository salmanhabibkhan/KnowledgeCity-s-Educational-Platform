"use strict";
// https://www.gateway-api-controller.eks.aws.dev/latest/guides/deploy/#setup
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AwsGatewayApiControllerAddOn = void 0;
const helm_addon_1 = require("../helm-addon");
const iam_policy_1 = require("./iam-policy");
const gateway_api_crds_1 = require("../gateway-api-crds");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const customResources = require("aws-cdk-lib/custom-resources");
const ec2 = require("aws-cdk-lib/aws-ec2");
const utils_1 = require("../../utils");
const AWS_GATEWAY_API_CONTROLLER_SA = 'gateway-api-controller';
const defaultProps = {
    name: 'aws-gateway-api-controller',
    namespace: 'aws-application-networking-system',
    chart: 'aws-gateway-controller-chart',
    version: 'v1.1.0',
    repository: 'oci://public.ecr.aws/aws-application-networking-k8s/aws-gateway-controller-chart',
    values: {},
    defaultServiceNetwork: '',
    enableServiceNetworkOverride: false,
    webhookEnabled: false,
    disableTaggingServiceApi: false,
    routeMaxConcurrentReconciles: 1,
};
class AwsGatewayApiControllerAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        // Step 1: Configure Security Groups for VPC Lattice 
        this.configureSecurityGroup(clusterInfo);
        // Step 2: Create namespace
        const namespace = this.createNamespace(clusterInfo);
        // Step 3: Set up IAM permissions
        const serviceAccount = this.setupIamPermissions(clusterInfo);
        // Step 4: Create GatewayClass that uses the official K8s Gateway API
        this.createGatewayClass(clusterInfo);
        // Step 5: Deploy the controller
        const chartValues = this.populateValues(serviceAccount);
        const awsGatewayApiController = this.addHelmChart(clusterInfo, chartValues);
        // Set up dependencies:
        serviceAccount.node.addDependency(namespace);
        awsGatewayApiController.node.addDependency(serviceAccount);
        return Promise.resolve(awsGatewayApiController);
    }
    /**
     * CDK does not provide native way to get managed prefix list as of 3/11/2025
     * PR seems to be almost done: https://github.com/aws/aws-cdk/pull/33619
     * Using CRD workaround as described here for now: https://gist.github.com/bericp1/eb0ce72079161f45f4867a9e3ab02bd9
     * */
    configureSecurityGroup(clusterInfo) {
        const clusterSg = clusterInfo.cluster.clusterSecurityGroup;
        const region = aws_cdk_lib_1.Stack.of(clusterInfo.cluster).region;
        // Create the prefix list lookup custom resource
        const vpcLatticePrefixListCall = new customResources.AwsCustomResource(clusterInfo.cluster.stack, 'GetVpcLatticePrefixListIDs', {
            resourceType: 'Custom::GetVpcLatticePrefixListIDs',
            onUpdate: {
                region,
                service: 'EC2',
                action: 'describeManagedPrefixLists',
                parameters: {
                    Filters: [
                        {
                            Name: 'prefix-list-name',
                            Values: [
                                `com.amazonaws.${region}.vpc-lattice`,
                                `com.amazonaws.${region}.ipv6.vpc-lattice`
                            ],
                        },
                    ],
                },
                physicalResourceId: customResources.PhysicalResourceId.of('GetVpcLatticePrefixListIDsFunction')
            },
            policy: customResources.AwsCustomResourcePolicy.fromSdkCalls({
                resources: customResources.AwsCustomResourcePolicy.ANY_RESOURCE
            })
        });
        // Get the prefix list IDs from the custom resource response
        const prefixListIds = [
            vpcLatticePrefixListCall.getResponseField('PrefixLists.0.PrefixListId'),
            vpcLatticePrefixListCall.getResponseField('PrefixLists.1.PrefixListId'),
        ];
        // Add security group rules for each prefix list
        prefixListIds.forEach(prefixListId => {
            // Add ingress rule
            clusterSg.addIngressRule(ec2.Peer.prefixList(prefixListId.toString()), ec2.Port.allTraffic(), 'Allow inbound from VPC Lattice');
            // Add egress rule
            clusterSg.addEgressRule(ec2.Peer.prefixList(prefixListId.toString()), ec2.Port.allTraffic(), 'Allow outbound to VPC Lattice');
        });
        return vpcLatticePrefixListCall;
    }
    // https://github.com/aws/aws-application-networking-k8s/blob/main/files/controller-installation/deploy-namesystem.yaml
    createNamespace(clusterInfo) {
        return clusterInfo.cluster.addManifest('aws-application-networking-system-namespace', {
            apiVersion: 'v1',
            kind: 'Namespace',
            metadata: {
                name: this.options.namespace,
                labels: {
                    'control-plane': 'gateway-api-controller'
                }
            }
        });
    }
    // https://github.com/aws/aws-application-networking-k8s/blob/main/files/controller-installation/recommended-inline-policy.json
    setupIamPermissions(clusterInfo) {
        const cluster = clusterInfo.cluster;
        const serviceAccount = cluster.addServiceAccount(AWS_GATEWAY_API_CONTROLLER_SA, {
            name: AWS_GATEWAY_API_CONTROLLER_SA,
            namespace: this.options.namespace,
        });
        (0, iam_policy_1.getVpcLatticeControllerPolicy)().forEach((statement) => {
            serviceAccount.addToPrincipalPolicy(statement);
        });
        return serviceAccount;
    }
    // Sets Helm and AWS Gateway API Controller Configuration 
    // https://www.gateway-api-controller.eks.aws.dev/latest/guides/environment/
    populateValues(serviceAccount) {
        var _a;
        const values = (_a = this.options.values) !== null && _a !== void 0 ? _a : {};
        values.serviceAccount = {
            create: false,
            name: serviceAccount.serviceAccountName
        };
        if (this.options.logLevel) {
            values.logLevel = this.options.logLevel;
        }
        if (this.options.defaultServiceNetwork) {
            values.defaultServiceNetwork = this.options.defaultServiceNetwork;
        }
        if (this.options.enableServiceNetworkOverride) {
            values.enableServiceNetworkOverride = this.options.enableServiceNetworkOverride;
        }
        if (this.options.webhookEnabled) {
            values.webhookEnabled = this.options.webhookEnabled;
        }
        if (this.options.disableTaggingServiceApi) {
            values.disableTaggingServiceApi = this.options.disableTaggingServiceApi;
        }
        if (this.options.routeMaxConcurrentReconciles) {
            values.routeMaxConcurrentReconciles = this.options.routeMaxConcurrentReconciles;
        }
        return values;
    }
    // https://github.com/aws/aws-application-networking-k8s/blob/main/files/controller-installation/gatewayclass.yaml
    createGatewayClass(clusterInfo) {
        return clusterInfo.cluster.addManifest('vpc-lattice-gateway-class', {
            apiVersion: 'gateway.networking.k8s.io/v1beta1',
            kind: 'GatewayClass',
            metadata: {
                name: 'amazon-vpc-lattice'
            },
            spec: {
                controllerName: 'application-networking.k8s.aws/gateway-api-controller'
            }
        });
    }
}
exports.AwsGatewayApiControllerAddOn = AwsGatewayApiControllerAddOn;
__decorate([
    (0, utils_1.dependable)(gateway_api_crds_1.GatewayApiCrdsAddOn.name)
], AwsGatewayApiControllerAddOn.prototype, "deploy", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2F3cy1nYXRld2F5LWFwaS1jb250cm9sbGVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw2RUFBNkU7Ozs7Ozs7OztBQUk3RSw4Q0FBOEQ7QUFFOUQsNkNBQTZEO0FBQzdELDBEQUEwRDtBQUMxRCw2Q0FBb0M7QUFDcEMsZ0VBQWdFO0FBQ2hFLDJDQUEyQztBQUMzQyx1Q0FBeUM7QUFHekMsTUFBTSw2QkFBNkIsR0FBRyx3QkFBd0IsQ0FBQztBQXlDL0QsTUFBTSxZQUFZLEdBQXNDO0lBQ3BELElBQUksRUFBRSw0QkFBNEI7SUFDbEMsU0FBUyxFQUFFLG1DQUFtQztJQUM5QyxLQUFLLEVBQUUsOEJBQThCO0lBQ3JDLE9BQU8sRUFBRSxRQUFRO0lBQ2pCLFVBQVUsRUFBRSxrRkFBa0Y7SUFDOUYsTUFBTSxFQUFFLEVBQUU7SUFDVixxQkFBcUIsRUFBRSxFQUFFO0lBQ3pCLDRCQUE0QixFQUFFLEtBQUs7SUFDbkMsY0FBYyxFQUFFLEtBQUs7SUFDckIsd0JBQXdCLEVBQUUsS0FBSztJQUMvQiw0QkFBNEIsRUFBRSxDQUFDO0NBQ2xDLENBQUM7QUFFRixNQUFhLDRCQUE2QixTQUFRLHNCQUFTO0lBR3ZELFlBQVksS0FBeUM7UUFDakQsS0FBSyxDQUFDLEVBQUUsR0FBSSxZQUFvQixFQUFFLEdBQUcsS0FBSyxFQUFDLENBQUMsQ0FBQztRQUM3QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUEwQyxDQUFDO0lBQ25FLENBQUM7SUFHRCxNQUFNLENBQUMsV0FBd0I7UUFDM0IscURBQXFEO1FBQ3JELElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUV6QywyQkFBMkI7UUFDM0IsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUVwRCxpQ0FBaUM7UUFDakMsTUFB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ZXIuZWtzLmF3cy5kZXYvbGF0ZXN0L2d1aWRlcy9kZXBsb3kvI3NldHVwXG5cbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBDbHVzdGVySW5mbywgVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgSGVsbUFkZE9uLCBIZWxtQWRkT25Vc2VyUHJvcHMgfSBmcm9tIFwiLi4vaGVsbS1hZGRvblwiO1xuaW1wb3J0IHsgU2VydmljZUFjY291bnQgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVrc1wiO1xuaW1wb3J0IHsgZ2V0VnBjTGF0dGljZUNvbnRyb2xsZXJQb2xpY3kgfSBmcm9tIFwiLi9pYW0tcG9saWN5XCI7XG5pbXBvcnQgeyBHYXRld2F5QXBpQ3Jkc0FkZE9uIH0gZnJvbSBcIi4uL2dhdGV3YXktYXBpLWNyZHNcIjtcbmltcG9ydCB7IFN0YWNrIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBjdXN0b21SZXNvdXJjZXMgZnJvbSAnYXdzLWNkay1saWIvY3VzdG9tLXJlc291cmNlcyc7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSAnYXdzLWNkay1saWIvYXdzLWVjMic7XG5pbXBvcnQgeyBkZXBlbmRhYmxlIH0gZnJvbSBcIi4uLy4uL3V0aWxzXCI7XG5cblxuY29uc3QgQVdTX0dBVEVXQVlfQVBJX0NPTlRST0xMRVJfU0EgPSAnZ2F0ZXdheS1hcGktY29udHJvbGxlcic7XG5cbi8vIGh0dHBzOi8vd3d3LmdhdGV3YXktYXBpLWNvbnRyb2xsZXIuZWtzLmF3cy5kZXYvbGF0ZXN0L2d1aWRlcy9lbnZpcm9ubWVudC8jZW52aXJvbm1lbnQtdmFyaWFibGVzXG5leHBvcnQgaW50ZXJmYWNlIEF3c0dhdGV3YXlBcGlDb250cm9sbGVyQWRkT25Qcm9wcyBleHRlbmRzIEhlbG1BZGRPblVzZXJQcm9wcyB7XG4gICAgLyoqXG4gICAgICogTG9nIGxldmVsIGNvbmZpZ3VyYXRpb25cbiAgICAgKiBAZGVmYXVsdCBcImluZm9cIlxuICAgICAqL1xuICAgIGxvZ0xldmVsPzogJ2luZm8nIHwgJ2RlYnVnJztcblxuICAgIC8qKlxuICAgICAqIERlZmF1bHQgc2VydmljZSBuZXR3b3JrIG5hbWVcbiAgICAgKiBAZGVmYXVsdCBcIlwiXG4gICAgICovXG4gICAgZGVmYXVsdFNlcnZpY2VOZXR3b3JrPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogRW5hYmxlIHNpbmdsZSBzZXJ2aWNlIG5ldHdvcmsgbW9kZVxuICAgICAqIEBkZWZhdWx0IFwiZmFsc2VcIlxuICAgICAqL1xuICAgIGVuYWJsZVNlcnZpY2VOZXR3b3JrT3ZlcnJpZGU/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICogRW5hYmxlIHdlYmhvb2sgbGlzdGVuZXIgZm9yIHBvZCByZWFkaW5lc3MgZ2F0ZSBpbmplY3Rpb25cbiAgICAgKiBAZGVmYXVsdCBcImZhbHNlXCJcbiAgICAgKi9cbiAgICB3ZWJob29rRW5hYmxlZD86IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiBEaXNhYmxlIEFXUyBSZXNvdXJjZSBHcm91cHMgVGFnZ2luZyBBUElcbiAgICAgKiBAZGVmYXVsdCBcImZhbHNlXCJcbiAgICAgKi9cbiAgICBkaXNhYmxlVGFnZ2luZ1NlcnZpY2VBcGk/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICogTWF4aW11bSBudW1iZXIgb2YgY29uY3VycmVudCByZWNvbmNpbGUgbG9vcHMgcGVyIHJvdXRlIHR5cGVcbiAgICAgKiBAZGVmYXVsdCAxXG4gICAgICovXG4gICAgcm91dGVNYXhDb25jdXJyZW50UmVjb25jaWxlcz86IG51bWJlcjtcbn1cblxuY29uc3QgZGVmYXVsdFByb3BzOiBBd3NHYXRld2F5QXBpQ29udHJvbGxlckFkZE9uUHJvcHMgPSB7XG4gICAgbmFtZTogJ2F3cy1nYXRld2F5LWFwaS1jb250cm9sbGVyJyxcbiAgICBuYW1lc3BhY2U6ICdhd3MtYXBwbGljYXRpb24tbmV0d29ya2luZy1zeXN0ZW0nLFxuICAgIGNoYXJ0OiAnYXdzLWdhdGV3YXktY29udHJvbGxlci1jaGFydCcsXG4gICAgdmVyc2lvbjogJ3YxLjEuMCcsXG4gICAgcmVwb3NpdG9yeTogJ29jaTovL3B1YmxpYy5lY3IuYXdzL2F3cy1hcHBsaWNhdGlvbi1uZXR3b3JraW5nLWs4cy9hd3MtZ2F0ZXdheS1jb250cm9sbGVyLWNoYXJ0JyxcbiAgICB2YWx1ZXM6IHt9LFxuICAgIGRlZmF1bHRTZXJ2aWNlTmV0d29yazogJycsXG4gICAgZW5hYmxlU2VydmljZU5ldHdvcmtPdmVycmlkZTogZmFsc2UsXG4gICAgd2ViaG9va0VuYWJsZWQ6IGZhbHNlLFxuICAgIGRpc2FibGVUYWdnaW5nU2VydmljZUFwaTogZmFsc2UsXG4gICAgcm91dGVNYXhDb25jdXJyZW50UmVjb25jaWxlczogMSxcbn07XG5cbmV4cG9ydCBjbGFzcyBBd3NHYXRld2F5QXBpQ29udHJvbGxlckFkZE9uIGV4dGVuZHMgSGVsbUFkZE9uIHtcbiAgICByZWFkb25seSBvcHRpb25zOiBBd3NHYXRld2F5QXBpQ29udHJvbGxlckFkZE9uUHJvcHM7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcz86IEF3c0dhdGV3YXlBcGlDb250cm9sbGVyQWRkT25Qcm9wcykge1xuICAgICAgICBzdXBlcih7IC4uLihkZWZhdWx0UHJvcHMgYXMgYW55KSwgLi4ucHJvcHN9KTtcbiAgICAgICAgdGhpcy5vcHRpb25zID0gdGhpcy5wcm9wcyBhcyBBd3NHYXRld2F5QXBpQ29udHJvbGxlckFkZE9uUHJvcHM7XG4gICAgfVxuXG4gICAgQGRlcGVuZGFibGUoR2F0ZXdheUFwaUNyZHNBZGRPbi5uYW1lKVxuICAgIGRlcGxveShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiBQcm9taXNlPENvbnN0cnVjdD4ge1xuICAgICAgICAvLyBTdGVwIDE6IENvbmZpZ3VyZSBTZWN1cml0eSBHcm91cHMgZm9yIFZQQyBMYXR0aWNlIFxuICAgICAgICB0aGlzLmNvbmZpZ3VyZVNlY3VyaXR5R3JvdXAoY2x1c3RlckluZm8pO1xuXG4gICAgICAgIC8vIFN0ZXAgMjogQ3JlYXRlIG5hbWVzcGFjZVxuICAgICAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLmNyZWF0ZU5hbWVzcGFjZShjbHVzdGVySW5mbyk7XG5cbiAgICAgICAgLy8gU3RlcCAzOiBTZXQgdXAgSUFNIHBlcm1pc3Npb25zXG4gICAgICAgIGNvbnN0IHNlcnZpY2VBY2NvdW50ID0gdGhpcy5zZXR1cElhbVBlcm1pc3Npb25zKGNsdXN0ZXJJbmZvKTtcblxuICAgICAgICAvLyBTdGVwIDQ6IENyZWF0ZSBHYXRld2F5Q2xhc3MgdGhhdCB1c2VzIHRoZSBvZmZpY2lhbCBLOHMgR2F0ZXdheSBBUElcbiAgICAgICAgdGhpcy5jcmVhdGVHYXRld2F5Q2xhc3MoY2x1c3RlckluZm8pO1xuXG4gICAgICAgIC8vIFN0ZXAgNTogRGVwbG95IHRoZSBjb250cm9sbGVyXG4gICAgICAgIGNvbnN0IGNoYXJ0VmFsdWVzID0gdGhpcy5wb3B1bGF0ZVZhbHVlcyhzZXJ2aWNlQWNjb3VudCk7XG4gICAgICAgIGNvbnN0IGF3c0dhdGV3YXlBcGlDb250cm9sbGVyID0gdGhpcy5hZGRIZWxtQ2hhcnQoY2x1c3RlckluZm8sIGNoYXJ0VmFsdWVzKTtcblxuICAgICAgICAvLyBTZXQgdXAgZGVwZW5kZW5jaWVzOlxuICAgICAgICBzZXJ2aWNlQWNjb3VudC5ub2RlLmFkZERlcGVuZGVuY3kobmFtZXNwYWNlKTtcbiAgICAgICAgYXdzR2F0ZXdheUFwaUNvbnRyb2xsZXIubm9kZS5hZGREZXBlbmRlbmN5KHNlcnZpY2VBY2NvdW50KTtcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGF3c0dhdGV3YXlBcGlDb250cm9sbGVyKTtcbiAgICB9XG5cbiAgICAvKiogXG4gICAgICogQ0RLIGRvZXMgbm90IHByb3ZpZGUgbmF0aXZlIHdheSB0byBnZXQgbWFuYWdlZCBwcmVmaXggbGlzdCBhcyBvZiAzLzExLzIwMjVcbiAgICAgKiBQUiBzZWVtcyB0byBiZSBhbG1vc3QgZG9uZTogaHR0cHM6Ly9naXRodWIuY29tL2F3cy9hd3MtY2RrL3B1bGwvMzM2MTlcbiAgICAgKiBVc2luZyBDUkQgd29ya2Fyb3VuZCBhcyBkZXNjcmliZWQgaGVyZSBmb3Igbm93OiBodHRwczovL2dpc3QuZ2l0aHViLmNvbS9iZXJpY3AxL2ViMGNlNzIwNzkxNjFmNDVmNDg2N2E5ZTNhYjAyYmQ5XG4gICAgICogKi8gXG4gICAgcHJpdmF0ZSBjb25maWd1cmVTZWN1cml0eUdyb3VwKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbykge1xuICAgICAgICBjb25zdCBjbHVzdGVyU2cgPSBjbHVzdGVySW5mby5jbHVzdGVyLmNsdXN0ZXJTZWN1cml0eUdyb3VwO1xuICAgICAgICBjb25zdCByZWdpb24gPSBTdGFjay5vZihjbHVzdGVySW5mby5jbHVzdGVyKS5yZWdpb247XG5cbiAgICAgICAgLy8gQ3JlYXRlIHRoZSBwcmVmaXggbGlzdCBsb29rdXAgY3VzdG9tIHJlc291cmNlXG4gICAgICAgIGNvbnN0IHZwY0xhdHRpY2VQcmVmaXhMaXN0Q2FsbCA9IG5ldyBjdXN0b21SZXNvdXJjZXMuQXdzQ3VzdG9tUmVzb3VyY2UoY2x1c3RlckluZm8uY2x1c3Rlci5zdGFjaywgJ0dldFZwY0xhdHRpY2VQcmVmaXhMaXN0SURzJywge1xuICAgICAgICAgICAgcmVzb3VyY2VUeXBlOiAnQ3VzdG9tOjpHZXRWcGNMYXR0aWNlUHJlZml4TGlzdElEcycsXG4gICAgICAgICAgICBvblVwZGF0ZToge1xuICAgICAgICAgICAgICAgIHJlZ2lvbixcbiAgICAgICAgICAgICAgICBzZXJ2aWNlOiAnRUMyJyxcbiAgICAgICAgICAgICAgICBhY3Rpb246ICdkZXNjcmliZU1hbmFnZWRQcmVmaXhMaXN0cycsXG4gICAgICAgICAgICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICAgICAgICAgICAgICBGaWx0ZXJzOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgTmFtZTogJ3ByZWZpeC1saXN0LW5hbWUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFZhbHVlczogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgY29tLmFtYXpvbmF3cy4ke3JlZ2lvbn0udnBjLWxhdHRpY2VgLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgY29tLmFtYXpvbmF3cy4ke3JlZ2lvbn0uaXB2Ni52cGMtbGF0dGljZWBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHBoeXNpY2FsUmVzb3VyY2VJZDogY3VzdG9tUmVzb3VyY2VzLlBoeXNpY2FsUmVzb3VyY2VJZC5vZignR2V0VnBjTGF0dGljZVByZWZpeExpc3RJRHNGdW5jdGlvbicpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcG9saWN5OiBjdXN0b21SZXNvdXJjZXMuQXdzQ3VzdG9tUmVzb3VyY2VQb2xpY3kuZnJvbVNka0NhbGxzKHtcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IGN1c3RvbVJlc291cmNlcy5Bd3NDdXN0b21SZXNvdXJjZVBvbGljeS5BTllfUkVTT1VSQ0VcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEdldCB0aGUgcHJlZml4IGxpc3QgSURzIGZyb20gdGhlIGN1c3RvbSByZXNvdXJjZSByZXNwb25zZVxuICAgICAgICBjb25zdCBwcmVmaXhMaXN0SWRzID0gW1xuICAgICAgICAgICAgdnBjTGF0dGljZVByZWZpeExpc3RDYWxsLmdldFJlc3BvbnNlRmllbGQoJ1ByZWZpeExpc3RzLjAuUHJlZml4TGlzdElkJyksXG4gICAgICAgICAgICB2cGNMYXR0aWNlUHJlZml4TGlzdENhbGwuZ2V0UmVzcG9uc2VGaWVsZCgnUHJlZml4TGlzdHMuMS5QcmVmaXhMaXN0SWQnKSxcbiAgICAgICAgXTtcblxuICAgICAgICAvLyBBZGQgc2VjdXJpdHkgZ3JvdXAgcnVsZXMgZm9yIGVhY2ggcHJlZml4IGxpc3RcbiAgICAgICAgcHJlZml4TGlzdElkcy5mb3JFYWNoKHByZWZpeExpc3RJZCA9PiB7XG4gICAgICAgICAgICAvLyBBZGQgaW5ncmVzcyBydWxlXG4gICAgICAgICAgICBjbHVzdGVyU2cuYWRkSW5ncmVzc1J1bGUoXG4gICAgICAgICAgICAgICAgZWMyLlBlZXIucHJlZml4TGlzdChwcmVmaXhMaXN0SWQudG9TdHJpbmcoKSksXG4gICAgICAgICAgICAgICAgZWMyLlBvcnQuYWxsVHJhZmZpYygpLFxuICAgICAgICAgICAgICAgICdBbGxvdyBpbmJvdW5kIGZyb20gVlBDIExhdHRpY2UnXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAvLyBBZGQgZWdyZXNzIHJ1bGVcbiAgICAgICAgICAgIGNsdXN0ZXJTZy5hZGRFZ3Jlc3NSdWxlKFxuICAgICAgICAgICAgICAgIGVjMi5QZWVyLnByZWZpeExpc3QocHJlZml4TGlzdElkLnRvU3RyaW5nKCkpLFxuICAgICAgICAgICAgICAgIGVjMi5Qb3J0LmFsbFRyYWZmaWMoKSxcbiAgICAgICAgICAgICAgICAnQWxsb3cgb3V0Ym91bmQgdG8gVlBDIExhdHRpY2UnXG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdnBjTGF0dGljZVByZWZpeExpc3RDYWxsO1xuICAgIH1cblxuXG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2F3cy9hd3MtYXBwbGljYXRpb24tbmV0d29ya2luZy1rOHMvYmxvYi9tYWluL2ZpbGVzL2NvbnRyb2xsZXItaW5zdGFsbGF0aW9uL2RlcGxveS1uYW1lc3lzdGVtLnlhbWxcbiAgICBwcml2YXRlIGNyZWF0ZU5hbWVzcGFjZShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiBDb25zdHJ1Y3Qge1xuICAgICAgICByZXR1cm4gY2x1c3RlckluZm8uY2x1c3Rlci5hZGRNYW5pZmVzdCgnYXdzLWFwcGxpY2F0aW9uLW5ldHdvcmtpbmctc3lzdGVtLW5hbWVzcGFjZScsIHtcbiAgICAgICAgICAgIGFwaVZlcnNpb246ICd2MScsXG4gICAgICAgICAgICBraW5kOiAnTmFtZXNwYWNlJyxcbiAgICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICAgICAgbmFtZTogdGhpcy5vcHRpb25zLm5hbWVzcGFjZSxcbiAgICAgICAgICAgICAgICBsYWJlbHM6IHtcbiAgICAgICAgICAgICAgICAgICAgJ2NvbnRyb2wtcGxhbmUnOiAnZ2F0ZXdheS1hcGktY29udHJvbGxlcidcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MvYXdzLWFwcGxpY2F0aW9uLW5ldHdvcmtpbmctazhzL2Jsb2IvbWFpbi9maWxlcy9jb250cm9sbGVyLWluc3RhbGxhdGlvbi9yZWNvbW1lbmRlZC1pbmxpbmUtcG9saWN5Lmpzb25cbiAgICBwcml2YXRlIHNldHVwSWFtUGVybWlzc2lvbnMoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKSB7XG4gICAgICAgIGNvbnN0IGNsdXN0ZXIgPSBjbHVzdGVySW5mby5jbHVzdGVyO1xuXG4gICAgICAgIGNvbnN0IHNlcnZpY2VBY2NvdW50ID0gY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudChBV1NfR0FURVdBWV9BUElfQ09OVFJPTExFUl9TQSwge1xuICAgICAgICAgICAgbmFtZTogQVdTX0dBVEVXQVlfQVBJX0NPTlRST0xMRVJfU0EsXG4gICAgICAgICAgICBuYW1lc3BhY2U6IHRoaXMub3B0aW9ucy5uYW1lc3BhY2UsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGdldFZwY0xhdHRpY2VDb250cm9sbGVyUG9saWN5KCkuZm9yRWFjaCgoc3RhdGVtZW50KSA9PiB7XG4gICAgICAgICAgICBzZXJ2aWNlQWNjb3VudC5hZGRUb1ByaW5jaXBhbFBvbGljeShzdGF0ZW1lbnQpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gc2VydmljZUFjY291bnQ7XG4gICAgfVxuXG4gICAgLy8gU2V0cyBIZWxtIGFuZCBBV1MgR2F0ZXdheSBBUEkgQ29udHJvbGxlciBDb25maWd1cmF0aW9uIFxuICAgIC8vIGh0dHBzOi8vd3d3LmdhdGV3YXktYXBpLWNvbnRyb2xsZXIuZWtzLmF3cy5kZXYvbGF0ZXN0L2d1aWRlcy9lbnZpcm9ubWVudC9cbiAgICBwcml2YXRlIHBvcHVsYXRlVmFsdWVzKHNlcnZpY2VBY2NvdW50OiBTZXJ2aWNlQWNjb3VudCk6IFZhbHVlcyB7XG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IHRoaXMub3B0aW9ucy52YWx1ZXMgPz8ge307XG4gICAgICAgIHZhbHVlcy5zZXJ2aWNlQWNjb3VudCA9IHtcbiAgICAgICAgICAgIGNyZWF0ZTogZmFsc2UsXG4gICAgICAgICAgICBuYW1lOiBzZXJ2aWNlQWNjb3VudC5zZXJ2aWNlQWNjb3VudE5hbWVcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ0xldmVsKSB7XG4gICAgICAgICAgICB2YWx1ZXMubG9nTGV2ZWwgPSB0aGlzLm9wdGlvbnMubG9nTGV2ZWw7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmRlZmF1bHRTZXJ2aWNlTmV0d29yaykge1xuICAgICAgICAgICAgdmFsdWVzLmRlZmF1bHRTZXJ2aWNlTmV0d29yayA9IHRoaXMub3B0aW9ucy5kZWZhdWx0U2VydmljZU5ldHdvcms7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmVuYWJsZVNlcnZpY2VOZXR3b3JrT3ZlcnJpZGUpIHtcbiAgICAgICAgICAgIHZhbHVlcy5lbmFibGVTZXJ2aWNlTmV0d29ya092ZXJyaWRlID0gdGhpcy5vcHRpb25zLmVuYWJsZVNlcnZpY2VOZXR3b3JrT3ZlcnJpZGU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLndlYmhvb2tFbmFibGVkKSB7XG4gICAgICAgICAgICB2YWx1ZXMud2ViaG9va0VuYWJsZWQgPSB0aGlzLm9wdGlvbnMud2ViaG9va0VuYWJsZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmRpc2FibGVUYWdnaW5nU2VydmljZUFwaSkge1xuICAgICAgICAgICAgdmFsdWVzLmRpc2FibGVUYWdnaW5nU2VydmljZUFwaSA9IHRoaXMub3B0aW9ucy5kaXNhYmxlVGFnZ2luZ1NlcnZpY2VBcGk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJvdXRlTWF4Q29uY3VycmVudFJlY29uY2lsZXMpIHtcbiAgICAgICAgICAgIHZhbHVlcy5yb3V0ZU1heENvbmN1cnJlbnRSZWNvbmNpbGVzID0gdGhpcy5vcHRpb25zLnJvdXRlTWF4Q29uY3VycmVudFJlY29uY2lsZXM7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdmFsdWVzO1xuICAgIH1cblxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MvYXdzLWFwcGxpY2F0aW9uLW5ldHdvcmtpbmctazhzL2Jsb2IvbWFpbi9maWxlcy9jb250cm9sbGVyLWluc3RhbGxhdGlvbi9nYXRld2F5Y2xhc3MueWFtbFxuICAgIHByaXZhdGUgY3JlYXRlR2F0ZXdheUNsYXNzKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IENvbnN0cnVjdCB7XG4gICAgICAgIHJldHVybiBjbHVzdGVySW5mby5jbHVzdGVyLmFkZE1hbmlmZXN0KCd2cGMtbGF0dGljZS1nYXRld2F5LWNsYXNzJywge1xuICAgICAgICAgICAgYXBpVmVyc2lvbjogJ2dhdGV3YXkubmV0d29ya2luZy5rOHMuaW8vdjFiZXRhMScsXG4gICAgICAgICAgICBraW5kOiAnR2F0ZXdheUNsYXNzJyxcbiAgICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICAgICAgbmFtZTogJ2FtYXpvbi12cGMtbGF0dGljZSdcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzcGVjOiB7XG4gICAgICAgICAgICAgICAgY29udHJvbGxlck5hbWU6ICdhcHBsaWNhdGlvbi1uZXR3b3JraW5nLms4cy5hd3MvZ2F0ZXdheS1hcGktY29udHJvbGxlcidcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufSJdfQ==