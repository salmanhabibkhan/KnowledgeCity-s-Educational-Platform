"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CoreAddOn = exports.CoreAddOnProps = void 0;
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const utils_1 = require("../../utils");
const sdk = require("@aws-sdk/client-eks");
const aws_cdk_lib_1 = require("aws-cdk-lib");
class CoreAddOnProps {
}
exports.CoreAddOnProps = CoreAddOnProps;
const DEFAULT_NAMESPACE = "kube-system";
/**
 * Implementation of EKS Managed add-ons.
 */
class CoreAddOn {
    constructor(coreAddOnProps) {
        this.coreAddOnProps = coreAddOnProps;
        utils_1.userLog.debug(`Core add-on ${coreAddOnProps.addOnName} is at version ${coreAddOnProps.version}`);
    }
    async deploy(clusterInfo) {
        var _a;
        let serviceAccountRoleArn = undefined;
        let serviceAccount = undefined;
        let saNamespace = undefined;
        saNamespace = DEFAULT_NAMESPACE;
        if ((_a = this.coreAddOnProps) === null || _a === void 0 ? void 0 : _a.namespace) {
            saNamespace = this.coreAddOnProps.namespace;
        }
        const ns = this.createNamespace(clusterInfo, saNamespace);
        // Create a service account if user provides namespace, PolicyDocument
        const policies = this.provideManagedPolicies(clusterInfo);
        if (policies) {
            serviceAccount = this.createServiceAccount(clusterInfo, saNamespace, policies);
            serviceAccountRoleArn = serviceAccount.role.roleArn;
            if (ns) {
                serviceAccount.node.addDependency(ns);
            }
        }
        let version = this.coreAddOnProps.version;
        if (this.coreAddOnProps.version === "auto") {
            version = await this.provideVersion(clusterInfo.version, clusterInfo.cluster.stack.region);
        }
        let addOnProps = {
            addonName: this.coreAddOnProps.addOnName,
            addonVersion: version,
            configurationValues: JSON.stringify(this.coreAddOnProps.configurationValues),
            clusterName: clusterInfo.cluster.clusterName,
            serviceAccountRoleArn: serviceAccountRoleArn,
            resolveConflicts: "OVERWRITE"
        };
        const cfnAddon = new aws_eks_1.CfnAddon(clusterInfo.cluster.stack, this.coreAddOnProps.addOnName + "-addOn", addOnProps);
        if (serviceAccount) {
            cfnAddon.node.addDependency(serviceAccount);
        }
        else if (ns) {
            cfnAddon.node.addDependency(ns);
        }
        if (this.coreAddOnProps.controlPlaneAddOn) {
            (0, utils_1.deployBeforeCapacity)(cfnAddon, clusterInfo);
        }
        /**
         *  Retain the addon otherwise cluster destroy will fail due to CoreDnsComputeTypePatch
         *  https://github.com/aws/aws-cdk/issues/28621
         * */
        if (clusterInfo.cluster instanceof aws_eks_1.FargateCluster && this.coreAddOnProps.addOnName === "coredns") {
            cfnAddon.applyRemovalPolicy(aws_cdk_lib_1.RemovalPolicy.RETAIN_ON_UPDATE_OR_DELETE);
        }
        // Instantiate the Add-on
        return Promise.resolve(cfnAddon);
    }
    /**
     * Override this method to create namespace for the core addon. In many cases the addon is created in the kube-system namespace
     * which does not require creation as it is always there.
     * For addons that support other namespace as destinations this method should be implemented.
     * @param clusterInfo
     * @param name
     * @returns
     */
    createNamespace(_clusterInfo, _namespaceName) {
        return undefined;
    }
    /**
     * Override this method to control how service account is created.
     * @param clusterInfo
     * @param saNamespace
     * @param policies
     * @returns
     */
    createServiceAccount(clusterInfo, saNamespace, policies) {
        return (0, utils_1.createServiceAccountWithPolicy)(clusterInfo.cluster, this.coreAddOnProps.saName, saNamespace, ...policies);
    }
    /**
     * Template method with default implementation to execute the supplied function of policyDocumentProvider.
     * Allows overriding this method in subclasses for more complex cases of policies.
     * @param clusterInfo
     * @returns
     */
    providePolicyDocument(clusterInfo) {
        var _a;
        if ((_a = this.coreAddOnProps) === null || _a === void 0 ? void 0 : _a.policyDocumentProvider) {
            return this.coreAddOnProps.policyDocumentProvider(clusterInfo.cluster.stack.partition);
        }
        return undefined;
    }
    /**
     * Template method to return managed policies for the service account.
     * Allows overriding in subclasses to handle more complex cases of policies.
     */
    provideManagedPolicies(clusterInfo) {
        let result;
        const policyDocument = this.providePolicyDocument(clusterInfo);
        if (policyDocument) {
            const policy = new aws_iam_1.ManagedPolicy(clusterInfo.cluster, `${this.coreAddOnProps.addOnName}-managed-policy`, {
                document: policyDocument
            });
            result = [policy];
        }
        return result;
    }
    async provideVersion(clusterVersion, region) {
        var _a, _b;
        const client = new sdk.EKSClient({ region });
        const command = new sdk.DescribeAddonVersionsCommand({
            addonName: this.coreAddOnProps.addOnName,
            kubernetesVersion: clusterVersion.version
        });
        try {
            const response = await client.send(command);
            if (response.addons && response.addons.length > 0) {
                const defaultVersions = (_a = response.addons) === null || _a === void 0 ? void 0 : _a.flatMap(addon => {
                    var _a;
                    return (_a = addon.addonVersions) === null || _a === void 0 ? void 0 : _a.filter(version => { var _a; return (_a = version.compatibilities) === null || _a === void 0 ? void 0 : _a.some(compatibility => compatibility.defaultVersion === true); });
                });
                const version = (_b = defaultVersions[0]) === null || _b === void 0 ? void 0 : _b.addonVersion;
                if (!version) {
                    throw new Error(`No default version found for addo-on ${this.coreAddOnProps.addOnName}`);
                }
                utils_1.userLog.debug(`Core add-on ${this.coreAddOnProps.addOnName} has autoselected version ${version}`);
                return version;
            }
            else {
                throw new Error(`No add-on versions found for addon-on ${this.coreAddOnProps.addOnName}`);
            }
        }
        catch (error) {
            utils_1.logger.warn(error);
            utils_1.logger.warn(error);
            utils_1.logger.warn(`Failed to retrieve add-on versions from EKS for add-on ${this.coreAddOnProps.addOnName}.`);
            utils_1.logger.warn("Possible reasons for failures - Unauthorized or Authentication failure or Network failure on the terminal.");
            utils_1.logger.warn(" Falling back to default version.");
            let version = this.provideDefaultAutoVersion(clusterVersion);
            utils_1.userLog.debug(`Core add-on ${this.coreAddOnProps.addOnName} has autoselected version ${version}`);
            return version;
        }
    }
    provideDefaultAutoVersion(version) {
        var _a;
        const versionMap = this.coreAddOnProps.versionMap;
        if (versionMap && versionMap.size > 0) {
            return (_a = versionMap.get(version)) !== null && _a !== void 0 ? _a : versionMap.values().next().value;
        }
        throw new Error(`No default version found for add-on ${this.coreAddOnProps.addOnName}`);
    }
}
exports.CoreAddOn = CoreAddOn;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2NvcmUtYWRkb24vaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsaURBQStFO0FBSS9FLGlEQUFvRjtBQUVwRix1Q0FBc0c7QUFDdEcsMkNBQTJDO0FBQzNDLDZDQUE0QztBQUc1QyxNQUFhLGNBQWM7Q0FxQzFCO0FBckNELHdDQXFDQztBQUVELE1BQU0saUJBQWlCLEdBQUcsYUFBYSxDQUFDO0FBRXhDOztHQUVHO0FBQ0gsTUFBYSxTQUFTO0lBSWxCLFlBQVksY0FBOEI7UUFDdEMsSUFBSSxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUM7UUFDckMsZUFBTyxDQUFDLEtBQUssQ0FBQyxlQUFlLGNBQWMsQ0FBQyxTQUFTLGtCQUFrQixjQUFjLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUNyRyxDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUF3Qjs7UUFFakMsSUFBSSxxQkFBcUIsR0FBdUIsU0FBUyxDQUFDO1FBQzFELElBQUksY0FBYyxHQUErQixTQUFTLENBQUM7UUFDM0QsSUFBSSxXQUFXLEdBQXVCLFNBQVMsQ0FBQztRQUVoRCxXQUFXLEdBQUcsaUJBQWlCLENBQUM7UUFDaEMsSUFBSSxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLFNBQVMsRUFBRSxDQUFDO1lBQ2pDLFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQztRQUNoRCxDQUFDO1FBRUQsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFFMUQsc0VBQXNFO1FBQ3RFLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMxRCxJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ1gsY0FBYyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxX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LENBQUM7WUFDbEcsT0FBTyxPQUFPLENBQUM7UUFDbkIsQ0FBQztJQUNMLENBQUM7SUFFRCx5QkFBeUIsQ0FBQyxPQUEwQjs7UUFDaEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUM7UUFDbEQsSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLElBQUksR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNwQyxPQUFPLE1BQUEsVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsbUNBQUksVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDLEtBQU0sQ0FBQztRQUN4RSxDQUFDO1FBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyx1Q0FBdUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQzVGLENBQUM7Q0FDSjtBQTNLRCw4QkEyS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZm5BZGRvbiwgRmFyZ2F0ZUNsdXN0ZXIsIFNlcnZpY2VBY2NvdW50IH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1la3NcIjtcbmltcG9ydCB7IENsdXN0ZXJBZGRPbiB9IGZyb20gXCIuLi8uLlwiO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8sIFZhbHVlcyB9IGZyb20gXCIuLi8uLi9zcGlcIjtcbmltcG9ydCB7IENvbnN0cnVjdCwgSUNvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBJTWFuYWdlZFBvbGljeSwgTWFuYWdlZFBvbGljeSwgUG9saWN5RG9jdW1lbnQgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0IHsgS3ViZXJuZXRlc1ZlcnNpb24gfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVrc1wiO1xuaW1wb3J0IHsgY3JlYXRlU2VydmljZUFjY291bnRXaXRoUG9saWN5LCBkZXBsb3lCZWZvcmVDYXBhY2l0eSwgbG9nZ2VyLCB1c2VyTG9nLCAgfSBmcm9tIFwiLi4vLi4vdXRpbHNcIjtcbmltcG9ydCAqIGFzIHNkayBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LWVrc1wiO1xuaW1wb3J0IHsgUmVtb3ZhbFBvbGljeSB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuXG5cbmV4cG9ydCBjbGFzcyBDb3JlQWRkT25Qcm9wcyB7XG4gICAgLyoqXG4gICAgICogTmFtZSBvZiB0aGUgYWRkLW9uIHRvIGluc3RhbnRpYXRlXG4gICAgICovXG4gICAgcmVhZG9ubHkgYWRkT25OYW1lOiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogVmVyc2lvbiBvZiB0aGUgYWRkLW9uIHRvIHVzZS4gTXVzdCBtYXRjaCB0aGUgdmVyc2lvbiBvZiB0aGUgY2x1c3RlciB3aGVyZSBpdFxuICAgICAqIHdpbGwgYmUgZGVwbG95ZWQgaXRcbiAgICAgKi9cbiAgICByZWFkb25seSB2ZXJzaW9uOiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogUG9saWN5IGRvY3VtZW50IHByb3ZpZGVyIHJldHVybnMgdGhlIHBvbGljeSByZXF1aXJlZCBieSB0aGUgYWRkLW9uIHRvIGFsbG93IGl0IHRvIGludGVyYWN0IHdpdGggQVdTIHJlc291cmNlc1xuICAgICAqL1xuICAgIHJlYWRvbmx5IHBvbGljeURvY3VtZW50UHJvdmlkZXI/OiAocGFydGl0aW9uOiBzdHJpbmcpID0+IFBvbGljeURvY3VtZW50O1xuICAgIC8qKlxuICAgICAqIFNlcnZpY2UgQWNjb3VudCBOYW1lIHRvIGJlIHVzZWQgd2l0aCBBZGRPbi5cbiAgICAgKi9cbiAgICByZWFkb25seSBzYU5hbWU6IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBOYW1lc3BhY2UgdG8gY3JlYXRlIHRoZSBTZXJ2aWNlQWNjb3VudC5cbiAgICAgKi9cbiAgICByZWFkb25seSBuYW1lc3BhY2U/OiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogQ29uZmlndXJhdGlvblZhbHVlcyBmaWVsZCB0byBwYXNzIGN1c3RvbSBjb25maWd1cmF0aW9ucyB0byBBZGRvblxuICAgICAqL1xuICAgIHJlYWRvbmx5IGNvbmZpZ3VyYXRpb25WYWx1ZXM/OiBWYWx1ZXM7XG5cbiAgICAvKipcbiAgICAgKiBJbmRpY2F0ZXMgdGhhdCBhZGQtb24gbXVzdCBiZSBpbnN0YWxsZWQgYmVmb3JlIGFueSBjYXBhY2l0eSBpcyBhZGRlZCBmb3Igd29ya2VyIG5vZGVzIChpbmN1ZGluZyBGYXJnYXRlKS5cbiAgICAgKi9cbiAgICByZWFkb25seSBjb250cm9sUGxhbmVBZGRPbj86IGJvb2xlYW47XG5cblxuICAgIC8qKlxuICAgICAqIE1hcCBiZXR3ZWVuIGt1YmVybmV0ZXMgdmVyc2lvbnMgYW5kIGFkZE9uIHZlcnNpb25zIGZvciBhdXRvIHNlbGVjdGlvbi5cbiAgICAgKi9cbiAgICByZWFkb25seSB2ZXJzaW9uTWFwPzogTWFwPEt1YmVybmV0ZXNWZXJzaW9uLCBzdHJpbmc+O1xufVxuXG5jb25zdCBERUZBVUxUX05BTUVTUEFDRSA9IFwia3ViZS1zeXN0ZW1cIjtcblxuLyoqXG4gKiBJbXBsZW1lbnRhdGlvbiBvZiBFS1MgTWFuYWdlZCBhZGQtb25zLlxuICovXG5leHBvcnQgY2xhc3MgQ29yZUFkZE9uIGltcGxlbWVudHMgQ2x1c3RlckFkZE9uIHtcblxuICAgIHJlYWRvbmx5IGNvcmVBZGRPblByb3BzOiBDb3JlQWRkT25Qcm9wcztcblxuICAgIGNvbnN0cnVjdG9yKGNvcmVBZGRPblByb3BzOiBDb3JlQWRkT25Qcm9wcykge1xuICAgICAgICB0aGlzLmNvcmVBZGRPblByb3BzID0gY29yZUFkZE9uUHJvcHM7XG4gICAgICAgIHVzZXJMb2cuZGVidWcoYENvcmUgYWRkLW9uICR7Y29yZUFkZE9uUHJvcHMuYWRkT25OYW1lfSBpcyBhdCB2ZXJzaW9uICR7Y29yZUFkZE9uUHJvcHMudmVyc2lvbn1gKTtcbiAgICB9XG5cbiAgICBhc3luYyBkZXBsb3koY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHtcblxuICAgICAgICBsZXQgc2VydmljZUFjY291bnRSb2xlQXJuOiBzdHJpbmcgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBzZXJ2aWNlQWNjb3VudDogU2VydmljZUFjY291bnQgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBzYU5hbWVzcGFjZTogc3RyaW5nIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuXG4gICAgICAgIHNhTmFtZXNwYWNlID0gREVGQVVMVF9OQU1FU1BBQ0U7XG4gICAgICAgIGlmICh0aGlzLmNvcmVBZGRPblByb3BzPy5uYW1lc3BhY2UpIHtcbiAgICAgICAgICAgIHNhTmFtZXNwYWNlID0gdGhpcy5jb3JlQWRkT25Qcm9wcy5uYW1lc3BhY2U7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBucyA9IHRoaXMuY3JlYXRlTmFtZXNwYWNlKGNsdXN0ZXJJbmZvLCBzYU5hbWVzcGFjZSk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIGEgc2VydmljZSBhY2NvdW50IGlmIHVzZXIgcHJvdmlkZXMgbmFtZXNwYWNlLCBQb2xpY3lEb2N1bWVudFxuICAgICAgICBjb25zdCBwb2xpY2llcyA9IHRoaXMucHJvdmlkZU1hbmFnZWRQb2xpY2llcyhjbHVzdGVySW5mbyk7XG4gICAgICAgIGlmIChwb2xpY2llcykge1xuICAgICAgICAgICAgc2VydmljZUFjY291bnQgPSB0aGlzLmNyZWF0ZVNlcnZpY2VBY2NvdW50KGNsdXN0ZXJJbmZvLCBzYU5hbWVzcGFjZSwgcG9saWNpZXMpO1xuICAgICAgICAgICAgc2VydmljZUFjY291bnRSb2xlQXJuID0gc2VydmljZUFjY291bnQucm9sZS5yb2xlQXJuO1xuICAgICAgICAgICAgaWYobnMpIHtcbiAgICAgICAgICAgICAgICBzZXJ2aWNlQWNjb3VudC5ub2RlLmFkZERlcGVuZGVuY3kobnMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHZlcnNpb246IHN0cmluZyA9IHRoaXMuY29yZUFkZE9uUHJvcHMudmVyc2lvbjtcblxuICAgICAgICBpZiAodGhpcy5jb3JlQWRkT25Qcm9wcy52ZXJzaW9uID09PSBcImF1dG9cIikge1xuICAgICAgICAgICAgdmVyc2lvbiA9IGF3YWl0IHRoaXMucHJvdmlkZVZlcnNpb24oY2x1c3RlckluZm8udmVyc2lvbiwgY2x1c3RlckluZm8uY2x1c3Rlci5zdGFjay5yZWdpb24pO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFkZE9uUHJvcHMgPSB7XG4gICAgICAgICAgICBhZGRvbk5hbWU6IHRoaXMuY29yZUFkZE9uUHJvcHMuYWRkT25OYW1lLFxuICAgICAgICAgICAgYWRkb25WZXJzaW9uOiB2ZXJzaW9uLFxuICAgICAgICAgICAgY29uZmlndXJhdGlvblZhbHVlczogSlNPTi5zdHJpbmdpZnkodGhpcy5jb3JlQWRkT25Qcm9wcy5jb25maWd1cmF0aW9uVmFsdWVzKSxcbiAgICAgICAgICAgIGNsdXN0ZXJOYW1lOiBjbHVzdGVySW5mby5jbHVzdGVyLmNsdXN0ZXJOYW1lLFxuICAgICAgICAgICAgc2VydmljZUFjY291bnRSb2xlQXJuOiBzZXJ2aWNlQWNjb3VudFJvbGVBcm4sXG4gICAgICAgICAgICByZXNvbHZlQ29uZmxpY3RzOiBcIk9WRVJXUklURVwiXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgY2ZuQWRkb24gPSBuZXcgQ2ZuQWRkb24oY2x1c3RlckluZm8uY2x1c3Rlci5zdGFjaywgdGhpcy5jb3JlQWRkT25Qcm9wcy5hZGRPbk5hbWUgKyBcIi1hZGRPblwiLCBhZGRPblByb3BzKTtcbiAgICAgICAgaWYgKHNlcnZpY2VBY2NvdW50KSB7XG4gICAgICAgICAgICBjZm5BZGRvbi5ub2RlLmFkZERlcGVuZGVuY3koc2VydmljZUFjY291bnQpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYobnMpIHtcbiAgICAgICAgICAgIGNmbkFkZG9uLm5vZGUuYWRkRGVwZW5kZW5jeShucyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZih0aGlzLmNvcmVBZGRPblByb3BzLmNvbnRyb2xQbGFuZUFkZE9uKSB7XG4gICAgICAgICAgICBkZXBsb3lCZWZvcmVDYXBhY2l0eShjZm5BZGRvbiwgY2x1c3RlckluZm8pO1xuICAgICAgICB9XG4gICAgICAgIC8qKlxuICAgICAgICAgKiAgUmV0YWluIHRoZSBhZGRvbiBvdGhlcndpc2UgY2x1c3RlciBkZXN0cm95IHdpbGwgZmFpbCBkdWUgdG8gQ29yZURuc0NvbXB1dGVUeXBlUGF0Y2ggXG4gICAgICAgICAqICBodHRwczovL2dpdGh1Yi5jb20vYXdzL2F3cy1jZGsvaXNzdWVzLzI4NjIxXG4gICAgICAgICAqICovIFxuICAgICAgICBcbiAgICAgICAgaWYoY2x1c3RlckluZm8uY2x1c3RlciBpbnN0YW5jZW9mIEZhcmdhdGVDbHVzdGVyICYmIHRoaXMuY29yZUFkZE9uUHJvcHMuYWRkT25OYW1lID09PSBcImNvcmVkbnNcIil7XG4gICAgICAgICAgICBjZm5BZGRvbi5hcHBseVJlbW92YWxQb2xpY3koUmVtb3ZhbFBvbGljeS5SRVRBSU5fT05fVVBEQVRFX09SX0RFTEVURSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gSW5zdGFudGlhdGUgdGhlIEFkZC1vblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNmbkFkZG9uKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBjcmVhdGUgbmFtZXNwYWNlIGZvciB0aGUgY29yZSBhZGRvbi4gSW4gbWFueSBjYXNlcyB0aGUgYWRkb24gaXMgY3JlYXRlZCBpbiB0aGUga3ViZS1zeXN0ZW0gbmFtZXNwYWNlXG4gICAgICogd2hpY2ggZG9lcyBub3QgcmVxdWlyZSBjcmVhdGlvbiBhcyBpdCBpcyBhbHdheXMgdGhlcmUuIFxuICAgICAqIEZvciBhZGRvbnMgdGhhdCBzdXBwb3J0IG90aGVyIG5hbWVzcGFjZSBhcyBkZXN0aW5hdGlvbnMgdGhpcyBtZXRob2Qgc2hvdWxkIGJlIGltcGxlbWVudGVkLlxuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mbyBcbiAgICAgKiBAcGFyYW0gbmFtZSBcbiAgICAgKiBAcmV0dXJucyBcbiAgICAgKi9cbiAgICBjcmVhdGVOYW1lc3BhY2UoX2NsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgX25hbWVzcGFjZU5hbWU6IHN0cmluZyk6IElDb25zdHJ1Y3QgfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGNvbnRyb2wgaG93IHNlcnZpY2UgYWNjb3VudCBpcyBjcmVhdGVkLlxuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mbyBcbiAgICAgKiBAcGFyYW0gc2FOYW1lc3BhY2UgXG4gICAgICogQHBhcmFtIHBvbGljaWVzIFxuICAgICAqIEByZXR1cm5zIFxuICAgICAqL1xuICAgIGNyZWF0ZVNlcnZpY2VBY2NvdW50KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgc2FOYW1lc3BhY2U6IHN0cmluZywgcG9saWNpZXM6IElNYW5hZ2VkUG9saWN5W10pOiBTZXJ2aWNlQWNjb3VudCB7XG4gICAgICAgIHJldHVybiBjcmVhdGVTZXJ2aWNlQWNjb3VudFdpdGhQb2xpY3koY2x1c3RlckluZm8uY2x1c3RlciwgdGhpcy5jb3JlQWRkT25Qcm9wcy5zYU5hbWUsXG4gICAgICAgICAgICBzYU5hbWVzcGFjZSwgLi4ucG9saWNpZXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRlbXBsYXRlIG1ldGhvZCB3aXRoIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gdG8gZXhlY3V0ZSB0aGUgc3VwcGxpZWQgZnVuY3Rpb24gb2YgcG9saWN5RG9jdW1lbnRQcm92aWRlci5cbiAgICAgKiBBbGxvd3Mgb3ZlcnJpZGluZyB0aGlzIG1ldGhvZCBpbiBzdWJjbGFzc2VzIGZvciBtb3JlIGNvbXBsZXggY2FzZXMgb2YgcG9saWNpZXMuXG4gICAgICogQHBhcmFtIGNsdXN0ZXJJbmZvXG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBwcm92aWRlUG9saWN5RG9jdW1lbnQoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKSA6IFBvbGljeURvY3VtZW50IHwgdW5kZWZpbmVkIHtcbiAgICAgICAgaWYodGhpcy5jb3JlQWRkT25Qcm9wcz8ucG9saWN5RG9jdW1lbnRQcm92aWRlcikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29yZUFkZE9uUHJvcHMucG9saWN5RG9jdW1lbnRQcm92aWRlcihjbHVzdGVySW5mby5jbHVzdGVyLnN0YWNrLnBhcnRpdGlvbik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUZW1wbGF0ZSBtZXRob2QgdG8gcmV0dXJuIG1hbmFnZWQgcG9saWNpZXMgZm9yIHRoZSBzZXJ2aWNlIGFjY291bnQuXG4gICAgICogQWxsb3dzIG92ZXJyaWRpbmcgaW4gc3ViY2xhc3NlcyB0byBoYW5kbGUgbW9yZSBjb21wbGV4IGNhc2VzIG9mIHBvbGljaWVzLlxuICAgICAqL1xuICAgIHByb3ZpZGVNYW5hZ2VkUG9saWNpZXMoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKSA6IElNYW5hZ2VkUG9saWN5W10gfCB1bmRlZmluZWQge1xuICAgICAgICBsZXQgcmVzdWx0IDogSU1hbmFnZWRQb2xpY3lbXSB8IHVuZGVmaW5lZDtcbiAgICAgICAgY29uc3QgcG9saWN5RG9jdW1lbnQgPSB0aGlzLnByb3ZpZGVQb2xpY3lEb2N1bWVudChjbHVzdGVySW5mbyk7XG5cbiAgICAgICAgaWYocG9saWN5RG9jdW1lbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IHBvbGljeSA9IG5ldyBNYW5hZ2VkUG9saWN5KGNsdXN0ZXJJbmZvLmNsdXN0ZXIsIGAke3RoaXMuY29yZUFkZE9uUHJvcHMuYWRkT25OYW1lfS1tYW5hZ2VkLXBvbGljeWAsIHtcbiAgICAgICAgICAgICAgICBkb2N1bWVudDogcG9saWN5RG9jdW1lbnRcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmVzdWx0ID0gW3BvbGljeV07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBhc3luYyBwcm92aWRlVmVyc2lvbihjbHVzdGVyVmVyc2lvbjogS3ViZXJuZXRlc1ZlcnNpb24sIHJlZ2lvbjogc3RyaW5nKSA6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBzZGsuRUtTQ2xpZW50KHsgcmVnaW9uIH0pO1xuICAgICAgICBjb25zdCBjb21tYW5kID0gbmV3IHNkay5EZXNjcmliZUFkZG9uVmVyc2lvbnNDb21tYW5kKHtcbiAgICAgICAgICAgIGFkZG9uTmFtZTogdGhpcy5jb3JlQWRkT25Qcm9wcy5hZGRPbk5hbWUsXG4gICAgICAgICAgICBrdWJlcm5ldGVzVmVyc2lvbjogY2x1c3RlclZlcnNpb24udmVyc2lvblxuICAgICAgICB9KTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5hZGRvbnMgJiYgcmVzcG9uc2UuYWRkb25zLmxlbmd0aCA+IDApXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGVmYXVsdFZlcnNpb25zID0gcmVzcG9uc2UuYWRkb25zPy5mbGF0TWFwKGFkZG9uID0+XG4gICAgICAgICAgICAgICAgICAgIGFkZG9uLmFkZG9uVmVyc2lvbnM/LmZpbHRlcih2ZXJzaW9uID0+XG4gICAgICAgICAgICAgICAgICAgICAgdmVyc2lvbi5jb21wYXRpYmlsaXRpZXM/LnNvbWUoY29tcGF0aWJpbGl0eSA9PiBjb21wYXRpYmlsaXR5LmRlZmF1bHRWZXJzaW9uID09PSB0cnVlKVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHZlcnNpb246IHN0cmluZyB8IHVuZGVmaW5lZCA9IGRlZmF1bHRWZXJzaW9uc1swXT8uYWRkb25WZXJzaW9uO1xuICAgICAgICAgICAgICAgIGlmICghdmVyc2lvbikgeyBcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBkZWZhdWx0IHZlcnNpb24gZm91bmQgZm9yIGFkZG8tb24gJHt0aGlzLmNvcmVBZGRPblByb3BzLmFkZE9uTmFtZX1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdXNlckxvZy5kZWJ1ZyhgQ29yZSBhZGQtb24gJHt0aGlzLmNvcmVBZGRPblByb3BzLmFkZE9uTmFtZX0gaGFzIGF1dG9zZWxlY3RlZCB2ZXJzaW9uICR7dmVyc2lvbn1gKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdmVyc2lvbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gYWRkLW9uIHZlcnNpb25zIGZvdW5kIGZvciBhZGRvbi1vbiAke3RoaXMuY29yZUFkZE9uUHJvcHMuYWRkT25OYW1lfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgbG9nZ2VyLndhcm4oZXJyb3IpO1xuICAgICAgICAgICAgbG9nZ2VyLndhcm4oZXJyb3IpO1xuICAgICAgICAgICAgbG9nZ2VyLndhcm4oYEZhaWxlZCB0byByZXRyaWV2ZSBhZGQtb24gdmVyc2lvbnMgZnJvbSBFS1MgZm9yIGFkZC1vbiAke3RoaXMuY29yZUFkZE9uUHJvcHMuYWRkT25OYW1lfS5gKTtcbiAgICAgICAgICAgIGxvZ2dlci53YXJuKFwiUG9zc2libGUgcmVhc29ucyBmb3IgZmFpbHVyZXMgLSBVbmF1dGhvcml6ZWQgb3IgQXV0aGVudGljYXRpb24gZmFpbHVyZSBvciBOZXR3b3JrIGZhaWx1cmUgb24gdGhlIHRlcm1pbmFsLlwiKTtcbiAgICAgICAgICAgIGxvZ2dlci53YXJuKFwiIEZhbGxpbmcgYmFjayB0byBkZWZhdWx0IHZlcnNpb24uXCIpO1xuICAgICAgICAgICAgbGV0IHZlcnNpb246IHN0cmluZyA9IHRoaXMucHJvdmlkZURlZmF1bHRBdXRvVmVyc2lvbihjbHVzdGVyVmVyc2lvbik7XG4gICAgICAgICAgICB1c2VyTG9nLmRlYnVnKGBDb3JlIGFkZC1vbiAke3RoaXMuY29yZUFkZE9uUHJvcHMuYWRkT25OYW1lfSBoYXMgYXV0b3NlbGVjdGVkIHZlcnNpb24gJHt2ZXJzaW9ufWApO1xuICAgICAgICAgICAgcmV0dXJuIHZlcnNpb247XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm92aWRlRGVmYXVsdEF1dG9WZXJzaW9uKHZlcnNpb246IEt1YmVybmV0ZXNWZXJzaW9uKSA6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHZlcnNpb25NYXAgPSB0aGlzLmNvcmVBZGRPblByb3BzLnZlcnNpb25NYXA7XG4gICAgICAgIGlmICh2ZXJzaW9uTWFwICYmIHZlcnNpb25NYXAuc2l6ZSA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiB2ZXJzaW9uTWFwLmdldCh2ZXJzaW9uKSA/PyB2ZXJzaW9uTWFwLnZhbHVlcygpLm5leHQoKS52YWx1ZSE7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBkZWZhdWx0IHZlcnNpb24gZm91bmQgZm9yIGFkZC1vbiAke3RoaXMuY29yZUFkZE9uUHJvcHMuYWRkT25OYW1lfWApO1xuICAgIH1cbn1cbiJdfQ==