"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.FluxCDAddOn = void 0;
const ts_deepmerge_1 = require("ts-deepmerge");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
const gitrepository_1 = require("./gitrepository");
const kustomization_1 = require("./kustomization");
const bucket_1 = require("./bucket");
const aws_cdk_lib_1 = require("aws-cdk-lib");
/**
 * Default props to be used when creating the Helm chart.
 * Find the latest version using the GitHub CLI command:
 * `$ gh release  list --repo fluxcd-community/helm-charts`
 * or from the packages page:
 * @link https://github.com/fluxcd-community/helm-charts/pkgs/container/charts%2Fflux2
 */
const defaultProps = {
    name: "fluxcd-addon",
    namespace: "flux-system",
    chart: "flux2",
    version: "2.13.0",
    release: "blueprints-fluxcd-addon",
    repository: "oci://ghcr.io/fluxcd-community/charts/flux2",
    values: {},
    createNamespace: true,
};
const defaultRepoProps = {
    syncInterval: "5m0s",
};
const defaultBucketProps = {
    syncInterval: "5m0s",
    endpoint: "s3.amazonaws.com",
    provider: "aws",
};
const defaultKustomizationProps = {
    kustomizationPath: ".",
    syncInterval: "5m0s",
    prune: true,
    timeout: "1m",
};
/**
 * Main class to instantiate the Helm chart
 */
let FluxCDAddOn = class FluxCDAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a, _b;
        const cluster = clusterInfo.cluster;
        let values = (_a = this.options.values) !== null && _a !== void 0 ? _a : {};
        values = (0, ts_deepmerge_1.merge)(values, (_b = this.props.values) !== null && _b !== void 0 ? _b : {});
        const chart = this.addHelmChart(clusterInfo, values, false, true, aws_cdk_lib_1.Duration.minutes(15));
        if (this.options.createNamespace == true) {
            // Let CDK Create the Namespace
            const namespace = (0, utils_1.createNamespace)(this.options.namespace, cluster);
            chart.node.addDependency(namespace);
        }
        //Create GitRepository sources and Kustomizations
        if (this.options.repositories) {
            this.options.repositories.map((repo) => {
                repo = { ...defaultRepoProps, ...repo };
                const gitRepositoryConstruct = createGitRepository(clusterInfo, this.options.name, this.options.namespace, repo);
                gitRepositoryConstruct.node.addDependency(chart);
                const kustomizationConstructs = createKustomizations(clusterInfo, this.options.name, this.options.namespace, repo);
                kustomizationConstructs.map(kustomizationConstruct => kustomizationConstruct.node.addDependency(gitRepositoryConstruct));
            });
        }
        // Create Bucket sources and Kustomizations
        if (this.options.buckets) {
            this.options.buckets.map((bucket) => {
                bucket = { ...defaultBucketProps, ...bucket };
                const bucketConstruct = createBucket(clusterInfo, this.options.name, this.options.namespace, bucket);
                bucketConstruct.node.addDependency(chart);
                const kustomizationConstructs = createKustomizations(clusterInfo, this.options.name, this.options.namespace, bucket, "Bucket");
                kustomizationConstructs.map(kustomizationConstruct => kustomizationConstruct.node.addDependency(bucketConstruct));
            });
        }
        return Promise.resolve(chart);
    }
};
exports.FluxCDAddOn = FluxCDAddOn;
exports.FluxCDAddOn = FluxCDAddOn = __decorate([
    utils_1.supportsALL
], FluxCDAddOn);
/**
 * create GitRepository calls the FluxGitRepository().generate to create GitRepostory resource.
 */
function createGitRepository(clusterInfo, name, namespace, fluxGitRepo) {
    var _a;
    if (fluxGitRepo.repository === undefined) {
        throw new Error("Missing Git repository");
    }
    const manifest = new gitrepository_1.FluxGitRepository(fluxGitRepo.repository).generate(fluxGitRepo.name, (_a = fluxGitRepo.namespace) !== null && _a !== void 0 ? _a : namespace, fluxGitRepo.syncInterval, fluxGitRepo.secretRefName);
    let manifestName = name + 'gitrepository' + fluxGitRepo.name;
    const construct = clusterInfo.cluster.addManifest(manifestName, manifest);
    return construct;
}
/**
 * create Bucket calls the FluxBucket().generate to create Bucket resource.
 */
function createBucket(clusterInfo, name, namespace, props) {
    var _a;
    const manifest = new bucket_1.FluxBucket(props.bucketName, props.bucketRegion, props.prefixPath).generate(props.name, (_a = props.namespace) !== null && _a !== void 0 ? _a : namespace, props.syncInterval, props.provider, props.endpoint, props.secretRefName);
    let manifestName = name + 'bucketrepository' + props.name;
    return clusterInfo.cluster.addManifest(manifestName, manifest);
}
/**
 * create Kustomizations calls the FluxKustomization().generate multiple times to create Kustomization resources.
 */
function createKustomizations(clusterInfo, name, namespace, fluxSource, fluxSourceKind) {
    var _a;
    const constructs = [];
    const kustomizations = (_a = fluxSource.kustomizations) !== null && _a !== void 0 ? _a : [{ kustomizationPath: "." }];
    const fluxKustomization = new kustomization_1.FluxKustomization();
    kustomizations === null || kustomizations === void 0 ? void 0 : kustomizations.map((kustomization, index) => {
        var _a;
        kustomization = { ...defaultKustomizationProps, ...kustomization };
        const manifest = fluxKustomization.generate(fluxSource.name + "-" + index, fluxSource.name, (_a = fluxSource.namespace) !== null && _a !== void 0 ? _a : namespace, kustomization.syncInterval, kustomization.prune, kustomization.timeout, fluxSource.values || {}, kustomization.kustomizationPath, kustomization.kustomizationTargetNamespace, fluxSourceKind);
        let manifestName = name + 'kustomization' + fluxSource.name + index;
        constructs.push(clusterInfo.cluster.addManifest(manifestName, manifest));
    });
    return constructs;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2ZsdXhjZC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFFQSwrQ0FBcUM7QUFHckMsdUNBQTJEO0FBQzNELDhDQUE4RTtBQUM5RSxtREFBb0Q7QUFDcEQsbURBQW9EO0FBQ3BELHFDQUFzQztBQUV0Qyw2Q0FBdUM7QUFnS3ZDOzs7Ozs7R0FNRztBQUNILE1BQU0sWUFBWSxHQUFzQztJQUNwRCxJQUFJLEVBQUUsY0FBYztJQUNwQixTQUFTLEVBQUUsYUFBYTtJQUN4QixLQUFLLEVBQUUsT0FBTztJQUNkLE9BQU8sRUFBRSxRQUFRO0lBQ2pCLE9BQU8sRUFBRSx5QkFBeUI7SUFDbEMsVUFBVSxFQUFFLDZDQUE2QztJQUN6RCxNQUFNLEVBQUUsRUFBRTtJQUNWLGVBQWUsRUFBRSxJQUFJO0NBQ3hCLENBQUM7QUFFRixNQUFNLGdCQUFnQixHQUF5QjtJQUMzQyxZQUFZLEVBQUUsTUFBTTtDQUN2QixDQUFDO0FBRUYsTUFBTSxrQkFBa0IsR0FBNEI7SUFDaEQsWUFBWSxFQUFFLE1BQU07SUFDcEIsUUFBUSxFQUFFLGtCQUFrQjtJQUM1QixRQUFRLEVBQUUsS0FBSztDQUNsQixDQUFDO0FBRUYsTUFBTSx5QkFBeUIsR0FBMkI7SUFDdEQsaUJBQWlCLEVBQUUsR0FBRztJQUN0QixZQUFZLEVBQUUsTUFBTTtJQUNwQixLQUFLLEVBQUUsSUFBSTtJQUNYLE9BQU8sRUFBRSxJQUFJO0NBQ2hCLENBQUM7QUFFRjs7R0FFRztBQUVJLElBQU0sV0FBVyxHQUFqQixNQUFNLFdBQVksU0FBUSxzQkFBUztJQUl0QyxZQUFZLEtBQXdCO1FBQ2hDLEtBQUssQ0FBQyxFQUFDLEdBQUcsWUFBWSxFQUFFLEdBQUcsS0FBSyxFQUFDLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUF5QixDQUFDO0lBQ2xELENBQUM7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QUksR0FBRyxlQUFlLEdBQUcsVUFBVSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7UUFDeEYsVUFBVSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxZQUFhLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUM5RSxDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sVUFBVSxDQUFDO0FBQ3RCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBsaWIvZmx1eGNkX2FkZG9uLnRzXHJcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xyXG5pbXBvcnQgeyBtZXJnZSB9IGZyb20gXCJ0cy1kZWVwbWVyZ2VcIjtcclxuaW1wb3J0ICogYXMgc3BpIGZyb20gXCIuLi8uLi9zcGlcIjtcclxuaW1wb3J0IHsgQ2x1c3RlckluZm8sIFZhbHVlcyB9IGZyb20gXCIuLi8uLi9zcGlcIjtcclxuaW1wb3J0IHsgY3JlYXRlTmFtZXNwYWNlLCBzdXBwb3J0c0FMTCB9IGZyb20gXCIuLi8uLi91dGlsc1wiO1xyXG5pbXBvcnQgeyBIZWxtQWRkT24sIEhlbG1BZGRPblByb3BzLCBIZWxtQWRkT25Vc2VyUHJvcHMgfSBmcm9tIFwiLi4vaGVsbS1hZGRvblwiO1xyXG5pbXBvcnQgeyBGbHV4R2l0UmVwb3NpdG9yeSB9IGZyb20gXCIuL2dpdHJlcG9zaXRvcnlcIjtcclxuaW1wb3J0IHsgRmx1eEt1c3RvbWl6YXRpb24gfSBmcm9tIFwiLi9rdXN0b21pemF0aW9uXCI7XHJcbmltcG9ydCB7IEZsdXhCdWNrZXQgfSBmcm9tICcuL2J1Y2tldCc7XHJcbmltcG9ydCB7IEt1YmVybmV0ZXNNYW5pZmVzdCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1la3MvbGliL2s4cy1tYW5pZmVzdCc7XHJcbmltcG9ydCB7IER1cmF0aW9uIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XHJcblxyXG4vKipcclxuICogT3B0aW9ucyBmb3IgYSBGbHV4Q0QgR2l0UmVwb3NpdG9yeVxyXG4gKiBwYXRoIGFuZCBuYW1lIHBhcmFtZXRlciB3aXRoaW4gcmVwb3NpdG9yeSBwYXJhbWV0ZXIgZG8gbm90IGhhdmUgYW55IGFmZmVjdCBpbiBmbHV4LCBtYXkgaGF2ZSBhbiBhZmZlY3QgaW4gYXJnb1xyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBGbHV4R2l0UmVwbyBleHRlbmRzIFJlcXVpcmVkPHNwaS5HaXRPcHNBcHBsaWNhdGlvbkRlcGxveW1lbnQ+IHtcclxuICAgIC8qKiBcclxuICAgICAqIEZsdXggU2VjcmV0UmVmXHJcbiAgICAgKi9cclxuICAgIHNlY3JldFJlZk5hbWU/OiBzdHJpbmc7XHJcblxyXG4gICAgLyoqIFxyXG4gICAgICogSW50ZXJuYWwgZm9yIEZsdXggc3luYy5cclxuICAgICAqIERlZmF1bHQgYDVtMHNgXHJcbiAgICAgKi9cclxuICAgIHN5bmNJbnRlcnZhbD86IHN0cmluZztcclxuXHJcbiAgICAvKipcclxuICAgICAqIExpc3Qgb2Yga3VzdG9taXphdGlvbnMgdG8gY3JlYXRlIGZyb20gZGlmZmVyZW50IHBhdGhzIGluIHJlcG9cclxuICAgICAqL1xyXG4gICAga3VzdG9taXphdGlvbnM/OiBGbHV4S3VzdG9taXphdGlvblByb3BzW107XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBPcHRpb25zIGZvciBhIEZsdXhDRCBCdWNrZXQuXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIEZsdXhCdWNrZXRSZXBvIHtcclxuICAgIC8qKlxyXG4gICAgICogTmFtZSBvZiB0aGUgRmx1eENEIGJ1Y2tldCByZXNvdXJjZS5cclxuICAgICAqL1xyXG4gICAgbmFtZTogc3RyaW5nO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogTmFtZXNwYWNlIGZvciB0aGUgRmx1eENEIGJ1Y2tldCBzb3VyY2UgKG9wdGlvbmFsKVxyXG4gICAgICogRGVmYXVsdCBpcyB0aGUgY2hhcnQgbmFtZXNwYWNlXHJcbiAgICAgKi9cclxuICAgIG5hbWVzcGFjZT86IHN0cmluZztcclxuICAgIFxyXG4gICAgLyoqXHJcbiAgICAgKiBGbHV4IEt1c3RvbWl6YXRpb24gdmFyaWFibGUgc3Vic3RpdHV0aW9ucyAob3B0aW9uYWwpXHJcbiAgICAgKiB7QGxpbmsgaHR0cHM6Ly9mbHV4Y2QuaW8vZmx1eC9jb21wb25lbnRzL2t1c3RvbWl6ZS9rdXN0b21pemF0aW9ucy8jcG9zdC1idWlsZC12YXJpYWJsZS1zdWJzdGl0dXRpb259XHJcbiAgICAgKi9cclxuICAgIHZhbHVlcz86IFZhbHVlcztcclxuXHJcbiAgICAvKipcclxuICAgICAqIFNvdXJjZSBTMyBCdWNrZXQgbmFtZVxyXG4gICAgICovXHJcbiAgICBidWNrZXROYW1lOiBzdHJpbmc7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBQcmVmaXggcGF0aCB1c2VkIGZvciBzZXJ2ZXItc2lkZSBmaWx0ZXJpbmcgKG9wdGlvbmFsKVxyXG4gICAgICovXHJcbiAgICBwcmVmaXhQYXRoPzogc3RyaW5nO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogU291cmNlIFMzIEJ1Y2tldCByZWdpb25cclxuICAgICAqL1xyXG4gICAgYnVja2V0UmVnaW9uOiBzdHJpbmc7XHJcblxyXG4gICAgLyoqIFxyXG4gICAgICogUmVmZXJlbmNlcyB0byBhIFNlY3JldCBjb250YWluaW5nIGBhY2Nlc3NrZXlgIGFuZCBgc2VjcmV0a2V5YCBmaWVsZHMgdG8gYXV0aGVudGljYXRlIGFzIGFuIElBTSB1c2VyIChvcHRpb25hbCkgXHJcbiAgICAgKiBEZWZhdWx0IHRvIGF1dGhlbnRpY2F0aW9uIHVzaW5nIHRoZSBJQU0gaW5zdGFuY2UgcHJvZmlsZVxyXG4gICAgICovXHJcbiAgICBzZWNyZXRSZWZOYW1lPzogc3RyaW5nO1xyXG5cclxuICAgIC8qKiBcclxuICAgICAqIFN5bmNyb25pemF0aW9uIHRpbWUgaW50ZXJ2YWwgZm9yIEZsdXggc3luY1xyXG4gICAgICogRGVmYXVsdCBgNW0wc2BcclxuICAgICAqL1xyXG4gICAgc3luY0ludGVydmFsPzogc3RyaW5nO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogT3ZlcnJpZGUgUzMgQnVja2V0IGVuZHBvaW50IChvcHRpb25hbClcclxuICAgICAqIERlZmF1bHQgYHMzLmFtYXpvbmF3cy5jb21gXHJcbiAgICAgKi9cclxuICAgIGVuZHBvaW50Pzogc3RyaW5nO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogT3ZlcnJpZGUgUzMgQnVja2V0IHByb3ZpZGVyIChvcHRpb25hbClcclxuICAgICAqIERlZmF1bHQgYGF3c2BcclxuICAgICAqL1xyXG4gICAgcHJvdmlkZXI/OiBzdHJpbmc7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBMaXN0IG9mIGt1c3RvbWl6YXRpb25zIHRvIGNyZWF0ZSBmcm9tIGRpZmZlcmVudCBwYXRocyBpbiByZXBvIChvcHRpb25hbClcclxuICAgICAqL1xyXG4gICAga3VzdG9taXphdGlvbnM/OiBGbHV4S3VzdG9taXphdGlvblByb3BzW107XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRmx1eEt1c3RvbWl6YXRpb25Qcm9wcyB7XHJcbiAgICAvKipcclxuICAgICAqIEZsdXggS3VzdG9taXphdGlvbiBwYXRoIHdpdGhpbiB0aGUgR2l0UmVwb3NpdG9yeSBcclxuICAgICAqIERvIG5vdCB1c2UgdGhlIHBhdGggaW4gdGhlIHJlcG9zaXRvcnkgZmllbGRcclxuICAgICAqL1xyXG4gICAga3VzdG9taXphdGlvblBhdGg6IHN0cmluZztcclxuXHJcbiAgICAvKiogXHJcbiAgICAqIEZsdXggS3VzdG9taXphdGlvbiBUYXJnZXQgTmFtZXNwYWNlLlxyXG4gICAgKiBOb3RlOiB3aGVuIHNldCwgdGhpcyBwYXJhbWV0ZXIgd2lsbCBvdmVycmlkZSBhbGwgdGhlIG9iamVjdHMgdGhhdCBhcmUgcGFydCBvZiB0aGUgS3VzdG9taXphdGlvbiwgcGxlYXNlIHNlZSBodHRwczovL2ZsdXhjZC5pby9mbHV4L2NvbXBvbmVudHMva3VzdG9taXplL2t1c3RvbWl6YXRpb24vI3RhcmdldC1uYW1lc3BhY2VcclxuICAgICovXHJcbiAgICBrdXN0b21pemF0aW9uVGFyZ2V0TmFtZXNwYWNlPzogc3RyaW5nO1xyXG5cclxuICAgIC8qKiBcclxuICAgICogSW50ZXJuYWwgZm9yIEZsdXggc3luYy5cclxuICAgICogRGVmYXVsdCBgNW0wc2BcclxuICAgICovXHJcbiAgICBzeW5jSW50ZXJ2YWw/OiBzdHJpbmc7XHJcblxyXG4gICAgLyoqIFxyXG4gICAgKiBGbHV4IEt1c3RvbWl6YXRpb24gUHJ1bmUuXHJcbiAgICAqIERlZmF1bHQgYHRydWVgXHJcbiAgICAqL1xyXG4gICAgcHJ1bmU/OiBib29sZWFuO1xyXG5cclxuICAgIC8qKiBcclxuICAgICogRmx1eCBLdXN0b21pemF0aW9uIFRpbWVvdXQuXHJcbiAgICAqIERlZmF1bHQgYDFtYFxyXG4gICAgKi9cclxuICAgIHRpbWVvdXQ/OiBzdHJpbmc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBVc2VyIHByb3ZpZGVkIG9wdGlvbnMgZm9yIHRoZSBIZWxtIENoYXJ0XHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIEZsdXhDREFkZE9uUHJvcHMgZXh0ZW5kcyBIZWxtQWRkT25Vc2VyUHJvcHMge1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogTmFtZXNwYWNlIHdoZXJlIGFkZC1vbiB3aWxsIGJlIGRlcGxveWVkLiBcclxuICAgICAqIEBkZWZhdWx0IGZsdXgtc3lzdGVtXHJcbiAgICAgKi9cclxuICAgIG5hbWVzcGFjZT86IHN0cmluZztcclxuXHJcbiAgICAvKipcclxuICAgICAqIEhlbG0gY2hhcnQgdmVyc2lvbiB0byB1c2UgdG8gaW5zdGFsbC5cclxuICAgICAqIEBkZWZhdWx0IDIuMTMuMFxyXG4gICAgICovXHJcbiAgICB2ZXJzaW9uPzogc3RyaW5nO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogVmFsdWVzIHRvIHBhc3MgdG8gdGhlIGNoYXJ0IGFzIHBlciBodHRwczovL2dpdGh1Yi5jb20vYXJnb3Byb2ovYXJnby1oZWxtL2Jsb2IvbWFzdGVyL2NoYXJ0cy9hcmdvLWNkL3ZhbHVlcy55YW1sLlxyXG4gICAgICovXHJcbiAgICB2YWx1ZXM/OiBzcGkuVmFsdWVzO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogVG8gQ3JlYXRlIE5hbWVzcGFjZSB1c2luZyBDREtcclxuICAgICAqLyAgICBcclxuICAgIGNyZWF0ZU5hbWVzcGFjZT86IGJvb2xlYW47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBMaXN0IG9mIHJlcG9zaXRvcmllcyB0byBzeW5jIGZyb20uXHJcbiAgICAgKi9cclxuICAgIHJlcG9zaXRvcmllcz86IEZsdXhHaXRSZXBvW107XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBMaXN0IG9mIGJ1Y2tldHMgdG8gc3luYyBmcm9tLlxyXG4gICAgICovXHJcbiAgICBidWNrZXRzPzogRmx1eEJ1Y2tldFJlcG9bXTtcclxufVxyXG5cclxuLyoqXHJcbiAqIERlZmF1bHQgcHJvcHMgdG8gYmUgdXNlZCB3aGVuIGNyZWF0aW5nIHRoZSBIZWxtIGNoYXJ0LlxyXG4gKiBGaW5kIHRoZSBsYXRlc3QgdmVyc2lvbiB1c2luZyB0aGUgR2l0SHViIENMSSBjb21tYW5kOlxyXG4gKiBgJCBnaCByZWxlYXNlICBsaXN0IC0tcmVwbyBmbHV4Y2QtY29tbXVuaXR5L2hlbG0tY2hhcnRzYFxyXG4gKiBvciBmcm9tIHRoZSBwYWNrYWdlcyBwYWdlOlxyXG4gKiBAbGluayBodHRwczovL2dpdGh1Yi5jb20vZmx1eGNkLWNvbW11bml0eS9oZWxtLWNoYXJ0cy9wa2dzL2NvbnRhaW5lci9jaGFydHMlMkZmbHV4MlxyXG4gKi9cclxuY29uc3QgZGVmYXVsdFByb3BzOiBIZWxtQWRkT25Qcm9wcyAmIEZsdXhDREFkZE9uUHJvcHMgPSB7XHJcbiAgICBuYW1lOiBcImZsdXhjZC1hZGRvblwiLFxyXG4gICAgbmFtZXNwYWNlOiBcImZsdXgtc3lzdGVtXCIsXHJcbiAgICBjaGFydDogXCJmbHV4MlwiLFxyXG4gICAgdmVyc2lvbjogXCIyLjEzLjBcIixcclxuICAgIHJlbGVhc2U6IFwiYmx1ZXByaW50cy1mbHV4Y2QtYWRkb25cIixcclxuICAgIHJlcG9zaXRvcnk6IFwib2NpOi8vZ2hjci5pby9mbHV4Y2QtY29tbXVuaXR5L2NoYXJ0cy9mbHV4MlwiLFxyXG4gICAgdmFsdWVzOiB7fSxcclxuICAgIGNyZWF0ZU5hbWVzcGFjZTogdHJ1ZSxcclxufTtcclxuXHJcbmNvbnN0IGRlZmF1bHRSZXBvUHJvcHM6IFBhcnRpYWw8Rmx1eEdpdFJlcG8+ID0ge1xyXG4gICAgc3luY0ludGVydmFsOiBcIjVtMHNcIixcclxufTtcclxuXHJcbmNvbnN0IGRlZmF1bHRCdWNrZXRQcm9wczogUGFydGlhbDxGbHV4QnVja2V0UmVwbz4gPSB7XHJcbiAgICBzeW5jSW50ZXJ2YWw6IFwiNW0wc1wiLFxyXG4gICAgZW5kcG9pbnQ6IFwiczMuYW1hem9uYXdzLmNvbVwiLFxyXG4gICAgcHJvdmlkZXI6IFwiYXdzXCIsXHJcbn07XHJcblxyXG5jb25zdCBkZWZhdWx0S3VzdG9taXphdGlvblByb3BzOiBGbHV4S3VzdG9taXphdGlvblByb3BzID0ge1xyXG4gICAga3VzdG9taXphdGlvblBhdGg6IFwiLlwiLFxyXG4gICAgc3luY0ludGVydmFsOiBcIjVtMHNcIixcclxuICAgIHBydW5lOiB0cnVlLFxyXG4gICAgdGltZW91dDogXCIxbVwiLFxyXG59O1xyXG5cclxuLyoqXHJcbiAqIE1haW4gY2xhc3MgdG8gaW5zdGFudGlhdGUgdGhlIEhlbG0gY2hhcnRcclxuICovXHJcbkBzdXBwb3J0c0FMTFxyXG5leHBvcnQgY2xhc3MgRmx1eENEQWRkT24gZXh0ZW5kcyBIZWxtQWRkT24ge1xyXG5cclxuICAgIHJlYWRvbmx5IG9wdGlvbnM6IEZsdXhDREFkZE9uUHJvcHM7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJvcHM/OiBGbHV4Q0RBZGRPblByb3BzKSB7XHJcbiAgICAgICAgc3VwZXIoey4uLmRlZmF1bHRQcm9wcywgLi4ucHJvcHN9KTtcclxuICAgICAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLnByb3BzIGFzIEZsdXhDREFkZE9uUHJvcHM7XHJcbiAgICB9XHJcblxyXG4gICAgZGVwbG95KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IFByb21pc2U8Q29uc3RydWN0PiB7XHJcbiAgICAgICAgY29uc3QgY2x1c3RlciA9IGNsdXN0ZXJJbmZvLmNsdXN0ZXI7XHJcbiAgICAgICAgbGV0IHZhbHVlczogVmFsdWVzID0gdGhpcy5vcHRpb25zLnZhbHVlcyA/PyB7fTtcclxuICAgICAgICB2YWx1ZXMgPSBtZXJnZSh2YWx1ZXMsIHRoaXMucHJvcHMudmFsdWVzID8/IHt9KTtcclxuICAgICAgICBjb25zdCBjaGFydCA9IHRoaXMuYWRkSGVsbUNoYXJ0KGNsdXN0ZXJJbmZvLCB2YWx1ZXMsIGZhbHNlLCB0cnVlLCBEdXJhdGlvbi5taW51dGVzKDE1KSk7XHJcblxyXG4gICAgICAgIGlmKCB0aGlzLm9wdGlvbnMuY3JlYXRlTmFtZXNwYWNlID09IHRydWUpe1xyXG4gICAgICAgICAgICAvLyBMZXQgQ0RLIENyZWF0ZSB0aGUgTmFtZXNwYWNlXHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWVzcGFjZSA9IGNyZWF0ZU5hbWVzcGFjZSh0aGlzLm9wdGlvbnMubmFtZXNwYWNlISAsIGNsdXN0ZXIpO1xyXG4gICAgICAgICAgICBjaGFydC5ub2RlLmFkZERlcGVuZGVuY3kobmFtZXNwYWNlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vQ3JlYXRlIEdpdFJlcG9zaXRvcnkgc291cmNlcyBhbmQgS3VzdG9taXphdGlvbnNcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJlcG9zaXRvcmllcykge1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMucmVwb3NpdG9yaWVzLm1hcCgocmVwbykgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmVwbyA9IHsuLi5kZWZhdWx0UmVwb1Byb3BzLCAuLi5yZXBvfTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGdpdFJlcG9zaXRvcnlDb25zdHJ1Y3QgPSBjcmVhdGVHaXRSZXBvc2l0b3J5KGNsdXN0ZXJJbmZvLCB0aGlzLm9wdGlvbnMubmFtZSEsIHRoaXMub3B0aW9ucy5uYW1lc3BhY2UhLCByZXBvKTtcclxuICAgICAgICAgICAgICAgIGdpdFJlcG9zaXRvcnlDb25zdHJ1Y3Qubm9kZS5hZGREZXBlbmRlbmN5KGNoYXJ0KTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBrdXN0b21pemF0aW9uQ29uc3RydWN0cyA9IGNyZWF0ZUt1c3RvbWl6YXRpb25zKGNsdXN0ZXJJbmZvLCB0aGlzLm9wdGlvbnMubmFtZSEsIHRoaXMub3B0aW9ucy5uYW1lc3BhY2UhLCByZXBvKTtcclxuICAgICAgICAgICAgICAgIGt1c3RvbWl6YXRpb25Db25zdHJ1Y3RzLm1hcChrdXN0b21pemF0aW9uQ29uc3RydWN0ID0+IGt1c3RvbWl6YXRpb25Db25zdHJ1Y3Qubm9kZS5hZGREZXBlbmRlbmN5KGdpdFJlcG9zaXRvcnlDb25zdHJ1Y3QpKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBDcmVhdGUgQnVja2V0IHNvdXJjZXMgYW5kIEt1c3RvbWl6YXRpb25zXHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5idWNrZXRzKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5idWNrZXRzLm1hcCgoYnVja2V0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBidWNrZXQgPSB7Li4uZGVmYXVsdEJ1Y2tldFByb3BzLCAuLi5idWNrZXR9O1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYnVja2V0Q29uc3RydWN0ID0gY3JlYXRlQnVja2V0KGNsdXN0ZXJJbmZvLCB0aGlzLm9wdGlvbnMubmFtZSEsIHRoaXMub3B0aW9ucy5uYW1lc3BhY2UhLCBidWNrZXQpO1xyXG4gICAgICAgICAgICAgICAgYnVja2V0Q29uc3RydWN0Lm5vZGUuYWRkRGVwZW5kZW5jeShjaGFydCk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qga3VzdG9taXphdGlvbkNvbnN0cnVjdHMgPSBjcmVhdGVLdXN0b21pemF0aW9ucyhjbHVzdGVySW5mbywgdGhpcy5vcHRpb25zLm5hbWUhLCB0aGlzLm9wdGlvbnMubmFtZXNwYWNlISwgYnVja2V0LCBcIkJ1Y2tldFwiKTtcclxuICAgICAgICAgICAgICAgIGt1c3RvbWl6YXRpb25Db25zdHJ1Y3RzLm1hcChrdXN0b21pemF0aW9uQ29uc3RydWN0ID0+IGt1c3RvbWl6YXRpb25Db25zdHJ1Y3Qubm9kZS5hZGREZXBlbmRlbmN5KGJ1Y2tldENvbnN0cnVjdCkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2hhcnQpO1xyXG4gICAgfVxyXG59XHJcblxyXG4vKipcclxuICogY3JlYXRlIEdpdFJlcG9zaXRvcnkgY2FsbHMgdGhlIEZsdXhHaXRSZXBvc2l0b3J5KCkuZ2VuZXJhdGUgdG8gY3JlYXRlIEdpdFJlcG9zdG9yeSByZXNvdXJjZS5cclxuICovXHJcbmZ1bmN0aW9uIGNyZWF0ZUdpdFJlcG9zaXRvcnkoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvLCBuYW1lOiBzdHJpbmcsIG5hbWVzcGFjZTogc3RyaW5nLCBmbHV4R2l0UmVwbzogRmx1eEdpdFJlcG8pOiBLdWJlcm5ldGVzTWFuaWZlc3Qge1xyXG4gICAgaWYgKGZsdXhHaXRSZXBvLnJlcG9zaXRvcnkgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIk1pc3NpbmcgR2l0IHJlcG9zaXRvcnlcIik7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbWFuaWZlc3QgPSBuZXcgRmx1eEdpdFJlcG9zaXRvcnkoZmx1eEdpdFJlcG8ucmVwb3NpdG9yeSkuZ2VuZXJhdGUoXHJcbiAgICAgICAgZmx1eEdpdFJlcG8ubmFtZSxcclxuICAgICAgICBmbHV4R2l0UmVwby5uYW1lc3BhY2UgPz8gbmFtZXNwYWNlLFxyXG4gICAgICAgIGZsdXhHaXRSZXBvLnN5bmNJbnRlcnZhbCEsXHJcbiAgICAgICAgZmx1eEdpdFJlcG8uc2VjcmV0UmVmTmFtZSEpO1xyXG4gICAgbGV0IG1hbmlmZXN0TmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkID0gbmFtZSArICdnaXRyZXBvc2l0b3J5JyArIGZsdXhHaXRSZXBvLm5hbWU7XHJcbiAgICBjb25zdCBjb25zdHJ1Y3QgPSBjbHVzdGVySW5mby5jbHVzdGVyLmFkZE1hbmlmZXN0KG1hbmlmZXN0TmFtZSEsIG1hbmlmZXN0KTtcclxuICAgIHJldHVybiBjb25zdHJ1Y3Q7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBjcmVhdGUgQnVja2V0IGNhbGxzIHRoZSBGbHV4QnVja2V0KCkuZ2VuZXJhdGUgdG8gY3JlYXRlIEJ1Y2tldCByZXNvdXJjZS5cclxuICovXHJcbmZ1bmN0aW9uIGNyZWF0ZUJ1Y2tldChjbHVzdGVySW5mbzogQ2x1c3RlckluZm8sIG5hbWU6IHN0cmluZywgbmFtZXNwYWNlOiBzdHJpbmcsIHByb3BzOiBGbHV4QnVja2V0UmVwbyk6IEt1YmVybmV0ZXNNYW5pZmVzdCB7XHJcbiAgICBjb25zdCBtYW5pZmVzdCA9IG5ldyBGbHV4QnVja2V0KHByb3BzLmJ1Y2tldE5hbWUsIHByb3BzLmJ1Y2tldFJlZ2lvbiwgcHJvcHMucHJlZml4UGF0aCkuZ2VuZXJhdGUoXHJcbiAgICAgICAgcHJvcHMubmFtZSxcclxuICAgICAgICBwcm9wcy5uYW1lc3BhY2UgPz8gbmFtZXNwYWNlLFxyXG4gICAgICAgIHByb3BzLnN5bmNJbnRlcnZhbCEsXHJcbiAgICAgICAgcHJvcHMucHJvdmlkZXIhLFxyXG4gICAgICAgIHByb3BzLmVuZHBvaW50ISxcclxuICAgICAgICBwcm9wcy5zZWNyZXRSZWZOYW1lISk7XHJcbiAgICBsZXQgbWFuaWZlc3ROYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBuYW1lICsgJ2J1Y2tldHJlcG9zaXRvcnknICsgcHJvcHMubmFtZTtcclxuICAgIHJldHVybiBjbHVzdGVySW5mby5jbHVzdGVyLmFkZE1hbmlmZXN0KG1hbmlmZXN0TmFtZSEsIG1hbmlmZXN0KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIGNyZWF0ZSBLdXN0b21pemF0aW9ucyBjYWxscyB0aGUgRmx1eEt1c3RvbWl6YXRpb24oKS5nZW5lcmF0ZSBtdWx0aXBsZSB0aW1lcyB0byBjcmVhdGUgS3VzdG9taXphdGlvbiByZXNvdXJjZXMuXHJcbiAqL1xyXG5mdW5jdGlvbiBjcmVhdGVLdXN0b21pemF0aW9ucyhjbHVzdGVySW5mbzogQ2x1c3RlckluZm8sIG5hbWU6IHN0cmluZywgbmFtZXNwYWNlOiBzdHJpbmcsIGZsdXhTb3VyY2U6IEZsdXhHaXRSZXBvIHwgRmx1eEJ1Y2tldFJlcG8sIGZsdXhTb3VyY2VLaW5kPzogc3RyaW5nKTogS3ViZXJuZXRlc01hbmlmZXN0W10ge1xyXG4gICAgY29uc3QgY29uc3RydWN0czogS3ViZXJuZXRlc01hbmlmZXN0W10gPSBbXTtcclxuICAgIGNvbnN0IGt1c3RvbWl6YXRpb25zID0gZmx1eFNvdXJjZS5rdXN0b21pemF0aW9ucyA/PyBbe2t1c3RvbWl6YXRpb25QYXRoOiBcIi5cIn1dO1xyXG4gICAgY29uc3QgZmx1eEt1c3RvbWl6YXRpb24gPSBuZXcgRmx1eEt1c3RvbWl6YXRpb24oKTtcclxuICAgIGt1c3RvbWl6YXRpb25zPy5tYXAoKGt1c3RvbWl6YXRpb24sIGluZGV4KSA9PiB7XHJcbiAgICAgICAga3VzdG9taXphdGlvbiA9IHsuLi5kZWZhdWx0S3VzdG9taXphdGlvblByb3BzLCAuLi5rdXN0b21pemF0aW9ufTtcclxuICAgICAgICBjb25zdCBtYW5pZmVzdCA9IGZsdXhLdXN0b21pemF0aW9uLmdlbmVyYXRlKFxyXG4gICAgICAgICAgICBmbHV4U291cmNlLm5hbWUgKyBcIi1cIiArIGluZGV4LFxyXG4gICAgICAgICAgICBmbHV4U291cmNlLm5hbWUsXHJcbiAgICAgICAgICAgIGZsdXhTb3VyY2UubmFtZXNwYWNlID8/IG5hbWVzcGFjZSxcclxuICAgICAgICAgICAga3VzdG9taXphdGlvbi5zeW5jSW50ZXJ2YWwhLFxyXG4gICAgICAgICAgICBrdXN0b21pemF0aW9uLnBydW5lISxcclxuICAgICAgICAgICAga3VzdG9taXphdGlvbi50aW1lb3V0ISxcclxuICAgICAgICAgICAgZmx1eFNvdXJjZS52YWx1ZXMgfHwge30sXHJcbiAgICAgICAgICAgIGt1c3RvbWl6YXRpb24ua3VzdG9taXphdGlvblBhdGgsXHJcbiAgICAgICAgICAgIGt1c3RvbWl6YXRpb24ua3VzdG9taXphdGlvblRhcmdldE5hbWVzcGFjZSxcclxuICAgICAgICAgICAgZmx1eFNvdXJjZUtpbmQsXHJcbiAgICAgICAgKTtcclxuICAgICAgICBsZXQgbWFuaWZlc3ROYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBuYW1lICsgJ2t1c3RvbWl6YXRpb24nICsgZmx1eFNvdXJjZS5uYW1lICsgaW5kZXg7XHJcbiAgICAgICAgY29uc3RydWN0cy5wdXNoKGNsdXN0ZXJJbmZvLmNsdXN0ZXIuYWRkTWFuaWZlc3QobWFuaWZlc3ROYW1lISwgbWFuaWZlc3QpKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBjb25zdHJ1Y3RzO1xyXG59XHJcbiJdfQ==