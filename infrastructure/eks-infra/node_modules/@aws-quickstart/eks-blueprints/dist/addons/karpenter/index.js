"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __exportStar = (this && this.__exportStar) || function(m, exports) {
    for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.KarpenterAddOn = void 0;
const assert = require("assert");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const aws_events_1 = require("aws-cdk-lib/aws-events");
const aws_events_targets_1 = require("aws-cdk-lib/aws-events-targets");
const iam = require("aws-cdk-lib/aws-iam");
const sqs = require("aws-cdk-lib/aws-sqs");
const semver = require("semver");
const ts_deepmerge_1 = require("ts-deepmerge");
const md5 = require("ts-md5");
const utils = require("../../utils");
const helm_addon_1 = require("../helm-addon");
const iam_1 = require("./iam");
const types_1 = require("./types");
__exportStar(require("./types"), exports);
__exportStar(require("./karpenter-v1"), exports);
class versionMap {
    static has(version) {
        return this.versionMap.has(version.version);
    }
    static get(version) {
        return this.versionMap.get(version.version);
    }
}
versionMap.versionMap = new Map([
    [aws_eks_1.KubernetesVersion.V1_32.version, '1.2.0'],
    [aws_eks_1.KubernetesVersion.V1_31.version, '0.37.5'],
    [aws_eks_1.KubernetesVersion.V1_30.version, '0.37.5'],
    [aws_eks_1.KubernetesVersion.V1_29.version, '0.34.0'],
    [aws_eks_1.KubernetesVersion.V1_28.version, '0.31.0'],
    [aws_eks_1.KubernetesVersion.V1_27.version, '0.28.0'],
    [aws_eks_1.KubernetesVersion.V1_26.version, '0.28.0'],
    [aws_eks_1.KubernetesVersion.V1_25.version, '0.25.0'],
    [aws_eks_1.KubernetesVersion.V1_24.version, '0.21.0'],
    [aws_eks_1.KubernetesVersion.V1_23.version, '0.21.0'],
]);
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    name: types_1.KARPENTER,
    namespace: "kube-system",
    version: '1.2.1',
    chart: types_1.KARPENTER,
    release: types_1.KARPENTER,
    repository: 'oci://public.ecr.aws/karpenter/karpenter',
};
/**
 * Implementation of the Karpenter add-on.
 * @deprecated use KarpenterV1AddOn moving forward
 */
let KarpenterAddOn = class KarpenterAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x, _y, _z, _0, _1, _2, _3, _4;
        assert(clusterInfo.cluster instanceof aws_eks_1.Cluster, "KarpenterAddOn cannot be used with imported clusters as it requires changes to the cluster authentication.");
        const cluster = clusterInfo.cluster;
        const endpoint = cluster.clusterEndpoint;
        const name = cluster.clusterName;
        const partition = cluster.stack.partition;
        const stackName = cluster.stack.stackName;
        const region = cluster.stack.region;
        let values = (_a = this.options.values) !== null && _a !== void 0 ? _a : {};
        const version = this.options.version;
        const interruption = this.options.interruptionHandling || false;
        const installCRDs = this.options.installCRDs || false;
        const podIdentity = this.options.podIdentity || false;
        // NodePool variables
        const labels = ((_b = this.options.nodePoolSpec) === null || _b === void 0 ? void 0 : _b.labels) || {};
        const annotations = ((_c = this.options.nodePoolSpec) === null || _c === void 0 ? void 0 : _c.annotations) || {};
        const taints = ((_d = this.options.nodePoolSpec) === null || _d === void 0 ? void 0 : _d.taints) || [];
        const startupTaints = ((_e = this.options.nodePoolSpec) === null || _e === void 0 ? void 0 : _e.startupTaints) || [];
        const requirements = ((_f = this.options.nodePoolSpec) === null || _f === void 0 ? void 0 : _f.requirements) || [];
        const consol = ((_g = this.options.nodePoolSpec) === null || _g === void 0 ? void 0 : _g.consolidation) || null;
        const ttlSecondsAfterEmpty = ((_h = this.options.nodePoolSpec) === null || _h === void 0 ? void 0 : _h.ttlSecondsAfterEmpty) || null;
        const ttlSecondsUntilExpired = ((_j = this.options.nodePoolSpec) === null || _j === void 0 ? void 0 : _j.ttlSecondsUntilExpired) || null;
        const disruption = ((_k = this.options.nodePoolSpec) === null || _k === void 0 ? void 0 : _k.disruption) || null;
        const limits = ((_l = this.options.nodePoolSpec) === null || _l === void 0 ? void 0 : _l.limits) || null;
        const weight = ((_m = this.options.nodePoolSpec) === null || _m === void 0 ? void 0 : _m.weight) || null;
        // NodeClass variables
        const subnetSelector = (_o = this.options.ec2NodeClassSpec) === null || _o === void 0 ? void 0 : _o.subnetSelector;
        const sgSelector = (_p = this.options.ec2NodeClassSpec) === null || _p === void 0 ? void 0 : _p.securityGroupSelector;
        const subnetSelectorTerms = (_q = this.options.ec2NodeClassSpec) === null || _q === void 0 ? void 0 : _q.subnetSelectorTerms;
        const sgSelectorTerms = (_r = this.options.ec2NodeClassSpec) === null || _r === void 0 ? void 0 : _r.securityGroupSelectorTerms;
        const amiFamily = (_s = this.options.ec2NodeClassSpec) === null || _s === void 0 ? void 0 : _s.amiFamily;
        const amiSelector = ((_t = this.options.ec2NodeClassSpec) === null || _t === void 0 ? void 0 : _t.amiSelector) || {};
        const amiSelectorTerms = (_u = this.options.ec2NodeClassSpec) === null || _u === void 0 ? void 0 : _u.amiSelectorTerms;
        const instanceStorePolicy = ((_v = this.options.ec2NodeClassSpec) === null || _v === void 0 ? void 0 : _v.instanceStorePolicy) || undefined;
        const userData = ((_w = this.options.ec2NodeClassSpec) === null || _w === void 0 ? void 0 : _w.userData) || "";
        const instanceProf = (_x = this.options.ec2NodeClassSpec) === null || _x === void 0 ? void 0 : _x.instanceProfile;
        const tags = ((_y = this.options.ec2NodeClassSpec) === null || _y === void 0 ? void 0 : _y.tags) || {};
        const metadataOptions = ((_z = this.options.ec2NodeClassSpec) === null || _z === void 0 ? void 0 : _z.metadataOptions) || {
            httpEndpoint: "enabled",
            httpProtocolIPv6: "disabled",
            httpPutResponseHopLimit: 2,
            httpTokens: "required"
        };
        if (cluster.ipFamily == aws_eks_1.IpFamily.IP_V6) {
            metadataOptions.httpProtocolIPv6 = "enabled";
        }
        const blockDeviceMappings = ((_0 = this.options.ec2NodeClassSpec) === null || _0 === void 0 ? void 0 : _0.blockDeviceMappings) || [];
        const detailedMonitoring = ((_1 = this.options.ec2NodeClassSpec) === null || _1 === void 0 ? void 0 : _1.detailedMonitoring) || false;
        // Check Kubernetes and Karpenter version compatibility for warning
        this.isCompatible(version, clusterInfo.version);
        // Version feature checks for errors
        this.versionFeatureChecksForError(clusterInfo, version, disruption, consol, ttlSecondsAfterEmpty, ttlSecondsUntilExpired, this.options.ec2NodeClassSpec, amiFamily);
        // Set up the node role and instance profile
        const [karpenterNodeRole, karpenterInstanceProfile] = this.setUpNodeRole(cluster, stackName, region);
        // Create the controller policy
        let karpenterPolicyDocument;
        if (semver.gte(version, "v0.32.0")) {
            karpenterPolicyDocument = iam.PolicyDocument.fromJson((0, iam_1.KarpenterControllerPolicyBeta)(cluster, partition, region));
        }
        else {
            karpenterPolicyDocument = iam.PolicyDocument.fromJson(iam_1.KarpenterControllerPolicy);
        }
        karpenterPolicyDocument.addStatements(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "iam:PassRole",
            ],
            resources: [`${karpenterNodeRole.roleArn}`]
        }));
        // Support for Native spot interruption
        if (interruption) {
            // Create Interruption Queue
            const queue = new sqs.Queue(cluster.stack, 'karpenter-queue', {
                queueName: stackName,
                retentionPeriod: aws_cdk_lib_1.Duration.seconds(300),
            });
            queue.addToResourcePolicy(new iam.PolicyStatement({
                sid: 'EC2InterruptionPolicy',
                effect: iam.Effect.ALLOW,
                principals: [
                    new iam.ServicePrincipal('sqs.amazonaws.com'),
                    new iam.ServicePrincipal('events.amazonaws.com'),
                ],
                actions: [
                    "sqs:SendMessage"
                ],
                resources: [`${queue.queueArn}`]
            }));
            // Add Interruption Rules
            new aws_events_1.Rule(cluster.stack, 'schedule-change-rule', {
                eventPattern: {
                    source: ["aws.health"],
                    detailType: ['AWS Health Event']
                },
            }).addTarget(new aws_events_targets_1.SqsQueue(queue));
            new aws_events_1.Rule(cluster.stack, 'spot-interruption-rule', {
                eventPattern: {
                    source: ["aws.ec2"],
                    detailType: ['EC2 Spot Instance Interruption Warning']
                },
            }).addTarget(new aws_events_targets_1.SqsQueue(queue));
            new aws_events_1.Rule(cluster.stack, 'rebalance-rule', {
                eventPattern: {
                    source: ["aws.ec2"],
                    detailType: ['EC2 Instance Rebalance Recommendation']
                },
            }).addTarget(new aws_events_targets_1.SqsQueue(queue));
            new aws_events_1.Rule(cluster.stack, 'inst-state-change-rule', {
                eventPattern: {
                    source: ["aws.ec2"],
                    detailType: ['C2 Instance State-change Notification']
                },
            }).addTarget(new aws_events_targets_1.SqsQueue(queue));
            // Add policy to the node role to allow access to the Interruption Queue
            const interruptionQueueStatement = new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                actions: [
                    "sqs:DeleteMessage",
                    "sqs:GetQueueUrl",
                    "sqs:GetQueueAttributes",
                    "sqs:ReceiveMessage"
                ],
                resources: [`${queue.queueArn}`]
            });
            karpenterPolicyDocument.addStatements(interruptionQueueStatement);
        }
        // Create Namespace
        const ns = utils.createNamespace(this.options.namespace, cluster, true, true);
        let sa;
        let saAnnotation;
        if (podIdentity && semver.gte(`${clusterInfo.version.version}.0`, '1.24.0') && semver.gte(version, "v0.35.0")) {
            sa = utils.podIdentityAssociation(cluster, types_1.RELEASE, this.options.namespace, karpenterPolicyDocument);
            saAnnotation = {};
        }
        else {
            sa = utils.createServiceAccount(cluster, types_1.RELEASE, this.options.namespace, karpenterPolicyDocument);
            saAnnotation = { "eks.amazonaws.com/role-arn": sa.role.roleArn };
        }
        sa.node.addDependency(ns);
        // Create global helm values based on v1beta1 migration as shown below:
        // https://karpenter.sh/v0.32/upgrading/v1beta1-migration/#helm-values
        let globalSettings = {
            clusterName: name,
            clusterEndpoint: endpoint
        };
        if (semver.lt(version, '0.32.0')) {
            globalSettings = (0, ts_deepmerge_1.merge)(globalSettings, {
                defaultInstanceProfile: karpenterInstanceProfile.instanceProfileName,
                interruptionQueueName: interruption ? stackName : ""
            });
        }
        else {
            globalSettings = (0, ts_deepmerge_1.merge)(globalSettings, {
                interruptionQueue: interruption ? stackName : ""
            });
        }
        if (semver.lt(version, '0.32.0')) {
            utils.setPath(values, "settings.aws", (0, ts_deepmerge_1.merge)(globalSettings, (_3 = (_2 = values === null || values === void 0 ? void 0 : values.settings) === null || _2 === void 0 ? void 0 : _2.aws) !== null && _3 !== void 0 ? _3 : {}));
        }
        else {
            utils.setPath(values, "settings", (0, ts_deepmerge_1.merge)(globalSettings, (_4 = values === null || values === void 0 ? void 0 : values.settings) !== null && _4 !== void 0 ? _4 : {}));
        }
        // Let Helm create the service account if using pod identity
        const saValues = {
            serviceAccount: {
                create: podIdentity,
                name: types_1.RELEASE,
                annotations: saAnnotation,
            }
        };
        values = (0, ts_deepmerge_1.merge)(values, saValues);
        // Install HelmChart using user defined value or default of 5 minutes.
        const helmChartTimeout = this.options.helmChartTimeout || aws_cdk_lib_1.Duration.minutes(5);
        const karpenterChart = this.addHelmChart(clusterInfo, values, false, true, helmChartTimeout);
        karpenterChart.node.addDependency(sa);
        if (clusterInfo.nodeGroups) {
            clusterInfo.nodeGroups.forEach(n => karpenterChart.node.addDependency(n));
        }
        if (semver.gte(version, "0.32.0") && installCRDs) {
            let _version = version;
            if (!version.startsWith('v')) {
                _version = `v${version}`;
            }
            const CRDs = [
                ["karpentersh-nodepool-beta1-crd", `https://raw.githubusercontent.com/aws/karpenter/${_version}/pkg/apis/crds/karpenter.sh_nodepools.yaml`],
                ["karpentersh-nodeclaims-beta1-crd", `https://raw.githubusercontent.com/aws/karpenter/${_version}/pkg/apis/crds/karpenter.sh_nodeclaims.yaml`],
                ["karpenterk8s-ec2nodeclasses-beta1-crd", `https://raw.githubusercontent.com/aws/karpenter/${_version}/pkg/apis/crds/karpenter.k8s.aws_ec2nodeclasses.yaml`],
            ];
            // loop over the CRD's and load the yaml and deploy the manifest
            for (const [crdName, crdUrl] of CRDs) {
                const crdManifest = utils.loadExternalYaml(crdUrl);
                const manifest = cluster.addManifest(crdName, crdManifest);
                // We want these installed before the karpenterChart, or helm will timeout waiting for it to stabilize
                karpenterChart.node.addDependency(manifest);
            }
        }
        // Deploy Provisioner (Alpha) or NodePool (Beta) CRD based on the Karpenter Version
        if (this.options.nodePoolSpec) {
            let pool;
            if (semver.gte(version, '0.32.0')) {
                pool = {
                    apiVersion: 'karpenter.sh/v1beta1',
                    kind: 'NodePool',
                    metadata: { name: 'default-nodepool' },
                    spec: {
                        template: {
                            metadata: {
                                labels: labels,
                                annotations: annotations,
                            },
                            spec: {
                                nodeClassRef: {
                                    name: "default-ec2nodeclass"
                                },
                                taints: taints,
                                startupTaints: startupTaints,
                                requirements: this.convert(requirements),
                            }
                        },
                        disruption: disruption,
                        limits: limits,
                        weight: weight,
                    },
                };
            }
            else {
                pool = {
                    apiVersion: 'karpenter.sh/v1alpha5',
                    kind: 'Provisioner',
                    metadata: { name: 'default-provisioner' },
                    spec: {
                        providerRef: {
                            name: "default-nodetemplate"
                        },
                        taints: taints,
                        startupTaints: startupTaints,
                        labels: labels,
                        annotations: annotations,
                        requirements: this.convert(requirements),
                        limits: {
                            resources: limits,
                        },
                        consolidation: consol,
                        ttlSecondsUntilExpired: ttlSecondsUntilExpired,
                        ttlSecondsAfterEmpty: ttlSecondsAfterEmpty,
                        weight: weight,
                    },
                };
            }
            const poolManifest = cluster.addManifest('default-pool', pool);
            poolManifest.node.addDependency(karpenterChart);
            // Deploy AWSNodeTemplate (Alpha) or EC2NodeClass (Beta) CRD based on the Karpenter Version
            if (this.options.ec2NodeClassSpec) {
                let ec2Node;
                if (semver.gte(version, '0.32.0')) {
                    ec2Node = {
                        apiVersion: "karpenter.k8s.aws/v1beta1",
                        kind: "EC2NodeClass",
                        metadata: {
                            name: "default-ec2nodeclass"
                        },
                        spec: {
                            amiFamily: amiFamily,
                            subnetSelectorTerms: subnetSelectorTerms,
                            securityGroupSelectorTerms: sgSelectorTerms,
                            amiSelectorTerms: amiSelectorTerms,
                            userData: userData,
                            tags: tags,
                            metadataOptions: metadataOptions,
                            blockDeviceMappings: blockDeviceMappings,
                            detailedMonitoring: detailedMonitoring,
                        },
                    };
                    // Provide custom Instance Profile to replace role if provided, else use the role created with the addon
                    if (instanceProf) {
                        ec2Node = (0, ts_deepmerge_1.merge)(ec2Node, { spec: { instanceProfile: instanceProf } });
                    }
                    else {
                        ec2Node = (0, ts_deepmerge_1.merge)(ec2Node, { spec: { role: karpenterNodeRole.roleName } });
                    }
                    // Instance Store Policy added for v0.34.0 and up
                    if (semver.gte(version, '0.34.0') && instanceStorePolicy) {
                        ec2Node = (0, ts_deepmerge_1.merge)(ec2Node, { spec: { instanceStorePolicy: instanceStorePolicy } });
                    }
                }
                else {
                    ec2Node = {
                        apiVersion: "karpenter.k8s.aws/v1alpha1",
                        kind: "AWSNodeTemplate",
                        metadata: {
                            name: "default-nodetemplate"
                        },
                        spec: {
                            subnetSelector: subnetSelector,
                            securityGroupSelector: sgSelector,
                            instanceProfile: instanceProf ? instanceProf : null,
                            amiFamily: amiFamily ? amiFamily : "AL2",
                            amiSelector: amiSelector,
                            tags: tags,
                            metadataOptions: metadataOptions,
                            blockDeviceMappings: blockDeviceMappings,
                            userData: userData,
                        },
                    };
                    // Add EC2 Detailed Monitoring for v0.22.0 and up
                    if (semver.gte(version, '0.22.0')) {
                        ec2Node = (0, ts_deepmerge_1.merge)(ec2Node, { spec: { detailedMonitoring: detailedMonitoring } });
                    }
                }
                const nodeManifest = cluster.addManifest('default-node-template', ec2Node);
                nodeManifest.node.addDependency(poolManifest);
            }
        }
        return Promise.resolve(karpenterChart);
    }
    /**
     * Helper function to convert a key-pair values (with an operator)
     * of spec configurations to appropriate json format for addManifest function
     * @param reqs
     * @returns newReqs
     * */
    convert(reqs) {
        const newReqs = [];
        for (let req of reqs) {
            const key = req['key'];
            const op = req['operator'];
            const val = req['values'];
            const requirement = {
                "key": key,
                "operator": op,
                "values": val
            };
            newReqs.push(requirement);
        }
        return newReqs;
    }
    /**
     * Helper function to ensure right features are added as part of the configuration
     * for the right version of the add-on
     * @param clusterInfo
     * @param version version of the add-on
     * @param disruption disruption feature available with the Beta CRDs
     * @param consolidation consolidation setting available with the Alpha CRDs
     * @param ttlSecondsAfterEmpty ttlSecondsAfterEmpty setting
     * @param ttlSecondsUntilExpired ttlSecondsUntilExpired setting
     * @param ec2NodeClassSpec Node Class Spec
     * @param amiFamily AMI Family
     * @returns
     */
    versionFeatureChecksForError(clusterInfo, version, disruption, consolidation, ttlSecondsAfterEmpty, ttlSecondsUntilExpired, ec2NodeClassSpec, amiFamily) {
        // EC2 Detailed Monitoring is only available in versions 0.23.0 and above
        if (semver.lt(version, '0.23.0') && ec2NodeClassSpec) {
            assert(ec2NodeClassSpec["detailedMonitoring"] === undefined, "Detailed Monitoring is not available in this version of Karpenter. Please upgrade to at least 0.23.0.");
        }
        // Disruption budget should not exist for versions below 0.34.x
        if (semver.lt(version, '0.34.0')) {
            if (disruption) {
                assert(!disruption["budgets"], "You cannot set disruption budgets for this version of Karpenter. Please upgrade to 0.34.0 or higher.");
            }
        }
        // version check errors for v0.32.0 and up (beta CRDs)
        if (semver.gte(version, '0.32.0')) {
            // Consolidation features don't exist in beta CRDs
            assert(!consolidation && !ttlSecondsAfterEmpty && !ttlSecondsUntilExpired, 'Consolidation features are only available for previous versions of Karpenter.');
            // consolidateAfter cannot be set if policy is set to WhenUnderutilized
            if (disruption && disruption["consolidationPolicy"] == "WhenUnderutilized") {
                assert(!disruption["consolidateAfter"], 'You cannot set consolidateAfter value if the consolidation policy is set to Underutilized.');
            }
            // AMI Family, Security Group and Subnet terms must be provided, given EC2 NodeSpec
            if (ec2NodeClassSpec) {
                assert(amiFamily !== undefined, "Please provide the AMI Family for your EC2NodeClass.");
                assert(ec2NodeClassSpec["securityGroupSelectorTerms"] !== undefined, "Please provide SecurityGroupTerm for your EC2NodeClass.");
                assert(ec2NodeClassSpec["subnetSelectorTerms"] !== undefined, "Please provide subnetGroupTerm for your EC2NodeClass.");
            }
        }
        // version check errors for v0.31.x and down (alpha CRDs)
        // Includes checks for consolidation and disruption features
        if (semver.lt(version, '0.32.0')) {
            if (consolidation) {
                assert(!(consolidation.enabled && ttlSecondsAfterEmpty), 'Consolidation and ttlSecondsAfterEmpty must be mutually exclusive.');
            }
            assert(!disruption, 'Disruption configuration is only supported on versions v0.32.0 and later.');
            //Security Group and Subnet terms must be provided, given EC2 NodeSpec
            if (ec2NodeClassSpec) {
                assert(ec2NodeClassSpec["securityGroupSelector"] !== undefined, "Please provide SecurityGroupTerm for your AWSNodeTemplate.");
                assert(ec2NodeClassSpec["subnetSelector"] !== undefined, "Please provide subnetGroupTerm for your AWSNodeTemplate.");
            }
        }
        // We should block Node Termination Handler usage once Karpenter is leveraged
        assert(!clusterInfo.getProvisionedAddOn('AwsNodeTerminationHandlerAddOn'), 'Karpenter supports native interruption handling, so Node Termination Handler will not be necessary.');
    }
    /**
     * Helper function to set up the Karpenter Node Role and Instance Profile
     * Outputs to CloudFormation and map the role to the aws-auth ConfigMap
     * @param cluster EKS Cluster
     * @param stackName Name of the stack
     * @param region Region of the stack
     * @returns [karpenterNodeRole, karpenterInstanceProfile]
     */
    setUpNodeRole(cluster, stackName, region) {
        // Set up Node Role
        const karpenterNodeRole = new iam.Role(cluster, 'karpenter-node-role', {
            assumedBy: new iam.ServicePrincipal(`ec2.${cluster.stack.urlSuffix}`),
            managedPolicies: [
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEKSWorkerNodePolicy"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEKS_CNI_Policy"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEC2ContainerRegistryReadOnly"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonSSMManagedInstanceCore"),
            ],
            //roleName: `KarpenterNodeRole-${name}` // let role name to be generated as unique
        });
        // Attach ipv6 related policies based on cluster IPFamily
        if (cluster.ipFamily === aws_eks_1.IpFamily.IP_V6) {
            const nodeIpv6Policy = new iam.Policy(cluster, 'karpenter-node-Ipv6-Policy', {
                document: utils.getEKSNodeIpv6PolicyDocument()
            });
            karpenterNodeRole.attachInlinePolicy(nodeIpv6Policy);
        }
        // Set up Instance Profile
        const instanceProfileName = md5.Md5.hashStr(stackName + region);
        const karpenterInstanceProfile = new iam.CfnInstanceProfile(cluster, 'karpenter-instance-profile', {
            roles: [karpenterNodeRole.roleName],
            instanceProfileName: `KarpenterNodeInstanceProfile-${instanceProfileName}`,
            path: '/'
        });
        karpenterInstanceProfile.node.addDependency(karpenterNodeRole);
        const clusterId = aws_cdk_lib_1.Names.uniqueId(cluster);
        //Cfn output for Node Role in case of needing to add additional policies
        new aws_cdk_lib_1.CfnOutput(cluster.stack, 'Karpenter Instance Node Role', {
            value: karpenterNodeRole.roleName,
            description: "Karpenter add-on Node Role name",
            exportName: clusterId + "KarpenterNodeRoleName",
        });
        //Cfn output for Instance Profile for creating additional provisioners
        new aws_cdk_lib_1.CfnOutput(cluster.stack, 'Karpenter Instance Profile name', {
            value: karpenterInstanceProfile ? karpenterInstanceProfile.instanceProfileName : "none",
            description: "Karpenter add-on Instance Profile name",
            exportName: clusterId + "KarpenterInstanceProfileName",
        });
        // Map Node Role to aws-auth
        cluster.awsAuth.addRoleMapping(karpenterNodeRole, {
            groups: ['system:bootstrapper', 'system:nodes'],
            username: 'system:node:{{EC2PrivateDNSName}}'
        });
        return [karpenterNodeRole, karpenterInstanceProfile];
    }
    /**
     * Helper function to check whether:
     * 1. Supported Karpenter versions are implemented, and
     * 2. Supported Kubernetes versions are deployed on the cluster to use Karpenter
     * It will reject the addon if the cluster uses deprecated Kubernetes version, and
     * Warn users about issues if incompatible Karpenter version is used for a particular cluster
     * given its Kubernetes version
     * @param karpenterVersion Karpenter version to be deployed
     * @param kubeVersion Cluster's Kubernetes version
     */
    isCompatible(karpenterVersion, kubeVersion) {
        assert(versionMap.has(kubeVersion), 'Please upgrade your EKS Kubernetes version to start using Karpenter.');
        assert(semver.gte(karpenterVersion, '0.21.0'), 'Please use Karpenter version 0.21.0 or above.');
        const compatibleVersion = versionMap.get(kubeVersion);
        if (semver.gt(compatibleVersion, karpenterVersion)) {
            console.warn(`Please use minimum Karpenter version for this Kubernetes Version: ${compatibleVersion}, otherwise you will run into compatibility issues.`);
        }
    }
};
exports.KarpenterAddOn = KarpenterAddOn;
__decorate([
    utils.conflictsWith('ClusterAutoScalerAddOn'),
    utils.conflictsWithAutoMode("fail")
], KarpenterAddOn.prototype, "deploy", null);
exports.KarpenterAddOn = KarpenterAddOn = __decorate([
    utils.supportsALL
], KarpenterAddOn);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2thcnBlbnRlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGlDQUFpQztBQUNqQyw2Q0FBeUQ7QUFDekQsaURBQTJFO0FBQzNFLHVEQUE4QztBQUM5Qyx1RUFBMEQ7QUFDMUQsMkNBQTJDO0FBQzNDLDJDQUEyQztBQUUzQyxpQ0FBaUM7QUFDakMsK0NBQXFDO0FBQ3JDLDhCQUE4QjtBQUU5QixxQ0FBcUM7QUFFckMsOENBQThFO0FBQzlFLCtCQUFpRjtBQUNqRixtQ0FBNkU7QUFFN0UsMENBQXdCO0FBQ3hCLGlEQUErQjtBQUUvQixNQUFNLFVBQVU7SUFhTCxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQTBCO1FBQzFDLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFDTSxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQTBCO1FBQzFDLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlDLENBQUM7O0FBakJ1QixxQkFBVSxHQUF3QixJQUFJLEdBQUcsQ0FBQztJQUM5RCxDQUFDLDJCQUFpQixDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDO0lBQzFDLENBQUMsMkJBQWlCLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUM7SUFDM0MsQ0FBQywyQkFBaUIsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQztJQUMzQyxDQUFDLDJCQUFpQixDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDO0lBQzNDLENBQUMsMkJBQWlCLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUM7SUFDM0MsQ0FBQywyQkFBaUIsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQztJQUMzQyxDQUFDLDJCQUFpQixDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDO0lBQzNDLENBQUMsMkJBQWlCLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUM7SUFDM0MsQ0FBQywyQkFBaUIsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQztJQUMzQyxDQUFDLDJCQUFpQixDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDO0NBQzlDLENBQUMsQ0FBQztBQTBEUDs7R0FFRztBQUNILE1BQU0sWUFBWSxHQUFtQjtJQUNqQyxJQUFJLEVBQUUsaUJBQVM7SUFDZixTQUFTLEVBQUUsYUFBYTtJQUN4QixPQUFPLEVBQUUsT0FBTztJQUNoQixLQUFLLEVBQUUsaUJBQVM7SUFDaEIsT0FBTyxFQUFFLGlCQUFTO0lBQ2xCLFVBQVUsRUFBRSwwQ0FBMEM7Q0FDekQsQ0FBQztBQUVGOzs7R0FHRztBQUVJLElBQU0sY0FBYyxHQUFwQixNQUFNLGNBQWUsU0FBUSxzQkFBUztJQUl6QyxZQUFZLEtBQTJCO1FBQ25DLEtBQUssQ0FBQyxFQUFDLEdBQUcsWUFBWSxFQUFFLEdBQUcsS0FBSyxFQUFDLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDOUIsQ0FBQztJQUlELE1BQU0sQ0FBQyxXQUF3Qjs7UUFDM0IsTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLFlBQVksaUJBQU8sRUFBRSw0R0FBNEcsQ0FBQyxDQUFDO1FBQzdKLE1BQU0sT0FBTyxHQUFhLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDOUMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQztRQUN6QyxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO1FBQ2pDLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO1FBRTFDLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO1FBQzFDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBRXBDLElBQUksTUFBTSxHQUFHLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLG1DQUFJLEVBQUUsQ0FBQztRQUN2QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQVEsQ0FBQztRQUV0QyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLG9CQUFvQixJQUFJLEtBQUssQ0FBQztRQUNoRSxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsSUFBSSxLQUFLLENBQUM7UUFFdEQsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLElBQUksS0FBSyxDQUFDO1FBRXRELHFCQUFxQjtRQUNyQixNQUFNLE1BQU0sR0FBRyxDQUFBLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLDBDQUFFLE1BQU0sS0FBSSxFQUFFLENBQUM7UUFDdkQsTUFBTSxXQUFXLEdBQUcsQ0FBQSxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSwwQ0FBRSxXQUFXLEtBQUksRUFBRSxDQUFDO1FBQ2pFLE1BQU0sTUFBTSxHQUFHLENBQUEsTUFBQSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksMENBQUUsTUFBTSxLQUFJLEVBQUUsQ0FBQztRQUN2RCxNQUFNLGFBQWEsR0FBRyxDQUFBLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLDBDQUFFLGFBQWEsS0FBSSxFQUFFLENBQUM7UUFDckUsTUFBTSxZQUFZLEdBQUcsQ0FBQSxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSwwQ0FBRSxZQUFZLEtBQUksRUFBRSxDQUFDO1FBQ25FLE1BQU0sTUFBTSxHQUFHLENBQUEsTUFBQSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksMENBQUUsYUFBYSxLQUFJLElBQUksQ0FBQztRQUNoRSxNQUFNLG9CQUFvQixHQUFHLENBQUEsTUFBQSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksMENBQUUsb0JBQW9CLEtBQUksSUFBSSxDQUFDO1FBQ3JGLE1BQU0sc0JBQXNCLEdBQUcsQ0FBQSxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSwwQ0FBRSxzQkFBc0IsS0FBSSxJQUFJLENBQUM7UUFDekYsTUFBTSxVQUFVLEdBQUcsQ0FBQSxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSwwQ0FBRSxVQUFVLEtBQUksSUFBSSxDQUFDO1FBQ2pFLE1BQU0sTUFBTSxHQUFHLENBQUEsTUFBQSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksMENBQUUsTUFBTSxLQUFJLElBQUksQ0FBQztRQUN6RCxNQUFNLE1BQU0sR0FBRyxDQUFBLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLDBDQUFFLE1BQU0sS0FBSSxJQUFJLENBQUM7UUFFekQsc0JBQXNCO1FBQ3RCLE1BQU0sY0FBYyxHQUFHLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsMENBQUUsY0FBYyxDQUFDO1FBQ3JFLE1BQU0sVUFBVSxHQUFHLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsMENBQUUscUJBQXFCLENBQUM7UUFDeEUsTUFBTSxtQkFBbUIsR0FBRyxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLDBDQUFFLG1CQUFtQixDQUFDO1FBQy9FLE1BQU0sZUFBZSxHQUFHLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsMENBQUUsMEJBQTBCLENBQUM7UUFDbEYsTUFBTSxTQUFTLEdBQUcsTUFBQSxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQiwwQ0FBRSxTQUFTLENBQUM7UUFDM0QsTUFBTSxXQUFXLEdBQUcsQ0FBQSxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLDBDQUFFLFdBQVcsS0FBSSxFQUFFLENBQUM7UUFDckUsTUFBTSxnQkFBZ0IsR0FBRyxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLDBDQUFFLGdCQUFnQixDQUFDO1FBQ3pFLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQSxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLDBDQUFFLG1CQUFtQixLQUFJLFNBQVMsQ0FBQztRQUM1RixNQUFNLFFBQVEsR0FBRyxDQUFBLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsMENBQUUsUUFBUSxLQUFJLEVBQUUsQ0FBQztRQUMvRCxNQUFNLFlBQVksR0FBRyxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLDBDQUFFLGVBQWUsQ0FBQztRQUNwRSxNQUFNLElBQUksR0FBRyxDQUFBLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsMENBQUUsSUFBSSxLQUFJLEVBQUUsQ0FBQztRQUN2RCxNQUFNLGVBQWUsR0FBRyxDQUFBLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsMENBQUUsZUFBZSxLQUFJO1lBQ3RFLFlBQVksRUFBRSxTQUFTO1lBQ3ZCLGdCQUFnQixFQUFFLFVBQVU7WUFDNUIsdUJBQXVCLEVBQUUsQ0FBQztZQUMxQixVQUFVLEVBQUUsVUFBVTtTQUN6QixDQUFDO1FBQ0YsSUFBSSxPQUFPLENBQUMsUUFBUSxJQUFJLGtCQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDckMsZUFBZSxDQUFDLGdCQUFnQixHQUFHLFNBQVMsQ0FBQztRQUNqRCxDQUFDO1FBQ0QsTUFBTSxtQkFBbUIsR0FBRyxDQUFBLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsMENBQUUsbUJBQW1CLEtBQUksRUFBRSxDQUFDO1FBQ3JGLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQSxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLDBDQUFFLGtCQUFrQixLQUFJLEtBQUssQ0FBQztRQUV0RixtRUFBbUU7UUFDbkUsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRWhELG9DQUFvQztRQUNwQyxJQUFJLENBQUMsNEJBQTRCLENBQUMsV0FBVyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLG9CQUFvQixFQUFFLHNCQUFzQixFQUNwSCxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRTlDLDRDQUE0QztRQUM1QyxNQUFNLENBQUMsaUJBQWlCLEVBQUUsd0JBQXdCLENBQUMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFckcsK0JBQStCO1FBQy9CLElBQUksdUJBQXVCLENBQUM7UUFDNUIsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsRUFBQyxDQUFDO1lBQ2hDLHVCQUF1QixHQUFHLEdBQUcsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLElBQUEsbUNBQTZCLEVBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ3JILENBQUM7YUFBTSxDQUFDO1lBQ0osdUJBQXVCLEdBQUcsR0FBRyxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsK0JBQXlCLENBQUMsQ0FBQztRQUNyRixDQUFDO1FBQ0QsdUJBQXVCLENBQUMsYUFBYSxDQUFDLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQztZQUMxRCxNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1lBQ3hCLE9BQU8sRUFBRTtnQkFDTCxjQUFjO2FBQ2pCO1lBQ0QsU0FBUyxFQUFFLENBQUMsR0FBRyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUM5QyxDQUFDLENBQUMsQ0FBQztRQUVKLHVDQUF1QztRQUN2QyxJQUFJLFlBQVksRUFBQyxDQUFDO1lBQ2QsNEJBQTRCO1lBQzVCLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLGlCQUFpQixFQUFFO2dCQUMxRCxTQUFTLEVBQUUsU0FBUztnQkFDcEIsZUFBZSxFQUFFLHNCQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQzthQUN6QyxDQUFDLENBQUM7WUFDSCxLQUFLLENBQUMsbUJBQW1CLENBQUMsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO2dCQUM5QyxHQUFHLEVBQUUsdUJBQXVCO2dCQUM1QixNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO2dCQUN4QixVQUFVLEVBQUU7b0JBQ1IsSUFBSSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLENBQUM7b0JBQzdDLElBQUksR0FBRyxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixDQUFDO2lCQUNuRDtnQkFDRCxPQUFPLEVBQUU7b0JBQ0wsaUJBQWlCO2lCQUNwQjtnQkFDRCxTQUFTLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQzthQUNuQyxDQUFDLENBQUMsQ0FBQztZQUVKLHlCQUF5QjtZQUN6QixJQUFJLGlCQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxzQkFBc0IsRUFBRTtnQkFDNUMsWUFBWSxFQUFFO29CQUNWLE1BQU0sRUFBRSxDQUFDLFlBQVksQ0FBQztvQkFDdEIsVUFBVSxFQUFFLENBQUMsa0JBQWtCLENBQUM7aUJBQ25DO2FBQ0osQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLDZCQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUVsQyxJQUFJLGlCQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSx3QkFBd0IsRUFBRTtnQkFDOUMsWUFBWSxFQUFFO29CQUNWLE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQztvQkFDbkIsVUFBVSxFQUFFLENBQUMsd0NBQXdDLENBQUM7aUJBQ3pEO2FBQ0osQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLDZCQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUVsQyxJQUFJLGlCQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsRUFBRTtnQkFDdEMsWUFBWSxFQUFFO29CQUNWLE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQztvQkFDbkIsVUFBVSxFQUFFLENBQUMsdUNBQXVDLENBQUM7aUJBQ3hEO2FBQ0osQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLDZCQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUVsQyxJQUFJLGlCQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSx3QkFBd0IsRUFBRTtnQkFDOUMsWUFBWSxFQUFFO29CQUNWLE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQztvQkFDbkIsVUFBVSxFQUFFLENBQUMsdUNBQXVDLENBQUM7aUJBQ3hEO2FBQ0osQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLDZCQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUVsQyx3RUFBd0U7WUFDeEUsTUFBTSwwQkFBMEIsR0FBRyxJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7Z0JBQ3ZELE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7Z0JBQ3hCLE9BQU8sRUFBRTtvQkFDTCxtQkFBbUI7b0JBQ25CLGlCQUFpQjtvQkFDakIsd0JBQXdCO29CQUN4QixvQkFBb0I7aUJBQ3ZCO2dCQUNELFNBQVMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO2FBQ25DLENBQUMsQ0FBQztZQUNILHVCQUF1QixDQUFDLGFBQWEsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBQ3RFLENBQUM7UUFFRCxtQkFBbUI7UUFDbkIsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRS9FLElBQUksRUFBTyxDQUFDO1FBQ1osSUFBSSxZQUFpQixDQUFDO1FBQ3RCLElBQUksV0FBVyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxFQUFFLFFBQVEsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxFQUFDLENBQUM7WUFDN0csRUFBRSxHQUFHLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLEVBQUUsZUFBTyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBVSxFQUFFLHVCQUF1QixDQUFDLENBQUM7WUFDdEcsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUNwQixDQUFDO2FBQU0sQ0FBQztZQUNOLEVBQUUsR0FBRyxLQUFLLENBQUMsb0JBQW9CLENBQUMsT0FBTyxFQUFFLGVBQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVUsRUFBRSx1QkFBdUIsQ0FBQyxDQUFDO1lBQ3BHLFlBQVksR0FBRyxFQUFDLDRCQUE0QixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFDLENBQUM7UUFDakUsQ0FBQztRQUNELEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTFCLHVFQUF1RTtRQUN2RSxzRUFBc0U7UUFDdEUsSUFBSSxjQUFjLEdBQUc7WUFDakIsV0FBVyxFQUFFLElBQUk7WUFDakIsZUFBZSxFQUFFLFFBQVE7U0FDNUIsQ0FBQztRQUVGLElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLEVBQUMsQ0FBQztZQUM5QixjQUFjLEdBQUcsSUFBQSxvQkFBSyxFQUFDLGNBQWMsRUFBRTtnQkFDbkMsc0JBQXNCLEVBQUUsd0JBQXdCLENBQUMsbUJBQW1CO2dCQUNwRSxxQkFBcUIsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRTthQUN2RCxDQUFDLENBQUM7UUFDUCxDQUFDO2FBQU0sQ0FBQztZQUNKLGNBQWMsR0FBRyxJQUFBLG9CQUFLLEVBQUMsY0FBYyxFQUFFO2dCQUNuQyxpQkFBaUIsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRTthQUNuRCxDQUFDLENBQUM7UUFDUCxDQUFDO1FBRUQsSUFBSSxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsRUFBQyxDQUFDO1lBQzlCLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLGNBQWMsRUFBRSxJQUFBLG9CQUFLLEVBQUMsY0FBYyxFQUFFLE1BQUEsTUFBQSxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsUUFBUSwwQ0FBRSxHQUFHLG1DQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDOUYsQ0FBQzthQUFNLENBQUM7WUFDSixLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsSUFBQSxvQkFBSyxFQUFDLGNBQWMsRUFBRSxNQUFBLE1BQU0sYUFBTixNQUFNLHVCQUFOLE1BQU0sQ0FBRSxRQUFRLG1DQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckYsQ0FBQztRQUVELDREQUE0RDtRQUM1RCxNQUFNLFFBQVEsR0FBRztZQUNiLGNBQWMsRUFBRTtnQkFDWixNQUFNLEVBQUUsV0FBVztnQkFDbkIsSUFBSSxFQUFFLGVBQU87Z0JBQ2IsV0FBVyxFQUFFLFlBQVk7YUFDNUI7U0FDSixDQUFDO1FBRUYsTUFBTSxHQUFHLElBQUEsb0JBQUssRUFBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDakMsc0VBQXNFO1FBQ3RFLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsSUFBSSxzQkFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5RSxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBRTdGLGNBQWMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRXRDLElBQUcsV0FBVyxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3hCLFdBQVcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5RSxDQUFDO1FBRUQsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsSUFBSSxXQUFXLEVBQUMsQ0FBQztZQUM5QyxJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUM7WUFDdkIsSUFBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDMUIsUUFBUSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7WUFDN0IsQ0FBQztZQUVELE1BQU0sSUFBSSxHQUFFO2dCQUNSLENBQUUsZ0NBQWdDLEVBQUUsbURBQW1ELFFBQVEsNENBQTRDLENBQUU7Z0JBQzdJLENBQUUsa0NBQWtDLEVBQUUsbURBQW1ELFFBQVEsNkNBQTZDLENBQUM7Z0JBQy9JLENBQUUsdUNBQXVDLEVBQUUsbURBQW1ELFFBQVEsc0RBQXNELENBQUM7YUFDaEssQ0FBQztZQUVGLGdFQUFnRTtZQUNoRSxLQUFLLE1BQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7Z0JBQ25DLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDbkQsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUM7Z0JBRTNELHNHQUFzRztnQkFDdEcsY0FBYyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDaEQsQ0FBQztRQUNMLENBQUM7UUFHRCxtRkFBbUY7UUFDbkYsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBQyxDQUFDO1lBQzNCLElBQUksSUFBSSxDQUFDO1lBQ1QsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsRUFBQyxDQUFDO2dCQUMvQixJQUFJLEdBQUc7b0JBQ0gsVUFBVSxFQUFFLHNCQUFzQjtvQkFDbEMsSUFBSSxFQUFFLFVBQVU7b0JBQ2hCLFFBQVEsRUFBRSxFQUFFLElBQUksRUFBRSxrQkFBa0IsRUFBRTtvQkFDdEMsSUFBSSxFQUFFO3dCQUNGLFFBQVEsRUFBRTs0QkFDTixRQUFRLEVBQUU7Z0NBQ04sTUFBTSxFQUFFLE1BQU07Z0NBQ2QsV0FBVyxFQUFFLFdBQVc7NkJBQzNCOzRCQUNELElBQUksRUFBRTtnQ0FDRixZQUFZLEVBQUU7b0NBQ1YsSUFBSSxFQUFFLHNCQUFzQjtpQ0FDL0I7Z0NBQ0QsTUFBTSxFQUFFLE1BQU07Z0NBQ2QsYUFBYSxFQUFFLGFBQWE7Z0NBQzVCLFlBQVksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQzs2QkFDM0M7eUJBQ0o7d0JBQ0QsVUFBVSxFQUFFLFVBQVU7d0JBQ3RCLE1BQU0sRUFBRSxNQUFNO3dCQUNkLE1BQU0sRUFBRSxNQUFNO3FCQUNqQjtpQkFDSixDQUFDO1lBQ04sQ0FBQztpQkFBTSxDQUFDO2dCQUNKLElBQUksR0FBRztvQkFDSCxVQUFVLEVBQUUsdUJBQXVCO29CQUNuQyxJQUFJLEVBQUUsYUFBYTtvQkFDbkIsUUFBUSxFQUFFLEVBQUUsSUFBSSxFQUFFLHFCQUFxQixFQUFFO29CQUN6QyxJQUFJLEVBQUU7d0JBQ0YsV0FBVyxFQUFFOzRCQUNULElBQUksRUFBRSxzQkFBc0I7eUJBQy9CO3dCQUNELE1BQU0sRUFBRSxNQUFNO3dCQUNkLGFBQWEsRUFBRSxhQUFhO3dCQUM1QixNQUFNLEVBQUUsTUFBTTt3QkFDZCxXQUFXLEVBQUUsV0FBVzt3QkFDeEIsWUFBWSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDO3dCQUN4QyxNQUFNLEVBQUU7NEJBQ0osU0FBUyxFQUFFLE1BQU07eUJBQ3BCO3dCQUNELGFBQWEsRUFBRSxNQUFNO3dCQUNyQixzQkFBc0IsRUFBRSxzQkFBc0I7d0JBQzlDLG9CQUFvQixFQUFFLG9CQUFvQjt3QkFDMUMsTUFBTSxFQUFFLE1BQU07cUJBQ2pCO2lCQUNKLENBQUM7WUFDTixDQUFDO1lBQ0QsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDL0QsWUFBWSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLENBQUM7WUFFaEQsMkZBQTJGO1lBQzNGLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBQyxDQUFDO2dCQUMvQixJQUFJLE9BQU8sQ0FBQztnQkFDWixJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxFQUFDLENBQUM7b0JBQy9CLE9BQU8sR0FBRzt3QkFDTixVQUFVLEVBQUUsMkJBQTJCO3dCQUN2QyxJQUFJLEVBQUUsY0FBYzt3QkFDcEIsUUFBUSxFQUFFOzRCQUNOLElBQUksRUFBRSxzQkFBc0I7eUJBQy9CO3dCQUNELElBQUksRUFBRTs0QkFDRixTQUFTLEVBQUUsU0FBUzs0QkFDcEIsbUJBQW1CLEVBQUUsbUJBQW1COzRCQUN4QywwQkFBMEIsRUFBRSxlQUFlOzRCQUMzQyxnQkFBZ0IsRUFBRSxnQkFBZ0I7NEJBQ2xDLFFBQVEsRUFBRSxRQUFROzRCQUNsQixJQUFJLEVBQUUsSUFBSTs0QkFDVixlQUFlLEVBQUUsZUFBZTs0QkFDaEMsbUJBQW1CLEVBQUUsbUJBQW1COzRCQUN4QyxrQkFBa0IsRUFBRSxrQkFBa0I7eUJBQ3pDO3FCQUNKLENBQUM7b0JBRUYsd0dBQXdHO29CQUN4RyxJQUFJLFlBQVksRUFBRSxDQUFDO3dCQUNmLE9BQU8sR0FBRyxJQUFBLG9CQUFLLEVBQUMsT0FBTyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsZUFBZSxFQUFFLFlBQVksRUFBRSxFQUFDLENBQUMsQ0FBQztvQkFDekUsQ0FBQzt5QkFBTSxDQUFDO3dCQUNKLE9BQU8sR0FBRyxJQUFBLG9CQUFLLEVBQUMsT0FBTyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxFQUFDLENBQUMsQ0FBQztvQkFDNUUsQ0FBQztvQkFFRCxpREFBaUQ7b0JBQ2pELElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLElBQUksbUJBQW1CLEVBQUMsQ0FBQzt3QkFDdEQsT0FBTyxHQUFHLElBQUEsb0JBQUssRUFBQyxPQUFPLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxtQkFBbUIsRUFBRSxtQkFBbUIsRUFBRSxFQUFDLENBQUMsQ0FBQztvQkFDcEYsQ0FBQztnQkFDTCxDQUFDO3FCQUFNLENBQUM7b0JBQ0osT0FBTyxHQUFHO3dCQUNOLFVBQVUsRUFBRSw0QkFBNEI7d0JBQ3hDLElBQUksRUFBRSxpQkFBaUI7d0JBQ3ZCLFFBQVEsRUFBRTs0QkFDTixJQUFJLEVBQUUsc0JBQXNCO3lCQUMvQjt3QkFDRCxJQUFJLEVBQUU7NEJBQ0YsY0FBYyxFQUFFLGNBQWM7NEJBQzlCLHFCQUFxQixFQUFFLFVBQVU7NEJBQ2pDLGVBQWUsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSTs0QkFDbkQsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxLQUFLOzRCQUN4QyxXQUFXLEVBQUUsV0FBVzs0QkFDeEIsSUFBSSxFQUFFLElBQUk7NEJBQ1YsZUFBZSxFQUFFLGVBQWU7NEJBQ2hDLG1CQUFtQixFQUFFLG1CQUFtQjs0QkFDeEMsUUFBUSxFQUFFLFFBQVE7eUJBQ3JCO3FCQUNKLENBQUM7b0JBRUYsaURBQWlEO29CQUNqRCxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxFQUFDLENBQUM7d0JBQy9CLE9BQU8sR0FBRyxJQUFBLG9CQUFLLEVBQUMsT0FBTyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsa0JBQWtCLEVBQUUsa0JBQWtCLEVBQUMsRUFBQyxDQUFDLENBQUM7b0JBQ2pGLENBQUM7Z0JBQ0wsQ0FBQztnQkFDRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLHVCQUF1QixFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUMzRSxZQUFZLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNsRCxDQUFDO1FBQ0wsQ0FBQztRQUVELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQ7Ozs7O1NBS0s7SUFDSyxPQUFPLENBQUMsSUFBeUQ7UUFDdkUsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ25CLEtBQUssSUFBSSxHQUFHLElBQUksSUFBSSxFQUFDLENBQUM7WUFDbEIsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZCLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUMzQixNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDMUIsTUFBTSxXQUFXLEdBQUc7Z0JBQ2hCLEtBQUssRUFBRSxHQUFHO2dCQUNWLFVBQVUsRUFBRSxFQUFFO2dCQUNkLFFBQVEsRUFBRSxHQUFHO2FBQ2hCLENBQUM7WUFDRixPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzlCLENBQUM7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRUQ7Ozs7Ozs7Ozs7OztPQVlHO0lBQ0ssNEJBQTRCLENBQUMsV0FBd0IsRUFBRSxPQUFlLEVBQUUsVUFBZSxFQUFFLGFBQWtCLEVBQUUsb0JBQXlCLEVBQUUsc0JBQTJCLEVBQ3ZLLGdCQUFxQixFQUFFLFNBQWM7UUFFckMseUVBQXlFO1FBQ3pFLElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLElBQUksZ0JBQWdCLEVBQUMsQ0FBQztZQUNsRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsb0JBQW9CLENBQUMsS0FBSyxTQUFTLEVBQUUsdUdBQXVHLENBQUMsQ0FBQztRQUMxSyxDQUFDO1FBRUQsK0RBQStEO1FBQy9ELElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLEVBQUMsQ0FBQztZQUM5QixJQUFJLFVBQVUsRUFBQyxDQUFDO2dCQUNaLE1BQU0sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsRUFBRSxzR0FBc0csQ0FBQyxDQUFDO1lBQzNJLENBQUM7UUFDTCxDQUFDO1FBRUQsc0RBQXNEO1FBQ3RELElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLEVBQUMsQ0FBQztZQUMvQixrREFBa0Q7WUFDbEQsTUFBTSxDQUFDLENBQUMsYUFBYSxJQUFJLENBQUMsb0JBQW9CLElBQUksQ0FBQyxzQkFBc0IsRUFBRSwrRUFBK0UsQ0FBQyxDQUFDO1lBRTVKLHVFQUF1RTtZQUN2RSxJQUFJLFVBQVUsSUFBSSxVQUFVLENBQUMscUJBQXFCLENBQUMsSUFBSSxtQkFBbUIsRUFBQyxDQUFDO2dCQUN4RSxNQUFNLENBQUMsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsRUFBRSw0RkFBNEYsQ0FBQyxDQUFDO1lBQzFJLENBQUM7WUFFRCxtRkFBbUY7WUFDbkYsSUFBSSxnQkFBZ0IsRUFBQyxDQUFDO2dCQUNsQixNQUFNLENBQUMsU0FBUyxLQUFLLFNBQVMsRUFBRSxzREFBc0QsQ0FBQyxDQUFDO2dCQUN4RixNQUFNLENBQUMsZ0JBQWdCLENBQUMsNEJBQTRCLENBQUMsS0FBSyxTQUFTLEVBQUUseURBQXlELENBQUMsQ0FBQztnQkFDaEksTUFBTSxDQUFDLGdCQUFnQixDQUFDLHFCQUFxQixDQUFDLEtBQUssU0FBUyxFQUFFLHVEQUF1RCxDQUFDLENBQUM7WUFDM0gsQ0FBQztRQUNMLENBQUM7UUFFRCx5REFBeUQ7UUFDekQsNERBQTREO1FBQzVELElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLEVBQUMsQ0FBQztZQUM5QixJQUFJLGFBQWEsRUFBQyxDQUFDO2dCQUNmLE1BQU0sQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLE9BQU8sSUFBSSxvQkFBb0IsQ0FBQyxFQUFHLG9FQUFvRSxDQUFDLENBQUM7WUFDcEksQ0FBQztZQUNELE1BQU0sQ0FBQyxDQUFDLFVBQVUsRUFBRSwyRUFBMkUsQ0FBQyxDQUFDO1lBRWpHLHNFQUFzRTtZQUN0RSxJQUFJLGdCQUFnQixFQUFDLENBQUM7Z0JBQ2xCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLFNBQVMsRUFBRSw0REFBNEQsQ0FBQyxDQUFDO2dCQUM5SCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxTQUFTLEVBQUUsMERBQTBELENBQUMsQ0FBQztZQUN6SCxDQUFDO1FBQ0wsQ0FBQztRQUVELDZFQUE2RTtRQUM1RSxNQUFNLENBQUMsQ0FBQyxXQUFXLENBQUMsbUJBQW1CLENBQUMsZ0NBQWdDLENBQUMsRUFBRSxxR0FBcUcsQ0FBQyxDQUFDO0lBRXZMLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0ssYUFBYSxDQUFDLE9BQWdCLEVBQUUsU0FBaUIsRUFBRSxNQUFjO1FBQ3JFLG1CQUFtQjtRQUNuQixNQUFNLGlCQUFpQixHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUscUJBQXFCLEVBQUU7WUFDbkUsU0FBUyxFQUFFLElBQUksR0FBRyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNyRSxlQUFlLEVBQUU7Z0JBQ2IsR0FBRyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQywyQkFBMkIsQ0FBQztnQkFDdkUsR0FBRyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQyxzQkFBc0IsQ0FBQztnQkFDbEUsR0FBRyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQyxvQ0FBb0MsQ0FBQztnQkFDaEYsR0FBRyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQyw4QkFBOEIsQ0FBQzthQUM3RTtZQUNELGtGQUFrRjtTQUNyRixDQUFDLENBQUM7UUFFSCx5REFBeUQ7UUFDekQsSUFBSSxPQUFPLENBQUMsUUFBUSxLQUFLLGtCQUFRLENBQUMsS0FBSyxFQUFDLENBQUM7WUFDckMsTUFBTSxjQUFjLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSw0QkFBNEIsRUFBRTtnQkFDekUsUUFBUSxFQUFFLEtBQUssQ0FBQyw0QkFBNEIsRUFBRTthQUFFLENBQUMsQ0FBQztZQUN0RCxpQkFBaUIsQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUN6RCxDQUFDO1FBRUQsMEJBQTBCO1FBQzFCLE1BQU0sbUJBQW1CLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxHQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlELE1BQU0sd0JBQXdCLEdBQUcsSUFBSSxHQUFHLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLDRCQUE0QixFQUFFO1lBQy9GLEtBQUssRUFBRSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQztZQUNuQyxtQkFBbUIsRUFBRSxnQ0FBZ0MsbUJBQW1CLEVBQUU7WUFDMUUsSUFBSSxFQUFFLEdBQUc7U0FDWixDQUFDLENBQUM7UUFDSCx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFL0QsTUFBTSxTQUFTLEdBQUcsbUJBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFMUMsd0VBQXdFO1FBQ3hFLElBQUksdUJBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLDhCQUE4QixFQUFFO1lBQ3pELEtBQUssRUFBRSxpQkFBaUIsQ0FBQyxRQUFRO1lBQ2pDLFdBQVcsRUFBRSxpQ0FBaUM7WUFDOUMsVUFBVSxFQUFFLFNBQVMsR0FBQyx1QkFBdUI7U0FDaEQsQ0FBQyxDQUFDO1FBQ0gsc0VBQXNFO1FBQ3RFLElBQUksdUJBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLGlDQUFpQyxFQUFFO1lBQzVELEtBQUssRUFBRSx3QkFBd0IsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsbUJBQW9CLENBQUMsQ0FBQyxDQUFDLE1BQU07WUFDeEYsV0FBVyxFQUFFLHdDQUF3QztZQUNyRCxVQUFVLEVBQUUsU0FBUyxHQUFDLDhCQUE4QjtTQUN2RCxDQUFDLENBQUM7UUFFSCw0QkFBNEI7UUFDNUIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsaUJBQWlCLEVBQUU7WUFDOUMsTUFBTSxFQUFFLENBQUMscUJBQXFCLEVBQUUsY0FBYyxDQUFDO1lBQy9DLFFBQVEsRUFBRSxtQ0FBbUM7U0FDaEQsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLGlCQUFpQixFQUFFLHdCQUF3QixDQUFDLENBQUM7SUFDekQsQ0FBQztJQUVEOzs7Ozs7Ozs7T0FTRztJQUNLLFlBQVksQ0FBQyxnQkFBd0IsRUFBRSxXQUE4QjtRQUN6RSxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsRUFBRSxzRUFBc0UsQ0FBQyxDQUFDO1FBQzVHLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLFFBQVEsQ0FBQyxFQUFFLCtDQUErQyxDQUFDLENBQUM7UUFDaEcsTUFBTSxpQkFBaUIsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBVyxDQUFDO1FBQ2hFLElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxnQkFBZ0IsQ0FBQyxFQUFFLENBQUM7WUFDakQsT0FBTyxDQUFDLElBQUksQ0FBQyxxRUFBcUUsaUJBQWlCLHFEQUFxRCxDQUFDLENBQUM7UUFDOUosQ0FBQztJQUNMLENBQUM7Q0FDSixDQUFBO0FBNWdCWSx3Q0FBYztBQVd2QjtJQUZDLEtBQUssQ0FBQyxhQUFhLENBQUMsd0JBQXdCLENBQUM7SUFDN0MsS0FBSyxDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQzs0Q0F5Vm5DO3lCQW5XUSxjQUFjO0lBRDFCLEtBQUssQ0FBQyxXQUFXO0dBQ0wsY0FBYyxDQTRnQjFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXNzZXJ0IGZyb20gXCJhc3NlcnRcIjtcbmltcG9ydCB7IENmbk91dHB1dCwgRHVyYXRpb24sIE5hbWVzIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgQ2x1c3RlciwgS3ViZXJuZXRlc1ZlcnNpb24sIElwRmFtaWx5IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWVrcyc7XG5pbXBvcnQgeyBSdWxlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWV2ZW50cyc7XG5pbXBvcnQgeyBTcXNRdWV1ZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1ldmVudHMtdGFyZ2V0cyc7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBzcXMgZnJvbSAnYXdzLWNkay1saWIvYXdzLXNxcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5pbXBvcnQgeyBtZXJnZSB9IGZyb20gJ3RzLWRlZXBtZXJnZSc7XG5pbXBvcnQgKiBhcyBtZDUgZnJvbSAndHMtbWQ1JztcbmltcG9ydCB7IENsdXN0ZXJJbmZvIH0gZnJvbSAnLi4vLi4vc3BpJztcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4uLy4uL3V0aWxzJztcblxuaW1wb3J0IHsgSGVsbUFkZE9uLCBIZWxtQWRkT25Qcm9wcywgSGVsbUFkZE9uVXNlclByb3BzIH0gZnJvbSAnLi4vaGVsbS1hZGRvbic7XG5pbXBvcnQgeyBLYXJwZW50ZXJDb250cm9sbGVyUG9saWN5LCBLYXJwZW50ZXJDb250cm9sbGVyUG9saWN5QmV0YSB9IGZyb20gJy4vaWFtJztcbmltcG9ydCB7IEVjMk5vZGVDbGFzc1NwZWMsIEtBUlBFTlRFUiwgTm9kZVBvb2xTcGVjLCBSRUxFQVNFIH0gZnJvbSBcIi4vdHlwZXNcIjtcblxuZXhwb3J0ICogZnJvbSBcIi4vdHlwZXNcIjtcbmV4cG9ydCAqIGZyb20gJy4va2FycGVudGVyLXYxJztcblxuY2xhc3MgdmVyc2lvbk1hcCB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgdmVyc2lvbk1hcDogTWFwPHN0cmluZywgc3RyaW5nPiA9IG5ldyBNYXAoW1xuICAgICAgICBbS3ViZXJuZXRlc1ZlcnNpb24uVjFfMzIudmVyc2lvbiwgJzEuMi4wJ10sXG4gICAgICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8zMS52ZXJzaW9uLCAnMC4zNy41J10sXG4gICAgICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8zMC52ZXJzaW9uLCAnMC4zNy41J10sXG4gICAgICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8yOS52ZXJzaW9uLCAnMC4zNC4wJ10sXG4gICAgICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8yOC52ZXJzaW9uLCAnMC4zMS4wJ10sXG4gICAgICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8yNy52ZXJzaW9uLCAnMC4yOC4wJ10sXG4gICAgICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8yNi52ZXJzaW9uLCAnMC4yOC4wJ10sXG4gICAgICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8yNS52ZXJzaW9uLCAnMC4yNS4wJ10sXG4gICAgICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8yNC52ZXJzaW9uLCAnMC4yMS4wJ10sXG4gICAgICAgIFtLdWJlcm5ldGVzVmVyc2lvbi5WMV8yMy52ZXJzaW9uLCAnMC4yMS4wJ10sXG4gICAgXSk7XG4gICAgcHVibGljIHN0YXRpYyBoYXModmVyc2lvbjogS3ViZXJuZXRlc1ZlcnNpb24pIHtcbiAgICAgIHJldHVybiB0aGlzLnZlcnNpb25NYXAuaGFzKHZlcnNpb24udmVyc2lvbik7XG4gICAgfVxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0KHZlcnNpb246IEt1YmVybmV0ZXNWZXJzaW9uKSB7XG4gICAgICByZXR1cm4gdGhpcy52ZXJzaW9uTWFwLmdldCh2ZXJzaW9uLnZlcnNpb24pO1xuICAgIH1cbiAgfVxuXG4vKipcbiAqIENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIGFkZC1vblxuICovXG5leHBvcnQgaW50ZXJmYWNlIEthcnBlbnRlckFkZE9uUHJvcHMgZXh0ZW5kcyBIZWxtQWRkT25Vc2VyUHJvcHMge1xuICAgIC8qKlxuICAgICAqIFRoaXMgaXMgdGhlIHRvcCBsZXZlbCBub2RlcG9vbCBzcGVjaWZpY2F0aW9uLiBOb2RlcG9vbHMgbGF1bmNoIG5vZGVzIGluIHJlc3BvbnNlIHRvIHBvZHMgdGhhdCBhcmUgdW5zY2hlZHVsYWJsZS5cbiAgICAgKiBBIHNpbmdsZSBub2RlcG9vbCBpcyBjYXBhYmxlIG9mIG1hbmFnaW5nIGEgZGl2ZXJzZSBzZXQgb2Ygbm9kZXMuXG4gICAgICogTm9kZSBwcm9wZXJ0aWVzIGFyZSBkZXRlcm1pbmVkIGZyb20gYSBjb21iaW5hdGlvbiBvZiBub2RlcG9vbCBhbmQgcG9kIHNjaGVkdWxpbmcgY29uc3RyYWludHMuXG4gICAgICovXG4gICAgbm9kZVBvb2xTcGVjPzogTm9kZVBvb2xTcGVjLFxuXG4gICAgLyoqXG4gICAgICogVGhpcyBpcyB0aGUgdG9wIGxldmVsIHNwZWMgZm9yIHRoZSBBV1MgS2FycGVudGVyIFByb3ZpZGVyXG4gICAgICogSXQgY29udGFpbnMgY29uZmlndXJhdGlvbiBuZWNlc3NhcnkgdG8gbGF1bmNoIGluc3RhbmNlcyBpbiBBV1MuXG4gICAgICovXG4gICAgZWMyTm9kZUNsYXNzU3BlYz86IEVjMk5vZGVDbGFzc1NwZWMsXG5cbiAgICAvKipcbiAgICAgKiBGbGFnIGZvciBlbmFibGluZyBLYXJwZW50ZXIncyBuYXRpdmUgaW50ZXJydXB0aW9uIGhhbmRsaW5nXG4gICAgICovXG4gICAgaW50ZXJydXB0aW9uSGFuZGxpbmc/OiBib29sZWFuLFxuXG4gICAgLypcbiAgICAqIEZsYWcgZm9yIG1hbmFnaW5nIGluc3RhbGwgb2YgS2FycGVudGVyJ3MgbmV3IENSRHMgYmV0d2VlbiB2ZXJzaW9uc1xuICAgICogVGhpcyBpcyBvbmx5IG5lY2Vzc2FyeSBpZiB1cGdyYWRpbmcgZnJvbSBhIHZlcnNpb24gcHJpb3IgdG8gdjAuMzIuMFxuICAgICogSWYgbm90IHByb3ZpZGVkLCBkZWZhdWx0cyB0byB0cnVlXG4gICAgKiBJZiBzZXQgdG8gdHJ1ZSwgdGhlIGFkZC1vbiB3aWxsIG1hbmFnZSBpbnN0YWxsYXRpb24gb2YgdGhlIENSRHNcbiAgICAqL1xuICAgIGluc3RhbGxDUkRzPzogYm9vbGVhbixcbiAgICAvKipcbiAgICAgKiBUaW1lb3V0IGR1cmF0aW9uIHdoaWxlIGluc3RhbGxpbmcga2FycGVudGVyIGhlbG0gY2hhcnQgdXNpbmcgYWRkSGVsbUNoYXJ0IEFQSVxuICAgICAqL1xuICAgIGhlbG1DaGFydFRpbWVvdXQ/OiBEdXJhdGlvbixcblxuICAgIC8qKlxuICAgICAqIFVzZSBQb2QgSWRlbnRpdHkuXG4gICAgICogVG8gdXNlIEVLUyBQb2QgSWRlbnRpdGllc1xuICAgICAqICAtIFRoZSBjbHVzdGVyIG11c3QgaGF2ZSBLdWJlcm5ldGVzIHZlcnNpb24gMS4yNCBvciBsYXRlclxuICAgICAqICAtIEthcnBlbnRlciBQb2RzIG11c3QgYmUgYXNzaWduZWQgdG8gTGludXggQW1hem9uIEVDMiBpbnN0YW5jZXNcbiAgICAgKiAgLSBLYXJwZW50ZXIgdmVyc2lvbiBzdXBwb3J0cyBQb2QgSWRlbnRpdHkgKHYwLjM1LjAgb3IgbGF0ZXIpIHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vZWtzL2xhdGVzdC91c2VyZ3VpZGUvcG9kLWlkZW50aXR5Lmh0bWxcbiAgICAgKlxuICAgICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2Vrcy9sYXRlc3QvdXNlcmd1aWRlL3BvZC1pZGVudGl0eS5odG1sXG4gICAgICpcbiAgICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgICAqL1xuICAgIHBvZElkZW50aXR5PzogYm9vbGVhbixcbn1cblxuXG4vKipcbiAqIERlZmF1bHRzIG9wdGlvbnMgZm9yIHRoZSBhZGQtb25cbiAqL1xuY29uc3QgZGVmYXVsdFByb3BzOiBIZWxtQWRkT25Qcm9wcyA9IHtcbiAgICBuYW1lOiBLQVJQRU5URVIsXG4gICAgbmFtZXNwYWNlOiBcImt1YmUtc3lzdGVtXCIsXG4gICAgdmVyc2lvbjogJzEuMi4xJyxcbiAgICBjaGFydDogS0FSUEVOVEVSLFxuICAgIHJlbGVhc2U6IEtBUlBFTlRFUixcbiAgICByZXBvc2l0b3J5OiAnb2NpOi8vcHVibGljLmVjci5hd3Mva2FycGVudGVyL2thcnBlbnRlcicsXG59O1xuXG4vKipcbiAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSBLYXJwZW50ZXIgYWRkLW9uLlxuICogQGRlcHJlY2F0ZWQgdXNlIEthcnBlbnRlclYxQWRkT24gbW92aW5nIGZvcndhcmRcbiAqL1xuQHV0aWxzLnN1cHBvcnRzQUxMXG5leHBvcnQgY2xhc3MgS2FycGVudGVyQWRkT24gZXh0ZW5kcyBIZWxtQWRkT24ge1xuXG4gICAgcmVhZG9ubHkgb3B0aW9uczogS2FycGVudGVyQWRkT25Qcm9wcztcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzPzogS2FycGVudGVyQWRkT25Qcm9wcykge1xuICAgICAgICBzdXBlcih7Li4uZGVmYXVsdFByb3BzLCAuLi5wcm9wc30pO1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLnByb3BzO1xuICAgIH1cblxuICAgIEB1dGlscy5jb25mbGljdHNXaXRoKCdDbHVzdGVyQXV0b1NjYWxlckFkZE9uJylcbiAgICBAdXRpbHMuY29uZmxpY3RzV2l0aEF1dG9Nb2RlKFwiZmFpbFwiKVxuICAgIGRlcGxveShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiBQcm9taXNlPENvbnN0cnVjdD4ge1xuICAgICAgICBhc3NlcnQoY2x1c3RlckluZm8uY2x1c3RlciBpbnN0YW5jZW9mIENsdXN0ZXIsIFwiS2FycGVudGVyQWRkT24gY2Fubm90IGJlIHVzZWQgd2l0aCBpbXBvcnRlZCBjbHVzdGVycyBhcyBpdCByZXF1aXJlcyBjaGFuZ2VzIHRvIHRoZSBjbHVzdGVyIGF1dGhlbnRpY2F0aW9uLlwiKTtcbiAgICAgICAgY29uc3QgY2x1c3RlciA6IENsdXN0ZXIgPSBjbHVzdGVySW5mby5jbHVzdGVyO1xuICAgICAgICBjb25zdCBlbmRwb2ludCA9IGNsdXN0ZXIuY2x1c3RlckVuZHBvaW50O1xuICAgICAgICBjb25zdCBuYW1lID0gY2x1c3Rlci5jbHVzdGVyTmFtZTtcbiAgICAgICAgY29uc3QgcGFydGl0aW9uID0gY2x1c3Rlci5zdGFjay5wYXJ0aXRpb247XG5cbiAgICAgICAgY29uc3Qgc3RhY2tOYW1lID0gY2x1c3Rlci5zdGFjay5zdGFja05hbWU7XG4gICAgICAgIGNvbnN0IHJlZ2lvbiA9IGNsdXN0ZXIuc3RhY2sucmVnaW9uO1xuXG4gICAgICAgIGxldCB2YWx1ZXMgPSB0aGlzLm9wdGlvbnMudmFsdWVzID8/IHt9O1xuICAgICAgICBjb25zdCB2ZXJzaW9uID0gdGhpcy5vcHRpb25zLnZlcnNpb24hO1xuXG4gICAgICAgIGNvbnN0IGludGVycnVwdGlvbiA9IHRoaXMub3B0aW9ucy5pbnRlcnJ1cHRpb25IYW5kbGluZyB8fCBmYWxzZTtcbiAgICAgICAgY29uc3QgaW5zdGFsbENSRHMgPSB0aGlzLm9wdGlvbnMuaW5zdGFsbENSRHMgfHwgZmFsc2U7XG5cbiAgICAgICAgY29uc3QgcG9kSWRlbnRpdHkgPSB0aGlzLm9wdGlvbnMucG9kSWRlbnRpdHkgfHwgZmFsc2U7XG5cbiAgICAgICAgLy8gTm9kZVBvb2wgdmFyaWFibGVzXG4gICAgICAgIGNvbnN0IGxhYmVscyA9IHRoaXMub3B0aW9ucy5ub2RlUG9vbFNwZWM/LmxhYmVscyB8fCB7fTtcbiAgICAgICAgY29uc3QgYW5ub3RhdGlvbnMgPSB0aGlzLm9wdGlvbnMubm9kZVBvb2xTcGVjPy5hbm5vdGF0aW9ucyB8fCB7fTtcbiAgICAgICAgY29uc3QgdGFpbnRzID0gdGhpcy5vcHRpb25zLm5vZGVQb29sU3BlYz8udGFpbnRzIHx8IFtdO1xuICAgICAgICBjb25zdCBzdGFydHVwVGFpbnRzID0gdGhpcy5vcHRpb25zLm5vZGVQb29sU3BlYz8uc3RhcnR1cFRhaW50cyB8fCBbXTtcbiAgICAgICAgY29uc3QgcmVxdWlyZW1lbnRzID0gdGhpcy5vcHRpb25zLm5vZGVQb29sU3BlYz8ucmVxdWlyZW1lbnRzIHx8IFtdO1xuICAgICAgICBjb25zdCBjb25zb2wgPSB0aGlzLm9wdGlvbnMubm9kZVBvb2xTcGVjPy5jb25zb2xpZGF0aW9uIHx8IG51bGw7XG4gICAgICAgIGNvbnN0IHR0bFNlY29uZHNBZnRlckVtcHR5ID0gdGhpcy5vcHRpb25zLm5vZGVQb29sU3BlYz8udHRsU2Vjb25kc0FmdGVyRW1wdHkgfHwgbnVsbDtcbiAgICAgICAgY29uc3QgdHRsU2Vjb25kc1VudGlsRXhwaXJlZCA9IHRoaXMub3B0aW9ucy5ub2RlUG9vbFNwZWM/LnR0bFNlY29uZHNVbnRpbEV4cGlyZWQgfHwgbnVsbDtcbiAgICAgICAgY29uc3QgZGlzcnVwdGlvbiA9IHRoaXMub3B0aW9ucy5ub2RlUG9vbFNwZWM/LmRpc3J1cHRpb24gfHwgbnVsbDtcbiAgICAgICAgY29uc3QgbGltaXRzID0gdGhpcy5vcHRpb25zLm5vZGVQb29sU3BlYz8ubGltaXRzIHx8IG51bGw7XG4gICAgICAgIGNvbnN0IHdlaWdodCA9IHRoaXMub3B0aW9ucy5ub2RlUG9vbFNwZWM/LndlaWdodCB8fCBudWxsO1xuXG4gICAgICAgIC8vIE5vZGVDbGFzcyB2YXJpYWJsZXNcbiAgICAgICAgY29uc3Qgc3VibmV0U2VsZWN0b3IgPSB0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYz8uc3VibmV0U2VsZWN0b3I7XG4gICAgICAgIGNvbnN0IHNnU2VsZWN0b3IgPSB0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYz8uc2VjdXJpdHlHcm91cFNlbGVjdG9yO1xuICAgICAgICBjb25zdCBzdWJuZXRTZWxlY3RvclRlcm1zID0gdGhpcy5vcHRpb25zLmVjMk5vZGVDbGFzc1NwZWM/LnN1Ym5ldFNlbGVjdG9yVGVybXM7XG4gICAgICAgIGNvbnN0IHNnU2VsZWN0b3JUZXJtcyA9IHRoaXMub3B0aW9ucy5lYzJOb2RlQ2xhc3NTcGVjPy5zZWN1cml0eUdyb3VwU2VsZWN0b3JUZXJtcztcbiAgICAgICAgY29uc3QgYW1pRmFtaWx5ID0gdGhpcy5vcHRpb25zLmVjMk5vZGVDbGFzc1NwZWM/LmFtaUZhbWlseTtcbiAgICAgICAgY29uc3QgYW1pU2VsZWN0b3IgPSB0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYz8uYW1pU2VsZWN0b3IgfHwge307XG4gICAgICAgIGNvbnN0IGFtaVNlbGVjdG9yVGVybXMgPSB0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYz8uYW1pU2VsZWN0b3JUZXJtcztcbiAgICAgICAgY29uc3QgaW5zdGFuY2VTdG9yZVBvbGljeSA9IHRoaXMub3B0aW9ucy5lYzJOb2RlQ2xhc3NTcGVjPy5pbnN0YW5jZVN0b3JlUG9saWN5IHx8IHVuZGVmaW5lZDtcbiAgICAgICAgY29uc3QgdXNlckRhdGEgPSB0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYz8udXNlckRhdGEgfHwgXCJcIjtcbiAgICAgICAgY29uc3QgaW5zdGFuY2VQcm9mID0gdGhpcy5vcHRpb25zLmVjMk5vZGVDbGFzc1NwZWM/Lmluc3RhbmNlUHJvZmlsZTtcbiAgICAgICAgY29uc3QgdGFncyA9IHRoaXMub3B0aW9ucy5lYzJOb2RlQ2xhc3NTcGVjPy50YWdzIHx8IHt9O1xuICAgICAgICBjb25zdCBtZXRhZGF0YU9wdGlvbnMgPSB0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYz8ubWV0YWRhdGFPcHRpb25zIHx8IHtcbiAgICAgICAgICAgIGh0dHBFbmRwb2ludDogXCJlbmFibGVkXCIsXG4gICAgICAgICAgICBodHRwUHJvdG9jb2xJUHY2OiBcImRpc2FibGVkXCIsXG4gICAgICAgICAgICBodHRwUHV0UmVzcG9uc2VIb3BMaW1pdDogMixcbiAgICAgICAgICAgIGh0dHBUb2tlbnM6IFwicmVxdWlyZWRcIlxuICAgICAgICB9O1xuICAgICAgICBpZiAoY2x1c3Rlci5pcEZhbWlseSA9PSBJcEZhbWlseS5JUF9WNikge1xuICAgICAgICAgICAgbWV0YWRhdGFPcHRpb25zLmh0dHBQcm90b2NvbElQdjYgPSBcImVuYWJsZWRcIjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBibG9ja0RldmljZU1hcHBpbmdzID0gdGhpcy5vcHRpb25zLmVjMk5vZGVDbGFzc1NwZWM/LmJsb2NrRGV2aWNlTWFwcGluZ3MgfHwgW107XG4gICAgICAgIGNvbnN0IGRldGFpbGVkTW9uaXRvcmluZyA9IHRoaXMub3B0aW9ucy5lYzJOb2RlQ2xhc3NTcGVjPy5kZXRhaWxlZE1vbml0b3JpbmcgfHwgZmFsc2U7XG5cbiAgICAgICAgLy8gQ2hlY2sgS3ViZXJuZXRlcyBhbmQgS2FycGVudGVyIHZlcnNpb24gY29tcGF0aWJpbGl0eSBmb3Igd2FybmluZ1xuICAgICAgICB0aGlzLmlzQ29tcGF0aWJsZSh2ZXJzaW9uLCBjbHVzdGVySW5mby52ZXJzaW9uKTtcblxuICAgICAgICAvLyBWZXJzaW9uIGZlYXR1cmUgY2hlY2tzIGZvciBlcnJvcnNcbiAgICAgICAgdGhpcy52ZXJzaW9uRmVhdHVyZUNoZWNrc0ZvckVycm9yKGNsdXN0ZXJJbmZvLCB2ZXJzaW9uLCBkaXNydXB0aW9uLCBjb25zb2wsIHR0bFNlY29uZHNBZnRlckVtcHR5LCB0dGxTZWNvbmRzVW50aWxFeHBpcmVkLFxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLmVjMk5vZGVDbGFzc1NwZWMsIGFtaUZhbWlseSk7XG5cbiAgICAgICAgLy8gU2V0IHVwIHRoZSBub2RlIHJvbGUgYW5kIGluc3RhbmNlIHByb2ZpbGVcbiAgICAgICAgY29uc3QgW2thcnBlbnRlck5vZGVSb2xlLCBrYXJwZW50ZXJJbnN0YW5jZVByb2ZpbGVdID0gdGhpcy5zZXRVcE5vZGVSb2xlKGNsdXN0ZXIsIHN0YWNrTmFtZSwgcmVnaW9uKTtcblxuICAgICAgICAvLyBDcmVhdGUgdGhlIGNvbnRyb2xsZXIgcG9saWN5XG4gICAgICAgIGxldCBrYXJwZW50ZXJQb2xpY3lEb2N1bWVudDtcbiAgICAgICAgaWYgKHNlbXZlci5ndGUodmVyc2lvbiwgXCJ2MC4zMi4wXCIpKXtcbiAgICAgICAgICAgIGthcnBlbnRlclBvbGljeURvY3VtZW50ID0gaWFtLlBvbGljeURvY3VtZW50LmZyb21Kc29uKEthcnBlbnRlckNvbnRyb2xsZXJQb2xpY3lCZXRhKGNsdXN0ZXIsIHBhcnRpdGlvbiwgcmVnaW9uKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBrYXJwZW50ZXJQb2xpY3lEb2N1bWVudCA9IGlhbS5Qb2xpY3lEb2N1bWVudC5mcm9tSnNvbihLYXJwZW50ZXJDb250cm9sbGVyUG9saWN5KTtcbiAgICAgICAgfVxuICAgICAgICBrYXJwZW50ZXJQb2xpY3lEb2N1bWVudC5hZGRTdGF0ZW1lbnRzKG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICBcImlhbTpQYXNzUm9sZVwiLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIHJlc291cmNlczogW2Ake2thcnBlbnRlck5vZGVSb2xlLnJvbGVBcm59YF1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIC8vIFN1cHBvcnQgZm9yIE5hdGl2ZSBzcG90IGludGVycnVwdGlvblxuICAgICAgICBpZiAoaW50ZXJydXB0aW9uKXtcbiAgICAgICAgICAgIC8vIENyZWF0ZSBJbnRlcnJ1cHRpb24gUXVldWVcbiAgICAgICAgICAgIGNvbnN0IHF1ZXVlID0gbmV3IHNxcy5RdWV1ZShjbHVzdGVyLnN0YWNrLCAna2FycGVudGVyLXF1ZXVlJywge1xuICAgICAgICAgICAgICAgIHF1ZXVlTmFtZTogc3RhY2tOYW1lLFxuICAgICAgICAgICAgICAgIHJldGVudGlvblBlcmlvZDogRHVyYXRpb24uc2Vjb25kcygzMDApLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBxdWV1ZS5hZGRUb1Jlc291cmNlUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBzaWQ6ICdFQzJJbnRlcnJ1cHRpb25Qb2xpY3knLFxuICAgICAgICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgICAgICBwcmluY2lwYWxzOiBbXG4gICAgICAgICAgICAgICAgICAgIG5ldyBpYW0uU2VydmljZVByaW5jaXBhbCgnc3FzLmFtYXpvbmF3cy5jb20nKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKCdldmVudHMuYW1hem9uYXdzLmNvbScpLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICAgICBcInNxczpTZW5kTWVzc2FnZVwiXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtgJHtxdWV1ZS5xdWV1ZUFybn1gXVxuICAgICAgICAgICAgfSkpO1xuXG4gICAgICAgICAgICAvLyBBZGQgSW50ZXJydXB0aW9uIFJ1bGVzXG4gICAgICAgICAgICBuZXcgUnVsZShjbHVzdGVyLnN0YWNrLCAnc2NoZWR1bGUtY2hhbmdlLXJ1bGUnLCB7XG4gICAgICAgICAgICAgICAgZXZlbnRQYXR0ZXJuOiB7XG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZTogW1wiYXdzLmhlYWx0aFwiXSxcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsVHlwZTogWydBV1MgSGVhbHRoIEV2ZW50J11cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSkuYWRkVGFyZ2V0KG5ldyBTcXNRdWV1ZShxdWV1ZSkpO1xuXG4gICAgICAgICAgICBuZXcgUnVsZShjbHVzdGVyLnN0YWNrLCAnc3BvdC1pbnRlcnJ1cHRpb24tcnVsZScsIHtcbiAgICAgICAgICAgICAgICBldmVudFBhdHRlcm46IHtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlOiBbXCJhd3MuZWMyXCJdLFxuICAgICAgICAgICAgICAgICAgICBkZXRhaWxUeXBlOiBbJ0VDMiBTcG90IEluc3RhbmNlIEludGVycnVwdGlvbiBXYXJuaW5nJ11cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSkuYWRkVGFyZ2V0KG5ldyBTcXNRdWV1ZShxdWV1ZSkpO1xuXG4gICAgICAgICAgICBuZXcgUnVsZShjbHVzdGVyLnN0YWNrLCAncmViYWxhbmNlLXJ1bGUnLCB7XG4gICAgICAgICAgICAgICAgZXZlbnRQYXR0ZXJuOiB7XG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZTogW1wiYXdzLmVjMlwiXSxcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsVHlwZTogWydFQzIgSW5zdGFuY2UgUmViYWxhbmNlIFJlY29tbWVuZGF0aW9uJ11cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSkuYWRkVGFyZ2V0KG5ldyBTcXNRdWV1ZShxdWV1ZSkpO1xuXG4gICAgICAgICAgICBuZXcgUnVsZShjbHVzdGVyLnN0YWNrLCAnaW5zdC1zdGF0ZS1jaGFuZ2UtcnVsZScsIHtcbiAgICAgICAgICAgICAgICBldmVudFBhdHRlcm46IHtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlOiBbXCJhd3MuZWMyXCJdLFxuICAgICAgICAgICAgICAgICAgICBkZXRhaWxUeXBlOiBbJ0MyIEluc3RhbmNlIFN0YXRlLWNoYW5nZSBOb3RpZmljYXRpb24nXVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KS5hZGRUYXJnZXQobmV3IFNxc1F1ZXVlKHF1ZXVlKSk7XG5cbiAgICAgICAgICAgIC8vIEFkZCBwb2xpY3kgdG8gdGhlIG5vZGUgcm9sZSB0byBhbGxvdyBhY2Nlc3MgdG8gdGhlIEludGVycnVwdGlvbiBRdWV1ZVxuICAgICAgICAgICAgY29uc3QgaW50ZXJydXB0aW9uUXVldWVTdGF0ZW1lbnQgPSBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAgXCJzcXM6RGVsZXRlTWVzc2FnZVwiLFxuICAgICAgICAgICAgICAgICAgICBcInNxczpHZXRRdWV1ZVVybFwiLFxuICAgICAgICAgICAgICAgICAgICBcInNxczpHZXRRdWV1ZUF0dHJpYnV0ZXNcIixcbiAgICAgICAgICAgICAgICAgICAgXCJzcXM6UmVjZWl2ZU1lc3NhZ2VcIlxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbYCR7cXVldWUucXVldWVBcm59YF1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAga2FycGVudGVyUG9saWN5RG9jdW1lbnQuYWRkU3RhdGVtZW50cyhpbnRlcnJ1cHRpb25RdWV1ZVN0YXRlbWVudCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDcmVhdGUgTmFtZXNwYWNlXG4gICAgICAgIGNvbnN0IG5zID0gdXRpbHMuY3JlYXRlTmFtZXNwYWNlKHRoaXMub3B0aW9ucy5uYW1lc3BhY2UhLCBjbHVzdGVyLCB0cnVlLCB0cnVlKTtcblxuICAgICAgICBsZXQgc2E6IGFueTtcbiAgICAgICAgbGV0IHNhQW5ub3RhdGlvbjogYW55O1xuICAgICAgICBpZiAocG9kSWRlbnRpdHkgJiYgc2VtdmVyLmd0ZShgJHtjbHVzdGVySW5mby52ZXJzaW9uLnZlcnNpb259LjBgLCAnMS4yNC4wJykgJiYgc2VtdmVyLmd0ZSh2ZXJzaW9uLCBcInYwLjM1LjBcIikpe1xuICAgICAgICAgIHNhID0gdXRpbHMucG9kSWRlbnRpdHlBc3NvY2lhdGlvbihjbHVzdGVyLCBSRUxFQVNFLCB0aGlzLm9wdGlvbnMubmFtZXNwYWNlISwga2FycGVudGVyUG9saWN5RG9jdW1lbnQpO1xuICAgICAgICAgIHNhQW5ub3RhdGlvbiA9IHt9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHNhID0gdXRpbHMuY3JlYXRlU2VydmljZUFjY291bnQoY2x1c3RlciwgUkVMRUFTRSwgdGhpcy5vcHRpb25zLm5hbWVzcGFjZSEsIGthcnBlbnRlclBvbGljeURvY3VtZW50KTtcbiAgICAgICAgICBzYUFubm90YXRpb24gPSB7XCJla3MuYW1hem9uYXdzLmNvbS9yb2xlLWFyblwiOiBzYS5yb2xlLnJvbGVBcm59O1xuICAgICAgICB9XG4gICAgICAgIHNhLm5vZGUuYWRkRGVwZW5kZW5jeShucyk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIGdsb2JhbCBoZWxtIHZhbHVlcyBiYXNlZCBvbiB2MWJldGExIG1pZ3JhdGlvbiBhcyBzaG93biBiZWxvdzpcbiAgICAgICAgLy8gaHR0cHM6Ly9rYXJwZW50ZXIuc2gvdjAuMzIvdXBncmFkaW5nL3YxYmV0YTEtbWlncmF0aW9uLyNoZWxtLXZhbHVlc1xuICAgICAgICBsZXQgZ2xvYmFsU2V0dGluZ3MgPSB7XG4gICAgICAgICAgICBjbHVzdGVyTmFtZTogbmFtZSxcbiAgICAgICAgICAgIGNsdXN0ZXJFbmRwb2ludDogZW5kcG9pbnRcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoc2VtdmVyLmx0KHZlcnNpb24sICcwLjMyLjAnKSl7XG4gICAgICAgICAgICBnbG9iYWxTZXR0aW5ncyA9IG1lcmdlKGdsb2JhbFNldHRpbmdzLCB7XG4gICAgICAgICAgICAgICAgZGVmYXVsdEluc3RhbmNlUHJvZmlsZToga2FycGVudGVySW5zdGFuY2VQcm9maWxlLmluc3RhbmNlUHJvZmlsZU5hbWUsXG4gICAgICAgICAgICAgICAgaW50ZXJydXB0aW9uUXVldWVOYW1lOiBpbnRlcnJ1cHRpb24gPyBzdGFja05hbWUgOiBcIlwiXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGdsb2JhbFNldHRpbmdzID0gbWVyZ2UoZ2xvYmFsU2V0dGluZ3MsIHtcbiAgICAgICAgICAgICAgICBpbnRlcnJ1cHRpb25RdWV1ZTogaW50ZXJydXB0aW9uID8gc3RhY2tOYW1lIDogXCJcIlxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc2VtdmVyLmx0KHZlcnNpb24sICcwLjMyLjAnKSl7XG4gICAgICAgICAgICB1dGlscy5zZXRQYXRoKHZhbHVlcywgXCJzZXR0aW5ncy5hd3NcIiwgbWVyZ2UoZ2xvYmFsU2V0dGluZ3MsIHZhbHVlcz8uc2V0dGluZ3M/LmF3cyA/PyB7fSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdXRpbHMuc2V0UGF0aCh2YWx1ZXMsIFwic2V0dGluZ3NcIiwgbWVyZ2UoZ2xvYmFsU2V0dGluZ3MsIHZhbHVlcz8uc2V0dGluZ3MgPz8ge30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIExldCBIZWxtIGNyZWF0ZSB0aGUgc2VydmljZSBhY2NvdW50IGlmIHVzaW5nIHBvZCBpZGVudGl0eVxuICAgICAgICBjb25zdCBzYVZhbHVlcyA9IHtcbiAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50OiB7XG4gICAgICAgICAgICAgICAgY3JlYXRlOiBwb2RJZGVudGl0eSxcbiAgICAgICAgICAgICAgICBuYW1lOiBSRUxFQVNFLFxuICAgICAgICAgICAgICAgIGFubm90YXRpb25zOiBzYUFubm90YXRpb24sXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFsdWVzID0gbWVyZ2UodmFsdWVzLCBzYVZhbHVlcyk7XG4gICAgICAgIC8vIEluc3RhbGwgSGVsbUNoYXJ0IHVzaW5nIHVzZXIgZGVmaW5lZCB2YWx1ZSBvciBkZWZhdWx0IG9mIDUgbWludXRlcy5cbiAgICAgICAgY29uc3QgaGVsbUNoYXJ0VGltZW91dCA9IHRoaXMub3B0aW9ucy5oZWxtQ2hhcnRUaW1lb3V0IHx8IER1cmF0aW9uLm1pbnV0ZXMoNSk7XG4gICAgICAgIGNvbnN0IGthcnBlbnRlckNoYXJ0ID0gdGhpcy5hZGRIZWxtQ2hhcnQoY2x1c3RlckluZm8sIHZhbHVlcywgZmFsc2UsIHRydWUsIGhlbG1DaGFydFRpbWVvdXQpO1xuXG4gICAgICAgIGthcnBlbnRlckNoYXJ0Lm5vZGUuYWRkRGVwZW5kZW5jeShzYSk7XG5cbiAgICAgICAgaWYoY2x1c3RlckluZm8ubm9kZUdyb3Vwcykge1xuICAgICAgICAgICAgY2x1c3RlckluZm8ubm9kZUdyb3Vwcy5mb3JFYWNoKG4gPT4ga2FycGVudGVyQ2hhcnQubm9kZS5hZGREZXBlbmRlbmN5KG4pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzZW12ZXIuZ3RlKHZlcnNpb24sIFwiMC4zMi4wXCIpICYmIGluc3RhbGxDUkRzKXtcbiAgICAgICAgICAgIGxldCBfdmVyc2lvbiA9IHZlcnNpb247XG4gICAgICAgICAgICBpZighdmVyc2lvbi5zdGFydHNXaXRoKCd2JykpIHtcbiAgICAgICAgICAgICAgICBfdmVyc2lvbiA9IGB2JHt2ZXJzaW9ufWA7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IENSRHMgPVtcbiAgICAgICAgICAgICAgICBbIFwia2FycGVudGVyc2gtbm9kZXBvb2wtYmV0YTEtY3JkXCIsIGBodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vYXdzL2thcnBlbnRlci8ke192ZXJzaW9ufS9wa2cvYXBpcy9jcmRzL2thcnBlbnRlci5zaF9ub2RlcG9vbHMueWFtbGAgXSxcbiAgICAgICAgICAgICAgICBbIFwia2FycGVudGVyc2gtbm9kZWNsYWltcy1iZXRhMS1jcmRcIiwgYGh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9hd3Mva2FycGVudGVyLyR7X3ZlcnNpb259L3BrZy9hcGlzL2NyZHMva2FycGVudGVyLnNoX25vZGVjbGFpbXMueWFtbGBdLFxuICAgICAgICAgICAgICAgIFsgXCJrYXJwZW50ZXJrOHMtZWMybm9kZWNsYXNzZXMtYmV0YTEtY3JkXCIsIGBodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vYXdzL2thcnBlbnRlci8ke192ZXJzaW9ufS9wa2cvYXBpcy9jcmRzL2thcnBlbnRlci5rOHMuYXdzX2VjMm5vZGVjbGFzc2VzLnlhbWxgXSxcbiAgICAgICAgICAgIF07XG5cbiAgICAgICAgICAgIC8vIGxvb3Agb3ZlciB0aGUgQ1JEJ3MgYW5kIGxvYWQgdGhlIHlhbWwgYW5kIGRlcGxveSB0aGUgbWFuaWZlc3RcbiAgICAgICAgICAgIGZvciAoY29uc3QgW2NyZE5hbWUsIGNyZFVybF0gb2YgQ1JEcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNyZE1hbmlmZXN0ID0gdXRpbHMubG9hZEV4dGVybmFsWWFtbChjcmRVcmwpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hbmlmZXN0ID0gY2x1c3Rlci5hZGRNYW5pZmVzdChjcmROYW1lLCBjcmRNYW5pZmVzdCk7XG5cbiAgICAgICAgICAgICAgICAvLyBXZSB3YW50IHRoZXNlIGluc3RhbGxlZCBiZWZvcmUgdGhlIGthcnBlbnRlckNoYXJ0LCBvciBoZWxtIHdpbGwgdGltZW91dCB3YWl0aW5nIGZvciBpdCB0byBzdGFiaWxpemVcbiAgICAgICAgICAgICAgICBrYXJwZW50ZXJDaGFydC5ub2RlLmFkZERlcGVuZGVuY3kobWFuaWZlc3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cblxuICAgICAgICAvLyBEZXBsb3kgUHJvdmlzaW9uZXIgKEFscGhhKSBvciBOb2RlUG9vbCAoQmV0YSkgQ1JEIGJhc2VkIG9uIHRoZSBLYXJwZW50ZXIgVmVyc2lvblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLm5vZGVQb29sU3BlYyl7XG4gICAgICAgICAgICBsZXQgcG9vbDtcbiAgICAgICAgICAgIGlmIChzZW12ZXIuZ3RlKHZlcnNpb24sICcwLjMyLjAnKSl7XG4gICAgICAgICAgICAgICAgcG9vbCA9IHtcbiAgICAgICAgICAgICAgICAgICAgYXBpVmVyc2lvbjogJ2thcnBlbnRlci5zaC92MWJldGExJyxcbiAgICAgICAgICAgICAgICAgICAga2luZDogJ05vZGVQb29sJyxcbiAgICAgICAgICAgICAgICAgICAgbWV0YWRhdGE6IHsgbmFtZTogJ2RlZmF1bHQtbm9kZXBvb2wnIH0sXG4gICAgICAgICAgICAgICAgICAgIHNwZWM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxzOiBsYWJlbHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25zOiBhbm5vdGF0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUNsYXNzUmVmOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBcImRlZmF1bHQtZWMybm9kZWNsYXNzXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFpbnRzOiB0YWludHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0dXBUYWludHM6IHN0YXJ0dXBUYWludHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVtZW50czogdGhpcy5jb252ZXJ0KHJlcXVpcmVtZW50cyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3J1cHRpb246IGRpc3J1cHRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW1pdHM6IGxpbWl0cyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHdlaWdodDogd2VpZ2h0LFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBvb2wgPSB7XG4gICAgICAgICAgICAgICAgICAgIGFwaVZlcnNpb246ICdrYXJwZW50ZXIuc2gvdjFhbHBoYTUnLFxuICAgICAgICAgICAgICAgICAgICBraW5kOiAnUHJvdmlzaW9uZXInLFxuICAgICAgICAgICAgICAgICAgICBtZXRhZGF0YTogeyBuYW1lOiAnZGVmYXVsdC1wcm92aXNpb25lcicgfSxcbiAgICAgICAgICAgICAgICAgICAgc3BlYzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXJSZWY6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBcImRlZmF1bHQtbm9kZXRlbXBsYXRlXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWludHM6IHRhaW50cyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0dXBUYWludHM6IHN0YXJ0dXBUYWludHMsXG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbHM6IGxhYmVscyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25zOiBhbm5vdGF0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVtZW50czogdGhpcy5jb252ZXJ0KHJlcXVpcmVtZW50cyksXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW1pdHM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXM6IGxpbWl0cyxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xpZGF0aW9uOiBjb25zb2wsXG4gICAgICAgICAgICAgICAgICAgICAgICB0dGxTZWNvbmRzVW50aWxFeHBpcmVkOiB0dGxTZWNvbmRzVW50aWxFeHBpcmVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHRsU2Vjb25kc0FmdGVyRW1wdHk6IHR0bFNlY29uZHNBZnRlckVtcHR5LFxuICAgICAgICAgICAgICAgICAgICAgICAgd2VpZ2h0OiB3ZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHBvb2xNYW5pZmVzdCA9IGNsdXN0ZXIuYWRkTWFuaWZlc3QoJ2RlZmF1bHQtcG9vbCcsIHBvb2wpO1xuICAgICAgICAgICAgcG9vbE1hbmlmZXN0Lm5vZGUuYWRkRGVwZW5kZW5jeShrYXJwZW50ZXJDaGFydCk7XG5cbiAgICAgICAgICAgIC8vIERlcGxveSBBV1NOb2RlVGVtcGxhdGUgKEFscGhhKSBvciBFQzJOb2RlQ2xhc3MgKEJldGEpIENSRCBiYXNlZCBvbiB0aGUgS2FycGVudGVyIFZlcnNpb25cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYyl7XG4gICAgICAgICAgICAgICAgbGV0IGVjMk5vZGU7XG4gICAgICAgICAgICAgICAgaWYgKHNlbXZlci5ndGUodmVyc2lvbiwgJzAuMzIuMCcpKXtcbiAgICAgICAgICAgICAgICAgICAgZWMyTm9kZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwaVZlcnNpb246IFwia2FycGVudGVyLms4cy5hd3MvdjFiZXRhMVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAga2luZDogXCJFQzJOb2RlQ2xhc3NcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogXCJkZWZhdWx0LWVjMm5vZGVjbGFzc1wiXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgc3BlYzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtaUZhbWlseTogYW1pRmFtaWx5LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Ym5ldFNlbGVjdG9yVGVybXM6IHN1Ym5ldFNlbGVjdG9yVGVybXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjdXJpdHlHcm91cFNlbGVjdG9yVGVybXM6IHNnU2VsZWN0b3JUZXJtcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbWlTZWxlY3RvclRlcm1zOiBhbWlTZWxlY3RvclRlcm1zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJEYXRhOiB1c2VyRGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWdzOiB0YWdzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGFkYXRhT3B0aW9uczogbWV0YWRhdGFPcHRpb25zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrRGV2aWNlTWFwcGluZ3M6IGJsb2NrRGV2aWNlTWFwcGluZ3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlsZWRNb25pdG9yaW5nOiBkZXRhaWxlZE1vbml0b3JpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIFByb3ZpZGUgY3VzdG9tIEluc3RhbmNlIFByb2ZpbGUgdG8gcmVwbGFjZSByb2xlIGlmIHByb3ZpZGVkLCBlbHNlIHVzZSB0aGUgcm9sZSBjcmVhdGVkIHdpdGggdGhlIGFkZG9uXG4gICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZVByb2YpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVjMk5vZGUgPSBtZXJnZShlYzJOb2RlLCB7IHNwZWM6IHsgaW5zdGFuY2VQcm9maWxlOiBpbnN0YW5jZVByb2YgfX0pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWMyTm9kZSA9IG1lcmdlKGVjMk5vZGUsIHsgc3BlYzogeyByb2xlOiBrYXJwZW50ZXJOb2RlUm9sZS5yb2xlTmFtZSB9fSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBJbnN0YW5jZSBTdG9yZSBQb2xpY3kgYWRkZWQgZm9yIHYwLjM0LjAgYW5kIHVwXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZW12ZXIuZ3RlKHZlcnNpb24sICcwLjM0LjAnKSAmJiBpbnN0YW5jZVN0b3JlUG9saWN5KXtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVjMk5vZGUgPSBtZXJnZShlYzJOb2RlLCB7IHNwZWM6IHsgaW5zdGFuY2VTdG9yZVBvbGljeTogaW5zdGFuY2VTdG9yZVBvbGljeSB9fSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBlYzJOb2RlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBpVmVyc2lvbjogXCJrYXJwZW50ZXIuazhzLmF3cy92MWFscGhhMVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAga2luZDogXCJBV1NOb2RlVGVtcGxhdGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogXCJkZWZhdWx0LW5vZGV0ZW1wbGF0ZVwiXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgc3BlYzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Ym5ldFNlbGVjdG9yOiBzdWJuZXRTZWxlY3RvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWN1cml0eUdyb3VwU2VsZWN0b3I6IHNnU2VsZWN0b3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VQcm9maWxlOiBpbnN0YW5jZVByb2YgPyBpbnN0YW5jZVByb2YgOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtaUZhbWlseTogYW1pRmFtaWx5ID8gYW1pRmFtaWx5IDogXCJBTDJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbWlTZWxlY3RvcjogYW1pU2VsZWN0b3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFnczogdGFncyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRhZGF0YU9wdGlvbnM6IG1ldGFkYXRhT3B0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9ja0RldmljZU1hcHBpbmdzOiBibG9ja0RldmljZU1hcHBpbmdzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJEYXRhOiB1c2VyRGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIEVDMiBEZXRhaWxlZCBNb25pdG9yaW5nIGZvciB2MC4yMi4wIGFuZCB1cFxuICAgICAgICAgICAgICAgICAgICBpZiAoc2VtdmVyLmd0ZSh2ZXJzaW9uLCAnMC4yMi4wJykpe1xuICAgICAgICAgICAgICAgICAgICAgICAgZWMyTm9kZSA9IG1lcmdlKGVjMk5vZGUsIHsgc3BlYzogeyBkZXRhaWxlZE1vbml0b3Jpbmc6IGRldGFpbGVkTW9uaXRvcmluZ319KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBub2RlTWFuaWZlc3QgPSBjbHVzdGVyLmFkZE1hbmlmZXN0KCdkZWZhdWx0LW5vZGUtdGVtcGxhdGUnLCBlYzJOb2RlKTtcbiAgICAgICAgICAgICAgICBub2RlTWFuaWZlc3Qubm9kZS5hZGREZXBlbmRlbmN5KHBvb2xNYW5pZmVzdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGthcnBlbnRlckNoYXJ0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBIZWxwZXIgZnVuY3Rpb24gdG8gY29udmVydCBhIGtleS1wYWlyIHZhbHVlcyAod2l0aCBhbiBvcGVyYXRvcilcbiAgICAgKiBvZiBzcGVjIGNvbmZpZ3VyYXRpb25zIHRvIGFwcHJvcHJpYXRlIGpzb24gZm9ybWF0IGZvciBhZGRNYW5pZmVzdCBmdW5jdGlvblxuICAgICAqIEBwYXJhbSByZXFzXG4gICAgICogQHJldHVybnMgbmV3UmVxc1xuICAgICAqICovXG4gICAgcHJvdGVjdGVkIGNvbnZlcnQocmVxczoge2tleTogc3RyaW5nLCBvcGVyYXRvcjogc3RyaW5nLCB2YWx1ZXM6IHN0cmluZ1tdfVtdKTogYW55W10ge1xuICAgICAgICBjb25zdCBuZXdSZXFzID0gW107XG4gICAgICAgIGZvciAobGV0IHJlcSBvZiByZXFzKXtcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IHJlcVsna2V5J107XG4gICAgICAgICAgICBjb25zdCBvcCA9IHJlcVsnb3BlcmF0b3InXTtcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHJlcVsndmFsdWVzJ107XG4gICAgICAgICAgICBjb25zdCByZXF1aXJlbWVudCA9IHtcbiAgICAgICAgICAgICAgICBcImtleVwiOiBrZXksXG4gICAgICAgICAgICAgICAgXCJvcGVyYXRvclwiOiBvcCxcbiAgICAgICAgICAgICAgICBcInZhbHVlc1wiOiB2YWxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBuZXdSZXFzLnB1c2gocmVxdWlyZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXdSZXFzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhlbHBlciBmdW5jdGlvbiB0byBlbnN1cmUgcmlnaHQgZmVhdHVyZXMgYXJlIGFkZGVkIGFzIHBhcnQgb2YgdGhlIGNvbmZpZ3VyYXRpb25cbiAgICAgKiBmb3IgdGhlIHJpZ2h0IHZlcnNpb24gb2YgdGhlIGFkZC1vblxuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mb1xuICAgICAqIEBwYXJhbSB2ZXJzaW9uIHZlcnNpb24gb2YgdGhlIGFkZC1vblxuICAgICAqIEBwYXJhbSBkaXNydXB0aW9uIGRpc3J1cHRpb24gZmVhdHVyZSBhdmFpbGFibGUgd2l0aCB0aGUgQmV0YSBDUkRzXG4gICAgICogQHBhcmFtIGNvbnNvbGlkYXRpb24gY29uc29saWRhdGlvbiBzZXR0aW5nIGF2YWlsYWJsZSB3aXRoIHRoZSBBbHBoYSBDUkRzXG4gICAgICogQHBhcmFtIHR0bFNlY29uZHNBZnRlckVtcHR5IHR0bFNlY29uZHNBZnRlckVtcHR5IHNldHRpbmdcbiAgICAgKiBAcGFyYW0gdHRsU2Vjb25kc1VudGlsRXhwaXJlZCB0dGxTZWNvbmRzVW50aWxFeHBpcmVkIHNldHRpbmdcbiAgICAgKiBAcGFyYW0gZWMyTm9kZUNsYXNzU3BlYyBOb2RlIENsYXNzIFNwZWNcbiAgICAgKiBAcGFyYW0gYW1pRmFtaWx5IEFNSSBGYW1pbHlcbiAgICAgKiBAcmV0dXJuc1xuICAgICAqL1xuICAgIHByaXZhdGUgdmVyc2lvbkZlYXR1cmVDaGVja3NGb3JFcnJvcihjbHVzdGVySW5mbzogQ2x1c3RlckluZm8sIHZlcnNpb246IHN0cmluZywgZGlzcnVwdGlvbjogYW55LCBjb25zb2xpZGF0aW9uOiBhbnksIHR0bFNlY29uZHNBZnRlckVtcHR5OiBhbnksIHR0bFNlY29uZHNVbnRpbEV4cGlyZWQ6IGFueSxcbiAgICAgICAgZWMyTm9kZUNsYXNzU3BlYzogYW55LCBhbWlGYW1pbHk6IGFueSk6IHZvaWQge1xuXG4gICAgICAgIC8vIEVDMiBEZXRhaWxlZCBNb25pdG9yaW5nIGlzIG9ubHkgYXZhaWxhYmxlIGluIHZlcnNpb25zIDAuMjMuMCBhbmQgYWJvdmVcbiAgICAgICAgaWYgKHNlbXZlci5sdCh2ZXJzaW9uLCAnMC4yMy4wJykgJiYgZWMyTm9kZUNsYXNzU3BlYyl7XG4gICAgICAgICAgICBhc3NlcnQoZWMyTm9kZUNsYXNzU3BlY1tcImRldGFpbGVkTW9uaXRvcmluZ1wiXSA9PT0gdW5kZWZpbmVkLCBcIkRldGFpbGVkIE1vbml0b3JpbmcgaXMgbm90IGF2YWlsYWJsZSBpbiB0aGlzIHZlcnNpb24gb2YgS2FycGVudGVyLiBQbGVhc2UgdXBncmFkZSB0byBhdCBsZWFzdCAwLjIzLjAuXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRGlzcnVwdGlvbiBidWRnZXQgc2hvdWxkIG5vdCBleGlzdCBmb3IgdmVyc2lvbnMgYmVsb3cgMC4zNC54XG4gICAgICAgIGlmIChzZW12ZXIubHQodmVyc2lvbiwgJzAuMzQuMCcpKXtcbiAgICAgICAgICAgIGlmIChkaXNydXB0aW9uKXtcbiAgICAgICAgICAgICAgICBhc3NlcnQoIWRpc3J1cHRpb25bXCJidWRnZXRzXCJdLCBcIllvdSBjYW5ub3Qgc2V0IGRpc3J1cHRpb24gYnVkZ2V0cyBmb3IgdGhpcyB2ZXJzaW9uIG9mIEthcnBlbnRlci4gUGxlYXNlIHVwZ3JhZGUgdG8gMC4zNC4wIG9yIGhpZ2hlci5cIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyB2ZXJzaW9uIGNoZWNrIGVycm9ycyBmb3IgdjAuMzIuMCBhbmQgdXAgKGJldGEgQ1JEcylcbiAgICAgICAgaWYgKHNlbXZlci5ndGUodmVyc2lvbiwgJzAuMzIuMCcpKXtcbiAgICAgICAgICAgIC8vIENvbnNvbGlkYXRpb24gZmVhdHVyZXMgZG9uJ3QgZXhpc3QgaW4gYmV0YSBDUkRzXG4gICAgICAgICAgICBhc3NlcnQoIWNvbnNvbGlkYXRpb24gJiYgIXR0bFNlY29uZHNBZnRlckVtcHR5ICYmICF0dGxTZWNvbmRzVW50aWxFeHBpcmVkLCAnQ29uc29saWRhdGlvbiBmZWF0dXJlcyBhcmUgb25seSBhdmFpbGFibGUgZm9yIHByZXZpb3VzIHZlcnNpb25zIG9mIEthcnBlbnRlci4nKTtcblxuICAgICAgICAgICAgLy8gY29uc29saWRhdGVBZnRlciBjYW5ub3QgYmUgc2V0IGlmIHBvbGljeSBpcyBzZXQgdG8gV2hlblVuZGVydXRpbGl6ZWRcbiAgICAgICAgICAgIGlmIChkaXNydXB0aW9uICYmIGRpc3J1cHRpb25bXCJjb25zb2xpZGF0aW9uUG9saWN5XCJdID09IFwiV2hlblVuZGVydXRpbGl6ZWRcIil7XG4gICAgICAgICAgICAgICAgYXNzZXJ0KCFkaXNydXB0aW9uW1wiY29uc29saWRhdGVBZnRlclwiXSwgJ1lvdSBjYW5ub3Qgc2V0IGNvbnNvbGlkYXRlQWZ0ZXIgdmFsdWUgaWYgdGhlIGNvbnNvbGlkYXRpb24gcG9saWN5IGlzIHNldCB0byBVbmRlcnV0aWxpemVkLicpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBBTUkgRmFtaWx5LCBTZWN1cml0eSBHcm91cCBhbmQgU3VibmV0IHRlcm1zIG11c3QgYmUgcHJvdmlkZWQsIGdpdmVuIEVDMiBOb2RlU3BlY1xuICAgICAgICAgICAgaWYgKGVjMk5vZGVDbGFzc1NwZWMpe1xuICAgICAgICAgICAgICAgIGFzc2VydChhbWlGYW1pbHkgIT09IHVuZGVmaW5lZCwgXCJQbGVhc2UgcHJvdmlkZSB0aGUgQU1JIEZhbWlseSBmb3IgeW91ciBFQzJOb2RlQ2xhc3MuXCIpO1xuICAgICAgICAgICAgICAgIGFzc2VydChlYzJOb2RlQ2xhc3NTcGVjW1wic2VjdXJpdHlHcm91cFNlbGVjdG9yVGVybXNcIl0gIT09IHVuZGVmaW5lZCwgXCJQbGVhc2UgcHJvdmlkZSBTZWN1cml0eUdyb3VwVGVybSBmb3IgeW91ciBFQzJOb2RlQ2xhc3MuXCIpO1xuICAgICAgICAgICAgICAgIGFzc2VydChlYzJOb2RlQ2xhc3NTcGVjW1wic3VibmV0U2VsZWN0b3JUZXJtc1wiXSAhPT0gdW5kZWZpbmVkLCBcIlBsZWFzZSBwcm92aWRlIHN1Ym5ldEdyb3VwVGVybSBmb3IgeW91ciBFQzJOb2RlQ2xhc3MuXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gdmVyc2lvbiBjaGVjayBlcnJvcnMgZm9yIHYwLjMxLnggYW5kIGRvd24gKGFscGhhIENSRHMpXG4gICAgICAgIC8vIEluY2x1ZGVzIGNoZWNrcyBmb3IgY29uc29saWRhdGlvbiBhbmQgZGlzcnVwdGlvbiBmZWF0dXJlc1xuICAgICAgICBpZiAoc2VtdmVyLmx0KHZlcnNpb24sICcwLjMyLjAnKSl7XG4gICAgICAgICAgICBpZiAoY29uc29saWRhdGlvbil7XG4gICAgICAgICAgICAgICAgYXNzZXJ0KCEoY29uc29saWRhdGlvbi5lbmFibGVkICYmIHR0bFNlY29uZHNBZnRlckVtcHR5KSAsICdDb25zb2xpZGF0aW9uIGFuZCB0dGxTZWNvbmRzQWZ0ZXJFbXB0eSBtdXN0IGJlIG11dHVhbGx5IGV4Y2x1c2l2ZS4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFzc2VydCghZGlzcnVwdGlvbiwgJ0Rpc3J1cHRpb24gY29uZmlndXJhdGlvbiBpcyBvbmx5IHN1cHBvcnRlZCBvbiB2ZXJzaW9ucyB2MC4zMi4wIGFuZCBsYXRlci4nKTtcblxuICAgICAgICAgICAgLy9TZWN1cml0eSBHcm91cCBhbmQgU3VibmV0IHRlcm1zIG11c3QgYmUgcHJvdmlkZWQsIGdpdmVuIEVDMiBOb2RlU3BlY1xuICAgICAgICAgICAgaWYgKGVjMk5vZGVDbGFzc1NwZWMpe1xuICAgICAgICAgICAgICAgIGFzc2VydChlYzJOb2RlQ2xhc3NTcGVjW1wic2VjdXJpdHlHcm91cFNlbGVjdG9yXCJdICE9PSB1bmRlZmluZWQsIFwiUGxlYXNlIHByb3ZpZGUgU2VjdXJpdHlHcm91cFRlcm0gZm9yIHlvdXIgQVdTTm9kZVRlbXBsYXRlLlwiKTtcbiAgICAgICAgICAgICAgICBhc3NlcnQoZWMyTm9kZUNsYXNzU3BlY1tcInN1Ym5ldFNlbGVjdG9yXCJdICE9PSB1bmRlZmluZWQsIFwiUGxlYXNlIHByb3ZpZGUgc3VibmV0R3JvdXBUZXJtIGZvciB5b3VyIEFXU05vZGVUZW1wbGF0ZS5cIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBXZSBzaG91bGQgYmxvY2sgTm9kZSBUZXJtaW5hdGlvbiBIYW5kbGVyIHVzYWdlIG9uY2UgS2FycGVudGVyIGlzIGxldmVyYWdlZFxuICAgICAgICAgYXNzZXJ0KCFjbHVzdGVySW5mby5nZXRQcm92aXNpb25lZEFkZE9uKCdBd3NOb2RlVGVybWluYXRpb25IYW5kbGVyQWRkT24nKSwgJ0thcnBlbnRlciBzdXBwb3J0cyBuYXRpdmUgaW50ZXJydXB0aW9uIGhhbmRsaW5nLCBzbyBOb2RlIFRlcm1pbmF0aW9uIEhhbmRsZXIgd2lsbCBub3QgYmUgbmVjZXNzYXJ5LicpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSGVscGVyIGZ1bmN0aW9uIHRvIHNldCB1cCB0aGUgS2FycGVudGVyIE5vZGUgUm9sZSBhbmQgSW5zdGFuY2UgUHJvZmlsZVxuICAgICAqIE91dHB1dHMgdG8gQ2xvdWRGb3JtYXRpb24gYW5kIG1hcCB0aGUgcm9sZSB0byB0aGUgYXdzLWF1dGggQ29uZmlnTWFwXG4gICAgICogQHBhcmFtIGNsdXN0ZXIgRUtTIENsdXN0ZXJcbiAgICAgKiBAcGFyYW0gc3RhY2tOYW1lIE5hbWUgb2YgdGhlIHN0YWNrXG4gICAgICogQHBhcmFtIHJlZ2lvbiBSZWdpb24gb2YgdGhlIHN0YWNrXG4gICAgICogQHJldHVybnMgW2thcnBlbnRlck5vZGVSb2xlLCBrYXJwZW50ZXJJbnN0YW5jZVByb2ZpbGVdXG4gICAgICovXG4gICAgcHJpdmF0ZSBzZXRVcE5vZGVSb2xlKGNsdXN0ZXI6IENsdXN0ZXIsIHN0YWNrTmFtZTogc3RyaW5nLCByZWdpb246IHN0cmluZyk6IFtpYW0uUm9sZSwgaWFtLkNmbkluc3RhbmNlUHJvZmlsZV0ge1xuICAgICAgICAvLyBTZXQgdXAgTm9kZSBSb2xlXG4gICAgICAgIGNvbnN0IGthcnBlbnRlck5vZGVSb2xlID0gbmV3IGlhbS5Sb2xlKGNsdXN0ZXIsICdrYXJwZW50ZXItbm9kZS1yb2xlJywge1xuICAgICAgICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoYGVjMi4ke2NsdXN0ZXIuc3RhY2sudXJsU3VmZml4fWApLFxuICAgICAgICAgICAgbWFuYWdlZFBvbGljaWVzOiBbXG4gICAgICAgICAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQW1hem9uRUtTV29ya2VyTm9kZVBvbGljeVwiKSxcbiAgICAgICAgICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoXCJBbWF6b25FS1NfQ05JX1BvbGljeVwiKSxcbiAgICAgICAgICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoXCJBbWF6b25FQzJDb250YWluZXJSZWdpc3RyeVJlYWRPbmx5XCIpLFxuICAgICAgICAgICAgICAgIGlhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZShcIkFtYXpvblNTTU1hbmFnZWRJbnN0YW5jZUNvcmVcIiksXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgLy9yb2xlTmFtZTogYEthcnBlbnRlck5vZGVSb2xlLSR7bmFtZX1gIC8vIGxldCByb2xlIG5hbWUgdG8gYmUgZ2VuZXJhdGVkIGFzIHVuaXF1ZVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBBdHRhY2ggaXB2NiByZWxhdGVkIHBvbGljaWVzIGJhc2VkIG9uIGNsdXN0ZXIgSVBGYW1pbHlcbiAgICAgICAgaWYgKGNsdXN0ZXIuaXBGYW1pbHkgPT09IElwRmFtaWx5LklQX1Y2KXtcbiAgICAgICAgICAgIGNvbnN0IG5vZGVJcHY2UG9saWN5ID0gbmV3IGlhbS5Qb2xpY3koY2x1c3RlciwgJ2thcnBlbnRlci1ub2RlLUlwdjYtUG9saWN5Jywge1xuICAgICAgICAgICAgICAgIGRvY3VtZW50OiB1dGlscy5nZXRFS1NOb2RlSXB2NlBvbGljeURvY3VtZW50KCkgfSk7XG4gICAgICAgICAgICBrYXJwZW50ZXJOb2RlUm9sZS5hdHRhY2hJbmxpbmVQb2xpY3kobm9kZUlwdjZQb2xpY3kpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU2V0IHVwIEluc3RhbmNlIFByb2ZpbGVcbiAgICAgICAgY29uc3QgaW5zdGFuY2VQcm9maWxlTmFtZSA9IG1kNS5NZDUuaGFzaFN0cihzdGFja05hbWUrcmVnaW9uKTtcbiAgICAgICAgY29uc3Qga2FycGVudGVySW5zdGFuY2VQcm9maWxlID0gbmV3IGlhbS5DZm5JbnN0YW5jZVByb2ZpbGUoY2x1c3RlciwgJ2thcnBlbnRlci1pbnN0YW5jZS1wcm9maWxlJywge1xuICAgICAgICAgICAgcm9sZXM6IFtrYXJwZW50ZXJOb2RlUm9sZS5yb2xlTmFtZV0sXG4gICAgICAgICAgICBpbnN0YW5jZVByb2ZpbGVOYW1lOiBgS2FycGVudGVyTm9kZUluc3RhbmNlUHJvZmlsZS0ke2luc3RhbmNlUHJvZmlsZU5hbWV9YCxcbiAgICAgICAgICAgIHBhdGg6ICcvJ1xuICAgICAgICB9KTtcbiAgICAgICAga2FycGVudGVySW5zdGFuY2VQcm9maWxlLm5vZGUuYWRkRGVwZW5kZW5jeShrYXJwZW50ZXJOb2RlUm9sZSk7XG5cbiAgICAgICAgY29uc3QgY2x1c3RlcklkID0gTmFtZXMudW5pcXVlSWQoY2x1c3Rlcik7XG5cbiAgICAgICAgLy9DZm4gb3V0cHV0IGZvciBOb2RlIFJvbGUgaW4gY2FzZSBvZiBuZWVkaW5nIHRvIGFkZCBhZGRpdGlvbmFsIHBvbGljaWVzXG4gICAgICAgIG5ldyBDZm5PdXRwdXQoY2x1c3Rlci5zdGFjaywgJ0thcnBlbnRlciBJbnN0YW5jZSBOb2RlIFJvbGUnLCB7XG4gICAgICAgICAgICB2YWx1ZToga2FycGVudGVyTm9kZVJvbGUucm9sZU5hbWUsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogXCJLYXJwZW50ZXIgYWRkLW9uIE5vZGUgUm9sZSBuYW1lXCIsXG4gICAgICAgICAgICBleHBvcnROYW1lOiBjbHVzdGVySWQrXCJLYXJwZW50ZXJOb2RlUm9sZU5hbWVcIixcbiAgICAgICAgfSk7XG4gICAgICAgIC8vQ2ZuIG91dHB1dCBmb3IgSW5zdGFuY2UgUHJvZmlsZSBmb3IgY3JlYXRpbmcgYWRkaXRpb25hbCBwcm92aXNpb25lcnNcbiAgICAgICAgbmV3IENmbk91dHB1dChjbHVzdGVyLnN0YWNrLCAnS2FycGVudGVyIEluc3RhbmNlIFByb2ZpbGUgbmFtZScsIHtcbiAgICAgICAgICAgIHZhbHVlOiBrYXJwZW50ZXJJbnN0YW5jZVByb2ZpbGUgPyBrYXJwZW50ZXJJbnN0YW5jZVByb2ZpbGUuaW5zdGFuY2VQcm9maWxlTmFtZSEgOiBcIm5vbmVcIixcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBcIkthcnBlbnRlciBhZGQtb24gSW5zdGFuY2UgUHJvZmlsZSBuYW1lXCIsXG4gICAgICAgICAgICBleHBvcnROYW1lOiBjbHVzdGVySWQrXCJLYXJwZW50ZXJJbnN0YW5jZVByb2ZpbGVOYW1lXCIsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIE1hcCBOb2RlIFJvbGUgdG8gYXdzLWF1dGhcbiAgICAgICAgY2x1c3Rlci5hd3NBdXRoLmFkZFJvbGVNYXBwaW5nKGthcnBlbnRlck5vZGVSb2xlLCB7XG4gICAgICAgICAgICBncm91cHM6IFsnc3lzdGVtOmJvb3RzdHJhcHBlcicsICdzeXN0ZW06bm9kZXMnXSxcbiAgICAgICAgICAgIHVzZXJuYW1lOiAnc3lzdGVtOm5vZGU6e3tFQzJQcml2YXRlRE5TTmFtZX19J1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gW2thcnBlbnRlck5vZGVSb2xlLCBrYXJwZW50ZXJJbnN0YW5jZVByb2ZpbGVdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhlbHBlciBmdW5jdGlvbiB0byBjaGVjayB3aGV0aGVyOlxuICAgICAqIDEuIFN1cHBvcnRlZCBLYXJwZW50ZXIgdmVyc2lvbnMgYXJlIGltcGxlbWVudGVkLCBhbmRcbiAgICAgKiAyLiBTdXBwb3J0ZWQgS3ViZXJuZXRlcyB2ZXJzaW9ucyBhcmUgZGVwbG95ZWQgb24gdGhlIGNsdXN0ZXIgdG8gdXNlIEthcnBlbnRlclxuICAgICAqIEl0IHdpbGwgcmVqZWN0IHRoZSBhZGRvbiBpZiB0aGUgY2x1c3RlciB1c2VzIGRlcHJlY2F0ZWQgS3ViZXJuZXRlcyB2ZXJzaW9uLCBhbmRcbiAgICAgKiBXYXJuIHVzZXJzIGFib3V0IGlzc3VlcyBpZiBpbmNvbXBhdGlibGUgS2FycGVudGVyIHZlcnNpb24gaXMgdXNlZCBmb3IgYSBwYXJ0aWN1bGFyIGNsdXN0ZXJcbiAgICAgKiBnaXZlbiBpdHMgS3ViZXJuZXRlcyB2ZXJzaW9uXG4gICAgICogQHBhcmFtIGthcnBlbnRlclZlcnNpb24gS2FycGVudGVyIHZlcnNpb24gdG8gYmUgZGVwbG95ZWRcbiAgICAgKiBAcGFyYW0ga3ViZVZlcnNpb24gQ2x1c3RlcidzIEt1YmVybmV0ZXMgdmVyc2lvblxuICAgICAqL1xuICAgIHByaXZhdGUgaXNDb21wYXRpYmxlKGthcnBlbnRlclZlcnNpb246IHN0cmluZywga3ViZVZlcnNpb246IEt1YmVybmV0ZXNWZXJzaW9uKTogdm9pZCB7XG4gICAgICAgIGFzc2VydCh2ZXJzaW9uTWFwLmhhcyhrdWJlVmVyc2lvbiksICdQbGVhc2UgdXBncmFkZSB5b3VyIEVLUyBLdWJlcm5ldGVzIHZlcnNpb24gdG8gc3RhcnQgdXNpbmcgS2FycGVudGVyLicpO1xuICAgICAgICBhc3NlcnQoc2VtdmVyLmd0ZShrYXJwZW50ZXJWZXJzaW9uLCAnMC4yMS4wJyksICdQbGVhc2UgdXNlIEthcnBlbnRlciB2ZXJzaW9uIDAuMjEuMCBvciBhYm92ZS4nKTtcbiAgICAgICAgY29uc3QgY29tcGF0aWJsZVZlcnNpb24gPSB2ZXJzaW9uTWFwLmdldChrdWJlVmVyc2lvbikgYXMgc3RyaW5nO1xuICAgICAgICBpZiAoc2VtdmVyLmd0KGNvbXBhdGlibGVWZXJzaW9uLCBrYXJwZW50ZXJWZXJzaW9uKSkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBQbGVhc2UgdXNlIG1pbmltdW0gS2FycGVudGVyIHZlcnNpb24gZm9yIHRoaXMgS3ViZXJuZXRlcyBWZXJzaW9uOiAke2NvbXBhdGlibGVWZXJzaW9ufSwgb3RoZXJ3aXNlIHlvdSB3aWxsIHJ1biBpbnRvIGNvbXBhdGliaWxpdHkgaXNzdWVzLmApO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19