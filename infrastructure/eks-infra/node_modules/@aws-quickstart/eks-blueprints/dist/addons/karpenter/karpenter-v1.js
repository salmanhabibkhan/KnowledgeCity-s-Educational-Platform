"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.KarpenterV1AddOn = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_events_1 = require("aws-cdk-lib/aws-events");
const aws_events_targets_1 = require("aws-cdk-lib/aws-events-targets");
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
const iam = require("aws-cdk-lib/aws-iam");
const sqs = require("aws-cdk-lib/aws-sqs");
const ts_deepmerge_1 = require("ts-deepmerge");
const utils = require("../../utils");
const semver = require("semver");
const assert = require("assert");
const helm_addon_1 = require("../helm-addon");
const iam_1 = require("./iam");
const types_1 = require("./types");
const md5 = require("ts-md5");
const defaultProps = {
    name: types_1.KARPENTER,
    namespace: "kube-system",
    version: "1.3.0",
    chart: types_1.KARPENTER,
    release: types_1.KARPENTER,
    repository: "oci://public.ecr.aws/karpenter/karpenter",
};
/**
 * Implementation of the Karpenter add-on
 */
let KarpenterV1AddOn = class KarpenterV1AddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x;
        assert(clusterInfo.cluster instanceof aws_eks_1.Cluster, "KarpenterAddOn cannot be used with imported clusters as it requires changes to the cluster authentication.");
        assert(semver.gte(this.options.version, "0.32.0"), `Karpenter interruption handling requires version >= 0.32.0. Current version: ${this.props.version}`);
        assert(semver.gte(semver.coerce(clusterInfo.version.version), "1.29.0", true), `Cluster version must be >= 1.29 for Karpenter interruption handling. Current version: ${clusterInfo.version.version}`);
        const cluster = clusterInfo.cluster;
        const endpoint = cluster.clusterEndpoint;
        const name = cluster.clusterName;
        const partition = cluster.stack.partition;
        const stackName = cluster.stack.stackName;
        const region = cluster.stack.region;
        let values = (_a = this.options.values) !== null && _a !== void 0 ? _a : {};
        const interruption = this.options.interruptionHandling || false;
        const podIdentity = this.options.podIdentity || false;
        // NodePool variables
        const labels = ((_b = this.options.nodePoolSpec) === null || _b === void 0 ? void 0 : _b.labels) || {};
        const annotations = ((_c = this.options.nodePoolSpec) === null || _c === void 0 ? void 0 : _c.annotations) || {};
        const taints = ((_d = this.options.nodePoolSpec) === null || _d === void 0 ? void 0 : _d.taints) || [];
        const startupTaints = ((_e = this.options.nodePoolSpec) === null || _e === void 0 ? void 0 : _e.startupTaints) || [];
        const requirements = ((_f = this.options.nodePoolSpec) === null || _f === void 0 ? void 0 : _f.requirements) || [];
        const disruption = ((_g = this.options.nodePoolSpec) === null || _g === void 0 ? void 0 : _g.disruption) || null;
        const limits = ((_h = this.options.nodePoolSpec) === null || _h === void 0 ? void 0 : _h.limits) || null;
        const weight = ((_j = this.options.nodePoolSpec) === null || _j === void 0 ? void 0 : _j.weight) || null;
        // NodeClass variables
        const subnetSelectorTerms = (_k = this.options.ec2NodeClassSpec) === null || _k === void 0 ? void 0 : _k.subnetSelectorTerms;
        const sgSelectorTerms = (_l = this.options.ec2NodeClassSpec) === null || _l === void 0 ? void 0 : _l.securityGroupSelectorTerms;
        const amiFamily = (_m = this.options.ec2NodeClassSpec) === null || _m === void 0 ? void 0 : _m.amiFamily;
        const amiSelectorTerms = (_o = this.options.ec2NodeClassSpec) === null || _o === void 0 ? void 0 : _o.amiSelectorTerms;
        const instanceStorePolicy = ((_p = this.options.ec2NodeClassSpec) === null || _p === void 0 ? void 0 : _p.instanceStorePolicy) || undefined;
        const userData = ((_q = this.options.ec2NodeClassSpec) === null || _q === void 0 ? void 0 : _q.userData) || "";
        const instanceProf = (_r = this.options.ec2NodeClassSpec) === null || _r === void 0 ? void 0 : _r.instanceProfile;
        const tags = ((_s = this.options.ec2NodeClassSpec) === null || _s === void 0 ? void 0 : _s.tags) || {};
        const metadataOptions = ((_t = this.options.ec2NodeClassSpec) === null || _t === void 0 ? void 0 : _t.metadataOptions) || {
            httpEndpoint: "enabled",
            httpProtocolIPv6: "disabled",
            httpPutResponseHopLimit: 2,
            httpTokens: "required",
        };
        if (cluster.ipFamily == aws_eks_1.IpFamily.IP_V6) {
            metadataOptions.httpProtocolIPv6 = "enabled";
        }
        const blockDeviceMappings = ((_u = this.options.ec2NodeClassSpec) === null || _u === void 0 ? void 0 : _u.blockDeviceMappings) || [];
        const detailedMonitoring = ((_v = this.options.ec2NodeClassSpec) === null || _v === void 0 ? void 0 : _v.detailedMonitoring) || false;
        // Set up the node role and instance profile
        const [karpenterNodeRole] = this.setUpNodeRole(cluster, stackName, region);
        // Create the controller policy
        let karpenterPolicyDocument;
        karpenterPolicyDocument = iam.PolicyDocument.fromJson((0, iam_1.KarpenterControllerPolicyV1)(cluster, partition, region));
        karpenterPolicyDocument.addStatements(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["iam:PassRole"],
            resources: [`${karpenterNodeRole.roleArn}`],
        }));
        // Support for Native spot interruption
        if (interruption) {
            // Add policy to the node role to allow access to the Interruption Queue
            const interruptionQueueStatement = this.createInterruptionQueue(cluster, stackName);
            karpenterPolicyDocument.addStatements(interruptionQueueStatement);
        }
        // Create Namespace
        const ns = utils.createNamespace(this.options.namespace, cluster, true, true);
        let sa;
        let saAnnotation;
        if (podIdentity) {
            sa = utils.podIdentityAssociation(cluster, types_1.RELEASE, this.options.namespace, karpenterPolicyDocument);
            saAnnotation = {};
        }
        else {
            sa = utils.createServiceAccount(cluster, types_1.RELEASE, this.options.namespace, karpenterPolicyDocument);
            saAnnotation = { "eks.amazonaws.com/role-arn": sa.role.roleArn };
        }
        sa.node.addDependency(ns);
        // Create global helm values based on v1beta1 migration as shown below:
        // https://karpenter.sh/v0.32/upgrading/v1beta1-migration/#helm-values
        let globalSettings = { clusterName: name, clusterEndpoint: endpoint };
        globalSettings = (0, ts_deepmerge_1.merge)(globalSettings, { interruptionQueue: interruption ? stackName : "" });
        utils.setPath(values, "settings", (0, ts_deepmerge_1.merge)(globalSettings, (_w = values === null || values === void 0 ? void 0 : values.settings) !== null && _w !== void 0 ? _w : {}));
        // Let Helm create the service account if using pod identity
        const saValues = {
            serviceAccount: { create: podIdentity, name: types_1.RELEASE, annotations: saAnnotation },
        };
        values = (0, ts_deepmerge_1.merge)(values, saValues);
        // Install HelmChart using user defined value or default of 5 minutes.
        const helmChartTimeout = this.options.helmChartTimeout || aws_cdk_lib_1.Duration.minutes(5);
        const karpenterChart = this.addHelmChart(clusterInfo, values, false, true, helmChartTimeout);
        karpenterChart.node.addDependency(sa);
        if (clusterInfo.nodeGroups) {
            clusterInfo.nodeGroups.forEach((n) => karpenterChart.node.addDependency(n));
        }
        // Deploy Provisioner (Alpha) or NodePool (Beta) CRD based on the Karpenter Version
        if (this.options.nodePoolSpec) {
            const pool = {
                apiVersion: "karpenter.sh/v1",
                kind: "NodePool",
                metadata: { name: "default-nodepool" },
                spec: {
                    template: {
                        metadata: { labels: labels, annotations: annotations },
                        spec: {
                            nodeClassRef: {
                                name: "default-ec2nodeclass",
                                group: "karpenter.k8s.aws",
                                kind: "EC2NodeClass"
                            },
                            taints: taints,
                            startupTaints: startupTaints,
                            requirements: this.convert(requirements),
                            expireAfter: (_x = this.options.nodePoolSpec) === null || _x === void 0 ? void 0 : _x.expireAfter
                        },
                    },
                    disruption: disruption,
                    limits: limits,
                    weight: weight,
                },
            };
            const poolManifest = cluster.addManifest("default-pool", pool);
            poolManifest.node.addDependency(karpenterChart);
            // Deploy AWSNodeTemplate (Alpha) or EC2NodeClass (Beta) CRD based on the Karpenter Version
            if (this.options.ec2NodeClassSpec) {
                let ec2Node;
                ec2Node = {
                    apiVersion: "karpenter.k8s.aws/v1",
                    kind: "EC2NodeClass",
                    metadata: { name: "default-ec2nodeclass" },
                    spec: {
                        amiFamily: amiFamily,
                        subnetSelectorTerms: subnetSelectorTerms,
                        securityGroupSelectorTerms: sgSelectorTerms,
                        amiSelectorTerms: amiSelectorTerms ? amiSelectorTerms : [],
                        userData: userData,
                        tags: tags,
                        metadataOptions: metadataOptions,
                        blockDeviceMappings: blockDeviceMappings,
                        detailedMonitoring: detailedMonitoring,
                    },
                };
                // Provide custom Instance Profile to replace role if provided, else use the role created with the addon
                if (instanceProf) {
                    ec2Node = (0, ts_deepmerge_1.merge)(ec2Node, { spec: { instanceProfile: instanceProf } });
                }
                else {
                    ec2Node = (0, ts_deepmerge_1.merge)(ec2Node, { spec: { role: karpenterNodeRole.roleName } });
                }
                // Instance Store Policy added for v0.34.0 and up
                if (instanceStorePolicy) {
                    ec2Node = (0, ts_deepmerge_1.merge)(ec2Node, { spec: { instanceStorePolicy: instanceStorePolicy } });
                }
                const nodeManifest = cluster.addManifest("default-node-template", ec2Node);
                nodeManifest.node.addDependency(karpenterChart);
                poolManifest.node.addDependency(nodeManifest);
            }
        }
        return Promise.resolve(karpenterChart);
    }
    /**
     * Helper function to convert a key-pair values (with an operator)
     * of spec configurations to appropriate json format for addManifest function
     * @param reqs
     * @returns newReqs
     * */
    convert(reqs) {
        const newReqs = [];
        for (let req of reqs) {
            const key = req["key"];
            const op = req["operator"];
            const val = req["values"];
            const requirement = { key: key, operator: op, values: val };
            newReqs.push(requirement);
        }
        return newReqs;
    }
    /**
     * Helper function to set up the Karpenter Node Role and Instance Profile
     * Outputs to CloudFormation and map the role to the aws-auth ConfigMap
     * @param cluster EKS Cluster
     * @param stackName Name of the stack
     * @param region Region of the stack
     * @returns [karpenterNodeRole, karpenterInstanceProfile]
     */
    setUpNodeRole(cluster, stackName, region) {
        // Set up Node Role
        const karpenterNodeRole = new iam.Role(cluster, "karpenter-node-role", {
            assumedBy: new iam.ServicePrincipal(`ec2.${cluster.stack.urlSuffix}`),
            managedPolicies: [
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEKSWorkerNodePolicy"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEKS_CNI_Policy"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEC2ContainerRegistryReadOnly"),
                iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonSSMManagedInstanceCore"),
            ],
            //roleName: `KarpenterNodeRole-${name}` // let role name to be generated as unique
        });
        // Attach ipv6 related policies based on cluster IPFamily
        if (cluster.ipFamily === aws_eks_1.IpFamily.IP_V6) {
            const nodeIpv6Policy = new iam.Policy(cluster, "karpenter-node-Ipv6-Policy", {
                document: utils.getEKSNodeIpv6PolicyDocument(),
            });
            karpenterNodeRole.attachInlinePolicy(nodeIpv6Policy);
        }
        // Set up Instance Profile
        const instanceProfileName = md5.Md5.hashStr(stackName + region);
        const karpenterInstanceProfile = new iam.CfnInstanceProfile(cluster, "karpenter-instance-profile", {
            roles: [karpenterNodeRole.roleName],
            instanceProfileName: `KarpenterNodeInstanceProfile-${instanceProfileName}`,
            path: "/",
        });
        karpenterInstanceProfile.node.addDependency(karpenterNodeRole);
        const clusterId = aws_cdk_lib_1.Names.uniqueId(cluster);
        //Cfn output for Node Role in case of needing to add additional policies
        new aws_cdk_lib_1.CfnOutput(cluster.stack, "Karpenter Instance Node Role", {
            value: karpenterNodeRole.roleName,
            description: "Karpenter add-on Node Role name",
            exportName: clusterId + "KarpenterNodeRoleName",
        });
        //Cfn output for Instance Profile for creating additional provisioners
        new aws_cdk_lib_1.CfnOutput(cluster.stack, "Karpenter Instance Profile name", {
            value: karpenterInstanceProfile ? karpenterInstanceProfile.instanceProfileName : "none",
            description: "Karpenter add-on Instance Profile name",
            exportName: clusterId + "KarpenterInstanceProfileName",
        });
        // Map Node Role to aws-auth
        cluster.awsAuth.addRoleMapping(karpenterNodeRole, {
            groups: ["system:bootstrapper", "system:nodes"],
            username: "system:node:{{EC2PrivateDNSName}}",
        });
        return [karpenterNodeRole, karpenterInstanceProfile];
    }
    createInterruptionQueue(cluster, stackName) {
        // Create Interruption Queue
        const queue = new sqs.Queue(cluster.stack, "karpenter-queue", {
            queueName: stackName,
            retentionPeriod: aws_cdk_lib_1.Duration.seconds(300),
        });
        queue.addToResourcePolicy(new iam.PolicyStatement({
            sid: "EC2InterruptionPolicy",
            effect: iam.Effect.ALLOW,
            principals: [
                new iam.ServicePrincipal("sqs.amazonaws.com"),
                new iam.ServicePrincipal("events.amazonaws.com"),
            ],
            actions: ["sqs:SendMessage"],
            resources: [`${queue.queueArn}`],
        }));
        // Add Interruption Rules
        new aws_events_1.Rule(cluster.stack, "schedule-change-rule", {
            eventPattern: { source: ["aws.health"], detailType: ["AWS Health Event"] },
        }).addTarget(new aws_events_targets_1.SqsQueue(queue));
        new aws_events_1.Rule(cluster.stack, "spot-interruption-rule", {
            eventPattern: { source: ["aws.ec2"], detailType: ["EC2 Spot Instance Interruption Warning"] },
        }).addTarget(new aws_events_targets_1.SqsQueue(queue));
        new aws_events_1.Rule(cluster.stack, "rebalance-rule", {
            eventPattern: { source: ["aws.ec2"], detailType: ["EC2 Instance Rebalance Recommendation"] },
        }).addTarget(new aws_events_targets_1.SqsQueue(queue));
        new aws_events_1.Rule(cluster.stack, "inst-state-change-rule", {
            eventPattern: { source: ["aws.ec2"], detailType: ["C2 Instance State-change Notification"] },
        }).addTarget(new aws_events_targets_1.SqsQueue(queue));
        // Create and return the interruption queue policy statement
        return new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "sqs:DeleteMessage",
                "sqs:GetQueueUrl",
                "sqs:GetQueueAttributes",
                "sqs:ReceiveMessage",
            ],
            resources: [`${queue.queueArn}`],
        });
    }
};
exports.KarpenterV1AddOn = KarpenterV1AddOn;
__decorate([
    utils.conflictsWith("ClusterAutoScalerAddOn")
], KarpenterV1AddOn.prototype, "deploy", null);
exports.KarpenterV1AddOn = KarpenterV1AddOn = __decorate([
    utils.supportsALL
], KarpenterV1AddOn);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2FycGVudGVyLXYxLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2FkZG9ucy9rYXJwZW50ZXIva2FycGVudGVyLXYxLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLDZDQUF5RDtBQUN6RCx1REFBOEM7QUFDOUMsdUVBQTBEO0FBQzFELGlEQUF3RDtBQUN4RCwyQ0FBMkM7QUFDM0MsMkNBQTJDO0FBRTNDLCtDQUFxQztBQUNyQyxxQ0FBcUM7QUFFckMsaUNBQWlDO0FBQ2pDLGlDQUFpQztBQUNqQyw4Q0FBOEU7QUFDOUUsK0JBQW9EO0FBQ3BELG1DQUFpRjtBQUNqRiw4QkFBOEI7QUFFOUIsTUFBTSxZQUFZLEdBQW1CO0lBQ2pDLElBQUksRUFBRSxpQkFBUztJQUNmLFNBQVMsRUFBRSxhQUFhO0lBQ3hCLE9BQU8sRUFBRSxPQUFPO0lBQ2hCLEtBQUssRUFBRSxpQkFBUztJQUNoQixPQUFPLEVBQUUsaUJBQVM7SUFDbEIsVUFBVSxFQUFFLDBDQUEwQztDQUN6RCxDQUFDO0FBMkNGOztHQUVHO0FBRUksSUFBTSxnQkFBZ0IsR0FBdEIsTUFBTSxnQkFBaUIsU0FBUSxzQkFBUztJQUczQyxZQUFZLEtBQTZCO1FBQ3JDLEtBQUssQ0FBQyxFQUFFLEdBQUcsWUFBWSxFQUFFLEdBQUcsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUNyQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDOUIsQ0FBQztJQUdELE1BQU0sQ0FBQyxXQUF3Qjs7UUFDM0IsTUFBTSxDQUNGLFdBQVcsQ0FBQyxPQUFPLFlBQVksaUJBQU8sRUFDdEMsNEdBQTRHLENBQy9HLENBQUM7UUFDRixNQUFNLENBQ0YsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQVEsRUFBRSxRQUFRLENBQUMsRUFDM0MsZ0ZBQWdGLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQ3ZHLENBQUM7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TyxJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDM0IsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztZQUN4QixPQUFPLEVBQUU7Z0JBQ0wsbUJBQW1CO2dCQUNuQixpQkFBaUI7Z0JBQ2pCLHdCQUF3QjtnQkFDeEIsb0JBQW9CO2FBQ3ZCO1lBQ0QsU0FBUyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDbkMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKLENBQUE7QUFoV1ksNENBQWdCO0FBU3pCO0lBREMsS0FBSyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQzs4Q0E2TTdDOzJCQXJOUSxnQkFBZ0I7SUFENUIsS0FBSyxDQUFDLFdBQVc7R0FDTCxnQkFBZ0IsQ0FnVzVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHVyYXRpb24sIE5hbWVzLCBDZm5PdXRwdXQgfSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCB7IFJ1bGUgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWV2ZW50c1wiO1xuaW1wb3J0IHsgU3FzUXVldWUgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWV2ZW50cy10YXJnZXRzXCI7XG5pbXBvcnQgeyBDbHVzdGVyLCBJcEZhbWlseSB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWtzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIHNxcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXNxc1wiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IG1lcmdlIH0gZnJvbSBcInRzLWRlZXBtZXJnZVwiO1xuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSBcIi4uLy4uL3V0aWxzXCI7XG5pbXBvcnQgeyBDbHVzdGVySW5mbyB9IGZyb20gXCIuLi8uLi9zcGlcIjtcbmltcG9ydCAqIGFzIHNlbXZlciBmcm9tIFwic2VtdmVyXCI7XG5pbXBvcnQgKiBhcyBhc3NlcnQgZnJvbSBcImFzc2VydFwiO1xuaW1wb3J0IHsgSGVsbUFkZE9uLCBIZWxtQWRkT25Qcm9wcywgSGVsbUFkZE9uVXNlclByb3BzIH0gZnJvbSBcIi4uL2hlbG0tYWRkb25cIjtcbmltcG9ydCB7IEthcnBlbnRlckNvbnRyb2xsZXJQb2xpY3lWMSB9IGZyb20gXCIuL2lhbVwiO1xuaW1wb3J0IHsgRWMyTm9kZUNsYXNzVjFTcGVjLCBOb2RlUG9vbFYxU3BlYywgS0FSUEVOVEVSLCBSRUxFQVNFIH0gZnJvbSBcIi4vdHlwZXNcIjtcbmltcG9ydCAqIGFzIG1kNSBmcm9tIFwidHMtbWQ1XCI7XG5cbmNvbnN0IGRlZmF1bHRQcm9wczogSGVsbUFkZE9uUHJvcHMgPSB7XG4gICAgbmFtZTogS0FSUEVOVEVSLFxuICAgIG5hbWVzcGFjZTogXCJrdWJlLXN5c3RlbVwiLFxuICAgIHZlcnNpb246IFwiMS4zLjBcIixcbiAgICBjaGFydDogS0FSUEVOVEVSLFxuICAgIHJlbGVhc2U6IEtBUlBFTlRFUixcbiAgICByZXBvc2l0b3J5OiBcIm9jaTovL3B1YmxpYy5lY3IuYXdzL2thcnBlbnRlci9rYXJwZW50ZXJcIixcbn07XG5cbi8qKlxuICogQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgYWRkLW9uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgS2FycGVudGVyVjFBZGRPblByb3BzIGV4dGVuZHMgSGVsbUFkZE9uVXNlclByb3BzIHtcbiAgICAvKipcbiAgICAgKiBUaGlzIGlzIHRoZSB0b3AgbGV2ZWwgbm9kZXBvb2wgc3BlY2lmaWNhdGlvbi4gTm9kZXBvb2xzIGxhdW5jaCBub2RlcyBpbiByZXNwb25zZSB0byBwb2RzIHRoYXQgYXJlIHVuc2NoZWR1bGFibGUuXG4gICAgICogQSBzaW5nbGUgbm9kZXBvb2wgaXMgY2FwYWJsZSBvZiBtYW5hZ2luZyBhIGRpdmVyc2Ugc2V0IG9mIG5vZGVzLlxuICAgICAqIE5vZGUgcHJvcGVydGllcyBhcmUgZGV0ZXJtaW5lZCBmcm9tIGEgY29tYmluYXRpb24gb2Ygbm9kZXBvb2wgYW5kIHBvZCBzY2hlZHVsaW5nIGNvbnN0cmFpbnRzLlxuICAgICAqL1xuICAgIG5vZGVQb29sU3BlYz86IE5vZGVQb29sVjFTcGVjO1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBpcyB0aGUgdG9wIGxldmVsIHNwZWMgZm9yIHRoZSBBV1MgS2FycGVudGVyIFByb3ZpZGVyXG4gICAgICogSXQgY29udGFpbnMgY29uZmlndXJhdGlvbiBuZWNlc3NhcnkgdG8gbGF1bmNoIGluc3RhbmNlcyBpbiBBV1MuXG4gICAgICovXG4gICAgZWMyTm9kZUNsYXNzU3BlYz86IEVjMk5vZGVDbGFzc1YxU3BlYztcblxuICAgIC8qKlxuICAgICAqIEZsYWcgZm9yIGVuYWJsaW5nIEthcnBlbnRlcidzIG5hdGl2ZSBpbnRlcnJ1cHRpb24gaGFuZGxpbmdcbiAgICAgKi9cbiAgICBpbnRlcnJ1cHRpb25IYW5kbGluZz86IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiBUaW1lb3V0IGR1cmF0aW9uIHdoaWxlIGluc3RhbGxpbmcga2FycGVudGVyIGhlbG0gY2hhcnQgdXNpbmcgYWRkSGVsbUNoYXJ0IEFQSVxuICAgICAqL1xuICAgIGhlbG1DaGFydFRpbWVvdXQ/OiBEdXJhdGlvbjtcblxuICAgIC8qKlxuICAgICAqIFVzZSBQb2QgSWRlbnRpdHkuXG4gICAgICogVG8gdXNlIEVLUyBQb2QgSWRlbnRpdGllc1xuICAgICAqICAtIFRoZSBjbHVzdGVyIG11c3QgaGF2ZSBLdWJlcm5ldGVzIHZlcnNpb24gMS4yNCBvciBsYXRlclxuICAgICAqICAtIEthcnBlbnRlciBQb2RzIG11c3QgYmUgYXNzaWduZWQgdG8gTGludXggQW1hem9uIEVDMiBpbnN0YW5jZXNcbiAgICAgKiAgLSBLYXJwZW50ZXIgdmVyc2lvbiBzdXBwb3J0cyBQb2QgSWRlbnRpdHkgKHYwLjM1LjAgb3IgbGF0ZXIpIHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vZWtzL2xhdGVzdC91c2VyZ3VpZGUvcG9kLWlkZW50aXR5Lmh0bWxcbiAgICAgKlxuICAgICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2Vrcy9sYXRlc3QvdXNlcmd1aWRlL3BvZC1pZGVudGl0eS5odG1sXG4gICAgICpcbiAgICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgICAqL1xuICAgIHBvZElkZW50aXR5PzogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBJbXBsZW1lbnRhdGlvbiBvZiB0aGUgS2FycGVudGVyIGFkZC1vblxuICovXG5AdXRpbHMuc3VwcG9ydHNBTExcbmV4cG9ydCBjbGFzcyBLYXJwZW50ZXJWMUFkZE9uIGV4dGVuZHMgSGVsbUFkZE9uIHtcbiAgICByZWFkb25seSBvcHRpb25zOiBLYXJwZW50ZXJWMUFkZE9uUHJvcHM7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcz86IEthcnBlbnRlclYxQWRkT25Qcm9wcykge1xuICAgICAgICBzdXBlcih7IC4uLmRlZmF1bHRQcm9wcywgLi4ucHJvcHMgfSk7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHRoaXMucHJvcHM7XG4gICAgfVxuXG4gICAgQHV0aWxzLmNvbmZsaWN0c1dpdGgoXCJDbHVzdGVyQXV0b1NjYWxlckFkZE9uXCIpXG4gICAgZGVwbG95KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IFByb21pc2U8Q29uc3RydWN0PiB7XG4gICAgICAgIGFzc2VydChcbiAgICAgICAgICAgIGNsdXN0ZXJJbmZvLmNsdXN0ZXIgaW5zdGFuY2VvZiBDbHVzdGVyLFxuICAgICAgICAgICAgXCJLYXJwZW50ZXJBZGRPbiBjYW5ub3QgYmUgdXNlZCB3aXRoIGltcG9ydGVkIGNsdXN0ZXJzIGFzIGl0IHJlcXVpcmVzIGNoYW5nZXMgdG8gdGhlIGNsdXN0ZXIgYXV0aGVudGljYXRpb24uXCJcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0KFxuICAgICAgICAgICAgc2VtdmVyLmd0ZSh0aGlzLm9wdGlvbnMudmVyc2lvbiEsIFwiMC4zMi4wXCIpLFxuICAgICAgICAgICAgYEthcnBlbnRlciBpbnRlcnJ1cHRpb24gaGFuZGxpbmcgcmVxdWlyZXMgdmVyc2lvbiA+PSAwLjMyLjAuIEN1cnJlbnQgdmVyc2lvbjogJHt0aGlzLnByb3BzLnZlcnNpb259YFxuICAgICAgICApO1xuXG4gICAgICAgIGFzc2VydChcbiAgICAgICAgICAgIHNlbXZlci5ndGUoc2VtdmVyLmNvZXJjZShjbHVzdGVySW5mby52ZXJzaW9uLnZlcnNpb24pISwgXCIxLjI5LjBcIiwgdHJ1ZSksXG4gICAgICAgICAgICBgQ2x1c3RlciB2ZXJzaW9uIG11c3QgYmUgPj0gMS4yOSBmb3IgS2FycGVudGVyIGludGVycnVwdGlvbiBoYW5kbGluZy4gQ3VycmVudCB2ZXJzaW9uOiAke2NsdXN0ZXJJbmZvLnZlcnNpb24udmVyc2lvbn1gXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGNsdXN0ZXI6IENsdXN0ZXIgPSBjbHVzdGVySW5mby5jbHVzdGVyO1xuICAgICAgICBjb25zdCBlbmRwb2ludCA9IGNsdXN0ZXIuY2x1c3RlckVuZHBvaW50O1xuICAgICAgICBjb25zdCBuYW1lID0gY2x1c3Rlci5jbHVzdGVyTmFtZTtcbiAgICAgICAgY29uc3QgcGFydGl0aW9uID0gY2x1c3Rlci5zdGFjay5wYXJ0aXRpb247XG5cbiAgICAgICAgY29uc3Qgc3RhY2tOYW1lID0gY2x1c3Rlci5zdGFjay5zdGFja05hbWU7XG4gICAgICAgIGNvbnN0IHJlZ2lvbiA9IGNsdXN0ZXIuc3RhY2sucmVnaW9uO1xuXG4gICAgICAgIGxldCB2YWx1ZXMgPSB0aGlzLm9wdGlvbnMudmFsdWVzID8/IHt9O1xuXG4gICAgICAgIGNvbnN0IGludGVycnVwdGlvbiA9IHRoaXMub3B0aW9ucy5pbnRlcnJ1cHRpb25IYW5kbGluZyB8fCBmYWxzZTtcbiAgICAgICAgY29uc3QgcG9kSWRlbnRpdHkgPSB0aGlzLm9wdGlvbnMucG9kSWRlbnRpdHkgfHwgZmFsc2U7XG5cbiAgICAgICAgLy8gTm9kZVBvb2wgdmFyaWFibGVzXG4gICAgICAgIGNvbnN0IGxhYmVscyA9IHRoaXMub3B0aW9ucy5ub2RlUG9vbFNwZWM/LmxhYmVscyB8fCB7fTtcbiAgICAgICAgY29uc3QgYW5ub3RhdGlvbnMgPSB0aGlzLm9wdGlvbnMubm9kZVBvb2xTcGVjPy5hbm5vdGF0aW9ucyB8fCB7fTtcbiAgICAgICAgY29uc3QgdGFpbnRzID0gdGhpcy5vcHRpb25zLm5vZGVQb29sU3BlYz8udGFpbnRzIHx8IFtdO1xuICAgICAgICBjb25zdCBzdGFydHVwVGFpbnRzID0gdGhpcy5vcHRpb25zLm5vZGVQb29sU3BlYz8uc3RhcnR1cFRhaW50cyB8fCBbXTtcbiAgICAgICAgY29uc3QgcmVxdWlyZW1lbnRzID0gdGhpcy5vcHRpb25zLm5vZGVQb29sU3BlYz8ucmVxdWlyZW1lbnRzIHx8IFtdO1xuICAgICAgICBjb25zdCBkaXNydXB0aW9uID0gdGhpcy5vcHRpb25zLm5vZGVQb29sU3BlYz8uZGlzcnVwdGlvbiB8fCBudWxsO1xuICAgICAgICBjb25zdCBsaW1pdHMgPSB0aGlzLm9wdGlvbnMubm9kZVBvb2xTcGVjPy5saW1pdHMgfHwgbnVsbDtcbiAgICAgICAgY29uc3Qgd2VpZ2h0ID0gdGhpcy5vcHRpb25zLm5vZGVQb29sU3BlYz8ud2VpZ2h0IHx8IG51bGw7XG5cbiAgICAgICAgLy8gTm9kZUNsYXNzIHZhcmlhYmxlc1xuXG4gICAgICAgIGNvbnN0IHN1Ym5ldFNlbGVjdG9yVGVybXMgPSB0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYz8uc3VibmV0U2VsZWN0b3JUZXJtcztcbiAgICAgICAgY29uc3Qgc2dTZWxlY3RvclRlcm1zID0gdGhpcy5vcHRpb25zLmVjMk5vZGVDbGFzc1NwZWM/LnNlY3VyaXR5R3JvdXBTZWxlY3RvclRlcm1zO1xuICAgICAgICBjb25zdCBhbWlGYW1pbHkgPSB0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYz8uYW1pRmFtaWx5O1xuXG4gICAgICAgIGNvbnN0IGFtaVNlbGVjdG9yVGVybXMgPSB0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYz8uYW1pU2VsZWN0b3JUZXJtcztcbiAgICAgICAgY29uc3QgaW5zdGFuY2VTdG9yZVBvbGljeSA9IHRoaXMub3B0aW9ucy5lYzJOb2RlQ2xhc3NTcGVjPy5pbnN0YW5jZVN0b3JlUG9saWN5IHx8IHVuZGVmaW5lZDtcbiAgICAgICAgY29uc3QgdXNlckRhdGEgPSB0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYz8udXNlckRhdGEgfHwgXCJcIjtcbiAgICAgICAgY29uc3QgaW5zdGFuY2VQcm9mID0gdGhpcy5vcHRpb25zLmVjMk5vZGVDbGFzc1NwZWM/Lmluc3RhbmNlUHJvZmlsZTtcbiAgICAgICAgY29uc3QgdGFncyA9IHRoaXMub3B0aW9ucy5lYzJOb2RlQ2xhc3NTcGVjPy50YWdzIHx8IHt9O1xuICAgICAgICBjb25zdCBtZXRhZGF0YU9wdGlvbnMgPSB0aGlzLm9wdGlvbnMuZWMyTm9kZUNsYXNzU3BlYz8ubWV0YWRhdGFPcHRpb25zIHx8IHtcbiAgICAgICAgICAgIGh0dHBFbmRwb2ludDogXCJlbmFibGVkXCIsXG4gICAgICAgICAgICBodHRwUHJvdG9jb2xJUHY2OiBcImRpc2FibGVkXCIsXG4gICAgICAgICAgICBodHRwUHV0UmVzcG9uc2VIb3BMaW1pdDogMixcbiAgICAgICAgICAgIGh0dHBUb2tlbnM6IFwicmVxdWlyZWRcIixcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoY2x1c3Rlci5pcEZhbWlseSA9PSBJcEZhbWlseS5JUF9WNikge1xuICAgICAgICAgICAgbWV0YWRhdGFPcHRpb25zLmh0dHBQcm90b2NvbElQdjYgPSBcImVuYWJsZWRcIjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBibG9ja0RldmljZU1hcHBpbmdzID0gdGhpcy5vcHRpb25zLmVjMk5vZGVDbGFzc1NwZWM/LmJsb2NrRGV2aWNlTWFwcGluZ3MgfHwgW107XG4gICAgICAgIGNvbnN0IGRldGFpbGVkTW9uaXRvcmluZyA9IHRoaXMub3B0aW9ucy5lYzJOb2RlQ2xhc3NTcGVjPy5kZXRhaWxlZE1vbml0b3JpbmcgfHwgZmFsc2U7XG5cbiAgICAgICAgLy8gU2V0IHVwIHRoZSBub2RlIHJvbGUgYW5kIGluc3RhbmNlIHByb2ZpbGVcbiAgICAgICAgY29uc3QgW2thcnBlbnRlck5vZGVSb2xlXSA9IHRoaXMuc2V0VXBOb2RlUm9sZShjbHVzdGVyLCBzdGFja05hbWUsIHJlZ2lvbik7XG5cbiAgICAgICAgLy8gQ3JlYXRlIHRoZSBjb250cm9sbGVyIHBvbGljeVxuICAgICAgICBsZXQga2FycGVudGVyUG9saWN5RG9jdW1lbnQ7XG5cbiAgICAgICAga2FycGVudGVyUG9saWN5RG9jdW1lbnQgPSBpYW0uUG9saWN5RG9jdW1lbnQuZnJvbUpzb24oXG4gICAgICAgICAgICBLYXJwZW50ZXJDb250cm9sbGVyUG9saWN5VjEoY2x1c3RlciwgcGFydGl0aW9uLCByZWdpb24pXG4gICAgICAgICk7XG5cbiAgICAgICAga2FycGVudGVyUG9saWN5RG9jdW1lbnQuYWRkU3RhdGVtZW50cyhcbiAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1wiaWFtOlBhc3NSb2xlXCJdLFxuICAgICAgICAgICAgICAgIHJlc291cmNlczogW2Ake2thcnBlbnRlck5vZGVSb2xlLnJvbGVBcm59YF0sXG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuXG4gICAgICAgIC8vIFN1cHBvcnQgZm9yIE5hdGl2ZSBzcG90IGludGVycnVwdGlvblxuICAgICAgICBpZiAoaW50ZXJydXB0aW9uKSB7XG4gICAgICAgICAgICAvLyBBZGQgcG9saWN5IHRvIHRoZSBub2RlIHJvbGUgdG8gYWxsb3cgYWNjZXNzIHRvIHRoZSBJbnRlcnJ1cHRpb24gUXVldWVcbiAgICAgICAgICAgIGNvbnN0IGludGVycnVwdGlvblF1ZXVlU3RhdGVtZW50ID0gdGhpcy5jcmVhdGVJbnRlcnJ1cHRpb25RdWV1ZShjbHVzdGVyLCBzdGFja05hbWUpO1xuICAgICAgICAgICAga2FycGVudGVyUG9saWN5RG9jdW1lbnQuYWRkU3RhdGVtZW50cyhpbnRlcnJ1cHRpb25RdWV1ZVN0YXRlbWVudCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDcmVhdGUgTmFtZXNwYWNlXG4gICAgICAgIGNvbnN0IG5zID0gdXRpbHMuY3JlYXRlTmFtZXNwYWNlKHRoaXMub3B0aW9ucy5uYW1lc3BhY2UhLCBjbHVzdGVyLCB0cnVlLCB0cnVlKTtcblxuICAgICAgICBsZXQgc2E6IGFueTtcbiAgICAgICAgbGV0IHNhQW5ub3RhdGlvbjogYW55O1xuICAgICAgICBpZiAocG9kSWRlbnRpdHkpIHtcbiAgICAgICAgICAgIHNhID0gdXRpbHMucG9kSWRlbnRpdHlBc3NvY2lhdGlvbihcbiAgICAgICAgICAgICAgICBjbHVzdGVyLFxuICAgICAgICAgICAgICAgIFJFTEVBU0UsXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLm5hbWVzcGFjZSEsXG4gICAgICAgICAgICAgICAga2FycGVudGVyUG9saWN5RG9jdW1lbnRcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBzYUFubm90YXRpb24gPSB7fTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNhID0gdXRpbHMuY3JlYXRlU2VydmljZUFjY291bnQoXG4gICAgICAgICAgICAgICAgY2x1c3RlcixcbiAgICAgICAgICAgICAgICBSRUxFQVNFLFxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5uYW1lc3BhY2UhLFxuICAgICAgICAgICAgICAgIGthcnBlbnRlclBvbGljeURvY3VtZW50XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgc2FBbm5vdGF0aW9uID0geyBcImVrcy5hbWF6b25hd3MuY29tL3JvbGUtYXJuXCI6IHNhLnJvbGUucm9sZUFybiB9O1xuICAgICAgICB9XG4gICAgICAgIHNhLm5vZGUuYWRkRGVwZW5kZW5jeShucyk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIGdsb2JhbCBoZWxtIHZhbHVlcyBiYXNlZCBvbiB2MWJldGExIG1pZ3JhdGlvbiBhcyBzaG93biBiZWxvdzpcbiAgICAgICAgLy8gaHR0cHM6Ly9rYXJwZW50ZXIuc2gvdjAuMzIvdXBncmFkaW5nL3YxYmV0YTEtbWlncmF0aW9uLyNoZWxtLXZhbHVlc1xuICAgICAgICBsZXQgZ2xvYmFsU2V0dGluZ3MgPSB7IGNsdXN0ZXJOYW1lOiBuYW1lLCBjbHVzdGVyRW5kcG9pbnQ6IGVuZHBvaW50IH07XG5cbiAgICAgICAgZ2xvYmFsU2V0dGluZ3MgPSBtZXJnZShnbG9iYWxTZXR0aW5ncywgeyBpbnRlcnJ1cHRpb25RdWV1ZTogaW50ZXJydXB0aW9uID8gc3RhY2tOYW1lIDogXCJcIiB9KTtcblxuICAgICAgICB1dGlscy5zZXRQYXRoKHZhbHVlcywgXCJzZXR0aW5nc1wiLCBtZXJnZShnbG9iYWxTZXR0aW5ncywgdmFsdWVzPy5zZXR0aW5ncyA/PyB7fSkpO1xuXG4gICAgICAgIC8vIExldCBIZWxtIGNyZWF0ZSB0aGUgc2VydmljZSBhY2NvdW50IGlmIHVzaW5nIHBvZCBpZGVudGl0eVxuICAgICAgICBjb25zdCBzYVZhbHVlcyA9IHtcbiAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50OiB7IGNyZWF0ZTogcG9kSWRlbnRpdHksIG5hbWU6IFJFTEVBU0UsIGFubm90YXRpb25zOiBzYUFubm90YXRpb24gfSxcbiAgICAgICAgfTtcblxuICAgICAgICB2YWx1ZXMgPSBtZXJnZSh2YWx1ZXMsIHNhVmFsdWVzKTtcbiAgICAgICAgLy8gSW5zdGFsbCBIZWxtQ2hhcnQgdXNpbmcgdXNlciBkZWZpbmVkIHZhbHVlIG9yIGRlZmF1bHQgb2YgNSBtaW51dGVzLlxuICAgICAgICBjb25zdCBoZWxtQ2hhcnRUaW1lb3V0ID0gdGhpcy5vcHRpb25zLmhlbG1DaGFydFRpbWVvdXQgfHwgRHVyYXRpb24ubWludXRlcyg1KTtcbiAgICAgICAgY29uc3Qga2FycGVudGVyQ2hhcnQgPSB0aGlzLmFkZEhlbG1DaGFydChjbHVzdGVySW5mbywgdmFsdWVzLCBmYWxzZSwgdHJ1ZSwgaGVsbUNoYXJ0VGltZW91dCk7XG5cbiAgICAgICAga2FycGVudGVyQ2hhcnQubm9kZS5hZGREZXBlbmRlbmN5KHNhKTtcblxuICAgICAgICBpZiAoY2x1c3RlckluZm8ubm9kZUdyb3Vwcykge1xuICAgICAgICAgICAgY2x1c3RlckluZm8ubm9kZUdyb3Vwcy5mb3JFYWNoKChuKSA9PiBrYXJwZW50ZXJDaGFydC5ub2RlLmFkZERlcGVuZGVuY3kobikpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRGVwbG95IFByb3Zpc2lvbmVyIChBbHBoYSkgb3IgTm9kZVBvb2wgKEJldGEpIENSRCBiYXNlZCBvbiB0aGUgS2FycGVudGVyIFZlcnNpb25cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5ub2RlUG9vbFNwZWMpIHtcbiAgICAgICAgICAgIGNvbnN0IHBvb2wgPSB7XG4gICAgICAgICAgICAgIGFwaVZlcnNpb246IFwia2FycGVudGVyLnNoL3YxXCIsXG4gICAgICAgICAgICAgIGtpbmQ6IFwiTm9kZVBvb2xcIixcbiAgICAgICAgICAgICAgbWV0YWRhdGE6IHtuYW1lOiBcImRlZmF1bHQtbm9kZXBvb2xcIn0sXG4gICAgICAgICAgICAgIHNwZWM6IHtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZToge1xuICAgICAgICAgICAgICAgICAgbWV0YWRhdGE6IHtsYWJlbHM6IGxhYmVscywgYW5ub3RhdGlvbnM6IGFubm90YXRpb25zfSxcbiAgICAgICAgICAgICAgICAgIHNwZWM6IHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZUNsYXNzUmVmOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBcImRlZmF1bHQtZWMybm9kZWNsYXNzXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBncm91cDogXCJrYXJwZW50ZXIuazhzLmF3c1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAga2luZDogXCJFQzJOb2RlQ2xhc3NcIlxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB0YWludHM6IHRhaW50cyxcbiAgICAgICAgICAgICAgICAgICAgc3RhcnR1cFRhaW50czogc3RhcnR1cFRhaW50cyxcbiAgICAgICAgICAgICAgICAgICAgcmVxdWlyZW1lbnRzOiB0aGlzLmNvbnZlcnQocmVxdWlyZW1lbnRzKSxcbiAgICAgICAgICAgICAgICAgICAgZXhwaXJlQWZ0ZXI6IHRoaXMub3B0aW9ucy5ub2RlUG9vbFNwZWM/LmV4cGlyZUFmdGVyXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZGlzcnVwdGlvbjogZGlzcnVwdGlvbixcbiAgICAgICAgICAgICAgICBsaW1pdHM6IGxpbWl0cyxcbiAgICAgICAgICAgICAgICB3ZWlnaHQ6IHdlaWdodCxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGNvbnN0IHBvb2xNYW5pZmVzdCA9IGNsdXN0ZXIuYWRkTWFuaWZlc3QoXCJkZWZhdWx0LXBvb2xcIiwgcG9vbCk7XG4gICAgICAgICAgICBwb29sTWFuaWZlc3Qubm9kZS5hZGREZXBlbmRlbmN5KGthcnBlbnRlckNoYXJ0KTtcblxuICAgICAgICAgICAgLy8gRGVwbG95IEFXU05vZGVUZW1wbGF0ZSAoQWxwaGEpIG9yIEVDMk5vZGVDbGFzcyAoQmV0YSkgQ1JEIGJhc2VkIG9uIHRoZSBLYXJwZW50ZXIgVmVyc2lvblxuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5lYzJOb2RlQ2xhc3NTcGVjKSB7XG4gICAgICAgICAgICAgICAgbGV0IGVjMk5vZGU7XG5cbiAgICAgICAgICAgICAgICBlYzJOb2RlID0ge1xuICAgICAgICAgICAgICAgICAgICBhcGlWZXJzaW9uOiBcImthcnBlbnRlci5rOHMuYXdzL3YxXCIsXG4gICAgICAgICAgICAgICAgICAgIGtpbmQ6IFwiRUMyTm9kZUNsYXNzXCIsXG4gICAgICAgICAgICAgICAgICAgIG1ldGFkYXRhOiB7IG5hbWU6IFwiZGVmYXVsdC1lYzJub2RlY2xhc3NcIiB9LFxuICAgICAgICAgICAgICAgICAgICBzcGVjOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbWlGYW1pbHk6IGFtaUZhbWlseSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Ym5ldFNlbGVjdG9yVGVybXM6IHN1Ym5ldFNlbGVjdG9yVGVybXMsXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWN1cml0eUdyb3VwU2VsZWN0b3JUZXJtczogc2dTZWxlY3RvclRlcm1zLFxuICAgICAgICAgICAgICAgICAgICAgICAgYW1pU2VsZWN0b3JUZXJtczogYW1pU2VsZWN0b3JUZXJtcyA/IGFtaVNlbGVjdG9yVGVybXMgOiBbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJEYXRhOiB1c2VyRGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3M6IHRhZ3MsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRhZGF0YU9wdGlvbnM6IG1ldGFkYXRhT3B0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrRGV2aWNlTWFwcGluZ3M6IGJsb2NrRGV2aWNlTWFwcGluZ3MsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWxlZE1vbml0b3Jpbmc6IGRldGFpbGVkTW9uaXRvcmluZyxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgLy8gUHJvdmlkZSBjdXN0b20gSW5zdGFuY2UgUHJvZmlsZSB0byByZXBsYWNlIHJvbGUgaWYgcHJvdmlkZWQsIGVsc2UgdXNlIHRoZSByb2xlIGNyZWF0ZWQgd2l0aCB0aGUgYWRkb25cbiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2VQcm9mKSB7XG4gICAgICAgICAgICAgICAgICAgIGVjMk5vZGUgPSBtZXJnZShlYzJOb2RlLCB7IHNwZWM6IHsgaW5zdGFuY2VQcm9maWxlOiBpbnN0YW5jZVByb2YgfSB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBlYzJOb2RlID0gbWVyZ2UoZWMyTm9kZSwgeyBzcGVjOiB7IHJvbGU6IGthcnBlbnRlck5vZGVSb2xlLnJvbGVOYW1lIH0gfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gSW5zdGFuY2UgU3RvcmUgUG9saWN5IGFkZGVkIGZvciB2MC4zNC4wIGFuZCB1cFxuICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZVN0b3JlUG9saWN5KSB7XG4gICAgICAgICAgICAgICAgICAgIGVjMk5vZGUgPSBtZXJnZShlYzJOb2RlLCB7IHNwZWM6IHsgaW5zdGFuY2VTdG9yZVBvbGljeTogaW5zdGFuY2VTdG9yZVBvbGljeSB9IH0pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGVNYW5pZmVzdCA9IGNsdXN0ZXIuYWRkTWFuaWZlc3QoXCJkZWZhdWx0LW5vZGUtdGVtcGxhdGVcIiwgZWMyTm9kZSk7XG4gICAgICAgICAgICAgICAgbm9kZU1hbmlmZXN0Lm5vZGUuYWRkRGVwZW5kZW5jeShrYXJwZW50ZXJDaGFydCk7XG4gICAgICAgICAgICAgICAgcG9vbE1hbmlmZXN0Lm5vZGUuYWRkRGVwZW5kZW5jeShub2RlTWFuaWZlc3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShrYXJwZW50ZXJDaGFydCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnZlcnQgYSBrZXktcGFpciB2YWx1ZXMgKHdpdGggYW4gb3BlcmF0b3IpXG4gICAgICogb2Ygc3BlYyBjb25maWd1cmF0aW9ucyB0byBhcHByb3ByaWF0ZSBqc29uIGZvcm1hdCBmb3IgYWRkTWFuaWZlc3QgZnVuY3Rpb25cbiAgICAgKiBAcGFyYW0gcmVxc1xuICAgICAqIEByZXR1cm5zIG5ld1JlcXNcbiAgICAgKiAqL1xuICAgIHByb3RlY3RlZCBjb252ZXJ0KHJlcXM6IHsga2V5OiBzdHJpbmc7IG9wZXJhdG9yOiBzdHJpbmc7IHZhbHVlczogc3RyaW5nW10gfVtdKTogYW55W10ge1xuICAgICAgICBjb25zdCBuZXdSZXFzID0gW107XG4gICAgICAgIGZvciAobGV0IHJlcSBvZiByZXFzKSB7XG4gICAgICAgICAgICBjb25zdCBrZXkgPSByZXFbXCJrZXlcIl07XG4gICAgICAgICAgICBjb25zdCBvcCA9IHJlcVtcIm9wZXJhdG9yXCJdO1xuICAgICAgICAgICAgY29uc3QgdmFsID0gcmVxW1widmFsdWVzXCJdO1xuICAgICAgICAgICAgY29uc3QgcmVxdWlyZW1lbnQgPSB7IGtleToga2V5LCBvcGVyYXRvcjogb3AsIHZhbHVlczogdmFsIH07XG4gICAgICAgICAgICBuZXdSZXFzLnB1c2gocmVxdWlyZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXdSZXFzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhlbHBlciBmdW5jdGlvbiB0byBzZXQgdXAgdGhlIEthcnBlbnRlciBOb2RlIFJvbGUgYW5kIEluc3RhbmNlIFByb2ZpbGVcbiAgICAgKiBPdXRwdXRzIHRvIENsb3VkRm9ybWF0aW9uIGFuZCBtYXAgdGhlIHJvbGUgdG8gdGhlIGF3cy1hdXRoIENvbmZpZ01hcFxuICAgICAqIEBwYXJhbSBjbHVzdGVyIEVLUyBDbHVzdGVyXG4gICAgICogQHBhcmFtIHN0YWNrTmFtZSBOYW1lIG9mIHRoZSBzdGFja1xuICAgICAqIEBwYXJhbSByZWdpb24gUmVnaW9uIG9mIHRoZSBzdGFja1xuICAgICAqIEByZXR1cm5zIFtrYXJwZW50ZXJOb2RlUm9sZSwga2FycGVudGVySW5zdGFuY2VQcm9maWxlXVxuICAgICAqL1xuICAgIHByaXZhdGUgc2V0VXBOb2RlUm9sZShcbiAgICAgICAgY2x1c3RlcjogQ2x1c3RlcixcbiAgICAgICAgc3RhY2tOYW1lOiBzdHJpbmcsXG4gICAgICAgIHJlZ2lvbjogc3RyaW5nXG4gICAgKTogW2lhbS5Sb2xlLCBpYW0uQ2ZuSW5zdGFuY2VQcm9maWxlXSB7XG4gICAgICAgIC8vIFNldCB1cCBOb2RlIFJvbGVcbiAgICAgICAgY29uc3Qga2FycGVudGVyTm9kZVJvbGUgPSBuZXcgaWFtLlJvbGUoY2x1c3RlciwgXCJrYXJwZW50ZXItbm9kZS1yb2xlXCIsIHtcbiAgICAgICAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKGBlYzIuJHtjbHVzdGVyLnN0YWNrLnVybFN1ZmZpeH1gKSxcbiAgICAgICAgICAgIG1hbmFnZWRQb2xpY2llczogW1xuICAgICAgICAgICAgICAgIGlhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZShcIkFtYXpvbkVLU1dvcmtlck5vZGVQb2xpY3lcIiksXG4gICAgICAgICAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQW1hem9uRUtTX0NOSV9Qb2xpY3lcIiksXG4gICAgICAgICAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQW1hem9uRUMyQ29udGFpbmVyUmVnaXN0cnlSZWFkT25seVwiKSxcbiAgICAgICAgICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoXCJBbWF6b25TU01NYW5hZ2VkSW5zdGFuY2VDb3JlXCIpLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIC8vcm9sZU5hbWU6IGBLYXJwZW50ZXJOb2RlUm9sZS0ke25hbWV9YCAvLyBsZXQgcm9sZSBuYW1lIHRvIGJlIGdlbmVyYXRlZCBhcyB1bmlxdWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQXR0YWNoIGlwdjYgcmVsYXRlZCBwb2xpY2llcyBiYXNlZCBvbiBjbHVzdGVyIElQRmFtaWx5XG4gICAgICAgIGlmIChjbHVzdGVyLmlwRmFtaWx5ID09PSBJcEZhbWlseS5JUF9WNikge1xuICAgICAgICAgICAgY29uc3Qgbm9kZUlwdjZQb2xpY3kgPSBuZXcgaWFtLlBvbGljeShjbHVzdGVyLCBcImthcnBlbnRlci1ub2RlLUlwdjYtUG9saWN5XCIsIHtcbiAgICAgICAgICAgICAgICBkb2N1bWVudDogdXRpbHMuZ2V0RUtTTm9kZUlwdjZQb2xpY3lEb2N1bWVudCgpLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBrYXJwZW50ZXJOb2RlUm9sZS5hdHRhY2hJbmxpbmVQb2xpY3kobm9kZUlwdjZQb2xpY3kpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU2V0IHVwIEluc3RhbmNlIFByb2ZpbGVcbiAgICAgICAgY29uc3QgaW5zdGFuY2VQcm9maWxlTmFtZSA9IG1kNS5NZDUuaGFzaFN0cihzdGFja05hbWUgKyByZWdpb24pO1xuICAgICAgICBjb25zdCBrYXJwZW50ZXJJbnN0YW5jZVByb2ZpbGUgPSBuZXcgaWFtLkNmbkluc3RhbmNlUHJvZmlsZShcbiAgICAgICAgICAgIGNsdXN0ZXIsXG4gICAgICAgICAgICBcImthcnBlbnRlci1pbnN0YW5jZS1wcm9maWxlXCIsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgcm9sZXM6IFtrYXJwZW50ZXJOb2RlUm9sZS5yb2xlTmFtZV0sXG4gICAgICAgICAgICAgICAgaW5zdGFuY2VQcm9maWxlTmFtZTogYEthcnBlbnRlck5vZGVJbnN0YW5jZVByb2ZpbGUtJHtpbnN0YW5jZVByb2ZpbGVOYW1lfWAsXG4gICAgICAgICAgICAgICAgcGF0aDogXCIvXCIsXG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICAgIGthcnBlbnRlckluc3RhbmNlUHJvZmlsZS5ub2RlLmFkZERlcGVuZGVuY3koa2FycGVudGVyTm9kZVJvbGUpO1xuXG4gICAgICAgIGNvbnN0IGNsdXN0ZXJJZCA9IE5hbWVzLnVuaXF1ZUlkKGNsdXN0ZXIpO1xuXG4gICAgICAgIC8vQ2ZuIG91dHB1dCBmb3IgTm9kZSBSb2xlIGluIGNhc2Ugb2YgbmVlZGluZyB0byBhZGQgYWRkaXRpb25hbCBwb2xpY2llc1xuICAgICAgICBuZXcgQ2ZuT3V0cHV0KGNsdXN0ZXIuc3RhY2ssIFwiS2FycGVudGVyIEluc3RhbmNlIE5vZGUgUm9sZVwiLCB7XG4gICAgICAgICAgICB2YWx1ZToga2FycGVudGVyTm9kZVJvbGUucm9sZU5hbWUsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogXCJLYXJwZW50ZXIgYWRkLW9uIE5vZGUgUm9sZSBuYW1lXCIsXG4gICAgICAgICAgICBleHBvcnROYW1lOiBjbHVzdGVySWQgKyBcIkthcnBlbnRlck5vZGVSb2xlTmFtZVwiLFxuICAgICAgICB9KTtcbiAgICAgICAgLy9DZm4gb3V0cHV0IGZvciBJbnN0YW5jZSBQcm9maWxlIGZvciBjcmVhdGluZyBhZGRpdGlvbmFsIHByb3Zpc2lvbmVyc1xuICAgICAgICBuZXcgQ2ZuT3V0cHV0KGNsdXN0ZXIuc3RhY2ssIFwiS2FycGVudGVyIEluc3RhbmNlIFByb2ZpbGUgbmFtZVwiLCB7XG4gICAgICAgICAgICB2YWx1ZToga2FycGVudGVySW5zdGFuY2VQcm9maWxlID8ga2FycGVudGVySW5zdGFuY2VQcm9maWxlLmluc3RhbmNlUHJvZmlsZU5hbWUhIDogXCJub25lXCIsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogXCJLYXJwZW50ZXIgYWRkLW9uIEluc3RhbmNlIFByb2ZpbGUgbmFtZVwiLFxuICAgICAgICAgICAgZXhwb3J0TmFtZTogY2x1c3RlcklkICsgXCJLYXJwZW50ZXJJbnN0YW5jZVByb2ZpbGVOYW1lXCIsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIE1hcCBOb2RlIFJvbGUgdG8gYXdzLWF1dGhcbiAgICAgICAgY2x1c3Rlci5hd3NBdXRoLmFkZFJvbGVNYXBwaW5nKGthcnBlbnRlck5vZGVSb2xlLCB7XG4gICAgICAgICAgICBncm91cHM6IFtcInN5c3RlbTpib290c3RyYXBwZXJcIiwgXCJzeXN0ZW06bm9kZXNcIl0sXG4gICAgICAgICAgICB1c2VybmFtZTogXCJzeXN0ZW06bm9kZTp7e0VDMlByaXZhdGVETlNOYW1lfX1cIixcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIFtrYXJwZW50ZXJOb2RlUm9sZSwga2FycGVudGVySW5zdGFuY2VQcm9maWxlXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUludGVycnVwdGlvblF1ZXVlKGNsdXN0ZXI6IENsdXN0ZXIsIHN0YWNrTmFtZTogc3RyaW5nKTogaWFtLlBvbGljeVN0YXRlbWVudCB7XG4gICAgICAgIC8vIENyZWF0ZSBJbnRlcnJ1cHRpb24gUXVldWVcbiAgICAgICAgY29uc3QgcXVldWUgPSBuZXcgc3FzLlF1ZXVlKGNsdXN0ZXIuc3RhY2ssIFwia2FycGVudGVyLXF1ZXVlXCIsIHtcbiAgICAgICAgICAgIHF1ZXVlTmFtZTogc3RhY2tOYW1lLFxuICAgICAgICAgICAgcmV0ZW50aW9uUGVyaW9kOiBEdXJhdGlvbi5zZWNvbmRzKDMwMCksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHF1ZXVlLmFkZFRvUmVzb3VyY2VQb2xpY3koXG4gICAgICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgc2lkOiBcIkVDMkludGVycnVwdGlvblBvbGljeVwiLFxuICAgICAgICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgICAgICBwcmluY2lwYWxzOiBbXG4gICAgICAgICAgICAgICAgICAgIG5ldyBpYW0uU2VydmljZVByaW5jaXBhbChcInNxcy5hbWF6b25hd3MuY29tXCIpLFxuICAgICAgICAgICAgICAgICAgICBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoXCJldmVudHMuYW1hem9uYXdzLmNvbVwiKSxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcInNxczpTZW5kTWVzc2FnZVwiXSxcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtgJHtxdWV1ZS5xdWV1ZUFybn1gXSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gQWRkIEludGVycnVwdGlvbiBSdWxlc1xuICAgICAgICBuZXcgUnVsZShjbHVzdGVyLnN0YWNrLCBcInNjaGVkdWxlLWNoYW5nZS1ydWxlXCIsIHtcbiAgICAgICAgICAgIGV2ZW50UGF0dGVybjogeyBzb3VyY2U6IFtcImF3cy5oZWFsdGhcIl0sIGRldGFpbFR5cGU6IFtcIkFXUyBIZWFsdGggRXZlbnRcIl0gfSxcbiAgICAgICAgfSkuYWRkVGFyZ2V0KG5ldyBTcXNRdWV1ZShxdWV1ZSkpO1xuXG4gICAgICAgIG5ldyBSdWxlKGNsdXN0ZXIuc3RhY2ssIFwic3BvdC1pbnRlcnJ1cHRpb24tcnVsZVwiLCB7XG4gICAgICAgICAgICBldmVudFBhdHRlcm46IHsgc291cmNlOiBbXCJhd3MuZWMyXCJdLCBkZXRhaWxUeXBlOiBbXCJFQzIgU3BvdCBJbnN0YW5jZSBJbnRlcnJ1cHRpb24gV2FybmluZ1wiXSB9LFxuICAgICAgICB9KS5hZGRUYXJnZXQobmV3IFNxc1F1ZXVlKHF1ZXVlKSk7XG5cbiAgICAgICAgbmV3IFJ1bGUoY2x1c3Rlci5zdGFjaywgXCJyZWJhbGFuY2UtcnVsZVwiLCB7XG4gICAgICAgICAgICBldmVudFBhdHRlcm46IHsgc291cmNlOiBbXCJhd3MuZWMyXCJdLCBkZXRhaWxUeXBlOiBbXCJFQzIgSW5zdGFuY2UgUmViYWxhbmNlIFJlY29tbWVuZGF0aW9uXCJdIH0sXG4gICAgICAgIH0pLmFkZFRhcmdldChuZXcgU3FzUXVldWUocXVldWUpKTtcblxuICAgICAgICBuZXcgUnVsZShjbHVzdGVyLnN0YWNrLCBcImluc3Qtc3RhdGUtY2hhbmdlLXJ1bGVcIiwge1xuICAgICAgICAgICAgZXZlbnRQYXR0ZXJuOiB7IHNvdXJjZTogW1wiYXdzLmVjMlwiXSwgZGV0YWlsVHlwZTogW1wiQzIgSW5zdGFuY2UgU3RhdGUtY2hhbmdlIE5vdGlmaWNhdGlvblwiXSB9LFxuICAgICAgICB9KS5hZGRUYXJnZXQobmV3IFNxc1F1ZXVlKHF1ZXVlKSk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIGFuZCByZXR1cm4gdGhlIGludGVycnVwdGlvbiBxdWV1ZSBwb2xpY3kgc3RhdGVtZW50XG4gICAgICAgIHJldHVybiBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICAgXCJzcXM6RGVsZXRlTWVzc2FnZVwiLFxuICAgICAgICAgICAgICAgIFwic3FzOkdldFF1ZXVlVXJsXCIsXG4gICAgICAgICAgICAgICAgXCJzcXM6R2V0UXVldWVBdHRyaWJ1dGVzXCIsXG4gICAgICAgICAgICAgICAgXCJzcXM6UmVjZWl2ZU1lc3NhZ2VcIixcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICByZXNvdXJjZXM6IFtgJHtxdWV1ZS5xdWV1ZUFybn1gXSxcbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19