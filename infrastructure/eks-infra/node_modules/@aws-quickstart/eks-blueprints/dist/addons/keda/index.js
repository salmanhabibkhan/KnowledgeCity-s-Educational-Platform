"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.KedaAddOn = void 0;
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const ts_deepmerge_1 = require("ts-deepmerge");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
/**
 * Default props to be used when creating the Helm chart
 */
const defaultProps = {
    name: "blueprints-keda-addon",
    chart: "keda",
    namespace: "keda",
    version: "2.17.0",
    release: "keda",
    repository: "https://kedacore.github.io/charts",
    values: {},
    kedaOperatorName: "keda-operator",
    kedaServiceAccountName: "keda-operator",
    irsaRoles: [],
    createNamespace: true
};
/**
 * Main class to instantiate the Helm chart
 */
let KedaAddOn = class KedaAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a;
        const cluster = clusterInfo.cluster;
        let values = populateValues(this.options);
        values = (0, ts_deepmerge_1.merge)(values, (_a = this.props.values) !== null && _a !== void 0 ? _a : {});
        let namespace = undefined;
        if (this.options.createNamespace) {
            namespace = (0, utils_1.createNamespace)(this.options.namespace, cluster);
        }
        const chart = this.addHelmChart(clusterInfo, values);
        if (this.options.irsaRoles.length > 0) {
            //Create Service Account with IRSA
            const opts = { name: this.options.kedaOperatorName, namespace: this.options.namespace };
            const sa = cluster.addServiceAccount(this.options.kedaServiceAccountName, opts);
            setRoles(sa, this.options.irsaRoles);
            if (namespace) {
                sa.node.addDependency(namespace);
            }
            chart.node.addDependency(sa);
        }
        else if (namespace) {
            chart.node.addDependency(namespace);
        }
        return Promise.resolve(chart);
    }
};
exports.KedaAddOn = KedaAddOn;
exports.KedaAddOn = KedaAddOn = __decorate([
    utils_1.supportsALL
], KedaAddOn);
/**
 * populateValues populates the appropriate values used to customize the Helm chart
 * @param helmOptions User provided values to customize the chart
 */
function populateValues(helmOptions) {
    var _a;
    const values = (_a = helmOptions.values) !== null && _a !== void 0 ? _a : {};
    (0, utils_1.setPath)(values, "operator.name", helmOptions.kedaOperatorName);
    //In Case irsaRoles array is non empty, code should not allow Keda to create Service Account, CDK will create Service Account with IRSA enabled
    (0, utils_1.setPath)(values, "serviceAccount.operator.create", helmOptions.irsaRoles.length > 0 ? false : true);
    (0, utils_1.setPath)(values, "serviceAccount.operator.name", helmOptions.kedaServiceAccountName);
    return values;
}
/**
 * This function will set the roles to Service Account
 * @param sa - Service Account Object
 * @param irsaRoles - Array  of Managed IAM Policies
 */
function setRoles(sa, irsaRoles) {
    irsaRoles.forEach((policyName) => {
        const policy = aws_iam_1.ManagedPolicy.fromAwsManagedPolicyName(policyName);
        sa.role.addManagedPolicy(policy);
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2tlZGEvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQ0EsaURBQW9EO0FBRXBELCtDQUFxQztBQUVyQyx1Q0FBb0U7QUFDcEUsOENBQThFO0FBb0Q5RTs7R0FFRztBQUNILE1BQU0sWUFBWSxHQUFvQztJQUNwRCxJQUFJLEVBQUUsdUJBQXVCO0lBQzdCLEtBQUssRUFBRSxNQUFNO0lBQ2IsU0FBUyxFQUFDLE1BQU07SUFDaEIsT0FBTyxFQUFFLFFBQVE7SUFDakIsT0FBTyxFQUFFLE1BQU07SUFDZixVQUFVLEVBQUcsbUNBQW1DO0lBQ2hELE1BQU0sRUFBRSxFQUFFO0lBQ1YsZ0JBQWdCLEVBQUUsZUFBZTtJQUNqQyxzQkFBc0IsRUFBRSxlQUFlO0lBQ3ZDLFNBQVMsRUFBRSxFQUFFO0lBQ2IsZUFBZSxFQUFFLElBQUk7Q0FDdEIsQ0FBQztBQUVGOztHQUVHO0FBRUksSUFBTSxTQUFTLEdBQWYsTUFBTSxTQUFVLFNBQVEsc0JBQVM7SUFHdEMsWUFBWSxLQUFzQjtRQUNoQyxLQUFLLENBQUMsRUFBQyxHQUFHLFlBQVksRUFBRSxHQUFHLEtBQUssRUFBQyxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBdUIsQ0FBQztJQUM5QyxDQUFDO0lBRUQsTUFBTSxDQUFDLFdBQXdCOztRQUU3QixNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ3BDLElBQUksTUFBTSxHQUFXLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbEQsTUFBTSxHQUFHLElBQUEsb0JBQUssRUFBQyxNQUFNLEVBQUUsTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sbUNBQUksRUFBRSxDQUFDLENBQUM7UUFFaEQsSUFBSSxTQUFTLEdBQTBCLFNBQVMsQ0FBQztRQUVqRCxJQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDOUIsU0FBUyxHQUFHLElBQUEsdUJBQWUsRUFBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVUsRUFBRyxPQUFPLENBQUMsQ0FBQztRQUNuRSxDQUFDO1FBQ0QsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFckQsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDdkMsa0NBQWtDO1lBQ2xDLE1BQU0sSUFBSSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDeEYsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsc0JBQXVCLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDakYsUUFBUSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVUsQ0FBQyxDQUFDO1lBQ3RDLElBQUcsU0FBUyxFQUFFLENBQUM7Z0JBQ2IsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDbkMsQ0FBQztZQUNELEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQy9CLENBQUM7YUFBTSxJQUFHLFNBQVMsRUFBRSxDQUFDO1lBQ3BCLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3RDLENBQUM7UUFDRCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEMsQ0FBQztDQUNGLENBQUE7QUFuQ1ksOEJBQVM7b0JBQVQsU0FBUztJQURyQixtQkFBVztHQUNDLFNBQVMsQ0FtQ3JCO0FBRUQ7OztHQUdHO0FBQ0gsU0FBUyxjQUFjLENBQUMsV0FBMkI7O0lBQ2pELE1BQU0sTUFBTSxHQUFHLE1BQUEsV0FBVyxDQUFDLE1BQU0sbUNBQUksRUFBRSxDQUFDO0lBRXhDLElBQUEsZUFBTyxFQUFDLE1BQU0sRUFBRSxlQUFlLEVBQUcsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDaEUsK0lBQStJO0lBQy9JLElBQUEsZUFBTyxFQUFDLE1BQU0sRUFBRSxnQ0FBZ0MsRUFBRyxXQUFXLENBQUMsU0FBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDckcsSUFBQSxlQUFPLEVBQUMsTUFBTSxFQUFFLDhCQUE4QixFQUFHLFdBQVcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBRXJGLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFFRDs7OztHQUlHO0FBQ0YsU0FBUyxRQUFRLENBQUMsRUFBaUIsRUFBRSxTQUFtQjtJQUNyRCxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUU7UUFDN0IsTUFBTSxNQUFNLEdBQUcsdUJBQWEsQ0FBQyx3QkFBd0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNsRSxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ25DLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNlcnZpY2VBY2NvdW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWVrcyc7XHJcbmltcG9ydCB7IE1hbmFnZWRQb2xpY3kgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xyXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcclxuaW1wb3J0IHsgbWVyZ2UgfSBmcm9tIFwidHMtZGVlcG1lcmdlXCI7XHJcbmltcG9ydCB7IENsdXN0ZXJJbmZvLCBWYWx1ZXMgfSBmcm9tIFwiLi4vLi4vc3BpXCI7XHJcbmltcG9ydCB7IGNyZWF0ZU5hbWVzcGFjZSwgc2V0UGF0aCwgc3VwcG9ydHNBTEwgfSBmcm9tIFwiLi4vLi4vdXRpbHNcIjtcclxuaW1wb3J0IHsgSGVsbUFkZE9uLCBIZWxtQWRkT25Qcm9wcywgSGVsbUFkZE9uVXNlclByb3BzIH0gZnJvbSBcIi4uL2hlbG0tYWRkb25cIjtcclxuXHJcbi8qKlxyXG4gKiBVc2VyIHByb3ZpZGVkIG9wdGlvbnMgZm9yIHRoZSBIZWxtIENoYXJ0XHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIEtlZGFBZGRPblByb3BzIGV4dGVuZHMgSGVsbUFkZE9uVXNlclByb3BzIHtcclxuICAgIC8qKlxyXG4gICAgICogVmVyc2lvbiBvZiB0aGUgaGVsbSBjaGFydCB0byBkZXBsb3lcclxuICAgICAqL1xyXG4gICAgdmVyc2lvbj86IHN0cmluZztcclxuICAgIC8qKlxyXG4gICAgICogTmFtZSBvZiB0aGUgS0VEQSBvcGVyYXRvclxyXG4gICAgICovXHJcbiAgICBrZWRhT3BlcmF0b3JOYW1lPzogc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiBUaGUgbmFtZSBvZiB0aGUgc2VydmljZSBhY2NvdW50IHRvIHVzZS4gSWYgbm90IHNldCBhbmQgY3JlYXRlIGlzIHRydWUsIGEgbmFtZSBpcyBnZW5lcmF0ZWQuXHJcbiAgICAgKi9cclxuICAgIGtlZGFTZXJ2aWNlQWNjb3VudE5hbWU/OiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIHNlY3VyaXR5Q29udGV4dDogZnNHcm91cFxyXG4gICAgICogQ2hlY2sgdGhlIHdvcmthcm91bmQgZm9yIFNRUyBTY2FsYXIgd2l0aCBJUlNBIGh0dHBzOi8vZ2l0aHViLmNvbS9rZWRhY29yZS9rZWRhL2lzc3Vlcy84MzcjaXNzdWVjb21tZW50LTc4OTAzNzMyNlxyXG4gICAgICpcclxuICAgICAqIEBkZXByZWNhdGVkIEhhcyBubyBlZmZlY3QgZm9yIHZlcnNpb24gMi4xNCBhbmQgYWJvdmUuIFVwZGF0ZSBwb2RTZWN1cml0eUNvbnRleHQub3BlcmF0b3IuZnNHcm91cCBpbiBWYWx1ZXMgaW5zdGVhZC4gS0VEQS1pcy1zZWN1cmUtYnktZGVmYXVsdCB3aXRoIGZzR3JvdXA6IDEwMDBcclxuICAgICAqL1xyXG4gICAgcG9kU2VjdXJpdHlDb250ZXh0RnNHcm91cD86IG51bWJlcjtcclxuICAgIC8qKlxyXG4gICAgICogc2VjdXJpdHlDb250ZXh0OnJ1bkFzR3JvdXBcclxuICAgICAqIENoZWNrIHRoZSB3b3JrYXJvdW5kIGZvciBTUVMgU2NhbGFyIHdpdGggSVJTQSBodHRwczovL2dpdGh1Yi5jb20va2VkYWNvcmUva2VkYS9pc3N1ZXMvODM3I2lzc3VlY29tbWVudC03ODkwMzczMjZcclxuICAgICAqXHJcbiAgICAgKiBAZGVwcmVjYXRlZCBIYXMgbm8gZWZmZWN0IGZvciB2ZXJzaW9uIDIuMTQgYW5kIGFib3ZlLiBVcGRhdGUgcG9kU2VjdXJpdHlDb250ZXh0Lm9wZXJhdG9yLnJ1bkFzR3JvdXAgaW4gVmFsdWVzIGluc3RlYWQuIEtFREEtaXMtc2VjdXJlLWJ5LWRlZmF1bHQgd2l0aCBydW5Bc0dyb3VwOiAxMDAwXHJcbiAgICAgKi9cclxuICAgIHNlY3VyaXR5Q29udGV4dFJ1bkFzR3JvdXA/OiBudW1iZXI7XHJcbiAgICAvKipcclxuICAgICAqIHNlY3VyaXR5Q29udGV4dDpydW5Bc1VzZXJcclxuICAgICAqIENoZWNrIHRoZSB3b3JrYXJvdW5kIGZvciBTUVMgU2NhbGFyIHdpdGggSVJTQSBodHRwczovL2dpdGh1Yi5jb20va2VkYWNvcmUva2VkYS9pc3N1ZXMvODM3I2lzc3VlY29tbWVudC03ODkwMzczMjZcclxuICAgICAqXHJcbiAgICAgKiBAZGVwcmVjYXRlZCBIYXMgbm8gZWZmZWN0IGZvciB2ZXJzaW9uIDIuMTQgYW5kIGFib3ZlLiBVcGRhdGUgcG9kU2VjdXJpdHlDb250ZXh0Lm9wZXJhdG9yLnJ1bkFzVXNlciBpbiBWYWx1ZXMgaW5zdGVhZC4gS0VEQS1pcy1zZWN1cmUtYnktZGVmYXVsdCB3aXRoIHJ1bkFzVXNlcjogMTAwMFxyXG4gICAgICovXHJcbiAgICBzZWN1cml0eUNvbnRleHRSdW5Bc1VzZXI/OiBudW1iZXI7XHJcbiAgICAvKipcclxuICAgICAqIEFuIGFycmF5IG9mIE1hbmFnZWQgSUFNIFBvbGljaWVzIHdoaWNoIFNlcnZpY2UgQWNjb3VudCBvZiBLRURBIG9wZXJhdG9yIG5lZWRzIGZvciBJUlNBIEVnOiBpcnNhUm9sZXM6W1wiQ2xvdWRXYXRjaEZ1bGxBY2Nlc3NcIixcIkFtYXpvblNRU0Z1bGxBY2Nlc3NcIl0uIElmIG5vdCBlbXB0eVxyXG4gICAgICogU2VydmljZSBBY2NvdW50IHdpbGwgYmUgQ3JlYXRlZCBieSBDREsgd2l0aCBJQU0gUm9sZXMgTWFwcGVkIChJUlNBKS4gSW4gY2FzZSBpZiBpdHMgZW1wdHksIEtlZGEgd2lsbCBjcmVhdGUgdGhlIFNlcnZpY2UgQWNjb3VudCB3aXRoIG91dCBJQU0gUm9sZXNcclxuICAgICAqL1xyXG4gICAgaXJzYVJvbGVzPzogc3RyaW5nW107XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJZiBzZXQgdG8gdHJ1ZSB0aGUgbmFtZXNwYWNlIHdpbGwgYmUgY3JlYXRlZC4gRGVmYXVsdCBpcyB0cnVlLCBzaW5jZSBuYW1lc3BhY2UgaXMgc2V0IHRvIGtlZGEuIFxyXG4gICAgICogU2V0IHRvIGZhbHNlIGlmIGluc3RhbGxpbmcgdG8ga3ViZS1zeXN0ZW0gb3Igb3RoZXIgZXhpc3RpbmcgbmFtZXNwYWNlLiBcclxuICAgICAqL1xyXG4gICAgY3JlYXRlTmFtZXNwYWNlPzogYm9vbGVhbixcclxufVxyXG5cclxuLyoqXHJcbiAqIERlZmF1bHQgcHJvcHMgdG8gYmUgdXNlZCB3aGVuIGNyZWF0aW5nIHRoZSBIZWxtIGNoYXJ0XHJcbiAqL1xyXG5jb25zdCBkZWZhdWx0UHJvcHM6IEhlbG1BZGRPblByb3BzICYgS2VkYUFkZE9uUHJvcHMgPSB7XHJcbiAgbmFtZTogXCJibHVlcHJpbnRzLWtlZGEtYWRkb25cIixcclxuICBjaGFydDogXCJrZWRhXCIsXHJcbiAgbmFtZXNwYWNlOlwia2VkYVwiLFxyXG4gIHZlcnNpb246IFwiMi4xNy4wXCIsXHJcbiAgcmVsZWFzZTogXCJrZWRhXCIsXHJcbiAgcmVwb3NpdG9yeTogIFwiaHR0cHM6Ly9rZWRhY29yZS5naXRodWIuaW8vY2hhcnRzXCIsXHJcbiAgdmFsdWVzOiB7fSxcclxuICBrZWRhT3BlcmF0b3JOYW1lOiBcImtlZGEtb3BlcmF0b3JcIixcclxuICBrZWRhU2VydmljZUFjY291bnROYW1lOiBcImtlZGEtb3BlcmF0b3JcIixcclxuICBpcnNhUm9sZXM6IFtdLFxyXG4gIGNyZWF0ZU5hbWVzcGFjZTogdHJ1ZVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIE1haW4gY2xhc3MgdG8gaW5zdGFudGlhdGUgdGhlIEhlbG0gY2hhcnRcclxuICovXHJcbkBzdXBwb3J0c0FMTFxyXG5leHBvcnQgY2xhc3MgS2VkYUFkZE9uIGV4dGVuZHMgSGVsbUFkZE9uIHtcclxuXHJcbiAgcmVhZG9ubHkgb3B0aW9uczogS2VkYUFkZE9uUHJvcHM7XHJcbiAgY29uc3RydWN0b3IocHJvcHM/OiBLZWRhQWRkT25Qcm9wcykge1xyXG4gICAgc3VwZXIoey4uLmRlZmF1bHRQcm9wcywgLi4ucHJvcHN9KTtcclxuICAgIHRoaXMub3B0aW9ucyA9IHRoaXMucHJvcHMgYXMgS2VkYUFkZE9uUHJvcHM7XHJcbiAgfVxyXG5cclxuICBkZXBsb3koY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHtcclxuXHJcbiAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcclxuICAgIGxldCB2YWx1ZXM6IFZhbHVlcyA9IHBvcHVsYXRlVmFsdWVzKHRoaXMub3B0aW9ucyk7XHJcbiAgICB2YWx1ZXMgPSBtZXJnZSh2YWx1ZXMsIHRoaXMucHJvcHMudmFsdWVzID8/IHt9KTtcclxuXHJcbiAgICBsZXQgbmFtZXNwYWNlOiBDb25zdHJ1Y3QgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XHJcbiAgICBcclxuICAgIGlmKHRoaXMub3B0aW9ucy5jcmVhdGVOYW1lc3BhY2UpIHtcclxuICAgICAgICBuYW1lc3BhY2UgPSBjcmVhdGVOYW1lc3BhY2UodGhpcy5vcHRpb25zLm5hbWVzcGFjZSEgLCBjbHVzdGVyKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGNoYXJ0ID0gdGhpcy5hZGRIZWxtQ2hhcnQoY2x1c3RlckluZm8sIHZhbHVlcyk7XHJcblxyXG4gICAgaWYgKHRoaXMub3B0aW9ucy5pcnNhUm9sZXMhLmxlbmd0aCA+IDApIHtcclxuICAgICAgLy9DcmVhdGUgU2VydmljZSBBY2NvdW50IHdpdGggSVJTQVxyXG4gICAgICBjb25zdCBvcHRzID0geyBuYW1lOiB0aGlzLm9wdGlvbnMua2VkYU9wZXJhdG9yTmFtZSwgbmFtZXNwYWNlOiB0aGlzLm9wdGlvbnMubmFtZXNwYWNlIH07XHJcbiAgICAgIGNvbnN0IHNhID0gY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCh0aGlzLm9wdGlvbnMua2VkYVNlcnZpY2VBY2NvdW50TmFtZSEsIG9wdHMpO1xyXG4gICAgICBzZXRSb2xlcyhzYSwgdGhpcy5vcHRpb25zLmlyc2FSb2xlcyEpO1xyXG4gICAgICBpZihuYW1lc3BhY2UpIHtcclxuICAgICAgICBzYS5ub2RlLmFkZERlcGVuZGVuY3kobmFtZXNwYWNlKTtcclxuICAgICAgfVxyXG4gICAgICBjaGFydC5ub2RlLmFkZERlcGVuZGVuY3koc2EpO1xyXG4gICAgfSBlbHNlIGlmKG5hbWVzcGFjZSkge1xyXG4gICAgICBjaGFydC5ub2RlLmFkZERlcGVuZGVuY3kobmFtZXNwYWNlKTtcclxuICAgIH1cclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2hhcnQpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIHBvcHVsYXRlVmFsdWVzIHBvcHVsYXRlcyB0aGUgYXBwcm9wcmlhdGUgdmFsdWVzIHVzZWQgdG8gY3VzdG9taXplIHRoZSBIZWxtIGNoYXJ0XHJcbiAqIEBwYXJhbSBoZWxtT3B0aW9ucyBVc2VyIHByb3ZpZGVkIHZhbHVlcyB0byBjdXN0b21pemUgdGhlIGNoYXJ0XHJcbiAqL1xyXG5mdW5jdGlvbiBwb3B1bGF0ZVZhbHVlcyhoZWxtT3B0aW9uczogS2VkYUFkZE9uUHJvcHMpOiBWYWx1ZXMge1xyXG4gIGNvbnN0IHZhbHVlcyA9IGhlbG1PcHRpb25zLnZhbHVlcyA/PyB7fTtcclxuXHJcbiAgc2V0UGF0aCh2YWx1ZXMsIFwib3BlcmF0b3IubmFtZVwiLCAgaGVsbU9wdGlvbnMua2VkYU9wZXJhdG9yTmFtZSk7XHJcbiAgLy9JbiBDYXNlIGlyc2FSb2xlcyBhcnJheSBpcyBub24gZW1wdHksIGNvZGUgc2hvdWxkIG5vdCBhbGxvdyBLZWRhIHRvIGNyZWF0ZSBTZXJ2aWNlIEFjY291bnQsIENESyB3aWxsIGNyZWF0ZSBTZXJ2aWNlIEFjY291bnQgd2l0aCBJUlNBIGVuYWJsZWRcclxuICBzZXRQYXRoKHZhbHVlcywgXCJzZXJ2aWNlQWNjb3VudC5vcGVyYXRvci5jcmVhdGVcIiwgIGhlbG1PcHRpb25zLmlyc2FSb2xlcyEubGVuZ3RoID4gMCA/IGZhbHNlIDogdHJ1ZSk7XHJcbiAgc2V0UGF0aCh2YWx1ZXMsIFwic2VydmljZUFjY291bnQub3BlcmF0b3IubmFtZVwiLCAgaGVsbU9wdGlvbnMua2VkYVNlcnZpY2VBY2NvdW50TmFtZSk7XHJcblxyXG4gIHJldHVybiB2YWx1ZXM7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUaGlzIGZ1bmN0aW9uIHdpbGwgc2V0IHRoZSByb2xlcyB0byBTZXJ2aWNlIEFjY291bnRcclxuICogQHBhcmFtIHNhIC0gU2VydmljZSBBY2NvdW50IE9iamVjdFxyXG4gKiBAcGFyYW0gaXJzYVJvbGVzIC0gQXJyYXkgIG9mIE1hbmFnZWQgSUFNIFBvbGljaWVzXHJcbiAqL1xyXG4gZnVuY3Rpb24gc2V0Um9sZXMoc2E6U2VydmljZUFjY291bnQsIGlyc2FSb2xlczogc3RyaW5nW10pe1xyXG4gICAgaXJzYVJvbGVzLmZvckVhY2goKHBvbGljeU5hbWUpID0+IHtcclxuICAgICAgICBjb25zdCBwb2xpY3kgPSBNYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZShwb2xpY3lOYW1lKTtcclxuICAgICAgICBzYS5yb2xlLmFkZE1hbmFnZWRQb2xpY3kocG9saWN5KTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG4iXX0=