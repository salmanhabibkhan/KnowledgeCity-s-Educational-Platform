"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.VeleroAddOn = void 0;
const iam = require("aws-cdk-lib/aws-iam");
const s3 = require("aws-cdk-lib/aws-s3");
const ts_deepmerge_1 = require("ts-deepmerge");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    name: 'velero',
    version: "3.2.0",
    namespace: "velero",
    createNamespace: true,
    chart: "velero",
    repository: "https://vmware-tanzu.github.io/helm-charts/",
    release: "blueprints-addon-velero",
    values: {
        initContainers: [
            {
                name: "velero-plugin-for-aws",
                image: "velero/velero-plugin-for-aws:v1.2.0",
                imagePullPolicy: "IfNotPresent",
                volumeMounts: [
                    {
                        mountPath: "/target",
                        name: "plugins"
                    }
                ]
            }
        ],
        configuration: {
            provider: "aws",
            backupStorageLocation: {
                name: "default",
                config: {}
            },
            volumeSnapshotLocation: {
                name: "default",
                config: {}
            },
        },
        serviceAccount: {
            server: {}
        }
    },
};
let VeleroAddOn = class VeleroAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super((0, ts_deepmerge_1.merge)(defaultProps, props !== null && props !== void 0 ? props : {}));
        this.options = this.props;
    }
    /**
     * Implementation of the add-on contract deploy method.
    */
    deploy(clusterInfo) {
        var _a, _b, _c, _d;
        const cluster = clusterInfo.cluster;
        const props = this.options;
        // Create S3 bucket if no existing bucket, create s3 bucket and corresponding KMS key
        const s3Bucket = this.getOrCreateS3Bucket(clusterInfo, "backup-bucket", props.values.configuration.backupStorageLocation.bucket);
        // Create Namespace if namespace is not explicied defined.
        const veleroNamespace = this.createNamespaceIfNeeded(clusterInfo, "velero", props.namespace, props.createNamespace);
        // Setup IAM Role for Service Accounts (IRSA) for the Velero Service Account    
        const veleroServiceAccount = this.createServiceAccountWithIamRoles(clusterInfo, "velero-account", veleroNamespace.name, s3Bucket);
        // if veleroName space does not exist and needs creation, add the dependency
        if (veleroNamespace.manifest) {
            veleroServiceAccount.node.addDependency(veleroNamespace.manifest);
        }
        // Setup the values for the helm chart
        const valueVariable = {
            values: {
                configuration: {
                    backupStorageLocation: {
                        prefix: (_a = props.values.configuration.backupStorageLocation.prefix) !== null && _a !== void 0 ? _a : "velero/" + cluster.clusterName,
                        bucket: s3Bucket.bucketName,
                        config: {
                            region: (_b = props.values.configuration.backupStorageLocation.config.region) !== null && _b !== void 0 ? _b : cluster.stack.region,
                        }
                    },
                    volumeSnapshotLocation: {
                        config: {
                            region: (_c = props.values.configuration.backupStorageLocation.config.region) !== null && _c !== void 0 ? _c : cluster.stack.region
                        }
                    }
                },
                // IAM role for Service Account
                serviceAccount: {
                    server: {
                        create: false,
                        name: veleroServiceAccount.serviceAccountName,
                    }
                }
            }
        };
        const values = (_d = (0, ts_deepmerge_1.merge)(props.values, valueVariable.values)) !== null && _d !== void 0 ? _d : {};
        const chartNode = this.addHelmChart(clusterInfo, values);
        chartNode.node.addDependency(veleroServiceAccount);
        return Promise.resolve(chartNode);
    }
    /**
     * Return S3 Bucket
     * @param clusterInfo
     * @param id S3-Bucket-Postfix
     * @param existingBucketName exiting provided S3 BucketName if it exists
     * @returns the existing provided S3 bucket  or the newly created S3 bucket as s3.IBucket
     */
    getOrCreateS3Bucket(clusterInfo, id, existingBucketName) {
        if (!existingBucketName) {
            const bucket = new s3.Bucket(clusterInfo.cluster, "velero-${id}", {
                encryption: s3.BucketEncryption.KMS_MANAGED, // Velero Known bug for support with S3 with SSE-KMS with CMK, thus it does not support S3 Bucket Key: https://github.com/vmware-tanzu/helm-charts/issues/83
                blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL, // Block Public Access for S3
                publicReadAccess: false,
                enforceSSL: true // Encryption in Transit
            });
            return s3.Bucket.fromBucketName(clusterInfo.cluster, 'getOrCreateS3Bucket', bucket.bucketName);
        }
        else {
            return s3.Bucket.fromBucketName(clusterInfo.cluster, 'getOrCreateS3Bucket', existingBucketName);
        }
    }
    /**
     * Return Velero Namespace where Velero will be installed onto
     * @param clusterInfo
     * @param defaultName the Default Namespace for Velero if nothing specified
     * @param namespace
     * @returns the namespace created or existed.
     */
    createNamespaceIfNeeded(clusterInfo, defaultName, namespace, create) {
        // Create Namespace if namespace is not explicied defined.
        if (namespace) {
            // Create Namespace if the "create" option is true
            if (create) {
                const namespaceManifest = (0, utils_1.createNamespace)(namespace, clusterInfo.cluster);
                return { name: namespace, manifest: namespaceManifest };
            }
            // If the "create" option if false, then namespace will not be created, return namespace.name
            else {
                return { name: namespace };
            }
        }
        else {
            return { name: defaultName }; // initial value of veleroNamespace
        }
    }
    /**
     * Return Velero Namespace where Velero will be installed onto
     * @param clusterInfo
     * @param id
     * @param namespace Velero namespace name
     * @param s3BucketName the S3 BucketName where Velero will stores the backup onto
     * @returns the service Account
     */
    createServiceAccountWithIamRoles(clusterInfo, id, namespace, s3Bucket) {
        // Setup IAM Role for Service Accounts (IRSA) for the Velero Service Account
        const veleroServiceAccount = clusterInfo.cluster.addServiceAccount(id, {
            name: id,
            namespace: namespace
        });
        // IAM policy for Velero
        const veleroPolicyDocument = {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Action": [
                        "ec2:DescribeVolumes",
                        "ec2:DescribeSnapshots",
                        "ec2:CreateTags",
                        "ec2:CreateVolume",
                        "ec2:CreateSnapshot",
                        "ec2:DeleteSnapshot"
                    ],
                    "Resource": "*"
                },
                {
                    "Effect": "Allow",
                    "Action": [
                        "s3:GetObject",
                        "s3:DeleteObject",
                        "s3:PutObject",
                        "s3:AbortMultipartUpload",
                        "s3:ListMultipartUploadParts",
                        "s3:ListBucket"
                    ],
                    "Resource": [
                        s3Bucket.arnForObjects("*"),
                        s3Bucket.bucketArn
                    ]
                }
            ]
        };
        const veleroCustomPolicyDocument = iam.PolicyDocument.fromJson(veleroPolicyDocument);
        const veleroPolicy = new iam.ManagedPolicy(clusterInfo.cluster, "velero-managed-policy", {
            document: veleroCustomPolicyDocument
        });
        veleroServiceAccount.role.addManagedPolicy(veleroPolicy);
        return veleroServiceAccount;
    }
};
exports.VeleroAddOn = VeleroAddOn;
exports.VeleroAddOn = VeleroAddOn = __decorate([
    utils_1.supportsALL
], VeleroAddOn);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL3ZlbGVyby9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFDQSwyQ0FBMkM7QUFDM0MseUNBQXlDO0FBRXpDLCtDQUFxQztBQUVyQyx1Q0FBMkQ7QUFDM0QsOENBQThEO0FBUzlEOztHQUVHO0FBQ0gsTUFBTSxZQUFZLEdBQUc7SUFDakIsSUFBSSxFQUFFLFFBQVE7SUFDZCxPQUFPLEVBQUUsT0FBTztJQUNoQixTQUFTLEVBQUUsUUFBUTtJQUNuQixlQUFlLEVBQUUsSUFBSTtJQUNyQixLQUFLLEVBQUUsUUFBUTtJQUNmLFVBQVUsRUFBRSw2Q0FBNkM7SUFDekQsT0FBTyxFQUFFLHlCQUF5QjtJQUNsQyxNQUFNLEVBQUM7UUFDSCxjQUFjLEVBQUM7WUFDWDtnQkFDSSxJQUFJLEVBQUUsdUJBQXVCO2dCQUM3QixLQUFLLEVBQUUscUNBQXFDO2dCQUM1QyxlQUFlLEVBQUUsY0FBYztnQkFDL0IsWUFBWSxFQUFDO29CQUNUO3dCQUNJLFNBQVMsRUFBRSxTQUFTO3dCQUNwQixJQUFJLEVBQUUsU0FBUztxQkFDbEI7aUJBQ0o7YUFDSjtTQUNKO1FBQ0QsYUFBYSxFQUFFO1lBQ1gsUUFBUSxFQUFFLEtBQUs7WUFDZixxQkFBcUIsRUFBQztnQkFDbEIsSUFBSSxFQUFFLFNBQVM7Z0JBQ2YsTUFBTSxFQUFDLEVBQUU7YUFDWjtZQUNELHNCQUFzQixFQUFDO2dCQUNuQixJQUFJLEVBQUUsU0FBUztnQkFDZixNQUFNLEVBQUMsRUFBRTthQUNaO1NBQ0o7UUFDRCxjQUFjLEVBQUU7WUFDWixNQUFNLEVBQUMsRUFBRTtTQUNaO0tBQ0o7Q0FDSixDQUFDO0FBR0ssSUFBTSxXQUFXLEdBQWpCLE1BQU0sV0FBWSxTQUFRLHNCQUFTO0lBSXRDLFlBQVksS0FBd0I7UUFDaEMsS0FBSyxDQUFDLElBQUEsb0JBQUssRUFBQyxZQUFZLEVBQUUsS0FBSyxh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QUFvQixDQUFDO0lBQ2hDLENBQUM7Q0FDSixDQUFBO0FBMUtZLGtDQUFXO3NCQUFYLFdBQVc7SUFEdkIsbUJBQVc7R0FDQyxXQUFXLENBMEt2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNlcnZpY2VBY2NvdW50IH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1la3NcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0ICogYXMgczMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zM1wiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IG1lcmdlIH0gZnJvbSBcInRzLWRlZXBtZXJnZVwiO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8gfSBmcm9tIFwiLi4vLi4vc3BpXCI7XG5pbXBvcnQgeyBjcmVhdGVOYW1lc3BhY2UsIHN1cHBvcnRzQUxMIH0gZnJvbSBcIi4uLy4uL3V0aWxzXCI7XG5pbXBvcnQgeyBIZWxtQWRkT24sIEhlbG1BZGRPblVzZXJQcm9wcyB9IGZyb20gXCIuLi9oZWxtLWFkZG9uXCI7XG5cbi8qKlxuICogQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgYWRkLW9uLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIFZlbGVyb0FkZE9uUHJvcHMgZXh0ZW5kcyBIZWxtQWRkT25Vc2VyUHJvcHMgeyAgICBcbiAgICBjcmVhdGVOYW1lc3BhY2U6IGJvb2xlYW47XG59XG5cbi8qKlxuICogRGVmYXVsdHMgb3B0aW9ucyBmb3IgdGhlIGFkZC1vblxuICovXG5jb25zdCBkZWZhdWx0UHJvcHMgPSB7XG4gICAgbmFtZTogJ3ZlbGVybycsXG4gICAgdmVyc2lvbjogXCIzLjIuMFwiLFxuICAgIG5hbWVzcGFjZTogXCJ2ZWxlcm9cIixcbiAgICBjcmVhdGVOYW1lc3BhY2U6IHRydWUsXG4gICAgY2hhcnQ6IFwidmVsZXJvXCIsXG4gICAgcmVwb3NpdG9yeTogXCJodHRwczovL3Ztd2FyZS10YW56dS5naXRodWIuaW8vaGVsbS1jaGFydHMvXCIsXG4gICAgcmVsZWFzZTogXCJibHVlcHJpbnRzLWFkZG9uLXZlbGVyb1wiLFxuICAgIHZhbHVlczp7XG4gICAgICAgIGluaXRDb250YWluZXJzOltcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiBcInZlbGVyby1wbHVnaW4tZm9yLWF3c1wiLFxuICAgICAgICAgICAgICAgIGltYWdlOiBcInZlbGVyby92ZWxlcm8tcGx1Z2luLWZvci1hd3M6djEuMi4wXCIsXG4gICAgICAgICAgICAgICAgaW1hZ2VQdWxsUG9saWN5OiBcIklmTm90UHJlc2VudFwiLFxuICAgICAgICAgICAgICAgIHZvbHVtZU1vdW50czpbXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vdW50UGF0aDogXCIvdGFyZ2V0XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBcInBsdWdpbnNcIlxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfVxuICAgICAgICBdLFxuICAgICAgICBjb25maWd1cmF0aW9uOiB7XG4gICAgICAgICAgICBwcm92aWRlcjogXCJhd3NcIixcbiAgICAgICAgICAgIGJhY2t1cFN0b3JhZ2VMb2NhdGlvbjp7XG4gICAgICAgICAgICAgICAgbmFtZTogXCJkZWZhdWx0XCIsXG4gICAgICAgICAgICAgICAgY29uZmlnOnt9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdm9sdW1lU25hcHNob3RMb2NhdGlvbjp7XG4gICAgICAgICAgICAgICAgbmFtZTogXCJkZWZhdWx0XCIsXG4gICAgICAgICAgICAgICAgY29uZmlnOnt9XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBzZXJ2aWNlQWNjb3VudDoge1xuICAgICAgICAgICAgc2VydmVyOnt9XG4gICAgICAgIH1cbiAgICB9LFxufTtcblxuQHN1cHBvcnRzQUxMXG5leHBvcnQgY2xhc3MgVmVsZXJvQWRkT24gZXh0ZW5kcyBIZWxtQWRkT24ge1xuXG4gICAgcHJpdmF0ZSBvcHRpb25zOiBSZXF1aXJlZDxWZWxlcm9BZGRPblByb3BzPjtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzPzogVmVsZXJvQWRkT25Qcm9wcykge1xuICAgICAgICBzdXBlcihtZXJnZShkZWZhdWx0UHJvcHMsIHByb3BzID8/IHt9KSk7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHRoaXMucHJvcHMgYXMgUmVxdWlyZWQ8VmVsZXJvQWRkT25Qcm9wcz47XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW1wbGVtZW50YXRpb24gb2YgdGhlIGFkZC1vbiBjb250cmFjdCBkZXBsb3kgbWV0aG9kLlxuICAgICovXG4gICAgZGVwbG95KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IFByb21pc2U8Q29uc3RydWN0PiB7XG4gICAgICAgIGNvbnN0IGNsdXN0ZXIgPSBjbHVzdGVySW5mby5jbHVzdGVyO1xuICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMub3B0aW9ucztcbiAgICAgICAgICAgICAgIFxuICAgICAgICAvLyBDcmVhdGUgUzMgYnVja2V0IGlmIG5vIGV4aXN0aW5nIGJ1Y2tldCwgY3JlYXRlIHMzIGJ1Y2tldCBhbmQgY29ycmVzcG9uZGluZyBLTVMga2V5XG4gICAgICAgIGNvbnN0IHMzQnVja2V0ID0gdGhpcy5nZXRPckNyZWF0ZVMzQnVja2V0KGNsdXN0ZXJJbmZvLCBcImJhY2t1cC1idWNrZXRcIiwgcHJvcHMudmFsdWVzLmNvbmZpZ3VyYXRpb24uYmFja3VwU3RvcmFnZUxvY2F0aW9uLmJ1Y2tldCk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIE5hbWVzcGFjZSBpZiBuYW1lc3BhY2UgaXMgbm90IGV4cGxpY2llZCBkZWZpbmVkLlxuICAgICAgICBjb25zdCB2ZWxlcm9OYW1lc3BhY2UgPSB0aGlzLmNyZWF0ZU5hbWVzcGFjZUlmTmVlZGVkKGNsdXN0ZXJJbmZvLCBcInZlbGVyb1wiLCBwcm9wcy5uYW1lc3BhY2UsIHByb3BzLmNyZWF0ZU5hbWVzcGFjZSk7XG5cbiAgICAgICAgLy8gU2V0dXAgSUFNIFJvbGUgZm9yIFNlcnZpY2UgQWNjb3VudHMgKElSU0EpIGZvciB0aGUgVmVsZXJvIFNlcnZpY2UgQWNjb3VudCAgICBcbiAgICAgICAgY29uc3QgdmVsZXJvU2VydmljZUFjY291bnQgPSB0aGlzLmNyZWF0ZVNlcnZpY2VBY2NvdW50V2l0aElhbVJvbGVzKGNsdXN0ZXJJbmZvLCBcInZlbGVyby1hY2NvdW50XCIsIHZlbGVyb05hbWVzcGFjZS5uYW1lLCBzM0J1Y2tldCk7XG4gICAgICAgIFxuICAgICAgICAvLyBpZiB2ZWxlcm9OYW1lIHNwYWNlIGRvZXMgbm90IGV4aXN0IGFuZCBuZWVkcyBjcmVhdGlvbiwgYWRkIHRoZSBkZXBlbmRlbmN5XG4gICAgICAgIGlmICh2ZWxlcm9OYW1lc3BhY2UubWFuaWZlc3QpIHtcbiAgICAgICAgICAgIHZlbGVyb1NlcnZpY2VBY2NvdW50Lm5vZGUuYWRkRGVwZW5kZW5jeSh2ZWxlcm9OYW1lc3BhY2UubWFuaWZlc3QpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBTZXR1cCB0aGUgdmFsdWVzIGZvciB0aGUgaGVsbSBjaGFydFxuICAgICAgICBjb25zdCB2YWx1ZVZhcmlhYmxlID0ge1xuICAgICAgICAgICAgdmFsdWVzOiB7XG4gICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbjoge1xuICAgICAgICAgICAgICAgICAgICBiYWNrdXBTdG9yYWdlTG9jYXRpb246IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeDogcHJvcHMudmFsdWVzIS5jb25maWd1cmF0aW9uLmJhY2t1cFN0b3JhZ2VMb2NhdGlvbi5wcmVmaXggPz8gXCJ2ZWxlcm8vXCIgKyBjbHVzdGVyLmNsdXN0ZXJOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgYnVja2V0OiBzM0J1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnOntcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2lvbjogcHJvcHMudmFsdWVzIS5jb25maWd1cmF0aW9uLmJhY2t1cFN0b3JhZ2VMb2NhdGlvbi5jb25maWcucmVnaW9uID8/IGNsdXN0ZXIuc3RhY2sucmVnaW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB2b2x1bWVTbmFwc2hvdExvY2F0aW9uOntcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZzp7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVnaW9uOiBwcm9wcy52YWx1ZXMhLmNvbmZpZ3VyYXRpb24uYmFja3VwU3RvcmFnZUxvY2F0aW9uLmNvbmZpZy5yZWdpb24gPz8gY2x1c3Rlci5zdGFjay5yZWdpb25cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgLy8gSUFNIHJvbGUgZm9yIFNlcnZpY2UgQWNjb3VudFxuICAgICAgICAgICAgICAgIHNlcnZpY2VBY2NvdW50OiB7XG4gICAgICAgICAgICAgICAgICAgIHNlcnZlcjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHZlbGVyb1NlcnZpY2VBY2NvdW50LnNlcnZpY2VBY2NvdW50TmFtZSwgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IG1lcmdlKHByb3BzLnZhbHVlcyEsIHZhbHVlVmFyaWFibGUudmFsdWVzKSA/PyB7fTsgXG4gXG4gICAgICAgIGNvbnN0IGNoYXJ0Tm9kZSA9IHRoaXMuYWRkSGVsbUNoYXJ0KGNsdXN0ZXJJbmZvLCB2YWx1ZXMpO1xuICAgICAgICBjaGFydE5vZGUubm9kZS5hZGREZXBlbmRlbmN5KHZlbGVyb1NlcnZpY2VBY2NvdW50KTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjaGFydE5vZGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBTMyBCdWNrZXRcbiAgICAgKiBAcGFyYW0gY2x1c3RlckluZm8gXG4gICAgICogQHBhcmFtIGlkIFMzLUJ1Y2tldC1Qb3N0Zml4IFxuICAgICAqIEBwYXJhbSBleGlzdGluZ0J1Y2tldE5hbWUgZXhpdGluZyBwcm92aWRlZCBTMyBCdWNrZXROYW1lIGlmIGl0IGV4aXN0cyBcbiAgICAgKiBAcmV0dXJucyB0aGUgZXhpc3RpbmcgcHJvdmlkZWQgUzMgYnVja2V0ICBvciB0aGUgbmV3bHkgY3JlYXRlZCBTMyBidWNrZXQgYXMgczMuSUJ1Y2tldFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBnZXRPckNyZWF0ZVMzQnVja2V0KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgaWQ6IHN0cmluZywgZXhpc3RpbmdCdWNrZXROYW1lOiBudWxsfHN0cmluZyApOiBzMy5JQnVja2V0IHtcbiAgICAgICAgaWYgKCFleGlzdGluZ0J1Y2tldE5hbWUpe1xuICAgICAgICAgICAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldChjbHVzdGVySW5mby5jbHVzdGVyLCBcInZlbGVyby0ke2lkfVwiLCB7XG4gICAgICAgICAgICAgICAgZW5jcnlwdGlvbjogczMuQnVja2V0RW5jcnlwdGlvbi5LTVNfTUFOQUdFRCwgLy8gVmVsZXJvIEtub3duIGJ1ZyBmb3Igc3VwcG9ydCB3aXRoIFMzIHdpdGggU1NFLUtNUyB3aXRoIENNSywgdGh1cyBpdCBkb2VzIG5vdCBzdXBwb3J0IFMzIEJ1Y2tldCBLZXk6IGh0dHBzOi8vZ2l0aHViLmNvbS92bXdhcmUtdGFuenUvaGVsbS1jaGFydHMvaXNzdWVzLzgzXG4gICAgICAgICAgICAgICAgYmxvY2tQdWJsaWNBY2Nlc3M6IHMzLkJsb2NrUHVibGljQWNjZXNzLkJMT0NLX0FMTCwgLy8gQmxvY2sgUHVibGljIEFjY2VzcyBmb3IgUzNcbiAgICAgICAgICAgICAgICBwdWJsaWNSZWFkQWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBlbmZvcmNlU1NMOiB0cnVlIC8vIEVuY3J5cHRpb24gaW4gVHJhbnNpdFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gczMuQnVja2V0LmZyb21CdWNrZXROYW1lKGNsdXN0ZXJJbmZvLmNsdXN0ZXIsICdnZXRPckNyZWF0ZVMzQnVja2V0JywgYnVja2V0LmJ1Y2tldE5hbWUgKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBzMy5CdWNrZXQuZnJvbUJ1Y2tldE5hbWUoY2x1c3RlckluZm8uY2x1c3RlciwgJ2dldE9yQ3JlYXRlUzNCdWNrZXQnLCBleGlzdGluZ0J1Y2tldE5hbWUgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBWZWxlcm8gTmFtZXNwYWNlIHdoZXJlIFZlbGVybyB3aWxsIGJlIGluc3RhbGxlZCBvbnRvXG4gICAgICogQHBhcmFtIGNsdXN0ZXJJbmZvXG4gICAgICogQHBhcmFtIGRlZmF1bHROYW1lIHRoZSBEZWZhdWx0IE5hbWVzcGFjZSBmb3IgVmVsZXJvIGlmIG5vdGhpbmcgc3BlY2lmaWVkIFxuICAgICAqIEBwYXJhbSBuYW1lc3BhY2VcbiAgICAgKiBAcmV0dXJucyB0aGUgbmFtZXNwYWNlIGNyZWF0ZWQgb3IgZXhpc3RlZC5cbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgY3JlYXRlTmFtZXNwYWNlSWZOZWVkZWQoY2x1c3RlckluZm86IENsdXN0ZXJJbmZvLCBkZWZhdWx0TmFtZTogc3RyaW5nLCBuYW1lc3BhY2U6IHN0cmluZywgY3JlYXRlOiBib29sZWFuKToge25hbWU6IHN0cmluZywgbWFuaWZlc3Q/OiBDb25zdHJ1Y3R9IHtcbiAgICAgICAgLy8gQ3JlYXRlIE5hbWVzcGFjZSBpZiBuYW1lc3BhY2UgaXMgbm90IGV4cGxpY2llZCBkZWZpbmVkLlxuICAgICAgICBpZiAobmFtZXNwYWNlKXtcbiAgICAgICAgICAgIC8vIENyZWF0ZSBOYW1lc3BhY2UgaWYgdGhlIFwiY3JlYXRlXCIgb3B0aW9uIGlzIHRydWVcbiAgICAgICAgICAgIGlmIChjcmVhdGUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuYW1lc3BhY2VNYW5pZmVzdCA9IGNyZWF0ZU5hbWVzcGFjZShuYW1lc3BhY2UsIGNsdXN0ZXJJbmZvLmNsdXN0ZXIpO1xuICAgICAgICAgICAgICAgIHJldHVybiB7IG5hbWU6IG5hbWVzcGFjZSwgbWFuaWZlc3Q6IG5hbWVzcGFjZU1hbmlmZXN0IH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBJZiB0aGUgXCJjcmVhdGVcIiBvcHRpb24gaWYgZmFsc2UsIHRoZW4gbmFtZXNwYWNlIHdpbGwgbm90IGJlIGNyZWF0ZWQsIHJldHVybiBuYW1lc3BhY2UubmFtZVxuICAgICAgICAgICAgZWxzZXtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBuYW1lOiBuYW1lc3BhY2UgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNle1xuICAgICAgICAgICAgcmV0dXJuIHsgbmFtZTogZGVmYXVsdE5hbWUgfTsgLy8gaW5pdGlhbCB2YWx1ZSBvZiB2ZWxlcm9OYW1lc3BhY2VcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBWZWxlcm8gTmFtZXNwYWNlIHdoZXJlIFZlbGVybyB3aWxsIGJlIGluc3RhbGxlZCBvbnRvXG4gICAgICogQHBhcmFtIGNsdXN0ZXJJbmZvXG4gICAgICogQHBhcmFtIGlkXG4gICAgICogQHBhcmFtIG5hbWVzcGFjZSBWZWxlcm8gbmFtZXNwYWNlIG5hbWVcbiAgICAgKiBAcGFyYW0gczNCdWNrZXROYW1lIHRoZSBTMyBCdWNrZXROYW1lIHdoZXJlIFZlbGVybyB3aWxsIHN0b3JlcyB0aGUgYmFja3VwIG9udG9cbiAgICAgKiBAcmV0dXJucyB0aGUgc2VydmljZSBBY2NvdW50XG4gICAgICovXG4gICAgcHJvdGVjdGVkIGNyZWF0ZVNlcnZpY2VBY2NvdW50V2l0aElhbVJvbGVzKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgaWQ6IHN0cmluZywgbmFtZXNwYWNlOiBzdHJpbmcsIHMzQnVja2V0OiBzMy5JQnVja2V0KTogU2VydmljZUFjY291bnQge1xuICAgICAgICAvLyBTZXR1cCBJQU0gUm9sZSBmb3IgU2VydmljZSBBY2NvdW50cyAoSVJTQSkgZm9yIHRoZSBWZWxlcm8gU2VydmljZSBBY2NvdW50XG4gICAgICAgIGNvbnN0IHZlbGVyb1NlcnZpY2VBY2NvdW50ID0gY2x1c3RlckluZm8uY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCAoXG4gICAgICAgICAgICBpZCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiBpZCxcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZVxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIC8vIElBTSBwb2xpY3kgZm9yIFZlbGVyb1xuICAgICAgICBjb25zdCB2ZWxlcm9Qb2xpY3lEb2N1bWVudCA9IHtcbiAgICAgICAgICAgIFwiVmVyc2lvblwiOiBcIjIwMTItMTAtMTdcIixcbiAgICAgICAgICAgIFwiU3RhdGVtZW50XCI6IFtcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgXCJFZmZlY3RcIjogXCJBbGxvd1wiLFxuICAgICAgICAgICAgICAgICAgXCJBY3Rpb25cIjogW1xuICAgICAgICAgICAgICAgICAgICAgIFwiZWMyOkRlc2NyaWJlVm9sdW1lc1wiLFxuICAgICAgICAgICAgICAgICAgICAgIFwiZWMyOkRlc2NyaWJlU25hcHNob3RzXCIsXG4gICAgICAgICAgICAgICAgICAgICAgXCJlYzI6Q3JlYXRlVGFnc1wiLFxuICAgICAgICAgICAgICAgICAgICAgIFwiZWMyOkNyZWF0ZVZvbHVtZVwiLFxuICAgICAgICAgICAgICAgICAgICAgIFwiZWMyOkNyZWF0ZVNuYXBzaG90XCIsXG4gICAgICAgICAgICAgICAgICAgICAgXCJlYzI6RGVsZXRlU25hcHNob3RcIlxuICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgIFwiUmVzb3VyY2VcIjogXCIqXCJcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIFwiRWZmZWN0XCI6IFwiQWxsb3dcIixcbiAgICAgICAgICAgICAgICBcIkFjdGlvblwiOiBbXG4gICAgICAgICAgICAgICAgICAgIFwiczM6R2V0T2JqZWN0XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiczM6RGVsZXRlT2JqZWN0XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiczM6UHV0T2JqZWN0XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiczM6QWJvcnRNdWx0aXBhcnRVcGxvYWRcIixcbiAgICAgICAgICAgICAgICAgICAgXCJzMzpMaXN0TXVsdGlwYXJ0VXBsb2FkUGFydHNcIixcbiAgICAgICAgICAgICAgICAgICAgXCJzMzpMaXN0QnVja2V0XCJcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIFwiUmVzb3VyY2VcIjogW1xuICAgICAgICAgICAgICAgICAgICBzM0J1Y2tldC5hcm5Gb3JPYmplY3RzKFwiKlwiKSxcbiAgICAgICAgICAgICAgICAgICAgczNCdWNrZXQuYnVja2V0QXJuICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXVxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHZlbGVyb0N1c3RvbVBvbGljeURvY3VtZW50ID0gaWFtLlBvbGljeURvY3VtZW50LmZyb21Kc29uKHZlbGVyb1BvbGljeURvY3VtZW50KTtcbiAgICAgICAgY29uc3QgdmVsZXJvUG9saWN5ID0gbmV3IGlhbS5NYW5hZ2VkUG9saWN5KGNsdXN0ZXJJbmZvLmNsdXN0ZXIsIFwidmVsZXJvLW1hbmFnZWQtcG9saWN5XCIsIHtcbiAgICAgICAgICAgIGRvY3VtZW50OiB2ZWxlcm9DdXN0b21Qb2xpY3lEb2N1bWVudFxuICAgICAgICB9KTtcbiAgICAgICAgdmVsZXJvU2VydmljZUFjY291bnQucm9sZS5hZGRNYW5hZ2VkUG9saWN5KHZlbGVyb1BvbGljeSk7XG4gICAgICAgIHJldHVybiB2ZWxlcm9TZXJ2aWNlQWNjb3VudDtcbiAgICB9XG59Il19