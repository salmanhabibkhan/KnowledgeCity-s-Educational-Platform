"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GenericClusterProviderV2 = exports.ClusterBuilderV2 = exports.defaultOptionsv2 = exports.GenericClusterPropsV2Constraints = exports.ComputeConfigConstraints = void 0;
exports.clusterBuilderv2 = clusterBuilderv2;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const autoscaling = require("aws-cdk-lib/aws-autoscaling");
const ec2 = require("aws-cdk-lib/aws-ec2");
const eks = require("@aws-cdk/aws-eks-v2-alpha");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const spi_1 = require("../spi");
const utils = require("../utils");
const constants = require("./constants");
const assert = require("assert");
const generic_cluster_provider_1 = require("./generic-cluster-provider");
function clusterBuilderv2() {
    return new ClusterBuilderV2();
}
class ComputeConfigConstraints {
    constructor() {
        this.nodePools = new utils.ArrayConstraint(0, 2);
    }
}
exports.ComputeConfigConstraints = ComputeConfigConstraints;
class GenericClusterPropsV2Constraints {
    constructor() {
        /**
        * managedNodeGroups per cluster have a soft limit of 30 managed node groups per EKS cluster, and as little as 0. But we multiply that
        * by a factor of 5 to 150 in case of situations of a hard limit request being accepted, and as a result the limit would be raised.
        * https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html
        */
        this.managedNodeGroups = new utils.ArrayConstraint(0, 150);
        /**
        * autoscalingNodeGroups per cluster have a soft limit of 500 autoscaling node groups per EKS cluster, and as little as 0. But we multiply that
        * by a factor of 5 to 2500 in case of situations of a hard limit request being accepted, and as a result the limit would be raised.
        * https://docs.aws.amazon.com/autoscaling/ec2/userguide/ec2-auto-scaling-quotas.html
        */
        this.autoscalingNodeGroups = new utils.ArrayConstraint(0, 5000);
    }
}
exports.GenericClusterPropsV2Constraints = GenericClusterPropsV2Constraints;
exports.defaultOptionsv2 = {};
class ClusterBuilderV2 {
    constructor() {
        this.props = {};
        this.privateCluster = false;
        this.managedNodeGroups = [];
        this.autoscalingNodeGroups = [];
        this.fargateProfiles = {};
        this.props = { ...this.props };
    }
    withCommonOptions(options) {
        this.props = { ...this.props, ...options };
        return this;
    }
    managedNodeGroup(...nodeGroups) {
        this.managedNodeGroups = this.managedNodeGroups.concat(nodeGroups);
        return this;
    }
    autoscalingGroup(...nodeGroups) {
        this.autoscalingNodeGroups = this.autoscalingNodeGroups.concat(nodeGroups);
        return this;
    }
    computeConfig(config) {
        this.compute = config;
        return this;
    }
    fargateProfile(name, options) {
        this.fargateProfiles[name] = options;
        return this;
    }
    version(version) {
        this.props = { ...this.props, version };
        return this;
    }
    build() {
        return new GenericClusterProviderV2({
            ...this.props,
            privateCluster: this.privateCluster,
            managedNodeGroups: this.managedNodeGroups,
            autoscalingNodeGroups: this.autoscalingNodeGroups,
            compute: this.compute,
            fargateProfiles: this.fargateProfiles
        });
    }
}
exports.ClusterBuilderV2 = ClusterBuilderV2;
/**
 * Cluster provider implementation that supports multiple node groups.
 */
class GenericClusterProviderV2 {
    constructor(props) {
        this.props = props;
        this.validateInput(props);
        const computeTypesEnabled = [
            props.managedNodeGroups && props.managedNodeGroups.length > 0,
            props.autoscalingNodeGroups && props.autoscalingNodeGroups.length > 0,
            props.compute != undefined
        ].filter(Boolean).length;
        // Assert that only one compute type is enabled
        assert(computeTypesEnabled <= 1, 'Only one compute type can be enabled: managed node groups, autoscaling node groups, or automode configuration.  Mixing these is not supported. Please file a request on GitHub to add this support if needed.');
    }
    /**
     * @override
     */
    createCluster(scope, vpc, secretsEncryptionKey, kubernetesVersion, clusterLogging, ipFamily) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k;
        const id = scope.node.id;
        // Props for the cluster.
        const clusterName = (_a = this.props.clusterName) !== null && _a !== void 0 ? _a : id;
        if (!kubernetesVersion && !this.props.version) {
            throw new Error("Version was not specified by cluster builder or in cluster provider props, must be specified in one of these");
        }
        const version = kubernetesVersion || this.props.version || eks.KubernetesVersion.V1_30;
        let privateCluster = (_b = this.props.privateCluster) !== null && _b !== void 0 ? _b : utils.valueFromContext(scope, constants.PRIVATE_CLUSTER, false);
        privateCluster = privateCluster ? privateCluster === 'true' : false;
        let isolatedCluster = (_c = this.props.isolatedCluster) !== null && _c !== void 0 ? _c : utils.valueFromContext(scope, constants.ISOLATED_CLUSTER, false);
        isolatedCluster = isolatedCluster ? isolatedCluster === 'true' : false;
        const endpointAccess = (privateCluster === true) ? eks.EndpointAccess.PRIVATE : eks.EndpointAccess.PUBLIC_AND_PRIVATE;
        const vpcSubnets = (_d = this.props.vpcSubnets) !== null && _d !== void 0 ? _d : (isolatedCluster === true ? [{ subnetType: ec2.SubnetType.PRIVATE_ISOLATED }] : privateCluster === true ? [{ subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS }] : undefined);
        const mastersRole = (_e = this.props.mastersRole) !== null && _e !== void 0 ? _e : new aws_iam_1.Role(scope, `${clusterName}-AccessRole`, {
            assumedBy: new aws_iam_1.AccountRootPrincipal()
        });
        const kubectlLayer = this.getKubectlLayer(scope, version);
        const kubectlProviderOptions = kubectlLayer && { kubectlLayer };
        const tags = this.props.tags;
        const defaultOptionsv2 = {
            vpc,
            secretsEncryptionKey,
            clusterName,
            clusterLogging,
            version,
            vpcSubnets,
            endpointAccess,
            kubectlProviderOptions,
            tags,
            mastersRole,
            defaultCapacityType: eks.DefaultCapacityType.AUTOMODE
        };
        const clusterOptions = { ...defaultOptionsv2, ...this.props, version, ipFamily };
        // Create an EKS Cluster
        const cluster = this.internalCreateCluster(scope, id, clusterOptions);
        cluster.node.addDependency(vpc);
        const nodeGroups = [];
        (_f = this.props.managedNodeGroups) === null || _f === void 0 ? void 0 : _f.forEach(n => {
            const nodeGroup = this.addManagedNodeGroup(cluster, n);
            nodeGroups.push(nodeGroup);
        });
        const autoscalingGroups = [];
        (_g = this.props.autoscalingNodeGroups) === null || _g === void 0 ? void 0 : _g.forEach(n => {
            const autoscalingGroup = this.addAutoScalingGroup(cluster, n);
            autoscalingGroups.push(autoscalingGroup);
        });
        const autoMode = clusterOptions.defaultCapacityType != undefined && clusterOptions.defaultCapacityType == eks.DefaultCapacityType.AUTOMODE;
        const fargateProfiles = Object.entries((_h = this.props.fargateProfiles) !== null && _h !== void 0 ? _h : {});
        const fargateConstructs = [];
        fargateProfiles === null || fargateProfiles === void 0 ? void 0 : fargateProfiles.forEach(([key, options]) => fargateConstructs.push(this.addFargateProfile(cluster, key, options)));
        const nodePools = Object.entries((_k = (_j = this.props.compute) === null || _j === void 0 ? void 0 : _j.extraNodePools) !== null && _k !== void 0 ? _k : {});
        const nodePoolConstructs = [];
        nodePools.forEach(([key, options]) => nodePoolConstructs.push(this.addNodePool(cluster, key, options)));
        return new spi_1.ClusterInfo(cluster, version, nodeGroups, autoscalingGroups, autoMode, fargateConstructs, cluster, nodeGroups);
    }
    /**
     * Template method that may be overridden by subclasses to create a specific cluster flavor (e.g. FargateCluster vs eks.Cluster)
     * @param scope
     * @param id
     * @param clusterOptions
     * @returns
     */
    internalCreateCluster(scope, id, clusterOptions) {
        return new eks.Cluster(scope, id, clusterOptions);
    }
    /**
     * Can be overridden to provide a custom kubectl layer.
     * @param scope
     * @param version
     * @returns
     */
    getKubectlLayer(scope, version) {
        return (0, generic_cluster_provider_1.selectKubectlLayer)(scope, version);
    }
    /**
     * Adds an autoscaling group to the cluster.
     * @param cluster
     * @param nodeGroup
     * @returns
     */
    addAutoScalingGroup(cluster, nodeGroup) {
        var _a, _b, _c, _d, _e, _f, _g;
        const machineImageType = (_a = nodeGroup.machineImageType) !== null && _a !== void 0 ? _a : eks.MachineImageType.AMAZON_LINUX_2;
        const instanceTypeContext = utils.valueFromContext(cluster, constants.INSTANCE_TYPE_KEY, constants.DEFAULT_INSTANCE_TYPE);
        const instanceType = (_b = nodeGroup.instanceType) !== null && _b !== void 0 ? _b : (typeof instanceTypeContext === 'string' ? new ec2.InstanceType(instanceTypeContext) : instanceTypeContext);
        const minSize = (_c = nodeGroup.minSize) !== null && _c !== void 0 ? _c : utils.valueFromContext(cluster, constants.MIN_SIZE_KEY, constants.DEFAULT_NG_MINSIZE);
        const maxSize = (_d = nodeGroup.maxSize) !== null && _d !== void 0 ? _d : utils.valueFromContext(cluster, constants.MAX_SIZE_KEY, constants.DEFAULT_NG_MAXSIZE);
        const desiredSize = (_e = nodeGroup.desiredSize) !== null && _e !== void 0 ? _e : utils.valueFromContext(cluster, constants.DESIRED_SIZE_KEY, minSize);
        const updatePolicy = (_f = nodeGroup.updatePolicy) !== null && _f !== void 0 ? _f : autoscaling.UpdatePolicy.rollingUpdate();
        // Create an autoscaling group
        return cluster.addAutoScalingGroupCapacity(nodeGroup.id, {
            ...nodeGroup,
            ...{
                autoScalingGroupName: (_g = nodeGroup.autoScalingGroupName) !== null && _g !== void 0 ? _g : nodeGroup.id,
                machineImageType,
                instanceType,
                minCapacity: minSize,
                maxCapacity: maxSize,
                desiredCapacity: desiredSize,
                updatePolicy,
                vpcSubnets: nodeGroup.nodeGroupSubnets,
            }
        });
    }
    /**
     * Adds a fargate profile to the cluster
     */
    addFargateProfile(cluster, name, profileOptions) {
        return cluster.addFargateProfile(name, profileOptions);
    }
    /**
     * Add a node pool to the cluster
     */
    addNodePool(cluster, name, pool) {
        const labels = pool.labels || {};
        const annotations = pool.annotations || {};
        const taints = pool.taints || [];
        const startupTaints = pool.startupTaints || [];
        const requirements = pool.requirements || [];
        const disruption = pool.disruption || null;
        const limits = pool.limits || null;
        const weight = pool.weight || null;
        const poolManifest = {
            apiVersion: "karpenter.sh/v1",
            kind: "NodePool",
            metadata: { name: name },
            spec: {
                template: {
                    metadata: { labels: labels, annotations: annotations },
                    spec: {
                        nodeClassRef: {
                            name: "default",
                            group: "eks.amazonaws.com",
                            kind: "NodeClass"
                        },
                        taints: taints,
                        startupTaints: startupTaints,
                        requirements: utils.convertKeyPair(requirements),
                        expireAfter: pool.expireAfter
                    },
                },
                disruption: disruption,
                limits: limits,
                weight: weight,
            },
        };
        return cluster.addManifest(name, poolManifest);
    }
    /**
     * Adds a managed node group to the cluster.
     * @param cluster
     * @param nodeGroup
     * @returns
     */
    addManagedNodeGroup(cluster, nodeGroup) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l;
        const capacityType = nodeGroup.nodeGroupCapacityType;
        const releaseVersion = nodeGroup.amiReleaseVersion;
        const instanceTypeContext = utils.valueFromContext(cluster, constants.INSTANCE_TYPE_KEY, constants.DEFAULT_INSTANCE_TYPE);
        const instanceTypes = (_a = nodeGroup.instanceTypes) !== null && _a !== void 0 ? _a : ([typeof instanceTypeContext === 'string' ? new ec2.InstanceType(instanceTypeContext) : instanceTypeContext]);
        const minSize = (_b = nodeGroup.minSize) !== null && _b !== void 0 ? _b : utils.valueFromContext(cluster, constants.MIN_SIZE_KEY, constants.DEFAULT_NG_MINSIZE);
        const maxSize = (_c = nodeGroup.maxSize) !== null && _c !== void 0 ? _c : utils.valueFromContext(cluster, constants.MAX_SIZE_KEY, constants.DEFAULT_NG_MAXSIZE);
        const desiredSize = (_d = nodeGroup.desiredSize) !== null && _d !== void 0 ? _d : utils.valueFromContext(cluster, constants.DESIRED_SIZE_KEY, minSize);
        // Create a managed node group.
        const nodegroupOptions = {
            ...nodeGroup,
            amiType: nodeGroup.amiType,
            ...{
                nodegroupName: (_e = nodeGroup.nodegroupName) !== null && _e !== void 0 ? _e : nodeGroup.id,
                capacityType,
                instanceTypes,
                minSize,
                maxSize,
                desiredSize,
                releaseVersion,
                subnets: nodeGroup.nodeGroupSubnets
            }
        };
        if (nodeGroup.launchTemplate) {
            // Create launch template with provided launch template properties
            const lt = new ec2.LaunchTemplate(cluster, `${nodeGroup.id}-lt`, {
                blockDevices: nodeGroup.launchTemplate.blockDevices,
                machineImage: (_f = nodeGroup.launchTemplate) === null || _f === void 0 ? void 0 : _f.machineImage,
                securityGroup: nodeGroup.launchTemplate.securityGroup,
                userData: (_g = nodeGroup.launchTemplate) === null || _g === void 0 ? void 0 : _g.userData,
                requireImdsv2: (_h = nodeGroup.launchTemplate) === null || _h === void 0 ? void 0 : _h.requireImdsv2,
                httpPutResponseHopLimit: (_j = nodeGroup.launchTemplate) === null || _j === void 0 ? void 0 : _j.httpPutResponseHopLimit,
            });
            utils.setPath(nodegroupOptions, "launchTemplateSpec", {
                id: lt.launchTemplateId,
                version: lt.latestVersionNumber,
            });
            const tags = Object.entries((_k = nodeGroup.launchTemplate.tags) !== null && _k !== void 0 ? _k : {});
            tags.forEach(([key, options]) => aws_cdk_lib_1.Tags.of(lt).add(key, options));
            if ((_l = nodeGroup.launchTemplate) === null || _l === void 0 ? void 0 : _l.machineImage) {
                delete nodegroupOptions.amiType;
                delete nodegroupOptions.releaseVersion;
                delete nodeGroup.amiReleaseVersion;
            }
        }
        const result = cluster.addNodegroupCapacity(nodeGroup.id + "-ng", nodegroupOptions);
        if (nodeGroup.enableSsmPermissions) {
            result.role.addManagedPolicy(aws_iam_1.ManagedPolicy.fromAwsManagedPolicyName('AmazonSSMManagedInstanceCore'));
        }
        return result;
    }
    validateInput(props) {
        utils.validateConstraints(new GenericClusterPropsV2Constraints, GenericClusterProviderV2.name, props);
        if (props.managedNodeGroups != undefined)
            utils.validateConstraints(new generic_cluster_provider_1.ManagedNodeGroupConstraints, "ManagedNodeGroup", ...props.managedNodeGroups);
        if (props.autoscalingNodeGroups != undefined)
            utils.validateConstraints(new generic_cluster_provider_1.AutoscalingNodeGroupConstraints, "AutoscalingNodeGroups", ...props.autoscalingNodeGroups);
        if (props.compute != undefined)
            utils.validateConstraints(new ComputeConfigConstraints, "ComputeConfigConstraints", props.compute);
        if (props.fargateProfiles != undefined)
            utils.validateConstraints(new generic_cluster_provider_1.FargateProfileConstraints, "FargateProfiles", ...Object.values(props.fargateProfiles));
    }
}
exports.GenericClusterProviderV2 = GenericClusterProviderV2;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJpYy1jbHVzdGVyLXByb3ZpZGVyLXYyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2NsdXN0ZXItcHJvdmlkZXJzL2dlbmVyaWMtY2x1c3Rlci1wcm92aWRlci12Mi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFpQkEsNENBRUM7QUFuQkQsNkNBQW1DO0FBQ25DLDJEQUEyRDtBQUMzRCwyQ0FBMkM7QUFDM0MsaURBQWlEO0FBRWpELGlEQUFnRjtBQUloRixnQ0FBc0Q7QUFDdEQsa0NBQWtDO0FBQ2xDLHlDQUF5QztBQUV6QyxpQ0FBa0M7QUFDbEMseUVBQXdKO0FBR3hKLFNBQWdCLGdCQUFnQjtJQUM1QixPQUFPLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztBQUNsQyxDQUFDO0FBNkRELE1BQWEsd0JBQXdCO0lBQXJDO1FBQ0ksY0FBUyxHQUFHLElBQUksS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEQsQ0FBQztDQUFBO0FBRkQsNERBRUM7QUFFRCxNQUFhLGdDQUFnQztJQUE3QztRQUNJOzs7O1VBSUU7UUFDRixzQkFBaUIsR0FBRyxJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3REOzs7O1VBSUU7UUFDRiwwQkFBcUIsR0FBRyxJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQy9ELENBQUM7Q0FBQTtBQWJELDRFQWFDO0FBRVksUUFBQSxnQkFBZ0IsR0FBRyxFQUMvQixDQUFDO0FBRUYsTUFBYSxnQkFBZ0I7SUFXekI7UUFUUSxVQUFLLEdBQTJDLEVBQUUsQ0FBQztRQUNuRCxtQkFBYyxHQUFHLEtBQUssQ0FBQztRQUN2QixzQkFBaUIsR0FBdUIsRUFBRSxDQUFDO1FBQzNDLDBCQUFxQixHQUEyQixFQUFFLENBQUM7UUFFbkQsb0JBQWUsR0FFbkIsRUFBRSxDQUFDO1FBR0gs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QUMscUJBQXFCLElBQUksU0FBUztZQUN4QyxLQUFLLENBQUMsbUJBQW1CLENBQUMsSUFBSSwwREFBK0IsRUFBRSx1QkFBdUIsRUFBRSxHQUFHLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQzVILElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxTQUFTO1lBQzFCLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLHdCQUF3QixFQUFFLDBCQUEwQixFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN2RyxJQUFJLEtBQUssQ0FBQyxlQUFzQixJQUFJLFNBQVM7WUFDekMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUksb0RBQXlCLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFzQixDQUFDLENBQUMsQ0FBQztJQUNwSSxDQUFDO0NBQ0o7QUEzUUQsNERBMlFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGFncyB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgYXV0b3NjYWxpbmcgZnJvbSAnYXdzLWNkay1saWIvYXdzLWF1dG9zY2FsaW5nJztcbmltcG9ydCAqIGFzIGVjMiBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVjMlwiO1xuaW1wb3J0ICogYXMgZWtzIGZyb20gXCJAYXdzLWNkay9hd3MtZWtzLXYyLWFscGhhXCI7XG5pbXBvcnQgKiBhcyBla3N2MSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWtzJztcbmltcG9ydCB7IEFjY291bnRSb290UHJpbmNpcGFsLCBNYW5hZ2VkUG9saWN5LCBSb2xlIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCB7IElLZXkgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWttc1wiO1xuaW1wb3J0IHsgSUxheWVyVmVyc2lvbiB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8sIENsdXN0ZXJQcm92aWRlciB9IGZyb20gXCIuLi9zcGlcIjtcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gXCIuLi91dGlsc1wiO1xuaW1wb3J0ICogYXMgY29uc3RhbnRzIGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCB7IEF1dG9zY2FsaW5nTm9kZUdyb3VwLCBNYW5hZ2VkTm9kZUdyb3VwIH0gZnJvbSBcIi4vdHlwZXNcIjtcbmltcG9ydCBhc3NlcnQgPSByZXF1aXJlKCdhc3NlcnQnKTtcbmltcG9ydCB7IHNlbGVjdEt1YmVjdGxMYXllciwgQXV0b3NjYWxpbmdOb2RlR3JvdXBDb25zdHJhaW50cywgRmFyZ2F0ZVByb2ZpbGVDb25zdHJhaW50cywgTWFuYWdlZE5vZGVHcm91cENvbnN0cmFpbnRzfSBmcm9tIFwiLi9nZW5lcmljLWNsdXN0ZXItcHJvdmlkZXJcIjtcbmltcG9ydCB7IE5vZGVQb29sVjFTcGVjIH0gZnJvbSBcIi4uL2FkZG9ucy9rYXJwZW50ZXIvdHlwZXNcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIGNsdXN0ZXJCdWlsZGVydjIoKSB7XG4gICAgcmV0dXJuIG5ldyBDbHVzdGVyQnVpbGRlclYyKCk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29tcHV0ZUNvbmZpZyBleHRlbmRzIGVrcy5Db21wdXRlQ29uZmlnIHtcbiAgXG4gIC8qKlxuICAgKiBFeHRyYSBub2RlIHBvb2xzIHRvIGJlIGFkZGVkIHRvIHRoZSBBdXRvIE1vZGUgQ2x1c3RlclxuICAgKi9cbiAgZXh0cmFOb2RlUG9vbHM/OiB7XG4gICAgW2tleTogc3RyaW5nXTogTm9kZVBvb2xWMVNwZWM7XG4gIH07XG5cbn1cblxuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIHRoZSBnZW5lcmljIGNsdXN0ZXIgcHJvdmlkZXIsIGNvbnRhaW5pbmcgZGVmaW5pdGlvbnMgb2YgbWFuYWdlZCBub2RlIGdyb3VwcyxcbiAqIGF1dG8tc2NhbGluZyBncm91cHMsIGZhcmdhdGUgcHJvZmlsZXMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgR2VuZXJpY0NsdXN0ZXJQcm92aWRlclYyUHJvcHMgZXh0ZW5kcyBQYXJ0aWFsPGVrcy5DbHVzdGVyUHJvcHM+IHtcblxuICAgIC8qKlxuICAgICAqIFdoZXRoZXIgY2x1c3RlciBoYXMgaW50ZXJuZXQgYWNjZXNzLlxuICAgICAqL1xuICAgIGlzb2xhdGVkQ2x1c3Rlcj86IGJvb2xlYW4sXG5cbiAgICAvKipcbiAgICAgKiBXaGV0aGVyIEFQSSBzZXJ2ZXIgaXMgcHJpdmF0ZS5cbiAgICAgKi9cbiAgICBwcml2YXRlQ2x1c3Rlcj86IGJvb2xlYW4sXG5cbiAgICAvKipcbiAgICAgKiBBcnJheSBvZiBtYW5hZ2VkIG5vZGUgZ3JvdXBzLlxuICAgICAqL1xuICAgIG1hbmFnZWROb2RlR3JvdXBzPzogTWFuYWdlZE5vZGVHcm91cFtdO1xuXG4gICAgLyoqXG4gICAgICogQXJyYXkgb2YgYXV0b3NjYWxpbmcgbm9kZSBncm91cHMuXG4gICAgICovXG4gICAgYXV0b3NjYWxpbmdOb2RlR3JvdXBzPzogQXV0b3NjYWxpbmdOb2RlR3JvdXBbXTtcblxuICAgIC8qKlxuICAgICAqIEVLUyBBdXRvbW9kZSBjb21wdXRlIGNvbmZpZ1xuICAgICAqL1xuICAgIGNvbXB1dGU/OiBDb21wdXRlQ29uZmlnO1xuXG4gICAgLyoqXG4gICAgICogRmFyZ2F0ZSBwcm9maWxlc1xuICAgICAqL1xuICAgIGZhcmdhdGVQcm9maWxlcz86IHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogZWtzLkZhcmdhdGVQcm9maWxlT3B0aW9ucztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUYWdzIGZvciB0aGUgY2x1c3RlclxuICAgICAqL1xuICAgIHRhZ3M/OiB7XG4gICAgICAgIFtrZXk6IHN0cmluZ106IHN0cmluZztcbiAgICB9XG59XG5cblxuZXhwb3J0IGNsYXNzIENvbXB1dGVDb25maWdDb25zdHJhaW50cyBpbXBsZW1lbnRzIHV0aWxzLkNvbnN0cmFpbnRzVHlwZTxDb21wdXRlQ29uZmlnPiB7XG4gICAgbm9kZVBvb2xzID0gbmV3IHV0aWxzLkFycmF5Q29uc3RyYWludCgwLCAyKTtcbn1cblxuZXhwb3J0IGNsYXNzIEdlbmVyaWNDbHVzdGVyUHJvcHNWMkNvbnN0cmFpbnRzIGltcGxlbWVudHMgdXRpbHMuQ29uc3RyYWludHNUeXBlPEdlbmVyaWNDbHVzdGVyUHJvdmlkZXJWMlByb3BzPiB7XG4gICAgLyoqXG4gICAgKiBtYW5hZ2VkTm9kZUdyb3VwcyBwZXIgY2x1c3RlciBoYXZlIGEgc29mdCBsaW1pdCBvZiAzMCBtYW5hZ2VkIG5vZGUgZ3JvdXBzIHBlciBFS1MgY2x1c3RlciwgYW5kIGFzIGxpdHRsZSBhcyAwLiBCdXQgd2UgbXVsdGlwbHkgdGhhdFxuICAgICogYnkgYSBmYWN0b3Igb2YgNSB0byAxNTAgaW4gY2FzZSBvZiBzaXR1YXRpb25zIG9mIGEgaGFyZCBsaW1pdCByZXF1ZXN0IGJlaW5nIGFjY2VwdGVkLCBhbmQgYXMgYSByZXN1bHQgdGhlIGxpbWl0IHdvdWxkIGJlIHJhaXNlZC5cbiAgICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9la3MvbGF0ZXN0L3VzZXJndWlkZS9zZXJ2aWNlLXF1b3Rhcy5odG1sXG4gICAgKi9cbiAgICBtYW5hZ2VkTm9kZUdyb3VwcyA9IG5ldyB1dGlscy5BcnJheUNvbnN0cmFpbnQoMCwgMTUwKTtcbiAgICAvKipcbiAgICAqIGF1dG9zY2FsaW5nTm9kZUdyb3VwcyBwZXIgY2x1c3RlciBoYXZlIGEgc29mdCBsaW1pdCBvZiA1MDAgYXV0b3NjYWxpbmcgbm9kZSBncm91cHMgcGVyIEVLUyBjbHVzdGVyLCBhbmQgYXMgbGl0dGxlIGFzIDAuIEJ1dCB3ZSBtdWx0aXBseSB0aGF0XG4gICAgKiBieSBhIGZhY3RvciBvZiA1IHRvIDI1MDAgaW4gY2FzZSBvZiBzaXR1YXRpb25zIG9mIGEgaGFyZCBsaW1pdCByZXF1ZXN0IGJlaW5nIGFjY2VwdGVkLCBhbmQgYXMgYSByZXN1bHQgdGhlIGxpbWl0IHdvdWxkIGJlIHJhaXNlZC5cbiAgICAqIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9hdXRvc2NhbGluZy9lYzIvdXNlcmd1aWRlL2VjMi1hdXRvLXNjYWxpbmctcXVvdGFzLmh0bWxcbiAgICAqL1xuICAgIGF1dG9zY2FsaW5nTm9kZUdyb3VwcyA9IG5ldyB1dGlscy5BcnJheUNvbnN0cmFpbnQoMCwgNTAwMCk7XG59XG5cbmV4cG9ydCBjb25zdCBkZWZhdWx0T3B0aW9uc3YyID0ge1xufTtcblxuZXhwb3J0IGNsYXNzIENsdXN0ZXJCdWlsZGVyVjIge1xuXG4gICAgcHJpdmF0ZSBwcm9wczogUGFydGlhbDxHZW5lcmljQ2x1c3RlclByb3ZpZGVyVjJQcm9wcz4gPSB7fTtcbiAgICBwcml2YXRlIHByaXZhdGVDbHVzdGVyID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBtYW5hZ2VkTm9kZUdyb3VwczogTWFuYWdlZE5vZGVHcm91cFtdID0gW107XG4gICAgcHJpdmF0ZSBhdXRvc2NhbGluZ05vZGVHcm91cHM6IEF1dG9zY2FsaW5nTm9kZUdyb3VwW10gPSBbXTtcbiAgICBwcml2YXRlIGNvbXB1dGU6IENvbXB1dGVDb25maWc7XG4gICAgcHJpdmF0ZSBmYXJnYXRlUHJvZmlsZXM6IHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogZWtzLkZhcmdhdGVQcm9maWxlT3B0aW9ucztcbiAgICB9ID0ge307XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcyB9O1xuICAgIH1cblxuICAgIHdpdGhDb21tb25PcHRpb25zKG9wdGlvbnM6IFBhcnRpYWw8ZWtzLkNsdXN0ZXJQcm9wcz4pOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4ub3B0aW9ucyB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBtYW5hZ2VkTm9kZUdyb3VwKC4uLm5vZGVHcm91cHM6IE1hbmFnZWROb2RlR3JvdXBbXSk6IHRoaXMge1xuICAgICAgICB0aGlzLm1hbmFnZWROb2RlR3JvdXBzID0gdGhpcy5tYW5hZ2VkTm9kZUdyb3Vwcy5jb25jYXQobm9kZUdyb3Vwcyk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGF1dG9zY2FsaW5nR3JvdXAoLi4ubm9kZUdyb3VwczogQXV0b3NjYWxpbmdOb2RlR3JvdXBbXSk6IHRoaXMge1xuICAgICAgICB0aGlzLmF1dG9zY2FsaW5nTm9kZUdyb3VwcyA9IHRoaXMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzLmNvbmNhdChub2RlR3JvdXBzKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgY29tcHV0ZUNvbmZpZyhjb25maWc6IENvbXB1dGVDb25maWcpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5jb21wdXRlID0gY29uZmlnO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBmYXJnYXRlUHJvZmlsZShuYW1lOiBzdHJpbmcsIG9wdGlvbnM6IGVrcy5GYXJnYXRlUHJvZmlsZU9wdGlvbnMpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5mYXJnYXRlUHJvZmlsZXNbbmFtZV0gPSBvcHRpb25zO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICB2ZXJzaW9uKHZlcnNpb246IGVrcy5LdWJlcm5ldGVzVmVyc2lvbik6IHRoaXMge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCB2ZXJzaW9uIH07XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGJ1aWxkKCkge1xuICAgICAgICByZXR1cm4gbmV3IEdlbmVyaWNDbHVzdGVyUHJvdmlkZXJWMih7XG4gICAgICAgICAgICAuLi50aGlzLnByb3BzLFxuICAgICAgICAgICAgcHJpdmF0ZUNsdXN0ZXI6IHRoaXMucHJpdmF0ZUNsdXN0ZXIsXG4gICAgICAgICAgICBtYW5hZ2VkTm9kZUdyb3VwczogdGhpcy5tYW5hZ2VkTm9kZUdyb3VwcyxcbiAgICAgICAgICAgIGF1dG9zY2FsaW5nTm9kZUdyb3VwczogdGhpcy5hdXRvc2NhbGluZ05vZGVHcm91cHMsXG4gICAgICAgICAgICBjb21wdXRlOiB0aGlzLmNvbXB1dGUsXG4gICAgICAgICAgICBmYXJnYXRlUHJvZmlsZXM6IHRoaXMuZmFyZ2F0ZVByb2ZpbGVzXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuLyoqXG4gKiBDbHVzdGVyIHByb3ZpZGVyIGltcGxlbWVudGF0aW9uIHRoYXQgc3VwcG9ydHMgbXVsdGlwbGUgbm9kZSBncm91cHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBHZW5lcmljQ2x1c3RlclByb3ZpZGVyVjIgaW1wbGVtZW50cyBDbHVzdGVyUHJvdmlkZXIge1xuXG4gICAgY29uc3RydWN0b3IocmVhZG9ubHkgcHJvcHM6IEdlbmVyaWNDbHVzdGVyUHJvdmlkZXJWMlByb3BzKSB7XG5cbiAgICAgICAgdGhpcy52YWxpZGF0ZUlucHV0KHByb3BzKTtcblxuICAgICAgICBjb25zdCBjb21wdXRlVHlwZXNFbmFibGVkID0gW1xuICAgICAgICAgICAgcHJvcHMubWFuYWdlZE5vZGVHcm91cHMgJiYgcHJvcHMubWFuYWdlZE5vZGVHcm91cHMubGVuZ3RoID4gMCxcbiAgICAgICAgICAgIHByb3BzLmF1dG9zY2FsaW5nTm9kZUdyb3VwcyAmJiBwcm9wcy5hdXRvc2NhbGluZ05vZGVHcm91cHMubGVuZ3RoID4gMCxcbiAgICAgICAgICAgIHByb3BzLmNvbXB1dGUgIT0gdW5kZWZpbmVkXG4gICAgICAgIF0uZmlsdGVyKEJvb2xlYW4pLmxlbmd0aDtcblxuICAgICAgICAvLyBBc3NlcnQgdGhhdCBvbmx5IG9uZSBjb21wdXRlIHR5cGUgaXMgZW5hYmxlZFxuICAgICAgICBhc3NlcnQoXG4gICAgICAgICAgICBjb21wdXRlVHlwZXNFbmFibGVkIDw9IDEsXG4gICAgICAgICAgICAnT25seSBvbmUgY29tcHV0ZSB0eXBlIGNhbiBiZSBlbmFibGVkOiBtYW5hZ2VkIG5vZGUgZ3JvdXBzLCBhdXRvc2NhbGluZyBub2RlIGdyb3Vwcywgb3IgYXV0b21vZGUgY29uZmlndXJhdGlvbi4gIE1peGluZyB0aGVzZSBpcyBub3Qgc3VwcG9ydGVkLiBQbGVhc2UgZmlsZSBhIHJlcXVlc3Qgb24gR2l0SHViIHRvIGFkZCB0aGlzIHN1cHBvcnQgaWYgbmVlZGVkLidcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAb3ZlcnJpZGVcbiAgICAgKi9cbiAgICBjcmVhdGVDbHVzdGVyKHNjb3BlOiBDb25zdHJ1Y3QsIHZwYzogZWMyLklWcGMsIHNlY3JldHNFbmNyeXB0aW9uS2V5PzogSUtleSwga3ViZXJuZXRlc1ZlcnNpb24/OiBla3MuS3ViZXJuZXRlc1ZlcnNpb24sIGNsdXN0ZXJMb2dnaW5nPzogZWtzLkNsdXN0ZXJMb2dnaW5nVHlwZXNbXSwgaXBGYW1pbHk/OiBla3MuSXBGYW1pbHkpOiBDbHVzdGVySW5mbyB7XG4gICAgICAgIGNvbnN0IGlkID0gc2NvcGUubm9kZS5pZDtcblxuICAgICAgICAvLyBQcm9wcyBmb3IgdGhlIGNsdXN0ZXIuXG4gICAgICAgIGNvbnN0IGNsdXN0ZXJOYW1lID0gdGhpcy5wcm9wcy5jbHVzdGVyTmFtZSA/PyBpZDtcbiAgICAgICAgaWYgKCFrdWJlcm5ldGVzVmVyc2lvbiAmJiAhdGhpcy5wcm9wcy52ZXJzaW9uKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJWZXJzaW9uIHdhcyBub3Qgc3BlY2lmaWVkIGJ5IGNsdXN0ZXIgYnVpbGRlciBvciBpbiBjbHVzdGVyIHByb3ZpZGVyIHByb3BzLCBtdXN0IGJlIHNwZWNpZmllZCBpbiBvbmUgb2YgdGhlc2VcIik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdmVyc2lvbjogZWtzLkt1YmVybmV0ZXNWZXJzaW9uID0ga3ViZXJuZXRlc1ZlcnNpb24gfHwgdGhpcy5wcm9wcy52ZXJzaW9uIHx8IGVrcy5LdWJlcm5ldGVzVmVyc2lvbi5WMV8zMDtcblxuICAgICAgICBsZXQgcHJpdmF0ZUNsdXN0ZXIgPSB0aGlzLnByb3BzLnByaXZhdGVDbHVzdGVyID8/IHV0aWxzLnZhbHVlRnJvbUNvbnRleHQoc2NvcGUsIGNvbnN0YW50cy5QUklWQVRFX0NMVVNURVIsIGZhbHNlKTtcbiAgICAgICAgcHJpdmF0ZUNsdXN0ZXIgPSBwcml2YXRlQ2x1c3RlciA/IHByaXZhdGVDbHVzdGVyID09PSAndHJ1ZScgOiBmYWxzZTtcbiAgICAgICAgbGV0IGlzb2xhdGVkQ2x1c3RlciA9IHRoaXMucHJvcHMuaXNvbGF0ZWRDbHVzdGVyID8/IHV0aWxzLnZhbHVlRnJvbUNvbnRleHQoc2NvcGUsIGNvbnN0YW50cy5JU09MQVRFRF9DTFVTVEVSLCBmYWxzZSk7XG4gICAgICAgIGlzb2xhdGVkQ2x1c3RlciA9IGlzb2xhdGVkQ2x1c3RlciA/IGlzb2xhdGVkQ2x1c3RlciA9PT0gJ3RydWUnIDogZmFsc2U7XG5cbiAgICAgICAgY29uc3QgZW5kcG9pbnRBY2Nlc3MgPSAocHJpdmF0ZUNsdXN0ZXIgPT09IHRydWUpID8gZWtzLkVuZHBvaW50QWNjZXNzLlBSSVZBVEUgOiBla3MuRW5kcG9pbnRBY2Nlc3MuUFVCTElDX0FORF9QUklWQVRFO1xuICAgICAgICBjb25zdCB2cGNTdWJuZXRzID0gdGhpcy5wcm9wcy52cGNTdWJuZXRzID8/IChpc29sYXRlZENsdXN0ZXIgPT09IHRydWUgPyBbeyBzdWJuZXRUeXBlOiBlYzIuU3VibmV0VHlwZS5QUklWQVRFX0lTT0xBVEVEIH1dIDogcHJpdmF0ZUNsdXN0ZXIgPT09IHRydWUgPyBbeyBzdWJuZXRUeXBlOiBlYzIuU3VibmV0VHlwZS5QUklWQVRFX1dJVEhfRUdSRVNTIH1dIDogdW5kZWZpbmVkKTtcbiAgICAgICAgY29uc3QgbWFzdGVyc1JvbGUgPSB0aGlzLnByb3BzLm1hc3RlcnNSb2xlID8/IG5ldyBSb2xlKHNjb3BlLCBgJHtjbHVzdGVyTmFtZX0tQWNjZXNzUm9sZWAsIHtcbiAgICAgICAgICAgIGFzc3VtZWRCeTogbmV3IEFjY291bnRSb290UHJpbmNpcGFsKClcbiAgICAgICAgfSk7XG5cblxuICAgICAgICBjb25zdCBrdWJlY3RsTGF5ZXIgPSB0aGlzLmdldEt1YmVjdGxMYXllcihzY29wZSwgdmVyc2lvbik7XG4gICAgICAgIGNvbnN0IGt1YmVjdGxQcm92aWRlck9wdGlvbnMgPSBrdWJlY3RsTGF5ZXIgJiYge2t1YmVjdGxMYXllcn07XG4gICAgICAgIGNvbnN0IHRhZ3MgPSB0aGlzLnByb3BzLnRhZ3M7XG5cbiAgICAgICAgY29uc3QgZGVmYXVsdE9wdGlvbnN2MjogUGFydGlhbDxla3MuQ2x1c3RlclByb3BzPiA9IHtcbiAgICAgICAgICAgIHZwYyxcbiAgICAgICAgICAgIHNlY3JldHNFbmNyeXB0aW9uS2V5LFxuICAgICAgICAgICAgY2x1c3Rlck5hbWUsXG4gICAgICAgICAgICBjbHVzdGVyTG9nZ2luZyxcbiAgICAgICAgICAgIHZlcnNpb24sXG4gICAgICAgICAgICB2cGNTdWJuZXRzLFxuICAgICAgICAgICAgZW5kcG9pbnRBY2Nlc3MsXG4gICAgICAgICAgICBrdWJlY3RsUHJvdmlkZXJPcHRpb25zLFxuICAgICAgICAgICAgdGFncyxcbiAgICAgICAgICAgIG1hc3RlcnNSb2xlLFxuICAgICAgICAgICAgZGVmYXVsdENhcGFjaXR5VHlwZTogZWtzLkRlZmF1bHRDYXBhY2l0eVR5cGUuQVVUT01PREVcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBjbHVzdGVyT3B0aW9ucyA9IHsgLi4uZGVmYXVsdE9wdGlvbnN2MiwgLi4udGhpcy5wcm9wcywgdmVyc2lvbiwgaXBGYW1pbHkgfTtcblxuICAgICAgICAvLyBDcmVhdGUgYW4gRUtTIENsdXN0ZXJcbiAgICAgICAgY29uc3QgY2x1c3RlciA9IHRoaXMuaW50ZXJuYWxDcmVhdGVDbHVzdGVyKHNjb3BlLCBpZCwgY2x1c3Rlck9wdGlvbnMpO1xuICAgICAgICBjbHVzdGVyLm5vZGUuYWRkRGVwZW5kZW5jeSh2cGMpO1xuXG4gICAgICAgIGNvbnN0IG5vZGVHcm91cHM6IChla3MuTm9kZWdyb3VwIHwgZWtzdjEuTm9kZWdyb3VwKVtdID0gW107XG5cbiAgICAgICAgdGhpcy5wcm9wcy5tYW5hZ2VkTm9kZUdyb3Vwcz8uZm9yRWFjaChuID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5vZGVHcm91cCA9IHRoaXMuYWRkTWFuYWdlZE5vZGVHcm91cChjbHVzdGVyIGFzIGVrcy5DbHVzdGVyLCBuKTtcbiAgICAgICAgICAgIG5vZGVHcm91cHMucHVzaChub2RlR3JvdXApO1xuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBhdXRvc2NhbGluZ0dyb3VwczogYXV0b3NjYWxpbmcuQXV0b1NjYWxpbmdHcm91cFtdID0gW107XG4gICAgICAgIHRoaXMucHJvcHMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzPy5mb3JFYWNoKG4gPT4ge1xuICAgICAgICAgICAgY29uc3QgYXV0b3NjYWxpbmdHcm91cCA9IHRoaXMuYWRkQXV0b1NjYWxpbmdHcm91cChjbHVzdGVyIGFzIGVrcy5DbHVzdGVyLCBuKTtcbiAgICAgICAgICAgIGF1dG9zY2FsaW5nR3JvdXBzLnB1c2goYXV0b3NjYWxpbmdHcm91cCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGF1dG9Nb2RlID0gY2x1c3Rlck9wdGlvbnMuZGVmYXVsdENhcGFjaXR5VHlwZSAhPSB1bmRlZmluZWQgJiYgKGNsdXN0ZXJPcHRpb25zLmRlZmF1bHRDYXBhY2l0eVR5cGUgYXMgZWtzLkRlZmF1bHRDYXBhY2l0eVR5cGUpID09IGVrcy5EZWZhdWx0Q2FwYWNpdHlUeXBlLkFVVE9NT0RFO1xuXG4gICAgICAgIGNvbnN0IGZhcmdhdGVQcm9maWxlcyA9IE9iamVjdC5lbnRyaWVzKHRoaXMucHJvcHMuZmFyZ2F0ZVByb2ZpbGVzID8/IHt9KTtcbiAgICAgICAgY29uc3QgZmFyZ2F0ZUNvbnN0cnVjdHM6IGVrcy5GYXJnYXRlUHJvZmlsZVtdID0gW107XG4gICAgICAgIGZhcmdhdGVQcm9maWxlcz8uZm9yRWFjaCgoW2tleSwgb3B0aW9uc10pID0+IGZhcmdhdGVDb25zdHJ1Y3RzLnB1c2godGhpcy5hZGRGYXJnYXRlUHJvZmlsZShjbHVzdGVyIGFzIGVrcy5DbHVzdGVyLCBrZXksIG9wdGlvbnMpKSk7XG5cbiAgICAgICAgY29uc3Qgbm9kZVBvb2xzID0gT2JqZWN0LmVudHJpZXModGhpcy5wcm9wcy5jb21wdXRlPy5leHRyYU5vZGVQb29scyA/PyB7fSk7XG4gICAgICAgIGNvbnN0IG5vZGVQb29sQ29uc3RydWN0czogZWtzLkt1YmVybmV0ZXNNYW5pZmVzdFtdID0gW107XG4gICAgICAgIG5vZGVQb29scy5mb3JFYWNoKChba2V5LCBvcHRpb25zXSkgPT4gbm9kZVBvb2xDb25zdHJ1Y3RzLnB1c2godGhpcy5hZGROb2RlUG9vbChjbHVzdGVyIGFzIGVrcy5DbHVzdGVyLCBrZXksIG9wdGlvbnMpKSk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBDbHVzdGVySW5mbyhjbHVzdGVyIGFzIGVrc3YxLkNsdXN0ZXIsIHZlcnNpb24sIG5vZGVHcm91cHMgYXMgZWtzdjEuTm9kZWdyb3VwW10sIGF1dG9zY2FsaW5nR3JvdXBzLCBhdXRvTW9kZSwgZmFyZ2F0ZUNvbnN0cnVjdHMsIGNsdXN0ZXIgYXMgZWtzLkNsdXN0ZXIsIG5vZGVHcm91cHMgYXMgZWtzLk5vZGVncm91cFtdKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUZW1wbGF0ZSBtZXRob2QgdGhhdCBtYXkgYmUgb3ZlcnJpZGRlbiBieSBzdWJjbGFzc2VzIHRvIGNyZWF0ZSBhIHNwZWNpZmljIGNsdXN0ZXIgZmxhdm9yIChlLmcuIEZhcmdhdGVDbHVzdGVyIHZzIGVrcy5DbHVzdGVyKVxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqIEBwYXJhbSBpZFxuICAgICAqIEBwYXJhbSBjbHVzdGVyT3B0aW9uc1xuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGludGVybmFsQ3JlYXRlQ2x1c3RlcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBjbHVzdGVyT3B0aW9uczogYW55KTogZWtzLkNsdXN0ZXIgfCBla3N2MS5DbHVzdGVyIHtcbiAgICAgICAgcmV0dXJuIG5ldyBla3MuQ2x1c3RlcihzY29wZSwgaWQsIGNsdXN0ZXJPcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYW4gYmUgb3ZlcnJpZGRlbiB0byBwcm92aWRlIGEgY3VzdG9tIGt1YmVjdGwgbGF5ZXIuXG4gICAgICogQHBhcmFtIHNjb3BlXG4gICAgICogQHBhcmFtIHZlcnNpb25cbiAgICAgKiBAcmV0dXJuc1xuICAgICAqL1xuICAgIHByb3RlY3RlZCBnZXRLdWJlY3RsTGF5ZXIoc2NvcGU6IENvbnN0cnVjdCwgdmVyc2lvbjogZWtzLkt1YmVybmV0ZXNWZXJzaW9uKTogSUxheWVyVmVyc2lvbiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiBzZWxlY3RLdWJlY3RsTGF5ZXIoc2NvcGUsIHZlcnNpb24pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYW4gYXV0b3NjYWxpbmcgZ3JvdXAgdG8gdGhlIGNsdXN0ZXIuXG4gICAgICogQHBhcmFtIGNsdXN0ZXJcbiAgICAgKiBAcGFyYW0gbm9kZUdyb3VwXG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBhZGRBdXRvU2NhbGluZ0dyb3VwKGNsdXN0ZXI6IGVrcy5DbHVzdGVyLCBub2RlR3JvdXA6IEF1dG9zY2FsaW5nTm9kZUdyb3VwKTogYXV0b3NjYWxpbmcuQXV0b1NjYWxpbmdHcm91cCB7XG4gICAgICAgIGNvbnN0IG1hY2hpbmVJbWFnZVR5cGUgPSBub2RlR3JvdXAubWFjaGluZUltYWdlVHlwZSA/PyBla3MuTWFjaGluZUltYWdlVHlwZS5BTUFaT05fTElOVVhfMjtcbiAgICAgICAgY29uc3QgaW5zdGFuY2VUeXBlQ29udGV4dCA9IHV0aWxzLnZhbHVlRnJvbUNvbnRleHQoY2x1c3RlciwgY29uc3RhbnRzLklOU1RBTkNFX1RZUEVfS0VZLCBjb25zdGFudHMuREVGQVVMVF9JTlNUQU5DRV9UWVBFKTtcbiAgICAgICAgY29uc3QgaW5zdGFuY2VUeXBlID0gbm9kZUdyb3VwLmluc3RhbmNlVHlwZSA/PyAodHlwZW9mIGluc3RhbmNlVHlwZUNvbnRleHQgPT09ICdzdHJpbmcnID8gbmV3IGVjMi5JbnN0YW5jZVR5cGUoaW5zdGFuY2VUeXBlQ29udGV4dCkgOiBpbnN0YW5jZVR5cGVDb250ZXh0KTtcbiAgICAgICAgY29uc3QgbWluU2l6ZSA9IG5vZGVHcm91cC5taW5TaXplID8/IHV0aWxzLnZhbHVlRnJvbUNvbnRleHQoY2x1c3RlciwgY29uc3RhbnRzLk1JTl9TSVpFX0tFWSwgY29uc3RhbnRzLkRFRkFVTFRfTkdfTUlOU0laRSk7XG4gICAgICAgIGNvbnN0IG1heFNpemUgPSBub2RlR3JvdXAubWF4U2l6ZSA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5NQVhfU0laRV9LRVksIGNvbnN0YW50cy5ERUZBVUxUX05HX01BWFNJWkUpO1xuICAgICAgICBjb25zdCBkZXNpcmVkU2l6ZSA9IG5vZGVHcm91cC5kZXNpcmVkU2l6ZSA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5ERVNJUkVEX1NJWkVfS0VZLCBtaW5TaXplKTtcbiAgICAgICAgY29uc3QgdXBkYXRlUG9saWN5ID0gbm9kZUdyb3VwLnVwZGF0ZVBvbGljeSA/PyBhdXRvc2NhbGluZy5VcGRhdGVQb2xpY3kucm9sbGluZ1VwZGF0ZSgpO1xuXG4gICAgICAgIC8vIENyZWF0ZSBhbiBhdXRvc2NhbGluZyBncm91cFxuICAgICAgICByZXR1cm4gY2x1c3Rlci5hZGRBdXRvU2NhbGluZ0dyb3VwQ2FwYWNpdHkobm9kZUdyb3VwLmlkLCB7XG4gICAgICAgICAgICAuLi5ub2RlR3JvdXAsXG4gICAgICAgICAgICAuLi4ge1xuICAgICAgICAgICAgICAgIGF1dG9TY2FsaW5nR3JvdXBOYW1lOiBub2RlR3JvdXAuYXV0b1NjYWxpbmdHcm91cE5hbWUgPz8gbm9kZUdyb3VwLmlkLFxuICAgICAgICAgICAgICAgIG1hY2hpbmVJbWFnZVR5cGUsXG4gICAgICAgICAgICAgICAgaW5zdGFuY2VUeXBlLFxuICAgICAgICAgICAgICAgIG1pbkNhcGFjaXR5OiBtaW5TaXplLFxuICAgICAgICAgICAgICAgIG1heENhcGFjaXR5OiBtYXhTaXplLFxuICAgICAgICAgICAgICAgIGRlc2lyZWRDYXBhY2l0eTogZGVzaXJlZFNpemUsXG4gICAgICAgICAgICAgICAgdXBkYXRlUG9saWN5LFxuICAgICAgICAgICAgICAgIHZwY1N1Ym5ldHM6IG5vZGVHcm91cC5ub2RlR3JvdXBTdWJuZXRzLFxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgZmFyZ2F0ZSBwcm9maWxlIHRvIHRoZSBjbHVzdGVyXG4gICAgICovXG4gICAgYWRkRmFyZ2F0ZVByb2ZpbGUoY2x1c3RlcjogZWtzLkNsdXN0ZXIsIG5hbWU6IHN0cmluZywgcHJvZmlsZU9wdGlvbnM6IGVrcy5GYXJnYXRlUHJvZmlsZU9wdGlvbnMpOiBla3MuRmFyZ2F0ZVByb2ZpbGUge1xuICAgICAgICByZXR1cm4gY2x1c3Rlci5hZGRGYXJnYXRlUHJvZmlsZShuYW1lLCBwcm9maWxlT3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgbm9kZSBwb29sIHRvIHRoZSBjbHVzdGVyXG4gICAgICovXG4gICAgYWRkTm9kZVBvb2woY2x1c3RlcjogZWtzLkNsdXN0ZXIsIG5hbWU6IHN0cmluZywgcG9vbDogTm9kZVBvb2xWMVNwZWMpIHtcbiAgICAgIGNvbnN0IGxhYmVscyA9ICBwb29sLmxhYmVscyB8fCB7fTtcbiAgICAgIGNvbnN0IGFubm90YXRpb25zID0gcG9vbC5hbm5vdGF0aW9ucyB8fCB7fTtcbiAgICAgIGNvbnN0IHRhaW50cyA9IHBvb2wudGFpbnRzIHx8IFtdO1xuICAgICAgY29uc3Qgc3RhcnR1cFRhaW50cyA9IHBvb2wuc3RhcnR1cFRhaW50cyB8fCBbXTtcbiAgICAgIGNvbnN0IHJlcXVpcmVtZW50cyA9IHBvb2wucmVxdWlyZW1lbnRzIHx8IFtdO1xuICAgICAgY29uc3QgZGlzcnVwdGlvbiA9IHBvb2wuZGlzcnVwdGlvbiB8fCBudWxsO1xuICAgICAgY29uc3QgbGltaXRzID0gcG9vbC5saW1pdHMgfHwgbnVsbDtcbiAgICAgIGNvbnN0IHdlaWdodCA9IHBvb2wud2VpZ2h0IHx8IG51bGw7XG4gICAgICBjb25zdCBwb29sTWFuaWZlc3QgPSB7XG4gICAgICAgIGFwaVZlcnNpb246IFwia2FycGVudGVyLnNoL3YxXCIsXG4gICAgICAgIGtpbmQ6IFwiTm9kZVBvb2xcIixcbiAgICAgICAgbWV0YWRhdGE6IHtuYW1lOiBuYW1lfSxcbiAgICAgICAgc3BlYzoge1xuICAgICAgICAgIHRlbXBsYXRlOiB7XG4gICAgICAgICAgICBtZXRhZGF0YToge2xhYmVsczogbGFiZWxzLCBhbm5vdGF0aW9uczogYW5ub3RhdGlvbnN9LFxuICAgICAgICAgICAgc3BlYzoge1xuICAgICAgICAgICAgICBub2RlQ2xhc3NSZWY6IHtcbiAgICAgICAgICAgICAgICAgIG5hbWU6IFwiZGVmYXVsdFwiLFxuICAgICAgICAgICAgICAgICAgZ3JvdXA6IFwiZWtzLmFtYXpvbmF3cy5jb21cIixcbiAgICAgICAgICAgICAgICAgIGtpbmQ6IFwiTm9kZUNsYXNzXCJcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgdGFpbnRzOiB0YWludHMsXG4gICAgICAgICAgICAgIHN0YXJ0dXBUYWludHM6IHN0YXJ0dXBUYWludHMsXG4gICAgICAgICAgICAgIHJlcXVpcmVtZW50czogdXRpbHMuY29udmVydEtleVBhaXIocmVxdWlyZW1lbnRzKSxcbiAgICAgICAgICAgICAgZXhwaXJlQWZ0ZXI6IHBvb2wuZXhwaXJlQWZ0ZXJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBkaXNydXB0aW9uOiBkaXNydXB0aW9uLFxuICAgICAgICAgIGxpbWl0czogbGltaXRzLFxuICAgICAgICAgIHdlaWdodDogd2VpZ2h0LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIHJldHVybiBjbHVzdGVyLmFkZE1hbmlmZXN0KG5hbWUsIHBvb2xNYW5pZmVzdCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIG1hbmFnZWQgbm9kZSBncm91cCB0byB0aGUgY2x1c3Rlci5cbiAgICAgKiBAcGFyYW0gY2x1c3RlclxuICAgICAqIEBwYXJhbSBub2RlR3JvdXBcbiAgICAgKiBAcmV0dXJuc1xuICAgICAqL1xuICAgIGFkZE1hbmFnZWROb2RlR3JvdXAoY2x1c3RlcjogZWtzLkNsdXN0ZXIsIG5vZGVHcm91cDogTWFuYWdlZE5vZGVHcm91cCk6IGVrcy5Ob2RlZ3JvdXAge1xuICAgICAgICBjb25zdCBjYXBhY2l0eVR5cGUgPSBub2RlR3JvdXAubm9kZUdyb3VwQ2FwYWNpdHlUeXBlO1xuICAgICAgICBjb25zdCByZWxlYXNlVmVyc2lvbiA9IG5vZGVHcm91cC5hbWlSZWxlYXNlVmVyc2lvbjtcbiAgICAgICAgY29uc3QgaW5zdGFuY2VUeXBlQ29udGV4dCA9IHV0aWxzLnZhbHVlRnJvbUNvbnRleHQoY2x1c3RlciwgY29uc3RhbnRzLklOU1RBTkNFX1RZUEVfS0VZLCBjb25zdGFudHMuREVGQVVMVF9JTlNUQU5DRV9UWVBFKTtcbiAgICAgICAgY29uc3QgaW5zdGFuY2VUeXBlcyA9IG5vZGVHcm91cC5pbnN0YW5jZVR5cGVzID8/IChbdHlwZW9mIGluc3RhbmNlVHlwZUNvbnRleHQgPT09ICdzdHJpbmcnID8gbmV3IGVjMi5JbnN0YW5jZVR5cGUoaW5zdGFuY2VUeXBlQ29udGV4dCkgOiBpbnN0YW5jZVR5cGVDb250ZXh0XSk7XG4gICAgICAgIGNvbnN0IG1pblNpemUgPSBub2RlR3JvdXAubWluU2l6ZSA/PyB1dGlscy52YWx1ZUZyb21Db250ZXh0KGNsdXN0ZXIsIGNvbnN0YW50cy5NSU5fU0laRV9LRVksIGNvbnN0YW50cy5ERUZBVUxUX05HX01JTlNJWkUpO1xuICAgICAgICBjb25zdCBtYXhTaXplID0gbm9kZUdyb3VwLm1heFNpemUgPz8gdXRpbHMudmFsdWVGcm9tQ29udGV4dChjbHVzdGVyLCBjb25zdGFudHMuTUFYX1NJWkVfS0VZLCBjb25zdGFudHMuREVGQVVMVF9OR19NQVhTSVpFKTtcbiAgICAgICAgY29uc3QgZGVzaXJlZFNpemUgPSBub2RlR3JvdXAuZGVzaXJlZFNpemUgPz8gdXRpbHMudmFsdWVGcm9tQ29udGV4dChjbHVzdGVyLCBjb25zdGFudHMuREVTSVJFRF9TSVpFX0tFWSwgbWluU2l6ZSk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIGEgbWFuYWdlZCBub2RlIGdyb3VwLlxuICAgICAgICBjb25zdCBub2RlZ3JvdXBPcHRpb25zOiB1dGlscy5Xcml0ZWFibGU8ZWtzLk5vZGVncm91cE9wdGlvbnM+ID0ge1xuICAgICAgICAgICAgLi4ubm9kZUdyb3VwLFxuICAgICAgICAgICAgYW1pVHlwZTogbm9kZUdyb3VwLmFtaVR5cGUgYXMgZWtzLk5vZGVncm91cEFtaVR5cGUsXG4gICAgICAgICAgICAuLi57XG4gICAgICAgICAgICAgICAgbm9kZWdyb3VwTmFtZTogbm9kZUdyb3VwLm5vZGVncm91cE5hbWUgPz8gbm9kZUdyb3VwLmlkLFxuICAgICAgICAgICAgICAgIGNhcGFjaXR5VHlwZSxcbiAgICAgICAgICAgICAgICBpbnN0YW5jZVR5cGVzLFxuICAgICAgICAgICAgICAgIG1pblNpemUsXG4gICAgICAgICAgICAgICAgbWF4U2l6ZSxcbiAgICAgICAgICAgICAgICBkZXNpcmVkU2l6ZSxcbiAgICAgICAgICAgICAgICByZWxlYXNlVmVyc2lvbixcbiAgICAgICAgICAgICAgICBzdWJuZXRzOiBub2RlR3JvdXAubm9kZUdyb3VwU3VibmV0c1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChub2RlR3JvdXAubGF1bmNoVGVtcGxhdGUpIHtcbiAgICAgICAgICAgIC8vIENyZWF0ZSBsYXVuY2ggdGVtcGxhdGUgd2l0aCBwcm92aWRlZCBsYXVuY2ggdGVtcGxhdGUgcHJvcGVydGllc1xuICAgICAgICAgICAgY29uc3QgbHQgPSBuZXcgZWMyLkxhdW5jaFRlbXBsYXRlKGNsdXN0ZXIsIGAke25vZGVHcm91cC5pZH0tbHRgLCB7XG4gICAgICAgICAgICAgICAgYmxvY2tEZXZpY2VzOiBub2RlR3JvdXAubGF1bmNoVGVtcGxhdGUuYmxvY2tEZXZpY2VzLFxuICAgICAgICAgICAgICAgIG1hY2hpbmVJbWFnZTogbm9kZUdyb3VwLmxhdW5jaFRlbXBsYXRlPy5tYWNoaW5lSW1hZ2UsXG4gICAgICAgICAgICAgICAgc2VjdXJpdHlHcm91cDogbm9kZUdyb3VwLmxhdW5jaFRlbXBsYXRlLnNlY3VyaXR5R3JvdXAsXG4gICAgICAgICAgICAgICAgdXNlckRhdGE6IG5vZGVHcm91cC5sYXVuY2hUZW1wbGF0ZT8udXNlckRhdGEsXG4gICAgICAgICAgICAgICAgcmVxdWlyZUltZHN2Mjogbm9kZUdyb3VwLmxhdW5jaFRlbXBsYXRlPy5yZXF1aXJlSW1kc3YyLFxuICAgICAgICAgICAgICAgIGh0dHBQdXRSZXNwb25zZUhvcExpbWl0OiBub2RlR3JvdXAubGF1bmNoVGVtcGxhdGU/Lmh0dHBQdXRSZXNwb25zZUhvcExpbWl0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB1dGlscy5zZXRQYXRoKG5vZGVncm91cE9wdGlvbnMsIFwibGF1bmNoVGVtcGxhdGVTcGVjXCIsIHtcbiAgICAgICAgICAgICAgICBpZDogbHQubGF1bmNoVGVtcGxhdGVJZCEsXG4gICAgICAgICAgICAgICAgdmVyc2lvbjogbHQubGF0ZXN0VmVyc2lvbk51bWJlcixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29uc3QgdGFncyA9IE9iamVjdC5lbnRyaWVzKG5vZGVHcm91cC5sYXVuY2hUZW1wbGF0ZS50YWdzID8/IHt9KTtcbiAgICAgICAgICAgIHRhZ3MuZm9yRWFjaCgoW2tleSwgb3B0aW9uc10pID0+IFRhZ3Mub2YobHQpLmFkZChrZXksIG9wdGlvbnMpKTtcbiAgICAgICAgICAgIGlmIChub2RlR3JvdXAubGF1bmNoVGVtcGxhdGU/Lm1hY2hpbmVJbWFnZSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBub2RlZ3JvdXBPcHRpb25zLmFtaVR5cGU7XG4gICAgICAgICAgICAgICAgZGVsZXRlIG5vZGVncm91cE9wdGlvbnMucmVsZWFzZVZlcnNpb247XG4gICAgICAgICAgICAgICAgZGVsZXRlIG5vZGVHcm91cC5hbWlSZWxlYXNlVmVyc2lvbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGNsdXN0ZXIuYWRkTm9kZWdyb3VwQ2FwYWNpdHkobm9kZUdyb3VwLmlkICsgXCItbmdcIiwgbm9kZWdyb3VwT3B0aW9ucyk7XG5cbiAgICAgICAgaWYgKG5vZGVHcm91cC5lbmFibGVTc21QZXJtaXNzaW9ucykge1xuICAgICAgICAgICAgcmVzdWx0LnJvbGUuYWRkTWFuYWdlZFBvbGljeShNYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZSgnQW1hem9uU1NNTWFuYWdlZEluc3RhbmNlQ29yZScpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZUlucHV0KHByb3BzOiBHZW5lcmljQ2x1c3RlclByb3ZpZGVyVjJQcm9wcykge1xuXG4gICAgICAgIHV0aWxzLnZhbGlkYXRlQ29uc3RyYWludHMobmV3IEdlbmVyaWNDbHVzdGVyUHJvcHNWMkNvbnN0cmFpbnRzLCBHZW5lcmljQ2x1c3RlclByb3ZpZGVyVjIubmFtZSwgcHJvcHMpO1xuICAgICAgICBpZiAocHJvcHMubWFuYWdlZE5vZGVHcm91cHMgIT0gdW5kZWZpbmVkKVxuICAgICAgICAgICAgdXRpbHMudmFsaWRhdGVDb25zdHJhaW50cyhuZXcgTWFuYWdlZE5vZGVHcm91cENvbnN0cmFpbnRzLCBcIk1hbmFnZWROb2RlR3JvdXBcIiwgLi4ucHJvcHMubWFuYWdlZE5vZGVHcm91cHMpO1xuICAgICAgICBpZiAocHJvcHMuYXV0b3NjYWxpbmdOb2RlR3JvdXBzICE9IHVuZGVmaW5lZClcbiAgICAgICAgICAgIHV0aWxzLnZhbGlkYXRlQ29uc3RyYWludHMobmV3IEF1dG9zY2FsaW5nTm9kZUdyb3VwQ29uc3RyYWludHMsIFwiQXV0b3NjYWxpbmdOb2RlR3JvdXBzXCIsIC4uLnByb3BzLmF1dG9zY2FsaW5nTm9kZUdyb3Vwcyk7XG4gICAgICAgIGlmIChwcm9wcy5jb21wdXRlICE9IHVuZGVmaW5lZClcbiAgICAgICAgICAgIHV0aWxzLnZhbGlkYXRlQ29uc3RyYWludHMobmV3IENvbXB1dGVDb25maWdDb25zdHJhaW50cywgXCJDb21wdXRlQ29uZmlnQ29uc3RyYWludHNcIiwgcHJvcHMuY29tcHV0ZSk7XG4gICAgICAgIGlmIChwcm9wcy5mYXJnYXRlUHJvZmlsZXMgYXMgYW55ICE9IHVuZGVmaW5lZClcbiAgICAgICAgICAgIHV0aWxzLnZhbGlkYXRlQ29uc3RyYWludHMobmV3IEZhcmdhdGVQcm9maWxlQ29uc3RyYWludHMsIFwiRmFyZ2F0ZVByb2ZpbGVzXCIsIC4uLk9iamVjdC52YWx1ZXMocHJvcHMuZmFyZ2F0ZVByb2ZpbGVzIGFzIGFueSkpO1xuICAgIH1cbn1cbiJdfQ==