"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LookupSubnetProvider = exports.DirectVpcProvider = exports.VpcProvider = void 0;
exports.getVPCFromId = getVPCFromId;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const ec2 = require("aws-cdk-lib/aws-ec2");
const eks = require("aws-cdk-lib/aws-eks");
const ipv6_vpc_1 = require("./ipv6-vpc");
/**
 * VPC resource provider
 */
class VpcProvider {
    constructor(vpcId, vpcProps) {
        this.vpcProps = vpcProps;
        this.vpcId = vpcId;
        this.primaryCidr = vpcProps === null || vpcProps === void 0 ? void 0 : vpcProps.primaryCidr;
        this.secondaryCidr = vpcProps === null || vpcProps === void 0 ? void 0 : vpcProps.secondaryCidr;
        this.secondarySubnetCidrs = vpcProps === null || vpcProps === void 0 ? void 0 : vpcProps.secondarySubnetCidrs;
    }
    provide(context) {
        const id = context.scope.node.id;
        const ipFamily = context.blueprintProps.ipFamily;
        if (ipFamily == eks.IpFamily.IP_V6) {
            const ipv6VpcProvider = new ipv6_vpc_1.Ipv6VpcProvider(this.vpcId);
            return ipv6VpcProvider.provide(context);
        }
        let vpc = getVPCFromId(context, id, this.vpcId);
        if (vpc == null) {
            // It will automatically divide the provided VPC CIDR range, and create public and private subnets per Availability Zone.
            // If VPC CIDR range is not provided, uses `10.0.0.0/16` as the range and creates public and private subnets per Availability Zone.
            // Network routing for the public subnets will be configured to allow outbound access directly via an Internet Gateway.
            // Network routing for the private subnets will be configured to allow outbound access via a set of resilient NAT Gateways (one per AZ).
            // Creates Secondary CIDR and Secondary subnets if passed.
            if (this.primaryCidr) {
                vpc = new ec2.Vpc(context.scope, id + "-vpc", {
                    ipAddresses: ec2.IpAddresses.cidr(this.primaryCidr)
                });
            }
            else {
                vpc = new ec2.Vpc(context.scope, id + "-vpc");
            }
        }
        if (this.secondaryCidr) {
            this.createSecondarySubnets(context, id, vpc);
        }
        return vpc;
    }
    createSecondarySubnets(context, id, vpc) {
        const secondarySubnets = [];
        const secondaryCidr = new ec2.CfnVPCCidrBlock(context.scope, id + "-secondaryCidr", {
            vpcId: vpc.vpcId,
            cidrBlock: this.secondaryCidr
        });
        secondaryCidr.node.addDependency(vpc);
        if (this.secondarySubnetCidrs) {
            for (let i = 0; i < vpc.availabilityZones.length; i++) {
                if (this.secondarySubnetCidrs[i]) {
                    secondarySubnets[i] = new ec2.PrivateSubnet(context.scope, id + "private-subnet-" + i, {
                        availabilityZone: vpc.availabilityZones[i],
                        cidrBlock: this.secondarySubnetCidrs[i],
                        vpcId: vpc.vpcId
                    });
                    secondarySubnets[i].node.addDependency(secondaryCidr);
                    context.add("secondary-cidr-subnet-" + i, {
                        provide(_context) { return secondarySubnets[i]; }
                    });
                }
            }
            for (let secondarySubnet of secondarySubnets) {
                aws_cdk_lib_1.Tags.of(secondarySubnet).add("kubernetes.io/role/internal-elb", "1", { applyToLaunchedInstances: true });
                aws_cdk_lib_1.Tags.of(secondarySubnet).add("Name", `blueprint-construct-dev-PrivateSubnet-${secondarySubnet}`, { applyToLaunchedInstances: true });
            }
        }
    }
}
exports.VpcProvider = VpcProvider;
/*
** This function will give return vpc based on the ResourceContext and vpcId passed to the cluster.
 */
function getVPCFromId(context, nodeId, vpcId) {
    let vpc = undefined;
    if (vpcId) {
        if (vpcId === "default") {
            console.log(`looking up completely default VPC`);
            vpc = ec2.Vpc.fromLookup(context.scope, nodeId + "-vpc", { isDefault: true });
        }
        else {
            console.log(`looking up non-default ${vpcId} VPC`);
            vpc = ec2.Vpc.fromLookup(context.scope, nodeId + "-vpc", { vpcId: vpcId });
        }
    }
    return vpc;
}
class DirectVpcProvider {
    constructor(vpc) {
        this.vpc = vpc;
    }
    provide(_context) {
        return this.vpc;
    }
}
exports.DirectVpcProvider = DirectVpcProvider;
/**
 * Direct import secondary subnet provider, based on a known subnet ID.
 * Recommended method if secondary subnet id is known, as it avoids extra look-ups.
 */
class LookupSubnetProvider {
    constructor(subnetId) {
        this.subnetId = subnetId;
    }
    provide(context) {
        return ec2.Subnet.fromSubnetAttributes(context.scope, `${this.subnetId}-secondarysubnet`, { subnetId: this.subnetId });
    }
}
exports.LookupSubnetProvider = LookupSubnetProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidnBjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL3Jlc291cmNlLXByb3ZpZGVycy92cGMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBb0dBLG9DQVlDO0FBaEhELDZDQUFtQztBQUNuQywyQ0FBMkM7QUFHM0MsMkNBQTJDO0FBQzNDLHlDQUEyQztBQVczQzs7R0FFRztBQUNILE1BQWEsV0FBVztJQU1wQixZQUFZLEtBQWMsRUFBVSxRQUFtQjtRQUFuQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ25ELElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxXQUFXLEdBQUcsUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLFdBQVcsQ0FBQztRQUN6QyxJQUFJLENBQUMsYUFBYSxHQUFHLFFBQVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxhQUFhLENBQUM7UUFDN0MsSUFBSSxDQUFDLG9CQUFvQixHQUFHLFFBQVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxvQkFBb0IsQ0FBQztJQUMvRCxDQUFDO0lBRUQsT0FBTyxDQUFDLE9BQXdCO1FBQzVCLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUNqQyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQztRQUVqRCxJQUFJLFFBQVEsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2pDLE1BQU0sZUFBZSxHQUFtQixJQUFJLDBCQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3hFLE9BQU8sZUFBZSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM1QyxDQUFDO1FBRUQsSUFBSSxHQUFHLEdBQUcsWUFBWSxDQUFDLE9BQU8sRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFD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LENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxRQUFRLGtCQUFrQixFQUFFLEVBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUMsQ0FBQyxDQUFDO0lBQ3pILENBQUM7Q0FDSjtBQU5ELG9EQU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGFncyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGVjMiBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCB7IElTdWJuZXQsIFByaXZhdGVTdWJuZXQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCB7IFJlc291cmNlQ29udGV4dCwgUmVzb3VyY2VQcm92aWRlciB9IGZyb20gXCIuLi9zcGlcIjtcbmltcG9ydCAqIGFzIGVrcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVrc1wiO1xuaW1wb3J0IHtJcHY2VnBjUHJvdmlkZXJ9IGZyb20gXCIuL2lwdjYtdnBjXCI7XG5cbi8qKlxuICogSW50ZXJmYWNlIGZvciBNYXBwaW5nIGZvciBmaWVsZHMgc3VjaCBhcyBQcmltYXJ5IENJRFIsIFNlY29uZGFyeSBDSURSLCBTZWNvbmRhcnkgU3VibmV0IENJRFIuXG4gKi9cbmludGVyZmFjZSBWcGNQcm9wcyB7XG4gICBwcmltYXJ5Q2lkcj86IHN0cmluZyxcbiAgIHNlY29uZGFyeUNpZHI/OiBzdHJpbmcsXG4gICBzZWNvbmRhcnlTdWJuZXRDaWRycz86IHN0cmluZ1tdXG59XG5cbi8qKlxuICogVlBDIHJlc291cmNlIHByb3ZpZGVyIFxuICovXG5leHBvcnQgY2xhc3MgVnBjUHJvdmlkZXIgaW1wbGVtZW50cyBSZXNvdXJjZVByb3ZpZGVyPGVjMi5JVnBjPiB7XG4gICAgcmVhZG9ubHkgdnBjSWQ/OiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgcHJpbWFyeUNpZHI/OiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgc2Vjb25kYXJ5Q2lkcj86IHN0cmluZztcbiAgICByZWFkb25seSBzZWNvbmRhcnlTdWJuZXRDaWRycz86IHN0cmluZ1tdO1xuXG4gICAgY29uc3RydWN0b3IodnBjSWQ/OiBzdHJpbmcsIHByaXZhdGUgdnBjUHJvcHM/OiBWcGNQcm9wcykge1xuICAgICAgICB0aGlzLnZwY0lkID0gdnBjSWQ7XG4gICAgICAgIHRoaXMucHJpbWFyeUNpZHIgPSB2cGNQcm9wcz8ucHJpbWFyeUNpZHI7XG4gICAgICAgIHRoaXMuc2Vjb25kYXJ5Q2lkciA9IHZwY1Byb3BzPy5zZWNvbmRhcnlDaWRyO1xuICAgICAgICB0aGlzLnNlY29uZGFyeVN1Ym5ldENpZHJzID0gdnBjUHJvcHM/LnNlY29uZGFyeVN1Ym5ldENpZHJzO1xuICAgIH1cblxuICAgIHByb3ZpZGUoY29udGV4dDogUmVzb3VyY2VDb250ZXh0KTogZWMyLklWcGMge1xuICAgICAgICBjb25zdCBpZCA9IGNvbnRleHQuc2NvcGUubm9kZS5pZDtcbiAgICAgICAgY29uc3QgaXBGYW1pbHkgPSBjb250ZXh0LmJsdWVwcmludFByb3BzLmlwRmFtaWx5O1xuXG4gICAgICAgIGlmIChpcEZhbWlseSA9PSBla3MuSXBGYW1pbHkuSVBfVjYpIHtcbiAgICAgICAgICAgIGNvbnN0IGlwdjZWcGNQcm92aWRlcjpJcHY2VnBjUHJvdmlkZXIgPSBuZXcgSXB2NlZwY1Byb3ZpZGVyKHRoaXMudnBjSWQpO1xuICAgICAgICAgICAgcmV0dXJuIGlwdjZWcGNQcm92aWRlci5wcm92aWRlKGNvbnRleHQpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHZwYyA9IGdldFZQQ0Zyb21JZChjb250ZXh0LCBpZCwgdGhpcy52cGNJZCk7XG4gICAgICAgIGlmICh2cGMgPT0gbnVsbCkge1xuICAgICAgICAgICAgLy8gSXQgd2lsbCBhdXRvbWF0aWNhbGx5IGRpdmlkZSB0aGUgcHJvdmlkZWQgVlBDIENJRFIgcmFuZ2UsIGFuZCBjcmVhdGUgcHVibGljIGFuZCBwcml2YXRlIHN1Ym5ldHMgcGVyIEF2YWlsYWJpbGl0eSBab25lLlxuICAgICAgICAgICAgLy8gSWYgVlBDIENJRFIgcmFuZ2UgaXMgbm90IHByb3ZpZGVkLCB1c2VzIGAxMC4wLjAuMC8xNmAgYXMgdGhlIHJhbmdlIGFuZCBjcmVhdGVzIHB1YmxpYyBhbmQgcHJpdmF0ZSBzdWJuZXRzIHBlciBBdmFpbGFiaWxpdHkgWm9uZS5cbiAgICAgICAgICAgIC8vIE5ldHdvcmsgcm91dGluZyBmb3IgdGhlIHB1YmxpYyBzdWJuZXRzIHdpbGwgYmUgY29uZmlndXJlZCB0byBhbGxvdyBvdXRib3VuZCBhY2Nlc3MgZGlyZWN0bHkgdmlhIGFuIEludGVybmV0IEdhdGV3YXkuXG4gICAgICAgICAgICAvLyBOZXR3b3JrIHJvdXRpbmcgZm9yIHRoZSBwcml2YXRlIHN1Ym5ldHMgd2lsbCBiZSBjb25maWd1cmVkIHRvIGFsbG93IG91dGJvdW5kIGFjY2VzcyB2aWEgYSBzZXQgb2YgcmVzaWxpZW50IE5BVCBHYXRld2F5cyAob25lIHBlciBBWikuXG4gICAgICAgICAgICAvLyBDcmVhdGVzIFNlY29uZGFyeSBDSURSIGFuZCBTZWNvbmRhcnkgc3VibmV0cyBpZiBwYXNzZWQuXG4gICAgICAgICAgICBpZiAodGhpcy5wcmltYXJ5Q2lkcikge1xuICAgICAgICAgICAgICAgIHZwYyA9IG5ldyBlYzIuVnBjKGNvbnRleHQuc2NvcGUsIGlkICsgXCItdnBjXCIse1xuICAgICAgICAgICAgICAgICAgICBpcEFkZHJlc3NlczogZWMyLklwQWRkcmVzc2VzLmNpZHIodGhpcy5wcmltYXJ5Q2lkcilcbiAgICAgICAgICAgICAgICB9KTsgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB2cGMgPSBuZXcgZWMyLlZwYyhjb250ZXh0LnNjb3BlLCBpZCArIFwiLXZwY1wiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIFxuICAgICAgICBpZiAodGhpcy5zZWNvbmRhcnlDaWRyKSB7XG4gICAgICAgICAgICB0aGlzLmNyZWF0ZVNlY29uZGFyeVN1Ym5ldHMoY29udGV4dCwgaWQsIHZwYyk7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgcmV0dXJuIHZwYztcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY3JlYXRlU2Vjb25kYXJ5U3VibmV0cyhjb250ZXh0OiBSZXNvdXJjZUNvbnRleHQsIGlkOiBzdHJpbmcsIHZwYzogZWMyLklWcGMpIHtcbiAgICAgICAgY29uc3Qgc2Vjb25kYXJ5U3VibmV0czogQXJyYXk8UHJpdmF0ZVN1Ym5ldD4gPSBbXTtcbiAgICAgICAgY29uc3Qgc2Vjb25kYXJ5Q2lkciA9IG5ldyBlYzIuQ2ZuVlBDQ2lkckJsb2NrKGNvbnRleHQuc2NvcGUsIGlkICsgXCItc2Vjb25kYXJ5Q2lkclwiLCB7XG4gICAgICAgICAgICB2cGNJZDogdnBjLnZwY0lkLFxuICAgICAgICAgICAgY2lkckJsb2NrOiB0aGlzLnNlY29uZGFyeUNpZHJcbiAgICAgICAgfSk7XG4gICAgICAgIHNlY29uZGFyeUNpZHIubm9kZS5hZGREZXBlbmRlbmN5KHZwYyk7XG4gICAgICAgIGlmICh0aGlzLnNlY29uZGFyeVN1Ym5ldENpZHJzKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZwYy5hdmFpbGFiaWxpdHlab25lcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnNlY29uZGFyeVN1Ym5ldENpZHJzW2ldKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlY29uZGFyeVN1Ym5ldHNbaV0gPSBuZXcgZWMyLlByaXZhdGVTdWJuZXQoY29udGV4dC5zY29wZSwgaWQgKyBcInByaXZhdGUtc3VibmV0LVwiICsgaSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmlsaXR5Wm9uZTogdnBjLmF2YWlsYWJpbGl0eVpvbmVzW2ldLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2lkckJsb2NrOiB0aGlzLnNlY29uZGFyeVN1Ym5ldENpZHJzW2ldLFxuICAgICAgICAgICAgICAgICAgICAgICAgdnBjSWQ6IHZwYy52cGNJZFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5U3VibmV0c1tpXS5ub2RlLmFkZERlcGVuZGVuY3koc2Vjb25kYXJ5Q2lkcik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQuYWRkKFwic2Vjb25kYXJ5LWNpZHItc3VibmV0LVwiICsgaSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZShfY29udGV4dCk6IElTdWJuZXQgeyByZXR1cm4gc2Vjb25kYXJ5U3VibmV0c1tpXTsgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKGxldCBzZWNvbmRhcnlTdWJuZXQgb2Ygc2Vjb25kYXJ5U3VibmV0cykge1xuICAgICAgICAgICAgICAgIFRhZ3Mub2Yoc2Vjb25kYXJ5U3VibmV0KS5hZGQoXCJrdWJlcm5ldGVzLmlvL3JvbGUvaW50ZXJuYWwtZWxiXCIsIFwiMVwiLCB7IGFwcGx5VG9MYXVuY2hlZEluc3RhbmNlczogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICBUYWdzLm9mKHNlY29uZGFyeVN1Ym5ldCkuYWRkKFwiTmFtZVwiLCBgYmx1ZXByaW50LWNvbnN0cnVjdC1kZXYtUHJpdmF0ZVN1Ym5ldC0ke3NlY29uZGFyeVN1Ym5ldH1gLCB7IGFwcGx5VG9MYXVuY2hlZEluc3RhbmNlczogdHJ1ZSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuXG5cbi8qXG4qKiBUaGlzIGZ1bmN0aW9uIHdpbGwgZ2l2ZSByZXR1cm4gdnBjIGJhc2VkIG9uIHRoZSBSZXNvdXJjZUNvbnRleHQgYW5kIHZwY0lkIHBhc3NlZCB0byB0aGUgY2x1c3Rlci5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFZQQ0Zyb21JZChjb250ZXh0OiBSZXNvdXJjZUNvbnRleHQsIG5vZGVJZDogc3RyaW5nLCB2cGNJZD86IHN0cmluZykge1xuICAgIGxldCB2cGMgPSB1bmRlZmluZWQ7XG4gICAgaWYgKHZwY0lkKSB7XG4gICAgICAgIGlmICh2cGNJZCA9PT0gXCJkZWZhdWx0XCIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBsb29raW5nIHVwIGNvbXBsZXRlbHkgZGVmYXVsdCBWUENgKTtcbiAgICAgICAgICAgIHZwYyA9IGVjMi5WcGMuZnJvbUxvb2t1cChjb250ZXh0LnNjb3BlLCBub2RlSWQgKyBcIi12cGNcIiwgeyBpc0RlZmF1bHQ6IHRydWUgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgbG9va2luZyB1cCBub24tZGVmYXVsdCAke3ZwY0lkfSBWUENgKTtcbiAgICAgICAgICAgIHZwYyA9IGVjMi5WcGMuZnJvbUxvb2t1cChjb250ZXh0LnNjb3BlLCBub2RlSWQgKyBcIi12cGNcIiwgeyB2cGNJZDogdnBjSWQgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHZwYztcbn1cblxuZXhwb3J0IGNsYXNzIERpcmVjdFZwY1Byb3ZpZGVyIGltcGxlbWVudHMgUmVzb3VyY2VQcm92aWRlcjxlYzIuSVZwYz4ge1xuICAgICBjb25zdHJ1Y3RvcihyZWFkb25seSB2cGM6IGVjMi5JVnBjKSB7IH1cblxuICAgIHByb3ZpZGUoX2NvbnRleHQ6IFJlc291cmNlQ29udGV4dCk6IGVjMi5JVnBjIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudnBjO1xuICAgIH0gICAgXG59XG5cbi8qKlxuICogRGlyZWN0IGltcG9ydCBzZWNvbmRhcnkgc3VibmV0IHByb3ZpZGVyLCBiYXNlZCBvbiBhIGtub3duIHN1Ym5ldCBJRC4gXG4gKiBSZWNvbW1lbmRlZCBtZXRob2QgaWYgc2Vjb25kYXJ5IHN1Ym5ldCBpZCBpcyBrbm93biwgYXMgaXQgYXZvaWRzIGV4dHJhIGxvb2stdXBzLlxuICovXG5leHBvcnQgY2xhc3MgTG9va3VwU3VibmV0UHJvdmlkZXIgaW1wbGVtZW50cyBSZXNvdXJjZVByb3ZpZGVyPElTdWJuZXQ+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHN1Ym5ldElkOiBzdHJpbmcpIHsgfVxuXG4gICAgcHJvdmlkZShjb250ZXh0OiBSZXNvdXJjZUNvbnRleHQpOiBlYzIuSVN1Ym5ldCB7XG4gICAgICAgIHJldHVybiBlYzIuU3VibmV0LmZyb21TdWJuZXRBdHRyaWJ1dGVzKGNvbnRleHQuc2NvcGUsIGAke3RoaXMuc3VibmV0SWR9LXNlY29uZGFyeXN1Ym5ldGAsIHtzdWJuZXRJZDogdGhpcy5zdWJuZXRJZH0pO1xuICAgIH1cbn1cbiJdfQ==