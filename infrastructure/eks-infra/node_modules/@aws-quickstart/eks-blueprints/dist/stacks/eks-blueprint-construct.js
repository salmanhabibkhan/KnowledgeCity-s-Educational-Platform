"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EksBlueprintConstruct = exports.BlueprintConstructBuilder = exports.BlueprintPropsConstraints = exports.EksBlueprintProps = exports.ControlPlaneLogType = exports.DEFAULT_VERSION = void 0;
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
Object.defineProperty(exports, "ControlPlaneLogType", { enumerable: true, get: function () { return aws_eks_1.ClusterLoggingTypes; } });
const constructs_1 = require("constructs");
const mng_cluster_provider_1 = require("../cluster-providers/mng-cluster-provider");
const vpc_1 = require("../resource-providers/vpc");
const spi = require("../spi");
const constraints = require("../utils/constraints-utils");
const utils = require("../utils");
const utils_1 = require("../utils");
const kms_key_1 = require("../resource-providers/kms-key");
const argo_gitops_factory_1 = require("../addons/argocd/argo-gitops-factory");
const eks = require("aws-cdk-lib/aws-eks");
/* Default K8s version of EKS Blueprints */
exports.DEFAULT_VERSION = aws_eks_1.KubernetesVersion.V1_31;
class EksBlueprintProps {
    constructor() {
        /**
         * Add-ons if any.
         */
        this.addOns = [];
        /**
         * Teams if any
         */
        this.teams = [];
        /**
         * EC2 or Fargate are supported in the blueprint but any implementation conforming the interface
         * will work
         */
        this.clusterProvider = new mng_cluster_provider_1.MngClusterProvider();
        /**
         * Named resource providers to leverage for cluster resources.
         * The resource can represent Vpc, Hosting Zones or other resources, see {@link spi.ResourceType}.
         * VPC for the cluster can be registered under the name of 'vpc' or as a single provider of type
         */
        this.resourceProviders = new Map();
        /**
         * If set to true and no resouce provider for KMS key is defined (under GlobalResources.KmsKey),
         * a default KMS encryption key will be used for envelope encryption of Kubernetes secrets (AWS managed new KMS key).
         * If set to false, and no resouce provider for KMS key is defined (under GlobalResources.KmsKey), then no secrets
         * encyrption is applied.
         *
         * Default is true.
         */
        this.useDefaultSecretEncryption = true;
    }
}
exports.EksBlueprintProps = EksBlueprintProps;
class BlueprintPropsConstraints {
    constructor() {
        /**
         * id can be no less than 1 character long, and no greater than 63 characters long.
         * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
         */
        this.id = new constraints.StringConstraint(1, 63);
        /**
         * name can be no less than 1 character long, and no greater than 63 characters long.
         * https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
         */
        this.name = new constraints.StringConstraint(1, 63);
    }
}
exports.BlueprintPropsConstraints = BlueprintPropsConstraints;
/**
 * Blueprint builder implements a builder pattern that improves readability (no bloated constructors)
 * and allows creating a blueprint in an abstract state that can be applied to various instantiations
 * in accounts and regions.
 */
class BlueprintConstructBuilder {
    constructor() {
        this.props = { addOns: new Array(), teams: new Array(), resourceProviders: new Map() };
        this.env = {
            account: process.env.CDK_DEFAULT_ACCOUNT,
            region: process.env.CDK_DEFAULT_REGION
        };
    }
    name(name) {
        this.props = { ...this.props, ...{ name } };
        return this;
    }
    account(account) {
        this.env.account = account;
        return this;
    }
    region(region) {
        this.env.region = region;
        return this;
    }
    version(version) {
        this.props = { ...this.props, ...{ version: version } };
        return this;
    }
    /**
     * Adding ipFamily method to support IPv6 clusters. By default, it uses IPv4 as the value.
     */
    ipFamily(ipFamily = eks.IpFamily.IP_V4) {
        this.props = { ...this.props, ...{ ipFamily: ipFamily } };
        return this;
    }
    enableControlPlaneLogTypes(...types) {
        this.props = { ...this.props, ...{ enableControlPlaneLogTypes: types } };
        return this;
    }
    enableGitOps(mode) {
        this.props = { ...this.props, ...{ enableGitOpsMode: mode !== null && mode !== void 0 ? mode : spi.GitOpsMode.APP_OF_APPS } };
        return this;
    }
    withBlueprintProps(props) {
        const resourceProviders = this.props.resourceProviders;
        this.props = { ...this.props, ...(0, utils_1.cloneDeep)(props) };
        if (props.resourceProviders) {
            this.props.resourceProviders = new Map([...resourceProviders.entries(), ...props.resourceProviders.entries()]);
        }
        return this;
    }
    addOns(...addOns) {
        var _a;
        this.props = { ...this.props, ...{ addOns: (_a = this.props.addOns) === null || _a === void 0 ? void 0 : _a.concat(addOns) } };
        return this;
    }
    clusterProvider(clusterProvider) {
        this.props = { ...this.props, ...{ clusterProvider: clusterProvider } };
        return this;
    }
    id(id) {
        this.props = { ...this.props, ...{ id } };
        return this;
    }
    teams(...teams) {
        var _a;
        this.props = { ...this.props, ...{ teams: (_a = this.props.teams) === null || _a === void 0 ? void 0 : _a.concat(teams) } };
        return this;
    }
    resourceProvider(name, provider) {
        var _a;
        (_a = this.props.resourceProviders) === null || _a === void 0 ? void 0 : _a.set(name, provider);
        return this;
    }
    useDefaultSecretEncryption(useDefault) {
        this.props = { ...this.props, ...{ useDefaultSecretEncryption: useDefault } };
        return this;
    }
    withEnv(env) {
        this.env.account = env.account;
        this.env.region = env.region;
        return this;
    }
}
exports.BlueprintConstructBuilder = BlueprintConstructBuilder;
/**
 * Entry point to the platform provisioning. Creates a CFN stack based on the provided configuration
 * and orchestrates provisioning of add-ons, teams and post deployment hooks.
 */
class EksBlueprintConstruct extends constructs_1.Construct {
    constructor(parent, blueprintProps) {
        var _a, _b, _c;
        super(parent, blueprintProps.id + "-ct");
        this.validateInput(blueprintProps);
        const scope = blueprintProps.compatibilityMode ? parent : this;
        const resourceContext = this.provideNamedResources(blueprintProps, scope);
        let vpcResource = resourceContext.get(spi.GlobalResources.Vpc);
        if (!vpcResource) {
            vpcResource = resourceContext.add(spi.GlobalResources.Vpc, new vpc_1.VpcProvider());
        }
        let version = blueprintProps.version;
        if (version == "auto") {
            version = exports.DEFAULT_VERSION;
        }
        let kmsKeyResource = resourceContext.get(spi.GlobalResources.KmsKey);
        if (!kmsKeyResource && blueprintProps.useDefaultSecretEncryption != false) {
            kmsKeyResource = resourceContext.add(spi.GlobalResources.KmsKey, new kms_key_1.CreateKmsKeyProvider());
        }
        blueprintProps = this.resolveDynamicProxies(blueprintProps, resourceContext);
        const clusterProvider = (_a = blueprintProps.clusterProvider) !== null && _a !== void 0 ? _a : new mng_cluster_provider_1.MngClusterProvider({
            id: `${(_b = blueprintProps.name) !== null && _b !== void 0 ? _b : blueprintProps.id}-ng`,
            version
        });
        this.clusterInfo = clusterProvider.createCluster(scope, vpcResource, kmsKeyResource, version, blueprintProps.enableControlPlaneLogTypes, blueprintProps.ipFamily);
        this.clusterInfo.setResourceContext(resourceContext);
        if (blueprintProps.enableGitOpsMode == spi.GitOpsMode.APPLICATION) {
            argo_gitops_factory_1.ArgoGitOpsFactory.enableGitOps();
        }
        else if (blueprintProps.enableGitOpsMode == spi.GitOpsMode.APP_OF_APPS) {
            argo_gitops_factory_1.ArgoGitOpsFactory.enableGitOpsAppOfApps();
        }
        const postDeploymentSteps = Array();
        for (let addOn of ((_c = blueprintProps.addOns) !== null && _c !== void 0 ? _c : [])) { // must iterate in the strict order
            const result = addOn.deploy(this.clusterInfo);
            if (result) {
                const addOnKey = utils.getAddOnNameOrId(addOn);
                this.clusterInfo.addScheduledAddOn(addOnKey, result, utils.isOrderedAddOn(addOn));
            }
            const postDeploy = addOn;
            if (postDeploy.postDeploy !== undefined) {
                postDeploymentSteps.push(postDeploy);
            }
        }
        const scheduledAddOns = this.clusterInfo.getAllScheduledAddons();
        const addOnKeys = [...scheduledAddOns.keys()];
        const promises = scheduledAddOns.values();
        this.asyncTasks = Promise.all(promises).then((constructs) => {
            var _a;
            constructs.forEach((construct, index) => {
                this.clusterInfo.addProvisionedAddOn(addOnKeys[index], construct);
            });
            if (blueprintProps.teams != null) {
                for (let team of blueprintProps.teams) {
                    team.setup(this.clusterInfo);
                }
            }
            for (let step of postDeploymentSteps) {
                step.postDeploy(this.clusterInfo, (_a = blueprintProps.teams) !== null && _a !== void 0 ? _a : []);
            }
        });
        this.asyncTasks.catch(err => {
            console.error(err);
            throw new Error(err);
        });
    }
    /**
     * Since constructor cannot be marked as async, adding a separate method to wait
     * for async code to finish.
     * @returns Promise that resolves to the blueprint
     */
    async waitForAsyncTasks() {
        if (this.asyncTasks) {
            return this.asyncTasks.then(() => {
                return this;
            });
        }
        return Promise.resolve(this);
    }
    /**
     * This method returns all the constructs produced by during the cluster creation (e.g. add-ons).
     * May be used in testing for verification.
     * @returns Async Tasks object
     */
    getAsyncTasks() {
        return this.asyncTasks;
    }
    /**
     * This method returns all the constructs produced by during the cluster creation (e.g. add-ons).
     * May be used in testing for verification.
     * @returns cluster info object
     */
    getClusterInfo() {
        return this.clusterInfo;
    }
    provideNamedResources(blueprintProps, scope) {
        var _a;
        const result = new spi.ResourceContext(scope, blueprintProps);
        for (let [key, value] of (_a = blueprintProps.resourceProviders) !== null && _a !== void 0 ? _a : []) {
            result.add(key, value);
        }
        return result;
    }
    /**
     * Resolves all dynamic proxies, that substitutes resource provider proxies with the resolved values.
     * @param blueprintProps
     * @param resourceContext
     * @returns a copy of blueprint props with resolved values
     */
    resolveDynamicProxies(blueprintProps, resourceContext) {
        return utils.cloneDeep(blueprintProps, (value) => {
            return utils.resolveTarget(value, resourceContext);
        });
    }
    /**
     * Validates input against basic defined constraints.
     * @param blueprintProps
     */
    validateInput(blueprintProps) {
        const teamNames = new Set();
        constraints.validateConstraints(new BlueprintPropsConstraints, EksBlueprintProps.name, blueprintProps);
        if (blueprintProps.teams) {
            blueprintProps.teams.forEach(e => {
                if (teamNames.has(e.name)) {
                    throw new Error(`Team ${e.name} is registered more than once`);
                }
                teamNames.add(e.name);
            });
        }
    }
}
exports.EksBlueprintConstruct = EksBlueprintConstruct;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWtzLWJsdWVwcmludC1jb25zdHJ1Y3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9saWIvc3RhY2tzL2Vrcy1ibHVlcHJpbnQtY29uc3RydWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLGlEQUFvRztBQW1CM0Ysb0dBbkJ1Qiw2QkFBbUIsT0FtQnZCO0FBbEI1QiwyQ0FBdUM7QUFDdkMsb0ZBQStFO0FBQy9FLG1EQUF3RDtBQUN4RCw4QkFBOEI7QUFDOUIsMERBQTBEO0FBQzFELGtDQUFrQztBQUNsQyxvQ0FBcUM7QUFFckMsMkRBQW1FO0FBQ25FLDhFQUF5RTtBQUV6RSwyQ0FBMkM7QUFDM0MsMkNBQTJDO0FBQzlCLFFBQUEsZUFBZSxHQUFHLDJCQUFpQixDQUFDLEtBQUssQ0FBQztBQU92RCxNQUFhLGlCQUFpQjtJQUE5QjtRQVdJOztXQUVHO1FBQ00sV0FBTSxHQUE2QixFQUFFLENBQUM7UUFFL0M7O1dBRUc7UUFDTSxVQUFLLEdBQXFCLEVBQUUsQ0FBQztRQUV0Qzs7O1dBR0c7UUFDTSxvQkFBZSxHQUF5QixJQUFJLHlDQUFrQixFQUFFLENBQUM7UUFPMUU7Ozs7V0FJRztRQUNILHNCQUFpQixHQUF1QyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBUWxFOzs7Ozs7O1dBT0c7UUFDTSwrQkFBMEIsR0FBZSxJQUFJLENBQUM7SUFpQjNELENBQUM7Q0FBQTtBQXRFRCw4Q0FzRUM7QUFFRCxNQUFhLHlCQUF5QjtJQUF0QztRQUNJOzs7V0FHRztRQUNILE9BQUUsR0FBRyxJQUFJLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFN0M7OztXQUdHO1FBQ0gsU0FBSSxHQUFHLElBQUksV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNuRCxDQUFDO0NBQUE7QUFaRCw4REFZQztBQUVEOzs7O0dBSUc7QUFDSCxNQUFhLHlCQUF5QjtJQVFsQztR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ZGstbGliJztcbmltcG9ydCB7IElWcGMgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCB7IENsdXN0ZXJMb2dnaW5nVHlwZXMgYXMgQ29udHJvbFBsYW5lTG9nVHlwZSwgS3ViZXJuZXRlc1ZlcnNpb24gfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWtzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgTW5nQ2x1c3RlclByb3ZpZGVyIH0gZnJvbSAnLi4vY2x1c3Rlci1wcm92aWRlcnMvbW5nLWNsdXN0ZXItcHJvdmlkZXInO1xuaW1wb3J0IHsgVnBjUHJvdmlkZXIgfSBmcm9tICcuLi9yZXNvdXJjZS1wcm92aWRlcnMvdnBjJztcbmltcG9ydCAqIGFzIHNwaSBmcm9tICcuLi9zcGknO1xuaW1wb3J0ICogYXMgY29uc3RyYWludHMgZnJvbSAnLi4vdXRpbHMvY29uc3RyYWludHMtdXRpbHMnO1xuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgSUtleSB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mta21zXCI7XG5pbXBvcnQge0NyZWF0ZUttc0tleVByb3ZpZGVyfSBmcm9tIFwiLi4vcmVzb3VyY2UtcHJvdmlkZXJzL2ttcy1rZXlcIjtcbmltcG9ydCB7IEFyZ29HaXRPcHNGYWN0b3J5IH0gZnJvbSBcIi4uL2FkZG9ucy9hcmdvY2QvYXJnby1naXRvcHMtZmFjdG9yeVwiO1xuXG5pbXBvcnQgKiBhcyBla3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1la3NcIjtcbi8qIERlZmF1bHQgSzhzIHZlcnNpb24gb2YgRUtTIEJsdWVwcmludHMgKi9cbmV4cG9ydCBjb25zdCBERUZBVUxUX1ZFUlNJT04gPSBLdWJlcm5ldGVzVmVyc2lvbi5WMV8zMTtcblxuLyoqXG4gKiAgRXhwb3J0aW5nIGNvbnRyb2wgcGxhbmUgbG9nIHR5cGUgc28gdGhhdCBjdXN0b21lcnMgZG9uJ3QgaGF2ZSB0byBpbXBvcnQgQ0RLIEVLUyBtb2R1bGUgZm9yIGJsdWVwcmludCBjb25maWd1cmF0aW9uLlxuICovXG5leHBvcnQgeyBDb250cm9sUGxhbmVMb2dUeXBlIH07XG5cbmV4cG9ydCBjbGFzcyBFa3NCbHVlcHJpbnRQcm9wcyB7XG4gICAgLyoqXG4gICAgICogVGhlIGlkIGZvciB0aGUgYmx1ZXByaW50LlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBEZWZhdWx0cyB0byBpZCBpZiBub3QgcHJvdmlkZWRcbiAgICAgKi9cbiAgICByZWFkb25seSBuYW1lPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogQWRkLW9ucyBpZiBhbnkuXG4gICAgICovXG4gICAgcmVhZG9ubHkgYWRkT25zPzogQXJyYXk8c3BpLkNsdXN0ZXJBZGRPbj4gPSBbXTtcblxuICAgIC8qKlxuICAgICAqIFRlYW1zIGlmIGFueVxuICAgICAqL1xuICAgIHJlYWRvbmx5IHRlYW1zPzogQXJyYXk8c3BpLlRlYW0+ID0gW107XG5cbiAgICAvKipcbiAgICAgKiBFQzIgb3IgRmFyZ2F0ZSBhcmUgc3VwcG9ydGVkIGluIHRoZSBibHVlcHJpbnQgYnV0IGFueSBpbXBsZW1lbnRhdGlvbiBjb25mb3JtaW5nIHRoZSBpbnRlcmZhY2VcbiAgICAgKiB3aWxsIHdvcmtcbiAgICAgKi9cbiAgICByZWFkb25seSBjbHVzdGVyUHJvdmlkZXI/OiBzcGkuQ2x1c3RlclByb3ZpZGVyID0gbmV3IE1uZ0NsdXN0ZXJQcm92aWRlcigpO1xuXG4gICAgLyoqXG4gICAgICogS3ViZXJuZXRlcyB2ZXJzaW9uIChtdXN0IGJlIGluaXRpYWxpemVkIGZvciBhZGRvbnMgdG8gd29yayBwcm9wZXJseSlcbiAgICAgKi9cbiAgICByZWFkb25seSB2ZXJzaW9uPzogS3ViZXJuZXRlc1ZlcnNpb24gfCBcImF1dG9cIjtcblxuICAgIC8qKlxuICAgICAqIE5hbWVkIHJlc291cmNlIHByb3ZpZGVycyB0byBsZXZlcmFnZSBmb3IgY2x1c3RlciByZXNvdXJjZXMuXG4gICAgICogVGhlIHJlc291cmNlIGNhbiByZXByZXNlbnQgVnBjLCBIb3N0aW5nIFpvbmVzIG9yIG90aGVyIHJlc291cmNlcywgc2VlIHtAbGluayBzcGkuUmVzb3VyY2VUeXBlfS5cbiAgICAgKiBWUEMgZm9yIHRoZSBjbHVzdGVyIGNhbiBiZSByZWdpc3RlcmVkIHVuZGVyIHRoZSBuYW1lIG9mICd2cGMnIG9yIGFzIGEgc2luZ2xlIHByb3ZpZGVyIG9mIHR5cGVcbiAgICAgKi9cbiAgICByZXNvdXJjZVByb3ZpZGVycz86IE1hcDxzdHJpbmcsIHNwaS5SZXNvdXJjZVByb3ZpZGVyPiA9IG5ldyBNYXAoKTtcblxuICAgIC8qKlxuICAgICAqIENvbnRyb2wgUGxhbmUgbG9nIHR5cGVzIHRvIGJlIGVuYWJsZWQgKGlmIG5vdCBwYXNzZWQsIG5vbmUpXG4gICAgICogSWYgd3JvbmcgdHlwZXMgYXJlIGluY2x1ZGVkLCB3aWxsIHRocm93IGFuIGVycm9yLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGVuYWJsZUNvbnRyb2xQbGFuZUxvZ1R5cGVzPzogQ29udHJvbFBsYW5lTG9nVHlwZVtdO1xuXG4gICAgLyoqXG4gICAgICogSWYgc2V0IHRvIHRydWUgYW5kIG5vIHJlc291Y2UgcHJvdmlkZXIgZm9yIEtNUyBrZXkgaXMgZGVmaW5lZCAodW5kZXIgR2xvYmFsUmVzb3VyY2VzLkttc0tleSksXG4gICAgICogYSBkZWZhdWx0IEtNUyBlbmNyeXB0aW9uIGtleSB3aWxsIGJlIHVzZWQgZm9yIGVudmVsb3BlIGVuY3J5cHRpb24gb2YgS3ViZXJuZXRlcyBzZWNyZXRzIChBV1MgbWFuYWdlZCBuZXcgS01TIGtleSkuXG4gICAgICogSWYgc2V0IHRvIGZhbHNlLCBhbmQgbm8gcmVzb3VjZSBwcm92aWRlciBmb3IgS01TIGtleSBpcyBkZWZpbmVkICh1bmRlciBHbG9iYWxSZXNvdXJjZXMuS21zS2V5KSwgdGhlbiBubyBzZWNyZXRzXG4gICAgICogZW5jeXJwdGlvbiBpcyBhcHBsaWVkLlxuICAgICAqXG4gICAgICogRGVmYXVsdCBpcyB0cnVlLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IHVzZURlZmF1bHRTZWNyZXRFbmNyeXB0aW9uPyA6IGJvb2xlYW4gID0gdHJ1ZTtcblxuICAgIC8qKlxuICAgICAqIEdpdE9wcyBtb2RlcyB0byBiZSBlbmFibGVkLiBJZiBub3Qgc3BlY2lmaWVkLCBHaXRPcHMgbW9kZSBpcyBub3QgZW5hYmxlZC5cbiAgICAgKi9cbiAgICByZWFkb25seSBlbmFibGVHaXRPcHNNb2RlPzogc3BpLkdpdE9wc01vZGU7XG5cbiAgICAvKipcbiAgICAgKiBXaGVuIHNldCB0byB0cnVlLCB3aWxsIG5vdCB1c2UgZXh0cmEgbmVzdGluZyBmb3IgYmx1ZXByaW50IHJlc291cmNlcyBhbmQgYXR0YWNoIHRoZW0gZGlyZWN0bHkgdG8gdGhlIHN0YWNrLlxuICAgICAqL1xuICAgIHJlYWRvbmx5IGNvbXBhdGliaWxpdHlNb2RlPzogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqIGlwRmFtaWx5IHRvIHN1cHBvcnQgSVB2NiBjbHVzdGVycy4gQnkgZGVmYXVsdCwgaXQgdXNlcyBJUHY0IGFzIHRoZSB2YWx1ZS5cbiAgICAgKi9cbiAgICByZWFkb25seSBpcEZhbWlseT86IGVrcy5JcEZhbWlseTtcblxufVxuXG5leHBvcnQgY2xhc3MgQmx1ZXByaW50UHJvcHNDb25zdHJhaW50cyBpbXBsZW1lbnRzIGNvbnN0cmFpbnRzLkNvbnN0cmFpbnRzVHlwZTxFa3NCbHVlcHJpbnRQcm9wcz4ge1xuICAgIC8qKlxuICAgICAqIGlkIGNhbiBiZSBubyBsZXNzIHRoYW4gMSBjaGFyYWN0ZXIgbG9uZywgYW5kIG5vIGdyZWF0ZXIgdGhhbiA2MyBjaGFyYWN0ZXJzIGxvbmcuXG4gICAgICogaHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvY29uY2VwdHMvb3ZlcnZpZXcvd29ya2luZy13aXRoLW9iamVjdHMvbmFtZXMvXG4gICAgICovXG4gICAgaWQgPSBuZXcgY29uc3RyYWludHMuU3RyaW5nQ29uc3RyYWludCgxLCA2Myk7XG5cbiAgICAvKipcbiAgICAgKiBuYW1lIGNhbiBiZSBubyBsZXNzIHRoYW4gMSBjaGFyYWN0ZXIgbG9uZywgYW5kIG5vIGdyZWF0ZXIgdGhhbiA2MyBjaGFyYWN0ZXJzIGxvbmcuXG4gICAgICogaHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvY29uY2VwdHMvb3ZlcnZpZXcvd29ya2luZy13aXRoLW9iamVjdHMvbmFtZXMvXG4gICAgICovXG4gICAgbmFtZSA9IG5ldyBjb25zdHJhaW50cy5TdHJpbmdDb25zdHJhaW50KDEsIDYzKTtcbn1cblxuLyoqXG4gKiBCbHVlcHJpbnQgYnVpbGRlciBpbXBsZW1lbnRzIGEgYnVpbGRlciBwYXR0ZXJuIHRoYXQgaW1wcm92ZXMgcmVhZGFiaWxpdHkgKG5vIGJsb2F0ZWQgY29uc3RydWN0b3JzKVxuICogYW5kIGFsbG93cyBjcmVhdGluZyBhIGJsdWVwcmludCBpbiBhbiBhYnN0cmFjdCBzdGF0ZSB0aGF0IGNhbiBiZSBhcHBsaWVkIHRvIHZhcmlvdXMgaW5zdGFudGlhdGlvbnNcbiAqIGluIGFjY291bnRzIGFuZCByZWdpb25zLlxuICovXG5leHBvcnQgY2xhc3MgQmx1ZXByaW50Q29uc3RydWN0QnVpbGRlciB7XG5cbiAgICBwcm9wczogUGFydGlhbDxFa3NCbHVlcHJpbnRQcm9wcz47XG4gICAgZW52OiB7XG4gICAgICAgIGFjY291bnQ/OiBzdHJpbmcsXG4gICAgICAgIHJlZ2lvbj86IHN0cmluZ1xuICAgIH07XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgYWRkT25zOiBuZXcgQXJyYXk8c3BpLkNsdXN0ZXJBZGRPbj4oKSwgdGVhbXM6IG5ldyBBcnJheTxzcGkuVGVhbT4oKSwgcmVzb3VyY2VQcm92aWRlcnM6IG5ldyBNYXAoKSB9O1xuICAgICAgICB0aGlzLmVudiA9IHtcbiAgICAgICAgICAgIGFjY291bnQ6IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQsXG4gICAgICAgICAgICByZWdpb246IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX1JFR0lPTlxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBuYW1lKG5hbWU6IHN0cmluZyk6IHRoaXMge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi57IG5hbWUgfSB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgYWNjb3VudChhY2NvdW50Pzogc3RyaW5nKTogdGhpcyB7XG4gICAgICAgIHRoaXMuZW52LmFjY291bnQgPSBhY2NvdW50O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVnaW9uKHJlZ2lvbj86IHN0cmluZyk6IHRoaXMge1xuICAgICAgICB0aGlzLmVudi5yZWdpb24gPSByZWdpb247XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB2ZXJzaW9uKHZlcnNpb246IFwiYXV0b1wiIHwgS3ViZXJuZXRlc1ZlcnNpb24pOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4ueyB2ZXJzaW9uOiB2ZXJzaW9uIH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkaW5nIGlwRmFtaWx5IG1ldGhvZCB0byBzdXBwb3J0IElQdjYgY2x1c3RlcnMuIEJ5IGRlZmF1bHQsIGl0IHVzZXMgSVB2NCBhcyB0aGUgdmFsdWUuXG4gICAgICovXG4gICAgcHVibGljIGlwRmFtaWx5KGlwRmFtaWx5OiAgZWtzLklwRmFtaWx5ID0gZWtzLklwRmFtaWx5LklQX1Y0KTogdGhpcyB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IC4uLnRoaXMucHJvcHMsIC4uLnsgaXBGYW1pbHk6IGlwRmFtaWx5IH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGVuYWJsZUNvbnRyb2xQbGFuZUxvZ1R5cGVzKC4uLnR5cGVzOiBDb250cm9sUGxhbmVMb2dUeXBlW10pOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4ueyBlbmFibGVDb250cm9sUGxhbmVMb2dUeXBlczogdHlwZXMgfSB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgZW5hYmxlR2l0T3BzKG1vZGU/OiBzcGkuR2l0T3BzTW9kZSk6IHRoaXMge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi57IGVuYWJsZUdpdE9wc01vZGU6IG1vZGUgPz8gc3BpLkdpdE9wc01vZGUuQVBQX09GX0FQUFMgfSB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgd2l0aEJsdWVwcmludFByb3BzKHByb3BzOiBQYXJ0aWFsPEVrc0JsdWVwcmludFByb3BzPik6IHRoaXMge1xuICAgICAgICBjb25zdCByZXNvdXJjZVByb3ZpZGVycyA9IHRoaXMucHJvcHMucmVzb3VyY2VQcm92aWRlcnMhO1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi5jbG9uZURlZXAocHJvcHMpIH07XG4gICAgICAgIGlmIChwcm9wcy5yZXNvdXJjZVByb3ZpZGVycykge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5yZXNvdXJjZVByb3ZpZGVycyA9IG5ldyBNYXAoWy4uLnJlc291cmNlUHJvdmlkZXJzIS5lbnRyaWVzKCksIC4uLnByb3BzLnJlc291cmNlUHJvdmlkZXJzLmVudHJpZXMoKV0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRPbnMoLi4uYWRkT25zOiBzcGkuQ2x1c3RlckFkZE9uW10pOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHsgLi4udGhpcy5wcm9wcywgLi4ueyBhZGRPbnM6IHRoaXMucHJvcHMuYWRkT25zPy5jb25jYXQoYWRkT25zKSB9IH07XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBjbHVzdGVyUHJvdmlkZXIoY2x1c3RlclByb3ZpZGVyOiBzcGkuQ2x1c3RlclByb3ZpZGVyKSB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IC4uLnRoaXMucHJvcHMsIC4uLnsgY2x1c3RlclByb3ZpZGVyOiBjbHVzdGVyUHJvdmlkZXIgfSB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgaWQoaWQ6IHN0cmluZyk6IHRoaXMge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi57IGlkIH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHRlYW1zKC4uLnRlYW1zOiBzcGkuVGVhbVtdKTogdGhpcyB7XG4gICAgICAgIHRoaXMucHJvcHMgPSB7IC4uLnRoaXMucHJvcHMsIC4uLnsgdGVhbXM6IHRoaXMucHJvcHMudGVhbXM/LmNvbmNhdCh0ZWFtcykgfSB9O1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVzb3VyY2VQcm92aWRlcihuYW1lOiBzdHJpbmcsIHByb3ZpZGVyOiBzcGkuUmVzb3VyY2VQcm92aWRlcik6IHRoaXMge1xuICAgICAgICB0aGlzLnByb3BzLnJlc291cmNlUHJvdmlkZXJzPy5zZXQobmFtZSwgcHJvdmlkZXIpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgdXNlRGVmYXVsdFNlY3JldEVuY3J5cHRpb24odXNlRGVmYXVsdDogYm9vbGVhbik6IHRoaXMge1xuICAgICAgICB0aGlzLnByb3BzID0geyAuLi50aGlzLnByb3BzLCAuLi57IHVzZURlZmF1bHRTZWNyZXRFbmNyeXB0aW9uOiB1c2VEZWZhdWx0IH0gfTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHdpdGhFbnYoZW52OiBjZGsuRW52aXJvbm1lbnQpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5lbnYuYWNjb3VudCA9IGVudi5hY2NvdW50O1xuICAgICAgICB0aGlzLmVudi5yZWdpb24gPSBlbnYucmVnaW9uO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbn1cblxuLyoqXG4gKiBFbnRyeSBwb2ludCB0byB0aGUgcGxhdGZvcm0gcHJvdmlzaW9uaW5nLiBDcmVhdGVzIGEgQ0ZOIHN0YWNrIGJhc2VkIG9uIHRoZSBwcm92aWRlZCBjb25maWd1cmF0aW9uXG4gKiBhbmQgb3JjaGVzdHJhdGVzIHByb3Zpc2lvbmluZyBvZiBhZGQtb25zLCB0ZWFtcyBhbmQgcG9zdCBkZXBsb3ltZW50IGhvb2tzLlxuICovXG5leHBvcnQgY2xhc3MgRWtzQmx1ZXByaW50Q29uc3RydWN0IGV4dGVuZHMgQ29uc3RydWN0IHtcblxuICAgIHByaXZhdGUgYXN5bmNUYXNrczogUHJvbWlzZTx2b2lkIHwgQ29uc3RydWN0W10+O1xuXG4gICAgcHJpdmF0ZSBjbHVzdGVySW5mbzogc3BpLkNsdXN0ZXJJbmZvO1xuXG4gICAgY29uc3RydWN0b3IocGFyZW50OiBDb25zdHJ1Y3QsIGJsdWVwcmludFByb3BzOiBFa3NCbHVlcHJpbnRQcm9wcykge1xuICAgICAgICBzdXBlcihwYXJlbnQsIGJsdWVwcmludFByb3BzLmlkICsgXCItY3RcIiApO1xuICAgICAgICB0aGlzLnZhbGlkYXRlSW5wdXQoYmx1ZXByaW50UHJvcHMpO1xuXG4gICAgICAgIGNvbnN0IHNjb3BlID0gYmx1ZXByaW50UHJvcHMuY29tcGF0aWJpbGl0eU1vZGUgPyBwYXJlbnQgOiB0aGlzO1xuXG4gICAgICAgIGNvbnN0IHJlc291cmNlQ29udGV4dCA9IHRoaXMucHJvdmlkZU5hbWVkUmVzb3VyY2VzKGJsdWVwcmludFByb3BzLCBzY29wZSk7XG5cbiAgICAgICAgbGV0IHZwY1Jlc291cmNlOiBJVnBjIHwgdW5kZWZpbmVkID0gcmVzb3VyY2VDb250ZXh0LmdldChzcGkuR2xvYmFsUmVzb3VyY2VzLlZwYyk7XG5cbiAgICAgICAgaWYgKCF2cGNSZXNvdXJjZSkge1xuICAgICAgICAgICAgdnBjUmVzb3VyY2UgPSByZXNvdXJjZUNvbnRleHQuYWRkKHNwaS5HbG9iYWxSZXNvdXJjZXMuVnBjLCBuZXcgVnBjUHJvdmlkZXIoKSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdmVyc2lvbiA9IGJsdWVwcmludFByb3BzLnZlcnNpb247XG4gICAgICAgIGlmICh2ZXJzaW9uID09IFwiYXV0b1wiKSB7XG4gICAgICAgICAgICB2ZXJzaW9uID0gREVGQVVMVF9WRVJTSU9OO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGttc0tleVJlc291cmNlOiBJS2V5IHwgdW5kZWZpbmVkID0gcmVzb3VyY2VDb250ZXh0LmdldChzcGkuR2xvYmFsUmVzb3VyY2VzLkttc0tleSk7XG5cbiAgICAgICAgaWYgKCFrbXNLZXlSZXNvdXJjZSAmJiBibHVlcHJpbnRQcm9wcy51c2VEZWZhdWx0U2VjcmV0RW5jcnlwdGlvbiAhPSBmYWxzZSkge1xuICAgICAgICAgICAga21zS2V5UmVzb3VyY2UgPSByZXNvdXJjZUNvbnRleHQuYWRkKHNwaS5HbG9iYWxSZXNvdXJjZXMuS21zS2V5LCBuZXcgQ3JlYXRlS21zS2V5UHJvdmlkZXIoKSk7XG4gICAgICAgIH1cblxuICAgICAgICBibHVlcHJpbnRQcm9wcyA9IHRoaXMucmVzb2x2ZUR5bmFtaWNQcm94aWVzKGJsdWVwcmludFByb3BzLCByZXNvdXJjZUNvbnRleHQpO1xuXG4gICAgICAgIGNvbnN0IGNsdXN0ZXJQcm92aWRlciA9IGJsdWVwcmludFByb3BzLmNsdXN0ZXJQcm92aWRlciA/PyBuZXcgTW5nQ2x1c3RlclByb3ZpZGVyKHtcbiAgICAgICAgICAgIGlkOiBgJHtibHVlcHJpbnRQcm9wcy5uYW1lID8/IGJsdWVwcmludFByb3BzLmlkfS1uZ2AsXG4gICAgICAgICAgICB2ZXJzaW9uXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuY2x1c3RlckluZm8gPSBjbHVzdGVyUHJvdmlkZXIuY3JlYXRlQ2x1c3RlcihzY29wZSwgdnBjUmVzb3VyY2UhLCBrbXNLZXlSZXNvdXJjZSwgdmVyc2lvbiwgYmx1ZXByaW50UHJvcHMuZW5hYmxlQ29udHJvbFBsYW5lTG9nVHlwZXMsIGJsdWVwcmludFByb3BzLmlwRmFtaWx5KTtcbiAgICAgICAgdGhpcy5jbHVzdGVySW5mby5zZXRSZXNvdXJjZUNvbnRleHQocmVzb3VyY2VDb250ZXh0KTtcblxuICAgICAgICBpZiAoYmx1ZXByaW50UHJvcHMuZW5hYmxlR2l0T3BzTW9kZSA9PSBzcGkuR2l0T3BzTW9kZS5BUFBMSUNBVElPTikge1xuICAgICAgICAgICAgQXJnb0dpdE9wc0ZhY3RvcnkuZW5hYmxlR2l0T3BzKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoYmx1ZXByaW50UHJvcHMuZW5hYmxlR2l0T3BzTW9kZSA9PSBzcGkuR2l0T3BzTW9kZS5BUFBfT0ZfQVBQUykge1xuICAgICAgICAgICAgQXJnb0dpdE9wc0ZhY3RvcnkuZW5hYmxlR2l0T3BzQXBwT2ZBcHBzKCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwb3N0RGVwbG95bWVudFN0ZXBzID0gQXJyYXk8c3BpLkNsdXN0ZXJQb3N0RGVwbG95PigpO1xuXG4gICAgICAgIGZvciAobGV0IGFkZE9uIG9mIChibHVlcHJpbnRQcm9wcy5hZGRPbnMgPz8gW10pKSB7IC8vIG11c3QgaXRlcmF0ZSBpbiB0aGUgc3RyaWN0IG9yZGVyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhZGRPbi5kZXBsb3kodGhpcy5jbHVzdGVySW5mbyk7XG4gICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYWRkT25LZXkgPSB1dGlscy5nZXRBZGRPbk5hbWVPcklkKGFkZE9uKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsdXN0ZXJJbmZvLmFkZFNjaGVkdWxlZEFkZE9uKGFkZE9uS2V5LCByZXN1bHQsIHV0aWxzLmlzT3JkZXJlZEFkZE9uKGFkZE9uKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBwb3N0RGVwbG95OiBhbnkgPSBhZGRPbjtcbiAgICAgICAgICAgIGlmICgocG9zdERlcGxveSBhcyBzcGkuQ2x1c3RlclBvc3REZXBsb3kpLnBvc3REZXBsb3kgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHBvc3REZXBsb3ltZW50U3RlcHMucHVzaCg8c3BpLkNsdXN0ZXJQb3N0RGVwbG95PnBvc3REZXBsb3kpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2NoZWR1bGVkQWRkT25zID0gdGhpcy5jbHVzdGVySW5mby5nZXRBbGxTY2hlZHVsZWRBZGRvbnMoKTtcbiAgICAgICAgY29uc3QgYWRkT25LZXlzID0gWy4uLnNjaGVkdWxlZEFkZE9ucy5rZXlzKCldO1xuICAgICAgICBjb25zdCBwcm9taXNlcyA9IHNjaGVkdWxlZEFkZE9ucy52YWx1ZXMoKTtcblxuICAgICAgICB0aGlzLmFzeW5jVGFza3MgPSBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbigoY29uc3RydWN0cykgPT4ge1xuICAgICAgICAgICAgY29uc3RydWN0cy5mb3JFYWNoKChjb25zdHJ1Y3QsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jbHVzdGVySW5mby5hZGRQcm92aXNpb25lZEFkZE9uKGFkZE9uS2V5c1tpbmRleF0sIGNvbnN0cnVjdCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKGJsdWVwcmludFByb3BzLnRlYW1zICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCB0ZWFtIG9mIGJsdWVwcmludFByb3BzLnRlYW1zKSB7XG4gICAgICAgICAgICAgICAgICAgIHRlYW0uc2V0dXAodGhpcy5jbHVzdGVySW5mbyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmb3IgKGxldCBzdGVwIG9mIHBvc3REZXBsb3ltZW50U3RlcHMpIHtcbiAgICAgICAgICAgICAgICBzdGVwLnBvc3REZXBsb3kodGhpcy5jbHVzdGVySW5mbywgYmx1ZXByaW50UHJvcHMudGVhbXMgPz8gW10pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmFzeW5jVGFza3MuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTaW5jZSBjb25zdHJ1Y3RvciBjYW5ub3QgYmUgbWFya2VkIGFzIGFzeW5jLCBhZGRpbmcgYSBzZXBhcmF0ZSBtZXRob2QgdG8gd2FpdFxuICAgICAqIGZvciBhc3luYyBjb2RlIHRvIGZpbmlzaC5cbiAgICAgKiBAcmV0dXJucyBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gdGhlIGJsdWVwcmludFxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyB3YWl0Rm9yQXN5bmNUYXNrcygpOiBQcm9taXNlPEVrc0JsdWVwcmludENvbnN0cnVjdD4ge1xuICAgICAgICBpZiAodGhpcy5hc3luY1Rhc2tzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hc3luY1Rhc2tzLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIG1ldGhvZCByZXR1cm5zIGFsbCB0aGUgY29uc3RydWN0cyBwcm9kdWNlZCBieSBkdXJpbmcgdGhlIGNsdXN0ZXIgY3JlYXRpb24gKGUuZy4gYWRkLW9ucykuXG4gICAgICogTWF5IGJlIHVzZWQgaW4gdGVzdGluZyBmb3IgdmVyaWZpY2F0aW9uLlxuICAgICAqIEByZXR1cm5zIEFzeW5jIFRhc2tzIG9iamVjdFxuICAgICAqL1xuICAgIGdldEFzeW5jVGFza3MoKTogUHJvbWlzZTx2b2lkIHwgQ29uc3RydWN0W10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXN5bmNUYXNrcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIG1ldGhvZCByZXR1cm5zIGFsbCB0aGUgY29uc3RydWN0cyBwcm9kdWNlZCBieSBkdXJpbmcgdGhlIGNsdXN0ZXIgY3JlYXRpb24gKGUuZy4gYWRkLW9ucykuXG4gICAgICogTWF5IGJlIHVzZWQgaW4gdGVzdGluZyBmb3IgdmVyaWZpY2F0aW9uLlxuICAgICAqIEByZXR1cm5zIGNsdXN0ZXIgaW5mbyBvYmplY3RcbiAgICAgKi9cbiAgICBnZXRDbHVzdGVySW5mbygpOiBzcGkuQ2x1c3RlckluZm8ge1xuICAgICAgICByZXR1cm4gdGhpcy5jbHVzdGVySW5mbztcbiAgICB9XG5cbiAgICBwcml2YXRlIHByb3ZpZGVOYW1lZFJlc291cmNlcyhibHVlcHJpbnRQcm9wczogRWtzQmx1ZXByaW50UHJvcHMsIHNjb3BlOiBDb25zdHJ1Y3QpOiBzcGkuUmVzb3VyY2VDb250ZXh0IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IHNwaS5SZXNvdXJjZUNvbnRleHQoc2NvcGUsIGJsdWVwcmludFByb3BzKTtcblxuICAgICAgICBmb3IgKGxldCBba2V5LCB2YWx1ZV0gb2YgYmx1ZXByaW50UHJvcHMucmVzb3VyY2VQcm92aWRlcnMgPz8gW10pIHtcbiAgICAgICAgICAgIHJlc3VsdC5hZGQoa2V5LCB2YWx1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlc29sdmVzIGFsbCBkeW5hbWljIHByb3hpZXMsIHRoYXQgc3Vic3RpdHV0ZXMgcmVzb3VyY2UgcHJvdmlkZXIgcHJveGllcyB3aXRoIHRoZSByZXNvbHZlZCB2YWx1ZXMuXG4gICAgICogQHBhcmFtIGJsdWVwcmludFByb3BzXG4gICAgICogQHBhcmFtIHJlc291cmNlQ29udGV4dFxuICAgICAqIEByZXR1cm5zIGEgY29weSBvZiBibHVlcHJpbnQgcHJvcHMgd2l0aCByZXNvbHZlZCB2YWx1ZXNcbiAgICAgKi9cbiAgICBwcml2YXRlIHJlc29sdmVEeW5hbWljUHJveGllcyhibHVlcHJpbnRQcm9wczogRWtzQmx1ZXByaW50UHJvcHMsIHJlc291cmNlQ29udGV4dDogc3BpLlJlc291cmNlQ29udGV4dCkgOiBFa3NCbHVlcHJpbnRQcm9wcyB7XG4gICAgICAgIHJldHVybiB1dGlscy5jbG9uZURlZXAoYmx1ZXByaW50UHJvcHMsICh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHV0aWxzLnJlc29sdmVUYXJnZXQodmFsdWUsIHJlc291cmNlQ29udGV4dCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRlcyBpbnB1dCBhZ2FpbnN0IGJhc2ljIGRlZmluZWQgY29uc3RyYWludHMuXG4gICAgICogQHBhcmFtIGJsdWVwcmludFByb3BzXG4gICAgICovXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZUlucHV0KGJsdWVwcmludFByb3BzOiBFa3NCbHVlcHJpbnRQcm9wcykge1xuICAgICAgICBjb25zdCB0ZWFtTmFtZXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICAgICAgY29uc3RyYWludHMudmFsaWRhdGVDb25zdHJhaW50cyhuZXcgQmx1ZXByaW50UHJvcHNDb25zdHJhaW50cywgRWtzQmx1ZXByaW50UHJvcHMubmFtZSwgYmx1ZXByaW50UHJvcHMpO1xuICAgICAgICBpZiAoYmx1ZXByaW50UHJvcHMudGVhbXMpIHtcbiAgICAgICAgICAgIGJsdWVwcmludFByb3BzLnRlYW1zLmZvckVhY2goZSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRlYW1OYW1lcy5oYXMoZS5uYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRlYW0gJHtlLm5hbWV9IGlzIHJlZ2lzdGVyZWQgbW9yZSB0aGFuIG9uY2VgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGVhbU5hbWVzLmFkZChlLm5hbWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbiJdfQ==